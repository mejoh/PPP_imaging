---
title: "Longitudinal comparisons of motor task performance"
author: "M.E. Johansson"
date: "6/7/2022"
output: 
  html_document: 
    toc: yes
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Prepare R environment

```{r libraries, echo=FALSE, warning=TRUE, message=F}
options(contrasts=c('contr.sum','contr.poly'))

library(MASS)
library(tidyverse)
options(dplyr.summarise.inform = FALSE)
library(lme4); library(lmerTest); library(emmeans); library(effectsize); library(finalfit); library(effects); library(bmlm)
emm_options(lmerTest.df = 'satterthwaite')  # Calculates DFs in the same way as lmerTest
emm_options(lmerTest.limit = 50000)
emm_options(disable.pbkrtest=TRUE)
library(car)
library(extrafont)
library(ggpubr);library(ggforce);library(gghalves);library(ggdist);library(ggeffects); library(GGally); library(sjPlot); library(cowplot); library(viridis); library(lattice); library(see); library(kableExtra); library(gridExtra)
library(mice); library(miceadds)
library(rmcorr); library(ppcor); library(PResiduals); library(cocor); library(olsrr)
loadfonts(device='win',quiet = TRUE)

sigsize=5
lsize=0.6
legend_position <- c(0.8,1.1)
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M://scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
source('M://scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
LmPlots <- function(model){
        
        count <- 1
        while(count<7)
        {
                plot(model, which = count)
                count <- count + 1
        }
        
        modplot <- predictorEffects(model)
        # plot(modplot)
        
}
interrogate_cluster <- function(df, cluster, outputpth){
    
    df <- dat.int
    cluster <- 'Z_SeverityType3gt1_cid1'
    outputpth <- 'M:/Visualization/R_LongitudinalComparisonFmri'
    
    # Set plotting parameters
    t <- 'Clinical progression predicts changes in actvity'
    fpth <- paste(outputpth,'/3dLMEr_c-', cluster, sep='')
    
    # Set cluster of interest
    df <- df %>%
        rename(cluster = any_of(cluster))
    
    # Take differences between conditions
    df.collapsed <- df %>% 
        pivot_wider(id_cols = c('Subj', 'TimepointNr', 'ClinScore', 'Age', 'Sex', 'MeanFD'),
                    names_from = trial_type,
                    values_from = c(cluster)) %>%
        mutate(Beta.2gt1 = `2c`-`1c`,
               Beta.3gt1 = `3c`-`1c`,
               Beta.23gt1 = (`2c`+`3c`)/2 - `1c`,
               Beta.Mean = (`1c`+`2c`+`3c`)/3)
    
    # Take differences between timepoints
    progression <- df.collapsed %>% 
        pivot_wider(id_cols = c('Subj'),
                    names_from = TimepointNr,
                    values_from = c(ClinScore,
                                    Beta.2gt1,
                                    Beta.3gt1,
                                    Beta.23gt1,
                                    Beta.Mean)) %>%
        mutate(ClinScore.BA=ClinScore_T0,
               ClinScore.delta=ClinScore_T1-ClinScore_T0,
               Beta.2gt1.delta = Beta.2gt1_T1 - Beta.2gt1_T0,
               Beta.3gt1.delta = Beta.3gt1_T1 - Beta.3gt1_T0,
               Beta.23gt1.delta = Beta.23gt1_T1 - Beta.23gt1_T0,
               Beta.Mean.delta = Beta.Mean_T1 - Beta.Mean_T0) %>%
        select(Subj, ClinScore.BA, ClinScore.delta, Beta.2gt1.delta, Beta.3gt1.delta, Beta.23gt1.delta, Beta.Mean.delta)
    df.collapsed <- left_join(df.collapsed,progression,by='Subj')
    
    # Full data
    g <- ggplot(df, aes(y=cluster,x=ClinScore)) + 
        geom_point(alpha=0.25,size=0.6) +
        geom_line(aes(group=Subj),alpha=0.5,lwd=0.5) +
        geom_smooth(color='darkred',method='lm') +
        facet_grid(~trial_type)+
        theme_bw() + 
        ylab('Beta') + xlab('Bradykinesia') +
        ggtitle(t)
    print(g)
    oname <- paste(fpth,'_i1.png',sep='')
    save_plot(oname,g, dpi=300, device='png', base_width = 5)
    # Collapsed across condition
    g <- ggplot(df.collapsed, aes(y=Beta.23gt1,x=ClinScore)) + 
        geom_point(alpha=0.25,size=0.6) +
        geom_line(aes(group=Subj,color=ClinScore.delta),alpha=0.5,lwd=0.5) +
        scale_color_viridis_c(option = 'mako',begin=0,end=1,direction=-1) + 
        geom_smooth(color='darkred',method='lm') +
        theme_bw() +
        labs(color='Progression') + ylab('Beta (multiple > single)') + xlab('Bradykinesia') +
        ggtitle(t)
    print(g)
    oname <- paste(fpth,'_i2.png',sep='')
    save_plot(oname, g, dpi=300, device='png', base_width = 5)
    # Collapsed across condition and time
    m <- lmer(cluster ~ ClinScore*trial_type + Age + Sex + (ClinScore|Subj), 
               data = df,
               control = lmerControl(optimizer = 'bobyqa'))
    tab_model(m)
    s <- summary(m)
    g <- df.collapsed %>%
        filter(TimepointNr=='T0') %>%
        ggplot(aes(y=Beta.23gt1.delta, x=ClinScore.delta)) +
        geom_point(alpha=0.25,size=0.6) +
        geom_smooth(color='darkred',method='lm') +
        theme_bw() +
        labs(color='Progression') + ylab('Delta: beta (multiple > single, fu > ba)') + xlab('Delta: bradykinesia (fu > ba)') +
        ggtitle(t) + 
        geom_text(x=0,y=2.5, label = paste('Bradykinesia*2c>1c: β = ', round(s$coefficients[7,1],digits=3),
                                           ', SE = ', round(s$coefficients[7,2],digits=3),
                                           ', P = ', round(s$coefficients[7,5],digits=10),
                                           sep='')) +
        geom_text(x=0,y=2, label = paste('Bradykinesia*3c>1c: β = ', round(s$coefficients[8,1],digits=3),
                                           ', SE = ', round(s$coefficients[8,2],digits=3),
                                           ', P = ', round(s$coefficients[8,5],digits=10),
                                           sep=''))
    print(g)
    oname <- paste(fpth,'_i3.png',sep='')
    save_plot(oname, g, dpi=300, device='png', base_width = 5)
    # Predicted trends
    e <- ggemmeans(m, terms = c('ClinScore','trial_type'))
    g <- plot(e) + 
        theme_bw() +
        ggtitle(t) + 
        labs(y='Beta',x='Bradykinesia')
    print(g)
    oname <- paste(fpth,'_i4.png',sep='')
    save_plot(oname, g, dpi=300, device='png', base_width = 5)
    # Predicted trends collapsed across condition and time
    tmp <- df.collapsed %>%
        filter(TimepointNr == 'T0') %>%
        select(Subj, ClinScore.BA, Age, Sex, ClinScore.delta, Beta.23gt1.delta)
    m.delta <- lm(Beta.23gt1.delta ~ ClinScore.delta + Age + Sex, data = tmp, weights = ClinScore.BA)
    tab_model(m.delta)
    e <- ggemmeans(m.delta, terms = 'ClinScore.delta [all]')
    g <- plot(e, residuals = TRUE, residuals.line = TRUE) + 
        theme_bw() +
        ggtitle(t) + 
        labs(y='Delta: beta (multiple > single, fu > ba)',x='Delta: bradykinesia (fu > ba)')
    print(g)
    oname <- paste(fpth,'_i5.png',sep='')
    save_plot(oname, g, dpi=300, device='png', base_width = 5)
    
    
}
```

# Load data

## Clinical

```{r clinvars, echo=FALSE, warning=TRUE, message=TRUE}
# Load clinical data
fClin <- 'P:/3022026.01/pep/ClinVars_10-08-2023/derivatives/merged_manipulated_2023-10-18.csv'
dfClin <- read_csv(fClin, show_col_types = FALSE)

# Initial variable selection and clean up
        # Define relevant variables
        # Fix TimepointNr inconsistency between POM and PIT
        # Remove PD_PIT sessions and include only motor task subjects
        # Set subtype variable, factorize, and convert units
clinvars <- c('pseudonym', 'TimepointNr', 'YearsToFollowUp', 'ParticipantType',
              'Subtype_DiagEx3_DisDurSplit','MriNeuroPsychTask',
              'Age', 'Gender', 'NpsEducYears', 'PrefHand', 'YearsSinceDiag',
              'ParkinMedUser', 'LEDD', 'Up3OfHoeYah',
              'Up3OfTotal', 'Up3OfAppendicularSum', 'Up3OfBradySum',
              'Up3OfRigiditySum', 'Up3OnTotal','Up3OnAppendicularSum', 'Up3OnBradySum','Up3OnRigiditySum',
              'Up3OnRestTremAmpSum','Up3OnActionTremorSum','Up3OnCompositeTremorSum','z_MoCA__total', 'z_CognitiveComposite2',
              'AsymmetryIndexRiLe.WeightedBradyRig2',
              'BDI2Sum','DiagParkCertain', 'DiagParkPersist','DiagParkReplace',
              'STAITraitSum', 'STAIStateSum', 'QUIPicdSum','MoCASum')
dfClin <- dfClin %>%
        mutate(TimepointNr=if_else(ParticipantType=='HC_PIT' & TimepointNr==1, 2,
                                   TimepointNr)) %>%
        filter(ParticipantType=='HC_PIT' | ParticipantType=='PD_POM') %>%
        select(all_of(clinvars)) %>%
        rename(Subtype = Subtype_DiagEx3_DisDurSplit) %>%
        mutate(TimepointNr = factor(TimepointNr, levels = c(0,1,2), labels = c('0','1','2')),
               ParticipantType = factor(ParticipantType),
               Gender = factor(Gender),
               Subtype = if_else(ParticipantType=='HC_PIT', '0_Healthy', Subtype),
               Subtype = if_else(is.na(Subtype),'4_Undefined',Subtype),
               Subtype = factor(Subtype),
               Up3OfHoeYah=factor(Up3OfHoeYah),
               MostAffSide = case_when(AsymmetryIndexRiLe.WeightedBradyRig2 < 0 ~ 'Left',
                                       AsymmetryIndexRiLe.WeightedBradyRig2 > 0 ~ 'Right',
                                       AsymmetryIndexRiLe.WeightedBradyRig2 == 0 ~ 'None',
                                       .default = NA))

# Set relevant covariates to their baseline values
baseline_covs <- dfClin %>%
        filter(TimepointNr==0) %>%
        select(pseudonym,ParticipantType,Age,Gender,NpsEducYears,PrefHand,MostAffSide,Subtype)
dfClin <- dfClin %>% 
        select(-c(Age,Gender,NpsEducYears,PrefHand,Subtype,MostAffSide)) %>%
        left_join(.,baseline_covs,by=c('pseudonym','ParticipantType'))

# Binarize the MostAffSide variable to Right and Left or Bilateral
# dfClin$MostAffSide[dfClin$MostAffSide=='BiL>R'] <- 'Left'
# dfClin$MostAffSide[dfClin$MostAffSide=='LeftOnly'] <- 'Left'
# dfClin$MostAffSide[dfClin$MostAffSide=='BiR>L'] <- 'Right'
# dfClin$MostAffSide[dfClin$MostAffSide=='Right'] <- 'Right'
# dfClin$MostAffSide[dfClin$MostAffSide=='RightOnly'] <- 'Right'
# dfClin$MostAffSide[dfClin$MostAffSide=='BiR=L'] <- 'Bilateral'
# dfClin$MostAffSide[dfClin$MostAffSide=='None'] <- 'Bilateral'

# # Create a variable of groups, needed to fix faulty label in task data
# pType <- dfClin %>%
#         select(pseudonym,ParticipantType) %>%
#         group_by(pseudonym) %>%
#         summarise(across(everything(), ~first(.x)))

# Print N
dfClin %>% select(ParticipantType,TimepointNr) %>% table() %>% print()

# Select ON or OFF medication scores
CLINVAR='Up3OnBradySum'         # This variable is needed for the multiple imputation
dfClin <- dfClin %>%
        mutate(Up3Total=Up3OnTotal, 
               Up3AppendicularSum=Up3OnAppendicularSum, 
               Up3BradySum=Up3OnBradySum,
               Up3RigiditySum=Up3OnRigiditySum)

```

## Task performance

```{r behav-fmri, echo=FALSE, warning=TRUE, message=F}
# Load fMRI task performance data
fTask <- 'P:/3022026.01/pep/bids/derivatives/manipulated_merged_motor_task_mri_2023-09-15.csv'
dfTask <- read_csv(fTask, show_col_types = FALSE)

# Initial variable selection and clean up
dfTask <- dfTask %>%
        filter(Group=='HC_PIT' | Group=='PD_POM') %>%
    select(pseudonym, Group, Timepoint, trial_type, response_time, trial_number,
           event_type, correct_response, block, RespondingHand, Group, 
           Button.Press.SwitchRatio, Button.Press.CoV) %>%
    mutate(TimepointNr = if_else(str_detect(Timepoint, 'Visit1'), '0', '2'),
           TimepointNr = factor(TimepointNr),
           trial_type=factor(trial_type),
           block=factor(block),
           RespondingHand=factor(RespondingHand),
           error = if_else(correct_response=='Incorrect',1,0)) %>%
    relocate(pseudonym, TimepointNr) %>%
    select(-Timepoint) %>%
        rename(ParticipantType=Group)

# Missed responses
misses <- dfTask %>%
        filter(is.na(response_time), event_type=='cue', correct_response=='Miss') %>%
        group_by(pseudonym, ParticipantType, TimepointNr, trial_type, block) %>%
        summarise(n_misses=n()) %>%
        ungroup()
dfTask <- dfTask %>%
        left_join(., misses) %>%
        mutate(n_misses = if_else(is.na(n_misses),0,n_misses))

# Divide into response time and error rate
dfTask.rt <- dfTask %>%
    filter(event_type == 'response') %>%
    filter(trial_type != 'Catch') %>%
    filter(response_time > 0.3) %>%
    filter(correct_response=='Hit') %>%
    select(pseudonym, ParticipantType, TimepointNr, trial_type, block, RespondingHand,
           response_time, Button.Press.CoV, Button.Press.SwitchRatio, n_misses) %>%
    mutate(trial_type=factor(trial_type))
dfTask.err <- dfTask %>%
    filter(event_type == 'response') %>%
    filter(trial_type != 'Catch') %>%
    filter(response_time > 0.3) %>%
    select(pseudonym, ParticipantType, TimepointNr, trial_type, block, RespondingHand,
           error, Button.Press.CoV, Button.Press.SwitchRatio, n_misses) %>%
    mutate(trial_type=factor(trial_type))
# Aggregate
dfTask.rt <- dfTask.rt %>%
    group_by(pseudonym, ParticipantType, TimepointNr, trial_type, block) %>%
    summarise(RespondingHand = first(RespondingHand),
              Button.Press.CoV = first(Button.Press.CoV),
              Button.Press.SwitchRatio=first(Button.Press.SwitchRatio),
              n_misses = first(n_misses),
              response_time = median(response_time,na.rm=TRUE)) %>%
    ungroup()
        # n_trials   = No. of correct and incorrect trials. Misses are excluded
dfTask.err <- dfTask.err %>%
    group_by(pseudonym, ParticipantType, TimepointNr, trial_type, block) %>%
    summarise(RespondingHand = first(RespondingHand),
              Button.Press.CoV = first(Button.Press.CoV),
              Button.Press.SwitchRatio=first(Button.Press.SwitchRatio),
              n_misses = first(n_misses),
              n_trials=n(),
              n_errors=sum(error),
              n_corrects=n_trials - n_errors,
              error_rate = (n_errors/n_trials),
              correct_rate = (n_corrects/n_trials)) %>%
    ungroup()

# Add participant type from clinical data
dfTask <- full_join(dfTask.rt,dfTask.err) %>%
        mutate(total_misses_by_time = sum(n_misses), .by=c(pseudonym,ParticipantType,TimepointNr))

print(dfTask)
```

## Practice performance

```{r behav-prac, echo=FALSE, warning=TRUE, message=F}
# Practice data
# Load
fTaskPrac <- 'P:/3022026.01/pep/bids/derivatives/manipulated_merged_motor_task_practice_2023-09-15.csv'
dfTaskPrac <- read_csv(fTaskPrac, show_col_types = FALSE)
dfTaskPrac <- dfTaskPrac %>%
        filter(Group=='HC_PIT' | Group=='PD_POM') %>%
    select(pseudonym, Group, Timepoint, trial_type, response_time, trial_number,
           event_type, correct_response, RespondingHand) %>%
    mutate(TimepointNr = if_else(str_detect(Timepoint, 'Visit1'), '0', '2'),
           TimepointNr = factor(TimepointNr),
           RespondingHand=factor(RespondingHand),
           error = if_else(correct_response=='Incorrect',1,0)) %>%
    relocate(pseudonym, TimepointNr) %>%
    select(-Timepoint) %>%
        rename(ParticipantType=Group)
# Clean
dfTaskPrac.rt <- dfTaskPrac %>%
    filter(event_type == 'response') %>%
    filter(trial_type != 'Catch') %>%
    filter(response_time > 0.3) %>%
    filter(correct_response=='Hit') %>%
    select(pseudonym, ParticipantType, TimepointNr, trial_type, RespondingHand, response_time) %>%
    mutate(trial_type=factor(trial_type))
dfTaskPrac.err <- dfTaskPrac %>%
    filter(event_type == 'response') %>%
    filter(trial_type != 'Catch') %>%
    filter(response_time > 0.3) %>%
    select(pseudonym, ParticipantType, TimepointNr, trial_type, RespondingHand, error) %>%
    mutate(trial_type=factor(trial_type))
# Aggregate
dfTaskPrac.rt <- dfTaskPrac.rt %>%
    group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>%
    summarise(RespondingHand = first(RespondingHand),
              response_time = median(response_time,na.rm=TRUE)) %>%
    ungroup()
dfTaskPrac.err <- dfTaskPrac.err %>%
    group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>%
    summarise(RespondingHand = first(RespondingHand),
              n_trials=n(),
              n_errors=sum(error),
              n_corrects=n_trials - n_errors,
              error_rate = (n_errors/n_trials),
              correct_rate = (n_corrects/n_trials)) %>%
    ungroup()
dfTaskPrac <- full_join(dfTaskPrac.rt,dfTaskPrac.err)

print(dfTaskPrac)
```

# Exclusions
 
## Diagnosis

 - Misdiagnosis

```{r exclude-diag, echo=FALSE, warning=TRUE, message=TRUE}

# Define misdiagnoses
diagnosis <- dfClin %>% select(pseudonym, TimepointNr, DiagParkCertain, DiagParkPersist, DiagParkReplace)
baseline_exclusion <- diagnosis %>%
    filter(TimepointNr=='0', (DiagParkCertain == 'NeitherDisease' | DiagParkCertain == 'DoubtAboutParkinsonism' | DiagParkCertain == 'Parkinsonism')) %>% 
    select(pseudonym, DiagParkCertain)
visit2_exclusion <- diagnosis %>%
    filter(TimepointNr=='2', (DiagParkPersist == 2)) %>% 
    select(pseudonym, DiagParkPersist, DiagParkReplace)
diag_exclusions <- full_join(baseline_exclusion, visit2_exclusion, by='pseudonym') %>% 
    unique()
dfClin <- dfClin %>%
    mutate(Misdiagnosis = if_else(pseudonym %in% diag_exclusions$pseudonym,1,0))

# Report patients with confirmed non-PD diagnosis
cat('>>> Excluding patients with confirmed non-PD diagnosis at baseline and patients who received a non-PD diagnosis at 2-year follow-up\n')
diagnosis %>% filter(TimepointNr=='0') %>% select(DiagParkCertain) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
diagnosis %>% filter(TimepointNr=='2') %>% select(DiagParkPersist) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
diagnosis %>% filter(TimepointNr=='2') %>% select(DiagParkReplace) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
cat('>>> Excluded based on misdiagnosis:\n')
diag_exclusions %>% kable(., 'pipe', digits = 3, padding=0)
write_csv(diag_exclusions, 'P:/3024006.02/Data/exclusions_diagnosis.csv')

# Checks on patients who had a doubtful diagnosis at baseline
cat('>>> How does the 2-year follow-up diagnosis change for patients with uncertain PD diagnoses at baseline?\n')
cat('>>> DoubtAboutPD\n')
doubt_at_ba <- diagnosis %>%
    filter(DiagParkCertain == 'DoubtAboutPD') %>%
    select(pseudonym)
diagnosis %>% filter(TimepointNr=='2', pseudonym %in% doubt_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
cat('>>> Parkinsonism\n')
parkinsonism_at_ba <- diagnosis %>%
    filter(DiagParkCertain == 'Parkinsonism') %>%
    select(pseudonym)
diagnosis %>% filter(TimepointNr=='2', pseudonym %in% parkinsonism_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
cat('>>> NeitherDisease\n')
neither_at_ba <- diagnosis %>%
    filter(DiagParkCertain == 'NeitherDisease') %>%
    select(pseudonym)
diagnosis %>% filter(TimepointNr=='2', pseudonym %in% neither_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
cat('>>> DoubtAboutParkinsonism\n')
doubt2_at_ba <- diagnosis %>%
    filter(DiagParkCertain == 'DoubtAboutParkinsonism') %>%
    select(pseudonym)
diagnosis %>% filter(TimepointNr=='2', pseudonym %in% doubt2_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table() %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

# Exclude subjects with non-PD diagnosis
n1 <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())
n2 <- dfTaskPrac %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTaskPrac=n())
n3 <- dfClin %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nClin=n())
n_before <- full_join(n1, n2, by=c('ParticipantType','TimepointNr')) %>%
    full_join(., n3, by=c('ParticipantType','TimepointNr'))

dfTask <- dfTask %>%
    filter(!(pseudonym %in% diag_exclusions$pseudonym))
dfTaskPrac <- dfTaskPrac %>%
    filter(!(pseudonym %in% diag_exclusions$pseudonym))
dfClin <- dfClin %>%
       filter(!(pseudonym %in% diag_exclusions$pseudonym)) 

n1 <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())
n2 <- dfTaskPrac %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTaskPrac=n())
n3 <- dfClin %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nClin=n())
n_after <- full_join(n1, n2, by=c('ParticipantType','TimepointNr')) %>%
    full_join(., n3, by=c('ParticipantType','TimepointNr'))

cat('>>> Before diagnosis exclusions:\n', sep='')
print(n_before)
cat('>>> After diagnosis exclusions:\n', sep='')
print(n_after)

```

## Accuracy

 - Low accuracy (< 25% correct on one-choice trials, averaged across blocks)

```{r exclude-perf, echo=FALSE, warning=TRUE, message=TRUE}

# Performance
# I've tried to balance the exclusion of subjects due to poor accuracy
# Some perform the task perfectly, just opposite of what is intended
# The subjects do not represent a problem, and excluding them would not 
# be appropriate. A decent balance is when considering average error rates across
# blocks, and by excluding sessions rather than entire subjects
# Current rule:
# If a timepoint has % correct <= 25 & trial_type == '1choice' THEN exclude that session
cat('>>> Excluding sessions where the across-block error rate in 1choice trials is <=25%\n')
poor_performance <- dfTask %>%
    filter(trial_type=='NChoice1') %>%
    group_by(ParticipantType, pseudonym, TimepointNr, trial_type, block) %>%
    summarise(across(everything(), ~first(.x))) %>% 
    ungroup() %>%
    select(pseudonym, ParticipantType, TimepointNr, trial_type, block, correct_rate) %>%
    pivot_wider(id_cols = c('pseudonym','ParticipantType','TimepointNr', 'trial_type'),
                values_from = correct_rate,
                names_from = block,
                names_prefix = 'block_') %>%
    mutate(success_rate.avg = ((block_1+block_2+block_3)/3),
           poor_performance = if_else(success_rate.avg<=0.25,1,0)) %>% 
    filter(poor_performance==1) %>%
    select(pseudonym, ParticipantType, TimepointNr, block_1, block_2, block_3, success_rate.avg)
cat('>>> Excluded sessions based on error rate:',nrow(poor_performance),'\n')
poor_performance %>% kable(., 'pipe', digits = 3, padding=0)
poor_performance %>% select(ParticipantType,TimepointNr) %>% table() %>% print()
write_csv(poor_performance, 'P:/3024006.02/Data/exclusions_accuarcy.csv')

n_before <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())

for(n in 1:nrow(poor_performance)){
    row <- poor_performance[n,]
    idx <- which(dfTask$pseudonym==row$pseudonym & dfTask$TimepointNr==row$TimepointNr)
    dfTask <- dfTask[-idx,]
}

n_after <- dfTask %>%
    group_by(pseudonym,ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    group_by(ParticipantType,TimepointNr) %>%
    summarise(nTask=n())

cat('>>> Before accuracy exclusions:\n', sep='')
print(n_before)
cat('>>> After accuracy exclusions:\n', sep='')
print(n_after)

```

## Misses

 - Excessive missing (< 60 misses across the whole session)

```{r exclude-missresp, echo=FALSE, warning=TRUE, message=TRUE}

thr=60
cat('>>> Excluding sessions where there were too many misses (n>', thr, '):\n', sep='')

n_before <- dfTask %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  TimepointNr=first(TimepointNr),
                  total_misses_by_time=first(total_misses_by_time)) %>%
        ungroup() %>%
        group_by(ParticipantType,TimepointNr) %>%
        summarise(N=n(),
                  Min=min(total_misses_by_time),
                  Max=max(total_misses_by_time),
                  Mean=mean(total_misses_by_time),
                  SD=sd(total_misses_by_time)) %>%
        ungroup()

poor_performance <- dfTask %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  TimepointNr=first(TimepointNr),
                  total_misses_by_time=first(total_misses_by_time),
                  error_rate = mean(error_rate),
                  RT = mean(response_time)) %>%
        mutate(poor_performance = if_else(total_misses_by_time > thr,1,0)) %>%
        filter(poor_performance == 1) %>%
        ungroup()
cat('>>> Excluded sessions based on number of misses:',nrow(poor_performance),'\n')
poor_performance %>% kable(., 'pipe', digits = 3, padding=0)
poor_performance %>% select(ParticipantType,TimepointNr) %>% table() %>% print()
write_csv(poor_performance, 'P:/3024006.02/Data/exclusions_misses.csv')

n_after <- dfTask %>%
        filter(total_misses_by_time < thr) %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  TimepointNr=first(TimepointNr),
                  total_misses_by_time=first(total_misses_by_time)) %>%
        ungroup() %>%
        group_by(ParticipantType,TimepointNr) %>%
        summarise(N=n(),
                  Min=min(total_misses_by_time),
                  Max=max(total_misses_by_time),
                  Mean=mean(total_misses_by_time),
                  SD=sd(total_misses_by_time)) %>%
        ungroup()

cat('>>> Before exclusions due to too many misses:\n', sep='')
print(n_before)
cat('>>> After exclusions due to too many misses:\n', sep='')
print(n_after)

dfTask <- dfTask %>%
        filter(total_misses_by_time < thr)

```

# Data organization

## Assembly and imputation

```{r data-assembly, echo=FALSE, warning=TRUE, message=TRUE}
# Extract confounders
vars.conf <- c('pseudonym', 'ParticipantType', 'Age', 'Gender', 'YearsSinceDiag', 'NpsEducYears', 'PrefHand', 'MostAffSide')
dfClin.conf <- dfClin %>%
    filter(TimepointNr==0) %>%
    select(all_of(vars.conf))

# Extract progression
vars.prog <- c('pseudonym', 'TimepointNr', 'Age', 'Gender', 'YearsSinceDiag', 'NpsEducYears',
               'ParticipantType', 'Up3OfBradySum', 'Up3OnBradySum', 'Up3BradySum','z_MoCA__total','LEDD')
dfClin.prog <- dfClin %>%
    filter(ParticipantType=='PD_POM',
           TimepointNr == 0 | TimepointNr == 2) %>%
    select(all_of(vars.prog))
## Impute!
## Note that this stage is fragile with respect to changes in
## the clinical variable that is investigated. I set up CLINVAR as a
## ugly workaround so I could get Medication effects into the imputation
dfClin.prog.imp <- dfClin.prog %>%
        select(pseudonym, Up3OfBradySum, Up3OnBradySum, z_MoCA__total, LEDD, TimepointNr, Age, Gender, YearsSinceDiag, NpsEducYears) %>%
        pivot_longer(cols=c('Up3OfBradySum','Up3OnBradySum'),
                     names_to = 'Medication',
                     values_to = 'Up3BradySum') %>%
        mutate(Medication=factor(Medication))
md.pattern(dfClin.prog.imp)
isna <- apply(dfClin.prog.imp, 2, is.na) %>% colSums()
cat(paste('\n ', '>>> Percentage missing values\n', sep=''))
missing_perc <- round(isna/nrow(dfClin.prog.imp), digits = 3)*100
print(missing_perc)
imputed <- dfClin.prog.imp %>% 
        mice(m=round(5*missing_perc[names(missing_perc)=='Up3BradySum']), 
             maxit = 10, 
             method='pmm', 
             seed=157, 
             print=FALSE)
summary(imputed)
print(stripplot(imputed, formula('Up3BradySum ~ TimepointNr',sep='')),
      pch = 19)
print(stripplot(imputed, formula('z_MoCA__total ~ TimepointNr',sep='')),
      pch = 19)
print(stripplot(imputed, formula('LEDD ~ TimepointNr',sep='')),
      pch = 19)
dfClin.prog.imp <- imputed %>%
        complete() %>%
        tibble() %>%
        filter(Medication==CLINVAR) %>%
        select(pseudonym, TimepointNr, Up3BradySum, z_MoCA__total, LEDD) %>%
        rename(Up3BradySum.imp = Up3BradySum,
               z_MoCA__total.imp = z_MoCA__total,
               LEDD.imp = LEDD)

dfClin.prog <- dfClin.prog %>%
        left_join(., dfClin.prog.imp, by=c('pseudonym','TimepointNr'))

## Pivot wider
dfClin.prog <- dfClin.prog %>%
    pivot_wider(id_cols = c('pseudonym','ParticipantType'),
                names_from = TimepointNr,
                names_prefix = 'T',
                values_from = c(Up3OfBradySum,Up3OnBradySum,Up3BradySum,Up3BradySum.imp,z_MoCA__total,z_MoCA__total.imp,LEDD,LEDD.imp))
## Calculate raw change score
dfClin.prog <- dfClin.prog %>%
    mutate(Up3OfBradySum_RawChange = Up3OfBradySum_T2-Up3OfBradySum_T0,
           Up3OnBradySum_RawChange = Up3OnBradySum_T2-Up3OnBradySum_T0,
           Up3BradySum_RawChange = Up3BradySum_T2-Up3BradySum_T0,
           Up3BradySum.imp_RawChange = Up3BradySum.imp_T2-Up3BradySum.imp_T0,
           z_MoCA__total_RawChange = z_MoCA__total.imp_T2 - z_MoCA__total_T0,
           z_MoCA__total.imp_RawChange = z_MoCA__total.imp_T2 - z_MoCA__total.imp_T0,
           LEDD_RawChange = LEDD_T2 - LEDD_T0,
           LEDD.imp_RawChange = LEDD.imp_T2 - LEDD.imp_T0) %>%
    select(pseudonym, ParticipantType, 
           Up3OfBradySum_T0, Up3OfBradySum_T2, Up3OfBradySum_RawChange,
           Up3OnBradySum_T0, Up3OnBradySum_T2, Up3OnBradySum_RawChange,
           Up3BradySum_T0, Up3BradySum_T2, Up3BradySum_RawChange,
           Up3BradySum.imp_T0, Up3BradySum.imp_T2, Up3BradySum.imp_RawChange,
           z_MoCA__total_T0, z_MoCA__total.imp_T2, z_MoCA__total_RawChange,
           z_MoCA__total.imp_T0, z_MoCA__total.imp_T2, z_MoCA__total.imp_RawChange,
           LEDD_T0, LEDD_T2, LEDD_RawChange, LEDD.imp_T0, LEDD.imp_T2, LEDD.imp_RawChange)

# Extract time to follow-up
vars.time <- c('pseudonym', 'TimepointNr', 'YearsToFollowUp')
dfClin.time <- dfClin %>%
    select(all_of(vars.time))

# Merge clinical and task data
dfFMRI <- left_join(dfTask, dfClin.conf, by = c('pseudonym', 'ParticipantType')) %>%
    left_join(., dfClin.time, by = c('pseudonym','TimepointNr')) %>%
    left_join(., dfClin.prog, by = c('pseudonym','ParticipantType'))

# Do the same for practice data
dfPrac <- left_join(dfTaskPrac, dfClin.conf, by = c('pseudonym', 'ParticipantType')) %>%
    left_join(., dfClin.time, by = c('pseudonym', 'TimepointNr')) %>%
    left_join(., dfClin.prog, by = c('pseudonym','ParticipantType'))

```

## Mutation

```{r data-mutation, echo=FALSE, warning=TRUE, message=TRUE}

# Prepare age and years since diagnosis as a continuous measure of time. Center it at mean age at baseline
# Prepare a time-varying measure of symptom severity. Center it at mean severity at baseline
# 
dfFMRI <- dfFMRI %>%
    mutate(Age_timevar=if_else(TimepointNr=='2',Age+YearsToFollowUp,Age),
           Age_Dmean = Age - mean(dfFMRI$Age[dfFMRI$TimepointNr==0],na.rm=TRUE),
           YearsSinceDiag_timevar=if_else(TimepointNr=='2',YearsSinceDiag+YearsToFollowUp,YearsSinceDiag),
           YearsSinceDiag_Dmean = YearsSinceDiag - mean(dfFMRI$YearsSinceDiag[dfFMRI$TimepointNr==0],na.rm=TRUE),
           NpsEducYears_Dmean = NpsEducYears - mean(dfFMRI$NpsEducYears[dfFMRI$TimepointNr==0],na.rm=TRUE),
           Up3OfBradySum = Up3OfBradySum_T0,
           Up3OfBradySum = if_else(TimepointNr=='2',Up3OfBradySum_T0+Up3OfBradySum_RawChange,Up3OfBradySum),
           Up3OnBradySum = Up3OnBradySum_T0,
           Up3OnBradySum = if_else(TimepointNr=='2',Up3OnBradySum_T0+Up3OnBradySum_RawChange,Up3OnBradySum),
           Up3BradySum = Up3BradySum.imp_T0,
           Up3BradySum = if_else(TimepointNr=='2',Up3BradySum.imp_T0+Up3BradySum.imp_RawChange,Up3BradySum),
           z_MoCA__total = z_MoCA__total.imp_T0,
           z_MoCA__total = if_else(TimepointNr=='2',z_MoCA__total.imp_T0+z_MoCA__total.imp_RawChange,z_MoCA__total))
dfPrac <- dfPrac %>%
    mutate(Age_timevar=if_else(TimepointNr=='2',Age+YearsToFollowUp,Age),
           Age_Dmean = Age - mean(dfFMRI$Age[dfFMRI$TimepointNr==0],na.rm=TRUE),
           YearsSinceDiag_timevar=if_else(TimepointNr=='2',YearsSinceDiag+YearsToFollowUp,YearsSinceDiag),
           YearsSinceDiag_Dmean = YearsSinceDiag - mean(dfFMRI$YearsSinceDiag[dfFMRI$TimepointNr==0],na.rm=TRUE),
           NpsEducYears_Dmean = NpsEducYears - mean(dfFMRI$NpsEducYears[dfFMRI$TimepointNr==0],na.rm=TRUE),
           Up3OfBradySum = Up3OfBradySum_T0,
           Up3OfBradySum = if_else(TimepointNr=='2',Up3OfBradySum_T0+Up3OfBradySum_RawChange,Up3OfBradySum),
           Up3OnBradySum = Up3OnBradySum_T0,
           Up3OnBradySum = if_else(TimepointNr=='2',Up3OnBradySum_T0+Up3OnBradySum_RawChange,Up3OnBradySum),
           Up3BradySum = Up3BradySum.imp_T0,
           Up3BradySum = if_else(TimepointNr=='2',Up3BradySum.imp_T0+Up3BradySum.imp_RawChange,Up3BradySum),
           z_MoCA__total = z_MoCA__total.imp_T0,
           z_MoCA__total = if_else(TimepointNr=='2',z_MoCA__total.imp_T0+z_MoCA__total.imp_RawChange,z_MoCA__total))

# # Add polynomials
# tmp <- dfFMRI %>%
#     select(pseudonym,TimepointNr, Age_Dmean) %>%
#     group_by(pseudonym,TimepointNr) %>%
#     summarise(across(everything(), ~first(.x))) %>%
#     ungroup() %>%
#     na.omit()
# Age.poly <- poly(tmp$Age_Dmean, degree=3)
# colnames(Age.poly) <- c('Age_Dmean.poly1', 'Age_Dmean.poly2', 'Age_Dmean.poly3')
# tmp <- bind_cols(tmp, Age.poly) %>%
#     select(-Age_Dmean)
# dfFMRI <- dfFMRI %>%
#     left_join(., tmp, by=c('pseudonym','TimepointNr'))
# 
# tmp <- dfPrac %>%
#     select(pseudonym,TimepointNr, Age_Dmean) %>%
#     group_by(pseudonym,TimepointNr) %>%
#     summarise(across(everything(), ~first(.x))) %>%
#     ungroup() %>%
#     na.omit()
# Age.poly <- poly(tmp$Age_Dmean, degree=3)
# colnames(Age.poly) <- c('Age_Dmean.poly1', 'Age_Dmean.poly2', 'Age_Dmean.poly3')
# tmp <- bind_cols(tmp, Age.poly) %>%
#     select(-Age_Dmean)
# dfPrac <- dfPrac %>%
#     left_join(., tmp, by=c('pseudonym','TimepointNr'))

# Determine whether most affected side is the dominant side
dfFMRI <- dfFMRI %>%
        mutate(RespHandIsDominant = if_else(RespondingHand == PrefHand
                                            | RespondingHand == 'NoPref', 1, 0),
               RespHandIsDominant = factor(RespHandIsDominant))
dfPrac <- dfPrac %>%
        mutate(RespHandIsDominant = if_else(RespondingHand == PrefHand
                                            | RespondingHand == 'NoPref', 1, 0),
               RespHandIsDominant = factor(RespHandIsDominant))

# Include only baseline and two-year follow-up
dfFMRI <- dfFMRI %>%
        filter(TimepointNr==0 | TimepointNr==2) %>%
        mutate(across(where(is.factor), droplevels))
dfPrac <- dfPrac %>%
        filter(TimepointNr==0 | TimepointNr==2) %>%
        mutate(across(where(is.factor), droplevels))

# Inlcude only motor subjects for demographics
dfClin <- dfClin %>% filter(MriNeuroPsychTask=='Motor')

```

# *Demographics

## *Patients versus controls

```{r demographics-pdandhc, echo=FALSE, warning=TRUE, message=TRUE}

# Total N
dfClin %>%
        select(ParticipantType,TimepointNr) %>%
        table()

# Compare demographics between patients and controls
cat('>>> Demographics: controls v patients \n')
dependent <- c('ParticipantType')
exploratory <- c('Age', 'Gender', 'NpsEducYears', 'PrefHand', 'MoCASum',
                 'BDI2Sum','STAITraitSum', 'STAIStateSum', 'QUIPicdSum')
split <- c('TimepointNr')
dfClin %>% 
        filter(TimepointNr==0 | TimepointNr==2) %>%
    summary_factorlist_stratified(dependent, 
                                  exploratory,
                                  split = split,
                                  add_dependent_label=TRUE,
                                  p = TRUE, 
                                  p_cont_para = 't.test',
                                  p_cat = 'chisq',
                                  na_include = TRUE,
                                  colname_sep = ':Time') %>%
    kable(., 'pipe', digits = 3, padding=0) %>% 
    print()

# Responding hand
dfFMRI %>% 
        group_by(pseudonym,TimepointNr) %>% 
        summarise(ParticipantType=first(ParticipantType),RespondingHand=first(RespondingHand)) %>% 
        ungroup() %>% 
        select(-pseudonym) %>% 
        group_by(TimepointNr) %>% 
        table()

# Responding hand is dominant
dfFMRI %>% 
        group_by(pseudonym,TimepointNr) %>% 
        summarise(ParticipantType=first(ParticipantType),RespHandIsDominant=first(RespHandIsDominant)) %>% 
        ungroup() %>% 
        select(-pseudonym) %>% 
        group_by(TimepointNr) %>% 
        table()

# Compare time to follow-up between patients and controls
exploratory_time <- c('YearsToFollowUp')
dfClin %>%
    filter(TimepointNr==2) %>%
    summary_factorlist(dependent, 
                       exploratory_time,
                       add_dependent_label=TRUE,
                       p = TRUE, 
                       p_cont_para = 't.test',
                       p_cat = 'chisq',
                       na_include = TRUE) %>%
    kable(., 'pipe', digits = 3, padding=0) %>% 
    print()

# Compare responding hand between patients and controls
dfFMRI %>%
        filter(TimepointNr==0 | TimepointNr==2) %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(RespondingHand=first(RespondingHand)) %>%
        mutate(ParticipantType=factor(ParticipantType)) %>%
        ungroup() %>%
        summary_factorlist_stratified('ParticipantType', 
                                  'RespondingHand',
                                  split = 'TimepointNr',
                                  add_dependent_label=TRUE,
                                  p = TRUE, 
                                  p_cont_para = 't.test',
                                  p_cat = 'chisq',
                                  na_include = TRUE,
                                  colname_sep = ':Time') %>%
    kable(., 'pipe', digits = 3, padding=0) %>% 
    print()

# Compare responding hand is dominant between patients and controls
dfFMRI %>%
        filter(TimepointNr==0 | TimepointNr==2) %>%
        group_by(pseudonym,ParticipantType,TimepointNr) %>%
        summarise(RespHandIsDominant=first(RespHandIsDominant)) %>%
        mutate(ParticipantType=factor(ParticipantType)) %>%
        ungroup() %>%
        summary_factorlist_stratified('ParticipantType', 
                                  'RespHandIsDominant',
                                  split = 'TimepointNr',
                                  add_dependent_label=TRUE,
                                  p = TRUE, 
                                  p_cont_para = 't.test',
                                  p_cat = 'chisq',
                                  na_include = TRUE,
                                  colname_sep = ':Time') %>%
    kable(., 'pipe', digits = 3, padding=0) %>% 
    print()

```

## *Patient-specific

```{r demographics-pdonly, echo=FALSE, warning=TRUE, message=TRUE}

# Descriptives for patients
cat('>>> Demographics: patients only \n')
exploratory_pd <- c('YearsSinceDiag','ParkinMedUser','LEDD',
                    'Up3OfHoeYah','MostAffSide','Up3OfTotal', 'Up3OfAppendicularSum',
                    'Up3OfBradySum', 'Up3OfRigiditySum',
                    'Up3OnTotal', 'Up3OnAppendicularSum',
                    'Up3OnBradySum', 'Up3OnRigiditySum',
                    'z_MoCA__total')
dfClin %>%
        filter(ParticipantType=='PD_POM') %>%
        summary_factorlist('TimepointNr', 
                           exploratory_pd,
                           add_dependent_label=TRUE,
                           p = FALSE,
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3, padding=0) %>% 
        print()

dfClin %>% 
        select(TimepointNr,Subtype) %>%
        table() %>% print()

# Demographics for medication converters
cat('Demographics: patients who start medication \n')
MedConverters <- dfClin %>% 
        filter(ParticipantType=='PD_POM',
               TimepointNr!=1) %>% 
        select(pseudonym, TimepointNr, ParkinMedUser) %>%
        pivot_wider(id_cols = 'pseudonym',
                    names_from = TimepointNr,
                    names_prefix = 'T',
                    values_from = ParkinMedUser) %>%
        na.omit() %>%
        mutate(Converter = if_else(T0=='No' & T2=='Yes',1,0)) %>%
        filter(Converter==1)

dfClin %>%
        filter(pseudonym %in% MedConverters$pseudonym) %>%
        summary_factorlist('TimepointNr', 
                           exploratory_pd,
                           add_dependent_label=TRUE,
                           p = FALSE,
                           na_include = TRUE) %>%
        kable(., 'pipe', digits = 3, padding=0) %>% 
        print()        

```

# *Response times

## Function for comparing RTs (deprecated?)

```{r func-compare_rts, echo=FALSE, warning=TRUE, message=TRUE}
compare_rts <- function(f, tmp, tmp.collapsed){
    
        # Check whether the analzyed data set is fMRI or practice
        if(str_detect(f,'block')){
                g <- ggplot(tmp, aes(x=YearsToFollowUp,y=response_time,color=ParticipantType)) + 
                        geom_point() + 
                        geom_line(aes(group=pseudonym)) + 
                        facet_wrap(~trial_type+ParticipantType+block, nrow = 3,ncol = 6) + 
                        geom_smooth(color='black', method='lm')
                print(g)
        }else{
                g <- ggplot(tmp, aes(x=YearsToFollowUp,y=response_time,color=ParticipantType)) + 
                        geom_point() + 
                        geom_line(aes(group=pseudonym)) + 
                        facet_wrap(~trial_type+ParticipantType, nrow = 1,ncol = 6) + 
                        geom_smooth(color='black', method='lm')
                print(g)
        }
        
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        
        # Diagnostics
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit)) %>% print()

        # Hypothesis test
        tab_model(fit, title='Response times',digits=5, show.se = T)
        # print(s, corr = FALSE, digits = 3)
        anova <- Anova(fit,type=3)
        print(anova)
        eta_squared(fit, alternative = 'two.sided') %>% print()
    
    # # Post hoc test
    # em <- emtrends(fit, ~ ParticipantType*trial_type, 'YearsToFollowUp')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- ggplot(tmp.collapsed, aes(x=YearsToFollowUp,y=response_time,color=ParticipantType)) + 
    #     geom_point(alpha=0.75,shape=1) + 
    #     geom_line(aes(group=pseudonym),alpha=0.75) + 
    #     facet_wrap(~trial_type+ParticipantType, nrow = 1,ncol = 6) + 
    #     geom_smooth(color='black', method='lm')
    # print(g)
    # 
    # em <- emtrends(fit, ~ ParticipantType, 'YearsToFollowUp')
    # contrast(em, interaction = c('revpairwise'), adjust = 'mvt') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, ParticipantType, YearsToFollowUp) %>%
    #     summarise(response_time=mean(response_time)) %>%
    #     ggplot(., aes(x=YearsToFollowUp,y=response_time,color=ParticipantType)) + 
    #     geom_point(alpha=0.75,shape=1) + 
    #     geom_line(aes(group=pseudonym),alpha=0.75) + 
    #     facet_wrap(~ParticipantType, nrow = 1,ncol = 2) + 
    #     geom_smooth(color='black', method='lm')
    # print(g)
    # 
    # em <- emtrends(fit, ~ trial_type, 'YearsToFollowUp')
    # contrast(em, interaction = c('revpairwise'), adjust = 'mvt') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, trial_type, YearsToFollowUp) %>%
    #     summarise(response_time=mean(response_time)) %>%
    #     ggplot(., aes(x=YearsToFollowUp,y=response_time,color=trial_type)) + 
    #     geom_point(alpha=0.75,shape=1) + 
    #     geom_line(aes(group=pseudonym),alpha=0.75) + 
    #     facet_wrap(~trial_type, nrow = 1,ncol = 3) + 
    #     geom_smooth(color='black', method='lm')
    # print(g)
    # 
    # em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, ParticipantType, trial_type) %>%
    #     summarise(response_time=mean(response_time)) %>%
    #     ggplot(., aes(x=trial_type,y=response_time,color=ParticipantType)) + 
    #     geom_boxplot()
    # print(g)
    
        # Plot effects
        modplot <- predictorEffects(fit)
        # plot(modplot)
        
        # Three-way interaction
        em <- emmeans(fit, ~ trial_type*TimepointNr|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'),
                 adjust='mvt', type='response', by=NULL) %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'),
                 adjust='mvt', type='response') %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        contrast(em, interaction = c('revpairwise','identity','identity'),
                 adjust='mvt', type='response') %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
        ggemmeans(fit, terms=c('TimepointNr','trial_type','ParticipantType'),
                  back.transform = TRUE) %>% 
                plot(connect.lines=TRUE)
        
        g <- ggemmeans(fit, terms=c('TimepointNr','trial_type','ParticipantType'), back.transform = TRUE) %>% 
                plot(connect.lines=TRUE) +
                ggtitle('Comparison of response times') + 
                ylab('Response time (s)') + 
                xlab('Time') + 
                theme_bw() + 
                labs(color='Choices') +
                scale_color_viridis_d(option='mako', begin = .1, end = .6,
                                  direction = -1)
        
        # save_plot('M:/Visualization/R_LongitudinalComparisonFmri/RT_fmri-lmer_TypeXTimeXGroup.jpeg', g, dpi=300)
        
        # Two-way interactions
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt',
                 type='response', by=NULL) %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt',
                 type='response') %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        ggemmeans(fit, terms=c('trial_type','ParticipantType'), back.transform = TRUE) %>% 
                plot(connect.lines=TRUE)
        
        em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt',
                 type='response', by=NULL) %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt',
                 type='response') %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        ggemmeans(fit, terms=c('TimepointNr','ParticipantType'), back.transform = TRUE) %>% 
                plot(connect.lines=TRUE)
        
        em <- emmeans(fit, ~ trial_type|TimepointNr, type='response')
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', 
                 type='response', by=NULL) %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', 
                 type='response') %>% 
                kable(., 'pipe', digits = 3, padding=0) %>% print()
        ggemmeans(fit, terms=c('TimepointNr','trial_type'), back.transform = TRUE) %>% 
                plot(connect.lines=TRUE)
        
        # Main effects
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        ggemmeans(fit, terms=c('ParticipantType'), back.transform = TRUE) %>% 
                plot(connect.lines=TRUE)
        
        em <- emmeans(fit, revpairwise ~ TimepointNr, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        ggemmeans(fit, terms=c('TimepointNr'), back.transform = TRUE) %>% 
                plot(connect.lines=TRUE)
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        kable(em$emmeans,'pipe', digits = 3) %>% print()
        kable(em$contrasts,'pipe', digits = 3) %>% print()
        ggemmeans(fit, terms=c('trial_type'), back.transform = TRUE) %>% 
                plot(connect.lines=TRUE)
        
    # Visualization
    source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
    source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
    
    # Summary stats
    # emmip with plotit=FALSE gives a table of summarystats that is very handy
    # Some adjustments make it usable for the raincloudplot function below
    # emm.summary <- emmip(fit, ParticipantType ~ TimepointNr | trial_type, plotit = FALSE, type = 'response') %>%
    #         tibble() %>%
    #         rename(mean = yvar,
    #                se = SE) %>%
    #         select(-c(df, tvar, xvar)) %>%
    #         mutate(ci = se*1.96)
    # kable(emm.summary,'pipe', digits = 3) %>% print()
    
    # Plot
    N <- tmp  %>% 
        group_by(pseudonym, ParticipantType, TimepointNr) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        select(ParticipantType, TimepointNr) %>%
        table()
    
    g <- tmp.collapsed %>%
            mutate(trial_type=factor(trial_type,levels=c('NChoice1','NChoice2','NChoice3'), labels=c('One','Two','Three')),
                   ParticipantType=factor(ParticipantType,levels=c('HC_PIT','PD_POM'),labels=c('Control','Patient'))) %>%
            ggplot(aes(x=TimepointNr, y = response_time, color=trial_type)) +
            geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
            geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
            stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                         mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
            facet_grid(~ParticipantType) + 
            theme_bw() + 
            scale_x_discrete(labels=c('Baseline','Two years')) +
            scale_color_viridis_d(option='mako', begin = .1, end = .6,
                                  direction = -1) + 
            ggtitle('Group comparison of response times') +
            ylab('Response time (s)') + xlab('Time point') + 
            guides(color = guide_legend(title='Choices')) +
            ylim(0.3,1.75)
    y <- 1.7
    d = 0.09
    segmap <- data.frame(
            x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  0.80,  1.80,  1.80),
            xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  1.00,  1.20,  2.00,  2.20),
            y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3),
            yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3)
    )
    sigmap <- data.frame(
            x =     c(1.50,  0.90,  1.00,  1.90,  2.00),
            y =     c(y,     y-d*2, y-d*3, y-d*2, y-d*3),
            label = c('***', '***', '***', '***', '***')
    )
    annmap <- data.frame(
            x=c(1,2,1,2),
            y=c(0.3,0.3,0.3,0.3),
            label=c('N=60','N=54','N=339','N=281'),
            ParticipantType=c('Control','Control','Patient','Patient')
    )
    g <- g + 
            geom_segment(data=segmap,
                         mapping = aes(x=x,xend=xend,y=y,yend=yend),
                         inherit.aes = FALSE,
                         size = lsize) +
            geom_text(data=sigmap, 
                      mapping = aes(x=x,y=y,label=label),
                      inherit.aes = FALSE,
                      size = sigsize) +
            geom_text(data=annmap, 
                      mapping = aes(x=x,y=y,label=label),
                      inherit.aes = FALSE)
    
    print(g)
    # if(str_detect(f,'block')){
    #     save_plot('M:/Visualization/R_LongitudinalComparisonFmri/RT_fmri-lmer.png',
    #               g, dpi=300, device='png', base_width = 5)
    # }else{
    #     save_plot('M:/Visualization/R_LongitudinalComparisonFmri/RT_prac-lmer.png',
    #               g, dpi=300, device='png', base_width = 5)
    # }
    
    # y <- 1.75
    # d = 0.12
    # segmap <- data.frame(
    #         x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  0.80,  1.80,  1.80),
    #         xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  1.00,  1.20,  2.00,  2.20),
    #         y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3),
    #         yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3)
    # )
    # sigmap <- data.frame(
    #         x =     c(1.50,  0.90,  1.00,  1.90,  2.00),
    #         y =     c(y,     y-d*2, y-d*3, y-d*2, y-d*3),
    #         label = c('***', '***', '***', '***', '***')
    # )
    # plot <- plot + 
    #         geom_segment(data=segmap,
    #                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
    #                      inherit.aes = FALSE,
    #                      size = lsize) +
    #         geom_text(data=sigmap, 
    #                   mapping = aes(x=x,y=y,label=label),
    #                   inherit.aes = FALSE,
    #                   size = sigsize)
    # print(plot)
    # save_plot('M:/Visualization/R_BaselineComparisonFmri/RT_HCvsON.tiff',
    #   plot, dpi=300, device='tiff', base_width = 5)
    
}
```

## *fMRI

### *Group comparison

```{r rts-fMRI, echo=FALSE, warning=TRUE, message=TRUE}

f <- 'log(response_time) ~ 1 + ParticipantType*TimepointNr*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1+TimepointNr+trial_type+block|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- dfFMRI %>%
    select(pseudonym, TimepointNr, YearsToFollowUp, Age,
           ParticipantType, trial_type, Gender,NpsEducYears,RespHandIsDominant,
           block, response_time) %>%
    na.omit() %>%
        mutate(ParticipantType = factor(ParticipantType,levels=c('HC_PIT','PD_POM'),
                                        labels=c('Ctrl','PD')),
               TimepointNr = factor(TimepointNr,levels=c(0,2),
                                    labels=c('BA','2Y')),
               trial_type = case_when(trial_type == 'NChoice1' ~ 'Single',
                                      trial_type == 'NChoice2' ~ 'Multiple',
                                      trial_type == 'NChoice3' ~ 'Multiple'),
               trial_type = factor(trial_type,levels=c('Single','Multiple'),
                                   labels=c('Single','Multiple')),
               Age=scale(Age,scale=F),
               NpsEducYears = scale(NpsEducYears,scale=F))
tmp.collapsed <- tmp %>% 
    group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>%
    summarise(across(c(response_time,Age,YearsToFollowUp,NpsEducYears), ~ mean(.x, na.rm=TRUE))) %>%
    ungroup() %>%
    na.omit()
tmp.n <- tmp.collapsed %>%
    group_by(pseudonym, ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    ungroup() %>%
    select(ParticipantType,TimepointNr)
tmp.n %>% select(ParticipantType,TimepointNr) %>% table()

fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) 
tab_model(fit, digits=3, show.se=TRUE)
s <- summary(fit)
anova <- Anova(fit,type=3)
print(anova)
eta_squared(fit, alternative = 'two.sided') %>% print()

em <- emmeans(fit, ~ trial_type*TimepointNr|ParticipantType, type='response')
contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response')
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ trial_type|TimepointNr, type='response')
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ TimepointNr|trial_type, type='response')
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ ParticipantType, type='response')
contrast(em, interaction = c('revpairwise'))
em <- emmeans(fit, ~ TimepointNr, type='response')
contrast(em, interaction = c('revpairwise'))
em <- emmeans(fit, ~ trial_type, type='response')
contrast(em, interaction = c('revpairwise'))

g_ba <- tmp.collapsed %>%
        filter(TimepointNr=='BA') %>%
        ggplot(aes(x=ParticipantType, y = response_time, color=trial_type)) +
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
        theme_bw() + 
        scale_x_discrete(labels=c('Control','PD-ON')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('Response times during action selection') +
        ylab('Response time (s)') + xlab('Baseline') + 
        guides(color = guide_legend(title='Choice')) +
        ylim(0.45, 1.5) + 
        annotate(geom='text',label='N=60',x=1,y=0.45) +
        annotate(geom='text',label='N=342',x=2,y=0.45)
g_fu <- tmp.collapsed %>%
        filter(TimepointNr=='2Y') %>%
        ggplot(aes(x=ParticipantType, y = response_time, color=trial_type)) +
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
        theme_bw() + 
        scale_x_discrete(labels=c('Control','PD-ON')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('') +
        ylab('Response time (s)') + xlab('Follow-up') + 
        guides(color = guide_legend(title='Choice')) +
        ylim(0.45, 1.5) + 
        annotate(geom='text',label='N=54',x=1,y=0.45) +
        annotate(geom='text',label='N=296',x=2,y=0.45)
y <- 1.4
d = 0.1
segmap <- data.frame(
        x =    c(1.00, 0.80,  1.80),
        xend = c(2.00, 1.20,  2.20),
        y =    c(y, y-d,    y-d),
        yend = c(y, y-d,    y-d)
)
sigmap <- data.frame(
        x =     c(1.50, 1.00,  2.00),
        y =     c(y, y-d*1,     y-d*1),
        label = c('***', '***', '***')
)
g_ba <- g_ba + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
g_fu <- g_fu + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
g <- ggarrange(g_ba,g_fu)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_lmer_T0.png',
          g_ba, dpi=300, device='png', base_width = 3.5)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_lmer_T2.png',
          g_fu, dpi=300, device='png', base_width = 3.5)

```

### *Association with bradykinesia

```{r rts-vs-clin, echo=FALSE, warning=TRUE, message=TRUE}

##### Data preparation #####

dfFMRI.c <- dfFMRI %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym, ParticipantType, TimepointNr, trial_type, Age, Gender,YearsSinceDiag,NpsEducYears,RespHandIsDominant,
                 Up3BradySum_T0, Up3BradySum_T2, Up3BradySum_RawChange,
                 Up3BradySum.imp_T0, Up3BradySum.imp_T2, Up3BradySum.imp_RawChange) %>%
        summarise(response_time = mean(response_time)) %>%
        ungroup() %>%
        pivot_wider(id_cols = c('pseudonym','TimepointNr','ParticipantType','Age',
                                'Gender','YearsSinceDiag','NpsEducYears','RespHandIsDominant',
                                'Up3BradySum_T0','Up3BradySum_T2','Up3BradySum_RawChange',
                                'Up3BradySum.imp_T0','Up3BradySum.imp_T2','Up3BradySum.imp_RawChange'),
                    names_from = trial_type,
                    names_prefix = 'TT_',
                    values_from = response_time) %>%
        mutate(AS.3gt1 = TT_NChoice3-TT_NChoice1,
               AS.2gt1 = TT_NChoice2-TT_NChoice1,
               AS.23gt1 = round(((TT_NChoice2+TT_NChoice3)/2)-TT_NChoice1,digits = 5),
               AS.Mean = round((TT_NChoice3 + TT_NChoice2 + TT_NChoice1)/3,digits = 5)) %>%
        pivot_wider(id_cols = c('pseudonym','ParticipantType','Age','Gender','YearsSinceDiag','NpsEducYears','RespHandIsDominant',
                                'Up3BradySum_T0','Up3BradySum_T2','Up3BradySum_RawChange',
                                'Up3BradySum.imp_T0','Up3BradySum.imp_T2','Up3BradySum.imp_RawChange'),
                    names_from = TimepointNr,
                    names_sep = '.T',
                    values_from = c('TT_NChoice1','TT_NChoice2','TT_NChoice3','AS.3gt1','AS.2gt1','AS.23gt1','AS.Mean')) %>%
        mutate(AS.3gt1.Delta = AS.3gt1.T2 - AS.3gt1.T0,
               AS.2gt1.Delta = AS.2gt1.T2 - AS.2gt1.T0,
               AS.23gt1.Delta = AS.23gt1.T2 - AS.23gt1.T0,
               AS.Mean.Delta = AS.Mean.T2 - AS.Mean.T0,
               Age=scale(Age,scale=F),
               NpsEducYears = scale(NpsEducYears,scale=F),
               YearsSinceDiag=scale(YearsSinceDiag,scale=F),
               Up3BradySum.imp_RawChange = scale(Up3BradySum.imp_RawChange,scale=F,center=F))

##### Visualization #####

# gp <- dfFMRI.c %>% select(Up3BradySum_RawChange, AS.Mean.Delta, AS.2gt1.Delta, AS.3gt1.Delta) %>% 
#         na.omit() %>%
#         ggpairs(., lower = list(continuous = 'smooth'))
# print(gp)

##### Analysis #####
isna <- apply(dfFMRI.c, 2, is.na) %>% colSums()

cat(paste('\n ', 'Missing values\n', sep=''))
missing_perc <- round(isna/nrow(dfFMRI.c), digits = 3)*100
print(isna)

# Mean
m1 <- lm(AS.Mean.Delta ~ Up3BradySum.imp_RawChange + Up3BradySum.imp_T0 + AS.Mean.T0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m1, digits=5, show.se=TRUE)
s <- summary(m1)
print(s)
Anova(m1,type=3) %>% print()
g <- ggemmeans(m1, terms = 'Up3BradySum.imp_RawChange') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Between-session change') +
        xlab('Change in bradykinesia (ON)') + ylab('Change in mean response time (s)') + 
        geom_hline(yintercept = 0, color = 'darkgrey', lty = 2) + geom_vline(xintercept = 0, color = 'darkgrey', lty = 2) +
        annotate(geom='text',label=expression(italic('N')*'=283, '*italic('β')*'=2.9e-03, SE=1.3e-03, '*italic('P')*'=0.023'),x=-25,y=-0.55, hjust=0)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_bradyprog_meanRTchange.png',
                  g, dpi=300, device='png', base_width = 5)

# Multiple > Single
m4 <- lm(AS.23gt1.Delta ~ Up3BradySum.imp_RawChange + Up3BradySum.imp_T0 + AS.23gt1.T0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m4, digits=5, show.se=TRUE)
Anova(m4,type=3) %>% print()
g <- ggemmeans(m4, terms = 'Up3BradySum.imp_RawChange') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Clinical progression ~ Change in action selection (23-1)')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_bradyprog-3gt1change.png',
                  g, dpi=300, device='png', base_width = 5)

# Mean, baseline
m5 <- lm(log(AS.Mean.T0) ~ Up3BradySum.imp_T0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m5, digits=5, show.se=TRUE)
s <- summary(m5)
print(s)
Anova(m5,type=3) %>% print()
g <- ggemmeans(m5, terms = 'Up3BradySum.imp_T0') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Baseline') +
        xlab('Bradykinesia severity (ON)') + ylab('Mean response time (s)') + 
        annotate(geom='text',label=expression(italic('N')*'=341, '*italic('β')*'=3.6e-03, SE=1.0e-03, '*italic('P')*'=0.001'),x=0,y=0.3, hjust=0) + ylim(0.3,1.6)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_BA-mean.png',
                  g, dpi=300, device='png', base_width = 5)
#Mean, follow-up
m6 <- lm(log(AS.Mean.T2) ~ Up3BradySum.imp_T2 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m6, digits=5, show.se=TRUE)
Anova(m6,type=3) %>% print()
g <- ggemmeans(m6, terms = 'Up3BradySum.imp_T2') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Two-year follow-up') +
        xlab('Bradykinesia severity (ON)') + ylab('Mean response time (s)') + 
        annotate(geom='text',label=expression(italic('N')*'=292, '*italic('β')*'=5.5e-03, SE=1.4e-03, '*italic('P')*'<0.001'),x=0,y=0.3, hjust=0) + ylim(0.3,1.6)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_FU-mean.png',
                  g, dpi=300, device='png', base_width = 5)

# Multiple > Single, baseline
m11 <- lm(log(AS.23gt1.T0) ~ Up3BradySum.imp_T0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m11, digits=5, show.se=TRUE)
Anova(m11,type=3) %>% print()
g <- ggemmeans(m11, terms = 'Up3BradySum.imp_T0') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Baseline severity ~ 23 > 1')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_BA-32gt1.png',
                  g, dpi=300, device='png', base_width = 5)
# Multiple > Single, follow-up
m12 <- lm(log(AS.23gt1.T2) ~ Up3BradySum.imp_T2 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m12, digits=5, show.se=TRUE)
Anova(m12,type=3) %>% print()
g <- ggemmeans(m12, terms = 'Up3BradySum.imp_T2') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Follow-up severity ~ 23 > 1')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_FU-32gt1.png',
                  g, dpi=300, device='png', base_width = 5)

# N <- table(dfFMRI.cs$ParticipantType)
# print(N)
# g <- dfFMRI.cs %>%
#         select(pseudonym,AS.Mean.Delta,AS.2gt1.Delta,AS.3gt1.Delta,Up3BradySum_RawChange) %>%
#         pivot_longer(cols = c(AS.Mean.Delta,AS.2gt1.Delta,AS.3gt1.Delta),
#                      names_to = 'SummaryScore',
#                      values_to = 'response_time') %>%
#         mutate(SummaryScore=factor(SummaryScore,
#                                    levels=c('AS.Mean.Delta','AS.2gt1.Delta','AS.3gt1.Delta'),
#                                    labels=c('Mean*','2>1','3>1'))) %>%
#         ggplot(aes(x=Up3BradySum_RawChange,y=response_time,color=SummaryScore)) + 
#         geom_point() + 
#         geom_smooth(method=lm) + 
#         theme_bw() + 
#         ylab('Change in response time (s)') + xlab('Change in bradykinesia') + theme() + 
#         guides(color = guide_legend(title='Score')) +
#         scale_color_viridis_d(option='mako', begin = .1, end = .6,
#                                   direction = -1) +
#         annotate(geom='text', label='*N=237, β=2.8e-03, SE=1.4e-03, P=0.045', x=-20, y=-0.6, hjust=0) + 
#         ylim(-0.6,0.6)
# print(g)
# save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ResponseTimes/RT_ClinProgCorrPlot.png',
#                   g, dpi=300, device='png', base_width = 5)

```

### V2: Association with bradykinesia

```{r rts-vs-clin2, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

##### Data preparation #####

dfFMRI.c0 <- dfFMRI %>%
 filter(ParticipantType=='PD_POM') %>%
 mutate(Age=Age-mean(Age,na.rm=TRUE)) %>%
 isolate(d = .,
         by='pseudonym',
         value=c('Up3BradySum','response_time'),
         which='both')

dfFMRI.c <- dfFMRI %>%
 filter(ParticipantType=='PD_POM') %>%
 group_by(pseudonym, ParticipantType, TimepointNr, trial_type, Age, Gender, Up3BradySum, YearsSinceDiag) %>%
 summarise(response_time = mean(response_time)) %>%
 ungroup() %>%
 pivot_wider(id_cols = c('pseudonym','TimepointNr','ParticipantType','Age',
                         'Gender', 'YearsSinceDiag','Up3BradySum'),
             names_from = trial_type,
             names_prefix = 'TT_',
             values_from = response_time) %>%
 mutate(AS.3gt1 = TT_3choice-TT_1choice,
        AS.2gt1 = TT_2choice-TT_1choice,
        AS.23gt1 = round(((TT_2choice+TT_3choice)/2)-TT_1choice,digits = 5),
        AS.Mean = round((TT_3choice + TT_2choice + TT_1choice)/3,digits = 5)) %>%
 pivot_wider(id_cols = c('pseudonym','ParticipantType','Age','Gender', 'YearsSinceDiag'),
             names_from = TimepointNr,
             names_sep = '.T',
             values_from = c('Up3BradySum','TT_1choice','TT_2choice','TT_3choice','AS.3gt1','AS.2gt1','AS.23gt1','AS.Mean')) %>%
 na.omit() %>%
 pivot_longer(cols = c(starts_with('Up3'), starts_with('TT_'), starts_with('AS.')),
              names_to = c('.value','TimepointNr'),
              names_pattern = '(.*).(T.*)') %>%
 isolate(d = .,
         by = 'pseudonym',
         value = c('Up3BradySum', 'AS.3gt1', 'AS.2gt1', 'AS.23gt1', 'AS.Mean'),
         which = 'both')

##### Visualization #####

# gp <- dfFMRI.c %>% select(starts_with('Up3BradySum'),
#                           starts_with('AS.3gt1'),
#                           starts_with('AS.2gt1'),
#                           starts_with('AS.23gt1'),
#                           starts_with('AS.Mean')) %>% 
#         na.omit() %>%
#         ggpairs(., lower = list(continuous = 'smooth'))
# print(gp)

##### Analysis #####

# m0 will be the closest possible thing to the baseline correlation analysis
m0 <- lmer(log(response_time) ~ trial_type*Up3BradySum_cb*Up3BradySum_cw + block + Age + Gender + YearsSinceDiag + (1|pseudonym), 
           data = dfFMRI.c0,
           control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
Anova(m0,type=3) %>% print()
tab_model(m0, digits = 4)
ggemmeans(m0, terms=c('Up3BradySum_cw','trial_type', 'Up3BradySum_cb')) %>% plot
dfFMRI.c0.agg <- dfFMRI.c0 %>%
 group_by(pseudonym,TimepointNr,trial_type) %>%
 summarise(response_time_cb=mean(response_time_cb,na.rm=T),
           response_time_cw=mean(response_time_cw,na.rm=T),
           Up3BradySum_cb=mean(Up3BradySum_cb,na.rm=T),
           Up3BradySum_cw=mean(Up3BradySum_cw,na.rm=T)) %>%
        ungroup()
 
ggplot(dfFMRI.c0.agg, aes(x=response_time_cb,y=Up3BradySum_cb)) + 
 geom_point() +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 ylab('Overall MDS-UPDRS III: Bradykinesia') + xlab('Overall response time') + 
 facet_grid(~trial_type)
ggplot(dfFMRI.c0.agg, aes(x=response_time_cw,y=Up3BradySum_cw)) + 
 geom_point() + 
 geom_line(aes(group=pseudonym),alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 ylab('Change in bradykinesia') + xlab('Change in response time') + 
 facet_grid(~trial_type)

# The remaining models below test for effects on motor- and selection-related performance separately
up3.mean.tab <- dfFMRI.c %>% 
        group_by(TimepointNr) %>% 
        summarise(N=n(),AVG=mean(Up3BradySum_cb,na.rm=T),SD=sd(Up3BradySum_cb,na.rm=T)) %>%
        select(-TimepointNr) %>%
        colMeans()
dfFMRI.cs <- dfFMRI.c %>% 
        mutate(Gender=factor(Gender),
               Age=Age-mean(Age,na.rm=TRUE),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=TRUE),
               Up3BradySum_fct = 0,
               Up3BradySum_fct = if_else(Up3BradySum_cb > up3.mean.tab[2]+up3.mean.tab[3],1,Up3BradySum_fct),
               Up3BradySum_fct = if_else(Up3BradySum_cb < up3.mean.tab[2]-up3.mean.tab[3],-1,Up3BradySum_fct),
               Up3BradySum_fct=factor(Up3BradySum_fct))

m1 <- lmer(log(AS.Mean) ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m1,type=3) %>% print()
summary(m1) %>% print()
eta_squared(m1, alternative = 'two.sided')
ggemmeans(m1, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m1, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
ggemmeans(m1, terms = c('Up3BradySum_cw','Up3BradySum_cb')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(y=AS.Mean_cb,x=Up3BradySum_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Mean response time')
g2 <- ggplot(dfFMRI.cs, aes(y=AS.Mean_cw,x=Up3BradySum_cw,)) + 
 geom_point() + 
 geom_line(aes(group=pseudonym),alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Mean response time')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.Mean_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in response time')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/RT_clinprog-meanxbxw.png',
                  g, dpi=300, device='png', base_width = 5)

m2 <- lmer(AS.2gt1 ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m2,type=3) %>% print()
summary(m2) %>% print()
eta_squared(m2, alternative = 'two.sided')
ggemmeans(m2, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m2, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
ggemmeans(m2, terms = c('Up3BradySum_cw','Up3BradySum_cb')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cb,y=AS.2gt1_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Action selection (Two > One)')
g2 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cw,y=AS.2gt1_cw)) + 
 geom_point() +  
 geom_line(aes(group=pseudonym),alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Action selection (Two > One)')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.2gt1_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in response time')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/RT_clinprog-2gt1xbxw.png',
                  g, dpi=300, device='png', base_width = 5)

m3 <- lmer(AS.3gt1 ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m3,type=3) %>% print()
summary(m3) %>% print()
eta_squared(m3, alternative = 'two.sided')
ggemmeans(m3, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m3, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cb,y=AS.3gt1_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Action selection (Three > One)')
g2 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cw,y=AS.3gt1_cw)) + 
 geom_point() +  
 geom_line(aes(group=pseudonym),alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Action selection (Three > One)')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.3gt1_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in response time')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/RT_clinprog-3gt1xbxw.png',
                  g, dpi=300, device='png', base_width = 5)

m4 <- lmer(AS.23gt1 ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m4,type=3) %>% print()
summary(m4) %>% print()
eta_squared(m4, alternative = 'two.sided')
ggemmeans(m4, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m4, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cb,y=AS.23gt1_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Action selection (Two/Three > One)')
g2 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cw,y=AS.23gt1_cw)) + 
 geom_point() +  
 geom_line(aes(group=pseudonym),alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Action selection (Two/Three > One)')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.23gt1_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in response time')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/RT_clinprog-23gt1xbxw.png',
                  g, dpi=300, device='png', base_width = 5)

```

## Practice

Not evaluated.

```{r rts-Practice, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

f <- 'log(response_time) ~ 1 + ParticipantType*YearsToFollowUp*trial_type + scale(Age) + Gender + (1+YearsToFollowUp|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- dfPrac %>%
    select(pseudonym, TimepointNr, YearsToFollowUp, Age, Age_Dmean, ParticipantType, trial_type, Gender, response_time) %>%
    na.omit()
tmp.collapsed <- dfPrac %>% 
    group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>%
    summarise(across(c(response_time,Age,YearsToFollowUp), ~ mean(.x, na.rm=TRUE))) %>%
    ungroup() %>%
    na.omit()
# compare_rts(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```

# *Accuracy

## Function for comparing accuracy (deprecated?)

```{r func-compare_err, echo=FALSE, warning=TRUE, message=TRUE}
compare_correct <- function(f, tmp, tmp.collapsed){
    
    # Fit model
    print(paste('Fitting the following model:', f, sep=' '))
    fit <- glmer(f, data=tmp, family = binomial, weights = n_trials,
                 control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
    tab_model(fit, title='Error rates')
    # print(s, corr = FALSE)
    anova <- Anova(fit, type = 'III')
    print(anova)
    se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
    tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
    exp(tab) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    
    modplot <- predictorEffects(fit)
    # plot(modplot)
    
    em <- emmeans(fit, ~ trial_type*TimepointNr|ParticipantType, type='response')
    contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'), adjust='mvt', type='response') %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    contrast(em, interaction = c('revpairwise','identity','identity'), adjust='mvt', type='response') %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    ggemmeans(fit, terms=c('TimepointNr','trial_type','ParticipantType'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE) %>%
            save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Err_fmri-lmer_TypeXTimeXGroup.jpeg', ., dpi=300)
    
    g <- ggemmeans(fit, terms=c('TimepointNr','trial_type','ParticipantType'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE) +
            ggtitle('Comparison of error rates') + 
            ylab('Error rate (%)') + xlab('Time') + 
            theme_bw() + 
            labs(color='Choices')
    save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Err_fmri-lmer_TypeXTimeXGroup.jpeg', g, dpi=300)
    
    em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
    contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    ggemmeans(fit, terms=c('trial_type','ParticipantType'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE)
    
    em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response')
    contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    ggemmeans(fit, terms=c('TimepointNr','ParticipantType'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE)

    em <- emmeans(fit, ~ trial_type|TimepointNr, type='response')
    contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% 
            kable(., 'pipe', digits = 3, padding=0) %>% print()
    ggemmeans(fit, terms=c('TimepointNr','trial_type'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE)
    
    em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
    kable(em$emmeans,'pipe', digits = 3, padding=0) %>% print()
    kable(em$contrasts,'pipe', digits = 3, padding=0) %>% print()
    ggemmeans(fit, terms=c('ParticipantType'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE)
    
    em <- emmeans(fit, revpairwise ~ TimepointNr, type='response', adjust='mvt')
    kable(em$emmeans,'pipe', digits = 3, padding=0) %>% print()
    kable(em$contrasts,'pipe', digits = 3, padding=0) %>% print()
    ggemmeans(fit, terms=c('TimepointNr'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE)
    
    em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
    kable(em$emmeans,'pipe', digits = 3, padding=0) %>% print()
    kable(em$contrasts,'pipe', digits = 3, padding=0) %>% print()
    ggemmeans(fit, terms=c('trial_type'), back.transform = TRUE) %>% 
            plot(connect.lines=TRUE)
    
    # Post hoc test
    # em <- emtrends(fit, ~ ParticipantType*trial_type, 'YearsToFollowUp')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- ggplot(tmp.collapsed, aes(x=YearsToFollowUp,y=error_rate,color=ParticipantType)) + 
    #     geom_point(alpha=0.75,shape=1) + 
    #     geom_line(aes(group=pseudonym),alpha=0.75) + 
    #     facet_wrap(~trial_type+ParticipantType, nrow = 1, ncol=6) + 
    #     geom_smooth(color='black', method='lm')
    # print(g)
    # 
    # em <- emtrends(fit, ~ ParticipantType, 'YearsToFollowUp')
    # contrast(em, interaction = c('revpairwise'), adjust = 'mvt') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, ParticipantType, YearsToFollowUp) %>%
    #     summarise(error_rate=mean(error_rate)) %>%
    #     ggplot(., aes(x=YearsToFollowUp,y=error_rate,color=ParticipantType)) + 
    #     geom_point(alpha=0.75,shape=1) + 
    #     geom_line(aes(group=pseudonym),alpha=0.75) + 
    #     facet_wrap(~ParticipantType, nrow = 1,ncol = 2) + 
    #     geom_smooth(color='black', method='lm')
    # print(g)
    # 
    # em <- emtrends(fit, ~ trial_type, 'YearsToFollowUp')
    # contrast(em, interaction = c('revpairwise'), adjust = 'mvt') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, trial_type, YearsToFollowUp) %>%
    #     summarise(error_rate=mean(error_rate)) %>%
    #     ggplot(., aes(x=YearsToFollowUp,y=error_rate,color=trial_type)) + 
    #     geom_point(alpha=0.75,shape=1) + 
    #     geom_line(aes(group=pseudonym),alpha=0.75) + 
    #     facet_wrap(~trial_type, nrow = 1,ncol = 3) + 
    #     geom_smooth(color='black', method='lm')
    # print(g)
    # 
    # em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, ParticipantType, trial_type) %>%
    #     summarise(error_rate=mean(error_rate)) %>%
    #     ggplot(., aes(x=trial_type,y=error_rate,color=ParticipantType)) + 
    #     geom_boxplot()
    # print(g)
    # 
    # em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
    # kable(em$emmeans,'pipe', digits = 3) %>% print()
    # kable(em$contrasts,'pipe', digits = 3) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, ParticipantType) %>%
    #     summarise(error_rate=mean(error_rate)) %>%
    #     ggplot(., aes(x=ParticipantType,y=error_rate,color=ParticipantType)) + 
    #     geom_boxplot()
    # print(g)
    # 
    # em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
    # kable(em$emmeans,'pipe', digits = 3) %>% print()
    # kable(em$contrasts,'pipe', digits = 3) %>% print()
    # g <- tmp.collapsed %>%
    #     group_by(pseudonym, trial_type) %>%
    #     summarise(error_rate=mean(error_rate)) %>%
    #     ggplot(., aes(x=trial_type,y=error_rate,color=trial_type)) + 
    #     geom_boxplot()
    # print(g)
    
    N <- tmp  %>% 
        group_by(pseudonym, ParticipantType, TimepointNr) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        select(ParticipantType, TimepointNr) %>%
        table()
        
    g <- tmp.collapsed %>%
            mutate(trial_type=factor(trial_type,levels=c('1choice','2choice','3choice'), labels=c('One','Two','Three')),
                   ParticipantType=factor(ParticipantType,levels=c('HC_PIT','PD_POM'),labels=c('Control','Patient'))) %>%
            ggplot(aes(x=TimepointNr, y = error_rate, color=trial_type)) +
            geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
            geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
            stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                         mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
            facet_grid(~ParticipantType) + 
            theme_bw() + 
            scale_x_discrete(labels=c('Baseline','Two years')) +
            scale_color_viridis_d(option='mako', begin = .1, end = .6,
                                  direction = -1) + 
            ggtitle('Group comparison of error rates') +
            ylab('Error rate (%)') + xlab('Time point') + guides(color = guide_legend(title='Choices')) +
            ylim(0,100)
    y <- 95
    d = 6
    segmap <- data.frame(
            x =    c(1.00, 1.00,  2.00,  0.80,  1.80,
                     1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  1.00,  1.80,  2.00),
            xend = c(2.00, 1.00,  2.00,  1.20,  2.20,
                     2.00, 1.00,  2.00,  1.20,  2.20,  1.20,  1.20,  2.20,  2.20),
            y =    c(y,    y,     y,     y-d*1, y-d*1,
                     y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3),
            yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1,
                     y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3),
            ParticipantType = c('Control','Control','Control','Control','Control',
                                'Patient','Patient','Patient','Patient','Patient',
                                'Patient','Patient','Patient','Patient')
    )
    sigmap <- data.frame(
            x =     c(1.50,
                      1.50,  1.00,  1.10,  2.00,  2.10),
            y =     c(y,
                      y,     y-d*2, y-d*3, y-d*2, y-d*3),
            label = c('*',
                      '***', '***', '***', '***', '***'),
            ParticipantType = c('Control',
                                'Patient','Patient','Patient','Patient','Patient')
    )
    annmap <- data.frame(
            x=c(1,2,1,2),
            y=c(50,50,50,50),
            label=c('N=60','N=54','N=339','N=284'),
            ParticipantType=c('Control','Control','Patient','Patient')
    )
    g <- g + 
            geom_segment(data=segmap,
                         mapping = aes(x=x,xend=xend,y=y,yend=yend),
                         inherit.aes = FALSE,
                         size = lsize) +
            geom_text(data=sigmap, 
                      mapping = aes(x=x,y=y,label=label),
                      inherit.aes = FALSE,
                      size = sigsize) +
            geom_text(data=annmap, 
                      mapping = aes(x=x,y=y,label=label),
                      inherit.aes = FALSE)
    
    print(g)
    if(str_detect(f,'block')){
        save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Err_fmri-lmer.png',
                  g, dpi=300, device='png', base_width = 5)
    }else{
        save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Err_prac-lmer.png',
                  g, dpi=300, device='png', base_width = 5)
    }
    
    # em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # 
    # em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
    # 
    # em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # 
    # em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # emmip(fit, ParticipantType ~ TimepointNr, type='response', CIs=TRUE) %>% print()
    # 
    # em <- emmeans(fit, ~ trial_type|TimepointNr, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # 
    # em <- emmeans(fit, ~ trial_type|TimepointNr, type='response')
    # contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
    # emmip(fit, trial_type ~ TimepointNr, type='response', CIs=TRUE) %>% print()
    # 
    # em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
    # kable(em$emmeans,'pipe', digits = 3) %>% print()
    # kable(em$contrasts,'pipe', digits = 3) %>% print()
    # emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
    # 
    # em <- emmeans(fit, revpairwise ~ TimepointNr, type='response', adjust='mvt')
    # kable(em$emmeans,'pipe', digits = 3) %>% print()
    # kable(em$contrasts,'pipe', digits = 3) %>% print()
    # emmip(fit, ~ TimepointNr, type='response', CIs=TRUE) %>% print()
    # 
    # em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
    # kable(em$emmeans,'pipe', digits = 3) %>% print()
    # kable(em$contrasts,'pipe', digits = 3) %>% print()
    # emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
    
    # Visualization
    # source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
    # source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
    # N <- tmp  %>% 
    #         group_by(pseudonym, ParticipantType, TimepointNr) %>%
    #         summarise(across(everything(), ~first(.x))) %>%
    #         ungroup() %>%
    #         select(ParticipantType, TimepointNr) %>%
    #         table()
    # kable(N, 'pipe') %>% print()
    # plot <- raincloudplot_2Factor(data=tmp.collapsed, y='error_rate',
    #                       groupvar=c('trial_type','TimepointNr'),
    #                       title='Influence of Parkinson\'s \ndisease on error rates',
    #                       xlab='', ylab='Errors (%)',
    #                       xticklabs=c('Baseline','Two years'),
    #                       legend_title = '',
    #                       legend_labels = c('One','Two','Three'),
    #                       legend_position = legend_position,
    #                       provided_summary = 'None') +
    #         ylim(0,100) + 
    #         facet_grid(~ParticipantType)
    # y <- 70
    # d = 6
    # segmap <- data.frame(
    #         x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  1.80,  2.00),
    #         xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  2.20,  2.20),
    #         y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3),
    #         yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3)
    # )
    # sigmap <- data.frame(
    #         x =     c(1.50,  2.00,  2.10),
    #         y =     c(y,     y-d*2, y-d*3),
    #         label = c('**', '***', '***')
    # )
    # plot <- plot +
    #         geom_segment(data=segmap,
    #                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
    #                      inherit.aes = FALSE,
    #                      size = lsize) +
    #         geom_text(data=sigmap,
    #                   mapping = aes(x=x,y=y,label=label),
    #                   inherit.aes = FALSE,
    #                   size = sigsize)
    # print(plot)
    # save_plot('M:/Visualization/R_BaselineComparisonFmri/XXXXXXXAccuracy_HCvsON.tiff',
    #   plot, dpi=300, device='tiff', base_width = 5)
    
}
```

## fMRI

### *Group comparison

```{r err-fMRI, echo=FALSE, warning=TRUE, message=TRUE}

f <- 'error_rate ~ 1 + ParticipantType*TimepointNr*trial_type + block + Age + Gender + NpsEducYears + RespHandIsDominant + (1+TimepointNr+trial_type+block|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- dfFMRI %>%
    select(pseudonym, TimepointNr, YearsToFollowUp, Age,
           ParticipantType, trial_type, Gender,NpsEducYears,RespHandIsDominant,
           block, error_rate, n_trials) %>%
    na.omit() %>%
        mutate(ParticipantType = factor(ParticipantType,levels=c('HC_PIT','PD_POM'),
                                        labels=c('Ctrl','PD')),
               TimepointNr = factor(TimepointNr,levels=c(0,2),
                                    labels=c('BA','2Y')),
               trial_type = case_when(trial_type == 'NChoice1' ~ 'Single',
                                      trial_type == 'NChoice2' ~ 'Multiple',
                                      trial_type == 'NChoice3' ~ 'Multiple'),
               trial_type = factor(trial_type,levels=c('Single','Multiple'),
                                   labels=c('Single','Multiple')),
               Age=scale(Age,scale=F),
               NpsEducYears=scale(NpsEducYears,scale=F))
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>%
        summarise(across(c(error_rate,Age,YearsToFollowUp,NpsEducYears), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(error_rate = error_rate*100) %>%
    ungroup() %>%
    na.omit()
tmp.n <- tmp.collapsed %>%
    group_by(pseudonym, ParticipantType,TimepointNr) %>%
    summarise(across(everything(), ~first(.x))) %>%
    ungroup() %>%
    select(ParticipantType,TimepointNr)
tmp.n %>% select(ParticipantType,TimepointNr) %>% table()

fit <- glmer(f, data=tmp, family = binomial, weights = n_trials,
             control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
tab_model(fit, digits=5, show.se=TRUE)
s <- summary(fit)
anova <- Anova(fit,type=3)
print(anova)
# eta_squared(fit, alternative = 'two.sided') %>% print()

em <- emmeans(fit, ~ trial_type*TimepointNr|ParticipantType, type='response')
contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response')
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ trial_type|TimepointNr, type='response')
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()

em <- emmeans(fit, ~ ParticipantType, type='response')
contrast(em, interaction = c('revpairwise'))
em <- emmeans(fit, ~ TimepointNr, type='response')
contrast(em, interaction = c('revpairwise'))
em <- emmeans(fit, ~ trial_type, type='response')
contrast(em, interaction = c('revpairwise'))

# Plotting
g_ba <- tmp.collapsed %>%
        filter(TimepointNr=='BA') %>%
        ggplot(aes(x=ParticipantType, y = error_rate, color=trial_type)) +
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
        theme_bw() + 
        scale_x_discrete(labels=c('Control','PD-ON')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('Error rates during action selection') +
        ylab('Error rate (%)') + xlab('Baseline') + 
        guides(color = guide_legend(title='Choice')) +
        ylim(-5, 75) + 
        annotate(geom='text',label='N=60',x=1,y=-5) +
        annotate(geom='text',label='N=342',x=2,y=-5)
g_fu <- tmp.collapsed %>%
        filter(TimepointNr=='2Y') %>%
        ggplot(aes(x=ParticipantType, y = error_rate, color=trial_type)) +
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
        theme_bw() + 
        scale_x_discrete(labels=c('Control','PD-ON')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('') +
        ylab('Error rate (%)') + xlab('Follow-up') + 
        guides(color = guide_legend(title='Choice')) +
        ylim(-5, 75) + 
        annotate(geom='text',label='N=54',x=1,y=-5) +
        annotate(geom='text',label='N=296',x=2,y=-5)
y <- 70
d = 5
segmap <- data.frame(
        x =    c(1.00, 0.80,  1.80),
        xend = c(2.00, 1.20,  2.20),
        y =    c(y, y-d,    y-d),
        yend = c(y, y-d,    y-d)
)
sigmap <- data.frame(
        x =     c(1.50, 1.00,  2.00),
        y =     c(y+2, y-d*1,     y-d*1),
        label = c('+', '*', '**')
)
g_ba <- g_ba + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
g_fu <- g_fu + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
g <- ggarrange(g_ba,g_fu)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ERR_lmer_T0.png',
          g_ba, dpi=300, device='png', base_width = 3.5)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ERR_lmer_T2.png',
          g_fu, dpi=300, device='png', base_width = 3.5)

```

### *Association with bradykinesia

```{r err-vs-clin, echo=FALSE, warning=TRUE, message=TRUE}

##### Data preparation #####

dfFMRI.c <- dfFMRI %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym, ParticipantType, TimepointNr, trial_type, Age, Gender,
                 YearsSinceDiag,NpsEducYears,RespHandIsDominant, 
                 Up3BradySum_T0, Up3BradySum_T2, Up3BradySum_RawChange,
                 Up3BradySum.imp_T0, Up3BradySum.imp_T2, Up3BradySum.imp_RawChange) %>%
        summarise(error_rate = mean(error_rate)) %>%
        ungroup() %>%
        pivot_wider(id_cols = c('pseudonym','TimepointNr','ParticipantType','Age',
                                'Gender','YearsSinceDiag','NpsEducYears','RespHandIsDominant',
                                'Up3BradySum_T0','Up3BradySum_T2','Up3BradySum_RawChange',
                                'Up3BradySum.imp_T0','Up3BradySum.imp_T2','Up3BradySum.imp_RawChange'),
                    names_from = trial_type,
                    names_prefix = 'TT_',
                    values_from = error_rate) %>%
        mutate(AS.3gt1 = TT_NChoice3-TT_NChoice1,
               AS.2gt1 = TT_NChoice2-TT_NChoice1,
               AS.23gt1 = round(((TT_NChoice2+TT_NChoice3)/2)-TT_NChoice1,digits = 5),
               AS.Mean = round((TT_NChoice3 + TT_NChoice2 + TT_NChoice1)/3,digits = 5)) %>%
        pivot_wider(id_cols = c('pseudonym','ParticipantType','Age','Gender','YearsSinceDiag',
                                'NpsEducYears','RespHandIsDominant',
                                'Up3BradySum_T0','Up3BradySum_T2','Up3BradySum_RawChange',
                                'Up3BradySum.imp_T0','Up3BradySum.imp_T2','Up3BradySum.imp_RawChange'),
                    names_from = TimepointNr,
                    names_sep = '.T',
                    values_from = c('TT_NChoice1','TT_NChoice2','TT_NChoice3','AS.3gt1','AS.2gt1','AS.23gt1','AS.Mean')) %>%
        mutate(AS.3gt1.Delta = AS.3gt1.T2 - AS.3gt1.T0,
               AS.2gt1.Delta = AS.2gt1.T2 - AS.2gt1.T0,
               AS.23gt1.Delta = AS.23gt1.T2 - AS.23gt1.T0,
               AS.Mean.Delta = AS.Mean.T2 - AS.Mean.T0,
               Age=scale(Age,scale=F),
               NpsEducYears = scale(NpsEducYears,scale=F),
               YearsSinceDiag=scale(YearsSinceDiag,scale=F),
               Up3BradySum.imp_RawChange = scale(Up3BradySum.imp_RawChange,scale=F),
               Up3BradySum.imp_T0 = scale(Up3BradySum.imp_T0,scale=F),
               Up3BradySum.imp_T2 = scale(Up3BradySum.imp_T2,scale=F))

##### Visualization #####

# gp <- dfFMRI.c %>% select(Up3BradySum_RawChange, AS.Mean.Delta, AS.2gt1.Delta, AS.3gt1.Delta) %>% 
#         na.omit() %>%
#         ggpairs(., lower = list(continuous = 'smooth'))
# print(gp)

##### Analysis #####
isna <- apply(dfFMRI.c, 2, is.na) %>% colSums()

cat(paste('\n ', 'Missing values\n', sep=''))
missing_perc <- round(isna/nrow(dfFMRI.c), digits = 3)*100
print(isna)

# Mean, delta
m1 <- lm(AS.Mean.Delta ~ Up3BradySum.imp_RawChange + Up3BradySum.imp_T0 + AS.Mean.T0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m1, digits=5, show.se=TRUE)
Anova(m1,type=3) %>% print()
g <- ggemmeans(m1, terms = 'Up3BradySum.imp_RawChange') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('') +
        xlab('Change in bradykinesia') + ylab('Change in mean error rate')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ER_clinprog-meanchange.png',
                  g, dpi=300, device='png', base_width = 5)

# Selection, delta
m4 <- lm(AS.23gt1.Delta ~ Up3BradySum.imp_RawChange + Up3BradySum.imp_T0 + AS.23gt1.T0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data = dfFMRI.c)
tab_model(m4, digits=5, show.se=TRUE)
Anova(m4,type=3) %>% print()
g <- ggemmeans(m4, terms = 'Up3BradySum.imp_RawChange') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Clinical progression ~ Change in action selection (23-1)')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ER_clinprog-23gt1.png',
                  g, dpi=300, device='png', base_width = 5)

# Mean, bsaline
m5 <- lm(AS.Mean.T0 ~ Up3BradySum.imp_T0 + Age + Gender + YearsSinceDiag, data = dfFMRI.c)
tab_model(m5, digits=5, show.se=TRUE)
Anova(m5,type=3) %>% print()
g <- ggemmeans(m5, terms = 'Up3BradySum.imp_T0') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Baseline severity ~ Mean error rate')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ER_BA-mean.png',
                  g, dpi=300, device='png', base_width = 5)

# Mean, follow-up
m6 <- lm(AS.Mean.T2 ~ Up3BradySum.imp_T2 + Age + Gender + YearsSinceDiag, data = dfFMRI.c)
tab_model(m6, digits=5, show.se=TRUE)
Anova(m6,type=3) %>% print()
g <- ggemmeans(m6, terms = 'Up3BradySum.imp_T2') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Follow-up severity ~ Mean error rate')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ER_FU-mean.png',
                  g, dpi=300, device='png', base_width = 5)

# Selection, baseline
m7 <- lm(AS.23gt1.T0 ~ Up3BradySum.imp_T0 + Age + Gender + YearsSinceDiag, data = dfFMRI.c)
tab_model(m7, digits=5, show.se=TRUE)
Anova(m7,type=3) %>% print()
g <- ggemmeans(m7, terms = 'Up3BradySum.imp_T0') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Baseline severity ~ 23 > 1')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ER_BA-23gt1.png',
                  g, dpi=300, device='png', base_width = 5)

# Selection, follow-up
m8 <- lm(AS.23gt1.T2 ~ Up3BradySum.imp_T2 + Age + Gender + YearsSinceDiag, data = dfFMRI.c)
tab_model(m8, digits=5, show.se=TRUE)
Anova(m8,type=3) %>% print()
g <- ggemmeans(m8, terms = 'Up3BradySum.imp_T2') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + ggtitle('Follow-up severity ~ 23 > 1')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ER_FU-23gt1.png',
                  g, dpi=300, device='png', base_width = 5)

# N <- table(dfFMRI.cs$ParticipantType)
# print(N)
# g <- dfFMRI.cs %>%
#         select(pseudonym,AS.Mean.Delta,AS.2gt1.Delta,AS.3gt1.Delta,Up3BradySum_RawChange) %>%
#         pivot_longer(cols = c(AS.Mean.Delta,AS.2gt1.Delta,AS.3gt1.Delta),
#                      names_to = 'SummaryScore',
#                      values_to = 'error_rate') %>%
#         mutate(SummaryScore=factor(SummaryScore,
#                                    levels=c('AS.Mean.Delta','AS.2gt1.Delta','AS.3gt1.Delta'),
#                                    labels=c('Mean','2>1','3>1'))) %>%
#         ggplot(aes(x=Up3BradySum_RawChange,y=error_rate,color=SummaryScore)) + 
#         geom_point() + 
#         geom_smooth(method=lm) + 
#         theme_bw() + 
#         ylab('Change in error rate (%)') + xlab('Change in bradykinesia') + theme() + 
#         guides(color = guide_legend(title='Score')) +
#         scale_color_viridis_d(option='mako', begin = .1, end = .6,
#                                   direction = -1) +
#         annotate(geom='text', label='*N=239, all P>0.1', x=-20, y=-0.6, hjust=0) + 
#         ylim(-0.6,1.1)
#         
# print(g)
# save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Accuracy/ER_ClinProgCorrPlot.png',
#                   g, dpi=300, device='png', base_width = 5)

```

### V2: Association with bradykinesia

```{r err-vs-clin2, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

##### Data preparation #####

dfFMRI.c0 <- dfFMRI %>%
 filter(ParticipantType=='PD_POM') %>%
 mutate(Age=Age-mean(Age,na.rm=TRUE)) %>%
 isolate(d = .,
         by='pseudonym',
         value=c('Up3BradySum','error_rate'),
         which='both') %>%
        na.omit()

dfFMRI.c <- dfFMRI %>%
 filter(ParticipantType=='PD_POM') %>%
 group_by(pseudonym, ParticipantType, TimepointNr, trial_type, Age, Gender, YearsSinceDiag, Up3BradySum) %>%
 summarise(error_rate = mean(error_rate)) %>%
 ungroup() %>%
 pivot_wider(id_cols = c('pseudonym','TimepointNr','ParticipantType','Age',
                         'YearsSinceDiag', 'Gender','Up3BradySum'),
             names_from = trial_type,
             names_prefix = 'TT_',
             values_from = error_rate) %>%
 mutate(AS.3gt1 = TT_3choice-TT_1choice,
        AS.2gt1 = TT_2choice-TT_1choice,
        AS.23gt1 = round(((TT_2choice+TT_3choice)/2)-TT_1choice,digits = 5),
        AS.Mean = round((TT_3choice + TT_2choice + TT_1choice)/3,digits = 5)) %>%
 pivot_wider(id_cols = c('pseudonym','ParticipantType','Age','Gender','YearsSinceDiag'),
             names_from = TimepointNr,
             names_sep = '.T',
             values_from = c('Up3BradySum','TT_1choice','TT_2choice','TT_3choice','AS.3gt1','AS.2gt1','AS.23gt1','AS.Mean')) %>%
 na.omit() %>%
 pivot_longer(cols = c(starts_with('Up3'), starts_with('TT_'), starts_with('AS.')),
              names_to = c('.value','TimepointNr'),
              names_pattern = '(.*).(T.*)') %>%
 isolate(d = .,
         by = 'pseudonym',
         value = c('Up3BradySum', 'AS.3gt1', 'AS.2gt1', 'AS.23gt1', 'AS.Mean'),
         which = 'both')

##### Visualization #####

# gp <- dfFMRI.c %>% select(starts_with('Up3BradySum'),
#                           starts_with('AS.3gt1'),
#                           starts_with('AS.2gt1'),
#                           starts_with('AS.23gt1'),
#                           starts_with('AS.Mean')) %>% 
#         na.omit() %>%
#         ggpairs(., lower = list(continuous = 'smooth'))
# print(gp)

##### Analysis #####

# m0 will be the closest possible thing to the baseline correlation analysis
m0 <- glmer(error_rate ~ trial_type*Up3BradySum_cb*Up3BradySum_cw + block + Age + Gender + YearsSinceDiag + (1|pseudonym), 
            data = dfFMRI.c0, family = binomial, weights = n_trials,
            control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
Anova(m0,type=3)
tab_model(m0, digits = 4)
ggemmeans(m0, terms=c('Up3BradySum_cw [all]','trial_type', 'Up3BradySum_cb')) %>% plot
dfFMRI.c0.agg <- dfFMRI.c0 %>%
 group_by(pseudonym,TimepointNr,trial_type) %>%
 summarise(error_rate_cb=mean(error_rate_cb,na.rm=T),
           error_rate_cw=mean(error_rate_cw,na.rm=T),
           Up3BradySum_cb=mean(Up3BradySum_cb,na.rm=T),
           Up3BradySum_cw=mean(Up3BradySum_cw,na.rm=T))
 
ggplot(dfFMRI.c0.agg, aes(y=error_rate_cb,x=Up3BradySum_cb)) + 
 geom_point() +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 xlab('Overall MDS-UPDRS III: Bradykinesia') + ylab('Overall error rate') + 
 facet_grid(~trial_type)
ggplot(dfFMRI.c0.agg, aes(y=error_rate_cw,x=Up3BradySum_cw)) + 
 geom_point() + 
 geom_line(aes(group=pseudonym),alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 xlab('Change in bradykinesia') + ylab('Change in error rate') + 
 facet_grid(~trial_type)

# The remaining models below test for effects on motor- and selection-related performance separately

up3.mean.tab <- dfFMRI.c %>% 
        group_by(TimepointNr) %>% 
        summarise(N=n(),AVG=mean(Up3BradySum_cb,na.rm=T),SD=sd(Up3BradySum_cb,na.rm=T)) %>%
        select(-TimepointNr) %>%
        colMeans()
dfFMRI.cs <- dfFMRI.c %>% 
        mutate(Gender=factor(Gender),
               Age=Age-mean(Age,na.rm=TRUE),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=TRUE),
               Up3BradySum_fct = 0,
               Up3BradySum_fct = if_else(Up3BradySum_cb > up3.mean.tab[2]+up3.mean.tab[3],1,Up3BradySum_fct),
               Up3BradySum_fct = if_else(Up3BradySum_cb < up3.mean.tab[2]-up3.mean.tab[3],-1,Up3BradySum_fct),
               Up3BradySum_fct=factor(Up3BradySum_fct))

m1 <- lmer(AS.Mean ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m1,type=3) %>% print()
summary(m1) %>% print()
eta_squared(m1, alternative = 'two.sided')
ggemmeans(m1, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m1, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
ggemmeans(m1, terms = c('Up3BradySum_cw','Up3BradySum_cb')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cb,y=AS.Mean_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Mean error rate')
g2 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cw,y=AS.Mean_cw)) + 
 geom_point() + 
 geom_line(aes(group=pseudonym), alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Mean error rate')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.Mean_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in error rate')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ER_clinprog-meanxbxw.png',
                  g, dpi=300, device='png', base_width = 5)

m2 <- lmer(AS.2gt1 ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m2,type=3) %>% print()
summary(m2) %>% print()
eta_squared(m2, alternative = 'two.sided')
ggemmeans(m2, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m2, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
ggemmeans(m2, terms = c('Up3BradySum_cw','Up3BradySum_cb')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cb,y=AS.2gt1_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Action selection (Two > One)')
g2 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cw,y=AS.2gt1_cw)) + 
 geom_point() + 
 geom_line(aes(group=pseudonym), alpha=0.3) + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Action selection (Two > One)')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.2gt1_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in error rate')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ER_clinprog-2gt1xbxw.png',
                  g, dpi=300, device='png', base_width = 5)

m3 <- lmer(AS.3gt1 ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m3,type=3) %>% print()
summary(m3) %>% print()
eta_squared(m3, alternative = 'two.sided')
ggemmeans(m3, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m3, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
ggemmeans(m3, terms = c('Up3BradySum_cw','Up3BradySum_cb')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cb,y=AS.3gt1_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Action selection (Three > One)')
g2 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cw,y=AS.3gt1_cw)) + 
 geom_point() + 
 geom_line(aes(group=pseudonym), alpha=0.3) + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Action selection (Three > One)')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.3gt1_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in error rate')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ER_clinprog-3gt1xbxw.png',
                  g, dpi=300, device='png', base_width = 5)

m4 <- lmer(AS.23gt1 ~ Up3BradySum_cb*Up3BradySum_cw + Age + Gender + YearsSinceDiag + (1|pseudonym), data = dfFMRI.cs)
Anova(m4,type=3) %>% print()
summary(m4) %>% print()
eta_squared(m4, alternative = 'two.sided')
ggemmeans(m4, terms = c('Up3BradySum_cb')) %>% plot(add.data=T)
ggemmeans(m4, terms = c('Up3BradySum_cw')) %>% plot(add.data=T)
ggemmeans(m4, terms = c('Up3BradySum_cw','Up3BradySum_cb')) %>% plot(add.data=T)
g1 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cb,y=AS.23gt1_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Action selection (Two/Three > One)')
g2 <- ggplot(dfFMRI.cs, aes(x=Up3BradySum_cw,y=AS.23gt1_cw)) + 
 geom_point() + 
 geom_line(aes(group=pseudonym), alpha=0.3) + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 ylab('MDS-UPDRS III: Bradykinesia') + xlab('Action selection (Two/Three > One)')
g3 <- ggplot(dfFMRI.cs, aes(y=AS.23gt1_cw,x=Up3BradySum_cw)) +
        geom_point() +
        geom_line(aes(group=pseudonym)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~Up3BradySum_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in error rate')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ER_clinprog-23gt1xbxw.png',
                  g, dpi=300, device='png', base_width = 5)

```

## Practice

Not evaluated.

```{r err-Prac, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

f <- 'error_rate ~ 1 + ParticipantType*YearsToFollowUp*trial_type + scale(Age.ba) + Gender + (1+YearsToFollowUp|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- dfPrac %>%
    select(pseudonym, TimepointNr, YearsToFollowUp, Age, Age_Dmean, Age.ba, ParticipantType, trial_type, Gender, error_rate, n_trials) %>%
    na.omit()
# Collapse across blocks for visualization purposes
tmp.collapsed <- dfPrac %>% 
    group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>%
    summarise(across(c(error_rate,Age,YearsToFollowUp), ~ mean(.x, na.rm=TRUE))) %>%
    ungroup() %>%
    mutate(error_rate = error_rate*100) %>%
    na.omit()
compare_correct(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

# *Post hoc analyses

## Speed-accuracy trade-off 

```{r SAT, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

dfSAT <- dfTask %>%
        group_by(pseudonym, ParticipantType, TimepointNr) %>%
        summarise(RT=median(response_time),
                  ERR=mean(error_rate)*100) %>%
        ungroup()

# ggplot(test, aes(x=RT,y=ERR,color=TimepointNr)) + 
#         geom_point() +
#         geom_smooth(method='loess', se = FALSE) + 
#         facet_grid(~ParticipantType)

# Show relationship between error rates and response times
# Is there a speed accuracy trade-off?
# https://rpubs.com/ablonder/198840
rt_range <- 2
n_bins <- 20
break_seq <- seq(0, rt_range, rt_range/n_bins)

timeslice_range <- dfSAT %>%
        na.omit() %>%
        mutate(RT_bin = cut(RT, breaks = break_seq)) %>%
        group_by(RT_bin, ParticipantType, TimepointNr) %>%
        mutate(RT_bin_avg = mean(RT))

count_range <- timeslice_range %>%
        group_by(RT_bin, ParticipantType, TimepointNr) %>%
        summarise(subjcount = n_distinct(pseudonym), totalcount = n())

timeslice_range <- timeslice_range %>%
        group_by(RT_bin_avg, ParticipantType, TimepointNr, pseudonym) %>% 
        summarise(ss_acc = mean(ERR)) %>% 
        group_by(RT_bin_avg, ParticipantType, TimepointNr) %>%
        summarise(mean = mean(ss_acc),
                  n = n())

g <- ggplot(timeslice_range, aes(x=RT_bin_avg, y=mean, weight=n, 
                                 color = TimepointNr, group = TimepointNr)) + 
        geom_point(aes(size = n)) +
        geom_smooth(method = "lm", formula = y ~ poly(x,2), se = FALSE) +
        scale_color_grey() +
        geom_hline(yintercept = 0, lty = "dashed") +
        ggtitle('Error rates as a function of RTs') +
        xlab("Average RT (s)") +
        ylab("Error rate (%)") +
        facet_grid(~ParticipantType)

print(g)

# Baseline
dfSAT_BA <- dfSAT %>%
        filter(TimepointNr==0)
ct_BA <- cor.test(dfSAT_BA$RT, dfSAT_BA$ERR, alternative = c('two.sided'), 
               method = c('spearman'), exact = FALSE)
print(ct_BA)
g <- ggplot(dfSAT_BA, aes(x=RT,y=ERR)) + 
        geom_point() + 
        geom_smooth(method='lm')
print(g)

# Follow-up
dfSAT_FU <- dfSAT %>%
        filter(TimepointNr==2)
ct_FU <- cor.test(dfSAT_FU$RT, dfSAT_FU$ERR, alternative = c('two.sided'), 
               method = c('spearman'), exact = FALSE)
print(ct_FU)
g <- ggplot(dfSAT_FU, aes(x=RT,y=ERR)) + 
        geom_point() + 
        geom_smooth(method='lm')
print(g)

# Comparison of correlation coefs
cocor <- cocor.indep.groups(r1.jk = ct_BA$estimate,
                   r2.hm = ct_FU$estimate,
                   n1 = nrow(dfSAT_BA),
                   n2 = nrow(dfSAT_FU),
                   alternative = 'two.sided')

print(cocor)






dfFMRI.c <- dfFMRI %>%
        filter(ParticipantType!='PD_PIT') %>%
        group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>%
        summarise(response_time=mean(response_time),
                  error_rate = mean(error_rate)) %>%
        ungroup() %>%
        pivot_wider(id_cols = c('pseudonym','TimepointNr','ParticipantType'),
                    names_from = trial_type,
                    values_from = c(response_time, error_rate)) %>%
        mutate(RT.3gt1 = response_time_3choice-response_time_1choice,
               RT.2gt1 = response_time_2choice-response_time_1choice,
               RT.23gt1 = round(((response_time_2choice+response_time_3choice)/2)-response_time_1choice,digits = 5),
               RT.Mean = round((response_time_3choice + response_time_2choice + response_time_1choice)/3,digits = 5),
               ER.3gt1 = error_rate_3choice-error_rate_1choice,
               ER.2gt1 = error_rate_2choice-error_rate_1choice,
               ER.23gt1 = round(((error_rate_2choice+error_rate_3choice)/2)-error_rate_1choice,digits = 5),
               ER.Mean = round((error_rate_3choice + error_rate_2choice + error_rate_1choice)/3,digits = 5))

rmc <- rmcorr(pseudonym,
              RT.Mean,
              ER.Mean,
              dfFMRI.c)
print(rmc)
plot(rmc, overall = T)

rmc <- rmcorr(pseudonym,
              RT.23gt1,
              ER.23gt1,
              dfFMRI.c)
print(rmc)
plot(rmc, overall = T)


```

## *Missed responses

```{r miss, echo=FALSE, warning=TRUE, message=TRUE}

tmp <- dfFMRI %>%
        group_by(pseudonym,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  total_misses_by_time=first(total_misses_by_time),
                  Up3BradySum=first(Up3BradySum),
                  Age=first(Age),
                  Gender=first(Gender),
                  YearsSinceDiag=first(YearsSinceDiag),
                  NpsEducYears=first(NpsEducYears),
                  RespHandIsDominant=first(RespHandIsDominant)) %>%
        ungroup() %>%
        mutate(ParticipantType=factor(ParticipantType),
               TimepointNr=factor(TimepointNr),
               Age=Age-mean(Age,na.rm=T),
               Gender=factor(Gender),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               RespHandIsDominant=factor(RespHandIsDominant))

# Group comparison
f <- 'total_misses_by_time ~ ParticipantType*TimepointNr + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym)'
m <- glmer(f, data = tmp, family = 'poisson', control=glmerControl(optimizer = 'bobyqa'))
tab_model(m, title='Number of missed responses')
Anova(m,type=3) %>% print()
effectsize(m)
em <- emmeans(m, ~ TimepointNr|ParticipantType, type='response')
contrast(em, interaction=c('revpairwise','revpairwise'), adjust = 'mvt', by=NULL)
contrast(em, interaction=c('revpairwise','revpairwise'), adjust = 'mvt')
modplot <- predictorEffects(m)
plot(modplot)

# Clinical correlations
m.lm <- tmp %>%
 filter(ParticipantType=='PD_POM') %>%
 pivot_wider(id_cols = c('pseudonym','Age','Gender','YearsSinceDiag',
                         'NpsEducYears','RespHandIsDominant'),
             names_from = TimepointNr,
             names_prefix = 'TT_',
             values_from = c(total_misses_by_time,Up3BradySum)) %>%
 mutate(total_misses_by_time_Delta = total_misses_by_time_TT_2 - total_misses_by_time_TT_0,
        Up3BradySum_Delta = Up3BradySum_TT_2 - Up3BradySum_TT_0,
        Up3BradySum_Delta = Up3BradySum_Delta-mean(Up3BradySum_Delta,na.rm=T),
        Up3BradySum_TT_0 = Up3BradySum_TT_0-mean(Up3BradySum_TT_0,na.rm=T),
        total_misses_by_time_TT_0=total_misses_by_time_TT_0-mean(total_misses_by_time_TT_0,na.rm=T)) %>%
 na.omit() %>%
 lm(total_misses_by_time_Delta ~ Up3BradySum_Delta + total_misses_by_time_TT_0 + Up3BradySum_TT_0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data=.)
tab_model(m.lm, digits = 5, show.se = TRUE)
Anova(m.lm,type = 3) %>% print()

# Plotting
g <- tmp %>%
        mutate(ParticipantType=factor(ParticipantType,levels=c('HC_PIT','PD_POM'),labels=c('Control','Patient'))) %>%
        ggplot(aes(x=TimepointNr, y = total_misses_by_time, color = ParticipantType)) +
        geom_jitter(alpha=0.2, width=0.1) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5) +
        facet_grid(~ParticipantType) + 
        theme_bw() + 
        scale_x_discrete(labels=c('Baseline','Two years')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) +
        guides(color = guide_legend(title='Group')) +
        ggtitle('Group comparison of miss rates') +
        ylab('Number of misses') + xlab('Time point') +
        ylim(-1,60)
# y <- 55
# d = 3
# segmap <- data.frame(
#         x =    c(1.00, 1.00,  2.00,  0.80,  1.80),
#         xend = c(2.00, 1.00,  2.00,  1.20,  2.20),
#         y =    c(y,    y,     y,     y-d*1, y-d*1),
#         yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1)
# )
# sigmap <- data.frame(
#         x =     c(1.50),
#         y =     c(y),
#         label = c('***')
# )
# g <- g + 
#         geom_segment(data=segmap,
#                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
#                      inherit.aes = FALSE,
#                      size = lsize) +
#         geom_text(data=sigmap, 
#                   mapping = aes(x=x,y=y,label=label),
#                   inherit.aes = FALSE,
#                   size = sigsize)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Misc/Miss_lmer.png',
          g, dpi=300, device='png', base_width = 5)

```

## *Button selection variability

```{r CoV, echo=FALSE, warning=TRUE, message=TRUE}

tmp <- dfFMRI %>%
        group_by(pseudonym,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  Button.Press.CoV=first(Button.Press.CoV),
                  Up3BradySum=first(Up3BradySum),
                  Age=first(Age),
                  Gender=first(Gender),
                  YearsSinceDiag=first(YearsSinceDiag),
                  NpsEducYears=first(NpsEducYears),
                  RespHandIsDominant=first(RespHandIsDominant)) %>%
        ungroup() %>%
        mutate(ParticipantType=factor(ParticipantType),
               TimepointNr=factor(TimepointNr),
               Age=Age-mean(Age,na.rm=T),
               Gender=factor(Gender),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               RespHandIsDominant=factor(RespHandIsDominant)) %>%
        filter(Button.Press.CoV>0.001)

# Group comparison
m.lmer <- tmp %>%
        lmer(log(Button.Press.CoV) ~ ParticipantType*TimepointNr + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym), data=.)
tab_model(m.lmer, title='Coefficient of variation')
Anova(m.lmer, type=3) %>% print()
eta_squared(m.lmer) %>% print()
ems <- emmeans(m.lmer, revpairwise ~ ParticipantType, type = 'response')
summary(ems) %>% print()

# Clinical correlations
m.lm <- tmp %>%
 filter(ParticipantType=='PD_POM') %>%
 pivot_wider(id_cols = c('pseudonym','Age','Gender','YearsSinceDiag',
                         'NpsEducYears','RespHandIsDominant'),
             names_from = TimepointNr,
             names_prefix = 'TT_',
             values_from = c(Button.Press.CoV,Up3BradySum)) %>%
 mutate(Button.Press.CoV_Delta = Button.Press.CoV_TT_2 - Button.Press.CoV_TT_0,
        Up3BradySum_Delta = Up3BradySum_TT_2 - Up3BradySum_TT_0,
        Up3BradySum_Delta = Up3BradySum_Delta-mean(Up3BradySum_Delta,na.rm=T),
        Up3BradySum_TT_0 = Up3BradySum_TT_0-mean(Up3BradySum_TT_0,na.rm=T),
        Button.Press.CoV_TT_0=Button.Press.CoV_TT_0-mean(Button.Press.CoV_TT_0,na.rm=T)) %>%
 na.omit() %>%
 lm(Button.Press.CoV_Delta ~ Up3BradySum_Delta + Button.Press.CoV_TT_0 + Up3BradySum_TT_0 + Age + Gender + YearsSinceDiag + NpsEducYears + RespHandIsDominant, data=.)
tab_model(m.lm, digits = 5, show.se = TRUE)
Anova(m.lm,type = 3) %>% print()
ggemmeans(m.lm, terms = 'Up3BradySum_Delta') %>% plot()

# Plotting
g <- tmp %>%
        mutate(ParticipantType=factor(ParticipantType,levels=c('HC_PIT','PD_POM'),labels=c('Control','Patient'))) %>%
        ggplot(aes(x=TimepointNr, y = Button.Press.CoV, color = ParticipantType)) +
        geom_jitter(alpha=0.2, width=0.1) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5) +
        facet_grid(~ParticipantType) + 
        theme_bw() + 
        scale_x_discrete(labels=c('Baseline','Two years')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) +
        guides(color = guide_legend(title='Group')) +
        ggtitle('Group comparison of button press variability') +
        ylab('Coefficient of variation') + xlab('Time point') +
        ylim(0,1.5)
# y <- 1
# d = 0.4
# segmap <- data.frame(
#         x =    c(2.5),
#         xend = c(2.5),
#         y =    c(y),
#         yend = c(y-1*d),
#         ParticipantType=c('Patient')
# )
# sigmap <- data.frame(
#         x =     c(1.50),
#         y =     c(y),
#         label = c('***'),
#         ParticipantType=c('Patient')
# )
# g <- g +
#         geom_segment(data=segmap,
#                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
#                      inherit.aes = FALSE,
#                      size = lsize) +
#         geom_text(data=sigmap,
#                   mapping = aes(x=x,y=y,label=label),
#                   inherit.aes = FALSE,
#                   size = sigsize)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Misc/CoV_lmer.png',
          g, dpi=300, device='png', base_width = 5)

```

## *Switch ratio

```{r switch-repeat, echo=FALSE, warning=TRUE, message=TRUE}

tmp <- dfFMRI %>%
        group_by(pseudonym,TimepointNr) %>%
        summarise(ParticipantType=first(ParticipantType),
                  Button.Press.SwitchRatio=first(Button.Press.SwitchRatio),
                  Up3BradySum=first(Up3BradySum),
                  Age=first(Age),
                  Gender=first(Gender),
                  YearsSinceDiag=first(YearsSinceDiag),
                  NpsEducYears=first(NpsEducYears),
                  RespHandIsDominant=first(RespHandIsDominant)) %>%
        mutate(Button.Press.SwitchRatio=Button.Press.SwitchRatio*100) %>%
        ungroup() %>%
        mutate(ParticipantType=factor(ParticipantType),
               TimepointNr=factor(TimepointNr),
               Age=Age-mean(Age,na.rm=T),
               Gender=factor(Gender),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               RespHandIsDominant=factor(RespHandIsDominant))

# Group comparison
m.lmer <- tmp %>%
        lmer(log(Button.Press.SwitchRatio) ~ ParticipantType*TimepointNr + Age + Gender + NpsEducYears + RespHandIsDominant + (1|pseudonym), data=.)
tab_model(m.lmer, title='Switch-repeat ratio')
Anova(m.lmer, type=3) %>% print()
eta_squared(m.lmer) %>% print()
ems <- emmeans(m.lmer, revpairwise ~ ParticipantType, type = 'response')
summary(ems) %>% print()

# Clinical correlations
m.lm <- tmp %>%
 filter(ParticipantType=='PD_POM') %>%
 pivot_wider(id_cols = c('pseudonym','Age','Gender'),
             names_from = TimepointNr,
             names_prefix = 'TT_',
             values_from = c(Button.Press.SwitchRatio,Up3BradySum)) %>%
 mutate(Button.Press.SwitchRatio_Delta = Button.Press.SwitchRatio_TT_2 - Button.Press.SwitchRatio_TT_0,
        Up3BradySum_Delta = Up3BradySum_TT_2 - Up3BradySum_TT_0,
        Up3BradySum_Delta = Up3BradySum_Delta-mean(Up3BradySum_Delta,na.rm=T),
        Up3BradySum_TT_0 = Up3BradySum_TT_0-mean(Up3BradySum_TT_0,na.rm=T),
        Button.Press.SwitchRatio_TT_0=Button.Press.SwitchRatio_TT_0-mean(Button.Press.SwitchRatio_TT_0,na.rm=T)) %>%
 na.omit() %>%
 lm(Button.Press.SwitchRatio_Delta ~ Up3BradySum_Delta + Button.Press.SwitchRatio_TT_0 + Up3BradySum_TT_0 + Age + Gender, data=.)
tab_model(m.lm, digits = 5, show.se = TRUE)
Anova(m.lm,type = 3) %>% print()
ggemmeans(m.lm, terms='Up3BradySum_Delta') %>% plot()

# Plotting
g <- tmp %>%
        mutate(ParticipantType=factor(ParticipantType,levels=c('HC_PIT','PD_POM'),labels=c('Control','Patient'))) %>%
        ggplot(aes(x=TimepointNr, y = Button.Press.SwitchRatio, color = ParticipantType)) +
        geom_jitter(alpha=0.2, width=0.1) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5) +
        facet_grid(~ParticipantType) + 
        theme_bw() + 
        scale_x_discrete(labels=c('Baseline','Two years')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) +
        guides(color = guide_legend(title='Group')) +
        ggtitle('Group comparison of switching rates') +
        ylab('Switching rate (%)') + xlab('Time point') +
        ylim(0,100)
# y <- 1
# d = 0.4
# segmap <- data.frame(
#         x =    c(2.5),
#         xend = c(2.5),
#         y =    c(y),
#         yend = c(y-1*d),
#         ParticipantType=c('Patient')
# )
# sigmap <- data.frame(
#         x =     c(1.50),
#         y =     c(y),
#         label = c('***'),
#         ParticipantType=c('Patient')
# )
# g <- g +
#         geom_segment(data=segmap,
#                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
#                      inherit.aes = FALSE,
#                      size = lsize) +
#         geom_text(data=sigmap,
#                   mapping = aes(x=x,y=y,label=label),
#                   inherit.aes = FALSE,
#                   size = sigsize)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/Misc/Switch_lmer.png',
          g, dpi=300, device='png', base_width = 5)

```

# *Disease progression

## LMEr with 2 timepoints

```{r clin-prog1, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

# Mixed-effects modelling, 2 timepoints
tmp <- dfFMRI %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym,TimepointNr) %>%
        summarise(Up3BradySum_T0=first(Up3BradySum_T0), 
                  Up3BradySum_RawChange=first(Up3BradySum_RawChange),
                  Up3BradySum=first(Up3BradySum),
                  YearsToFollowUp=first(YearsToFollowUp),
                  Age=first(Age),
                  Gender=first(Gender),
                  YearsSinceDiag=first(YearsSinceDiag)-YearsToFollowUp) %>%
        ungroup()

tmp %>% group_by(TimepointNr) %>% summarise(n=n(),missing=sum(is.na(Up3BradySum))) %>%
        print()

m.lmer <- lmer(Up3BradySum ~ TimepointNr + scale(Age) + Gender + (1|pseudonym), data=tmp)
tab_model(m.lmer, title='Clinical progression')
a <- Anova(m.lmer,type=3)
print(a)
ems <- emmeans(m.lmer, pairwise ~ TimepointNr)
summary(ems) %>% print()
eta_squared(m.lmer, alternative = 'two.sided') %>% print()
ggemmeans(m.lmer, terms=c('TimepointNr')) %>% plot(connect.lines=TRUE)

g <- ggplot(tmp, aes(x=as.numeric(TimepointNr),y=Up3BradySum)) +
        geom_jitter(width=0.01, alpha=0.25, size=0.6) +
        geom_line(aes(group=pseudonym,color=Up3BradySum_RawChange),alpha=0.5,lwd=0.5,linetype=1) +
        scale_color_viridis_c(option = 'mako',begin=0,end=1,direction=-1) + 
        scale_x_continuous(breaks = c(1,2), name = 'Time point', labels = c('Baseline', 'Two years')) +
        geom_smooth(color='darkred',method='lm') + 
        theme_bw() +
        labs(color='Change') +
        ggtitle('Clinical progression') + ylab('MDS-UPDRS III: Bradykinesia') + 
        annotate('text', x=1.5, y=38, label = 'b = 3.18, 95%CI = [2.34, 4.02], P < 0.001')
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ClinicalProgression.png',
          g, dpi=300, device='png', base_width = 5)

```

## Raw change analysis

```{r clin-prog, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

# Raw change analysis
tmp.collapsed <- tmp %>% 
    na.omit() %>%
    filter(TimepointNr==0)
g <- ggplot(tmp.collapsed, aes(y=Up3BradySum_RawChange)) +
    geom_boxplot()
print(g)
g <- ggplot(tmp.collapsed, aes(x=Up3BradySum_T0,y=Up3BradySum_RawChange)) +
    geom_jitter(width = 0.02, alpha=0.75) + 
    geom_smooth(color='black',method='lm')
print(g)

m <- lm(Up3BradySum_RawChange ~  scale(Up3BradySum_T0) + scale(Age) + Gender, data=tmp.collapsed)
tab_model(m, title='Clinical progression')

```

## LMEr with 3 timepoints

```{r clin-prog2, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

# Mixed-effects modelling, 3 timepoints
tmp <- dfClin %>%
        filter(ParticipantType=='PD_POM') %>%
        select(pseudonym,TimepointNr,Up3BradySum,Age,Gender)

g <- tmp %>%
        ggplot(aes(x=as.numeric(TimepointNr),y=Up3BradySum)) +
        geom_line(aes(group=pseudonym),alpha=0.5) +
        geom_smooth(color='darkred',method='lm')
print(g)

m.lmer <- lmer(Up3BradySum ~ TimepointNr + scale(Age,center=T,scale=F) + Gender + (1|pseudonym), data = tmp)
tab_model(m.lmer, title='Clinical progression')
Anova(m.lmer)
ggemmeans(m.lmer, terms=c('TimepointNr')) %>% plot(connect.lines=TRUE) + 
        ylab('MDS-UPDRS III: Bradykinesia') + xlab('Time') + ggtitle('Clinical progression') + 
        theme_bw()

g <- raincloudplot_1Factor(data=tmp, y='Up3BradySum', groupvar='TimepointNr',
                           title = 'Clinical progression', ylab = 'MDS-UPDRS III: Bradykinesia', xlab = 'Time',
                           xticklabs = c('Baseline','1 year', '2 years'),
                           color_scheme = 'mako', provided_summary = 'None')

```

## *Clin prog: Time x Medication

```{r on-vs-off-prog, echo=FALSE, warning=TRUE, message=TRUE}

##### Correlate bradykinesia on and off delta
tmp <- dfClin %>%
        filter(ParticipantType=='PD_POM',
               TimepointNr != 1) %>%
        select(pseudonym,TimepointNr,Age,Gender,YearsSinceDiag,NpsEducYears,Up3OfBradySum,Up3OnBradySum) %>%
        pivot_wider(id_cols = c('pseudonym','Age','Gender','YearsSinceDiag','NpsEducYears'),
                    names_from = TimepointNr,
                    names_prefix = 'T',
                    values_from = c('Up3OfBradySum','Up3OnBradySum')) %>%
        mutate(Gender=factor(Gender),
               Age=Age-mean(Age,na.rm=T),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               Up3OfBradySum_Td = Up3OfBradySum_T2 - Up3OfBradySum_T0,
               Up3OnBradySum_Td = Up3OnBradySum_T2 - Up3OnBradySum_T0) %>%
        na.omit()

# ggpairs(tmp, columns = 2:7,
#         lower = list(continuous = 'smooth'))

m <- lm(Up3OfBradySum_Td ~ Up3OnBradySum_Td + Up3OfBradySum_T0 + Up3OnBradySum_T0 + Age + Gender + YearsSinceDiag + NpsEducYears, data = tmp)
tab_model(m,digits=5,show.se = T)
Anova(m,type=3) %>% print()
eff <- eta_squared(m)
print(eff)
g <- ggemmeans(m, terms='Up3OnBradySum_Td') %>% 
        plot(add.data=T) + theme_bw() + ggtitle('') +
        xlab('Change in bradykinesia (ON)') + ylab('Change in bradykinesia (OFF)') +
        annotate(geom = 'text', x=-25, y=30, label='N=289, β=0.873, SE=0.043, P<0.001', hjust=0) + 
        ylim(-25,30)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ClinicalProgression/ClinProg_OnOffCorr.png',
                  g, dpi=300, device='png', base_width = 5)

##### Breadykinesia: Time x Medication effect
tmp <- dfClin %>%
        filter(TimepointNr != 1) %>%
        select(pseudonym,TimepointNr,Up3OfBradySum,Up3OnBradySum,Age,Gender,YearsSinceDiag,NpsEducYears) %>%
        pivot_longer(cols = c('Up3OfBradySum','Up3OnBradySum'),
                     names_to = 'Medication',
                     values_to = 'Up3BradySum') %>%
        mutate(Medication=factor(Medication,
                                 levels=c('Up3OfBradySum','Up3OnBradySum'),
                                 labels=c('Off','On')),
               TimepointNr=factor(TimepointNr),
               Age=Age-mean(Age,na.rm=T),
               YearSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
        na.omit()

tmp %>% select(TimepointNr,Medication) %>% table()
m <- lmer(Up3BradySum ~ TimepointNr*Medication + Age + Gender + YearsSinceDiag + NpsEducYears + (1+TimepointNr|pseudonym), data = tmp)
tab_model(m, digits=5,show.se = T)
Anova(m, type=3) %>% print()
eff <- eta_squared(m)
print(eff)
em <- emmeans(m, ~Medication*TimepointNr)
contrast(em, interaction = c('revpairwise','revpairwise')) %>% print()
contrast(em, interaction = c('identity','revpairwise')) %>% print()
contrast(em, interaction = c('revpairwise','identity')) %>% print()
emmeans(m, pairwise~TimepointNr)$contrast %>% print()

g <- tmp %>%
        ggplot(aes(x=Medication, y = Up3BradySum, color=TimepointNr)) +
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=TimepointNr), position = position_dodge(width=0.8)) +
        theme_bw() + 
        scale_x_discrete(labels=c('OFF','ON')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('') +
        ylab('MDS-UPDRS III score (bradykinesia)') + xlab('Medication') + 
        guides(color = guide_legend(title='Year')) +
        ylim(0, 47) + 
        annotate(geom='text',label='N=347',x=0.8,y=0) + 
        annotate(geom='text',label='N=312',x=1.2,y=0) + 
        annotate(geom='text',label='N=330',x=1.8,y=0) + 
        annotate(geom='text',label='N=316',x=2.2,y=0)
y <- 46
d = 1.5
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  1.80),
        xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  1.20,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*3, y-d*3),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*3, y-d*3)
)
sigmap <- data.frame(
        x =     c(1.50,  1.00,  2.00),
        y =     c(y,     y-d*3, y-d*3),
        label = c('***', '***', '***')
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)

print(g)

save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ClinicalProgression/ClinProg_lmer_Brady.png',
          g, dpi=300, device='png', base_width = 5)

##### Effect of time on MoCA
tmp <- dfClin %>%
        filter(TimepointNr != 1) %>%
        select(pseudonym,TimepointNr,Up3OfBradySum,Up3OnBradySum,LEDD,z_MoCA__total,Age,Gender,YearsSinceDiag,NpsEducYears) %>%
        pivot_longer(cols = c('Up3OfBradySum','Up3OnBradySum'),
                     names_to = 'Medication',
                     values_to = 'Up3BradySum') %>%
        mutate(Medication=factor(Medication,
                                 levels=c('Up3OfBradySum','Up3OnBradySum'),
                                 labels=c('Off','On')),
               TimepointNr=factor(TimepointNr),
               Age=Age-mean(Age,na.rm=T),
               YearSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
        na.omit()

m.MOCA <- tmp %>%
        filter(Medication=='On') %>%
        lmer(z_MoCA__total ~ TimepointNr + Age + Gender + YearsSinceDiag + NpsEducYears + (1|pseudonym), data = .)
tab_model(m.MOCA, digits = 5, show.se = T)
Anova(m.MOCA, type=3) %>% print()
eta_squared(m.MOCA, alternative = 'two.sided')
em <- emmeans(m.MOCA, ~ TimepointNr, type='response')
pairs(em) %>% print()

# Correlation between MoCA increase and clinical progression
tmp.dMOCA <- tmp %>%
        filter(Medication=='On') %>%
        pivot_wider(id_cols = c('pseudonym','Age','Gender','YearsSinceDiag','NpsEducYears'),
                    names_from = TimepointNr,
                    names_prefix = 'T',
                    values_from = c('z_MoCA__total','Up3BradySum')) %>%
        mutate(Gender=factor(Gender),
               Age=Age-mean(Age,na.rm=T),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               Up3BradySum_Td = Up3BradySum_T2 - Up3BradySum_T0,
               z_MoCA__total_Td = z_MoCA__total_T2 - z_MoCA__total_T0,
               Up3BradySum_Td = Up3BradySum_Td - mean(Up3BradySum_Td,na.rm=T),
               Up3BradySum_T0 = Up3BradySum_T0 - mean(Up3BradySum_T0,na.rm=T),
               z_MoCA__total_T0 = z_MoCA__total_T0 - mean(z_MoCA__total_T0,na.rm=T)) %>%
        na.omit()

m.dMOCA <- lm(z_MoCA__total_Td ~ Up3BradySum_Td + z_MoCA__total_T0 + Up3BradySum_T0 + Age + Gender + YearsSinceDiag, data = tmp.dMOCA)
Anova(m.dMOCA,type=3) %>% print()
eff <- eta_squared(m.dMOCA)
print(eff)
s <- summary(m.dMOCA)
tab_model(m.dMOCA, digits = 5, show.se = T)
print(s)
ggemmeans(m.dMOCA, terms='Up3BradySum_Td') %>% plot(add.data=T)

##### Effect of time on medication
tmp <- dfClin %>%
        filter(TimepointNr != 1) %>%
        select(pseudonym,TimepointNr,Up3OfBradySum,Up3OnBradySum,LEDD,Age,Gender,YearsSinceDiag,NpsEducYears) %>%
        pivot_longer(cols = c('Up3OfBradySum','Up3OnBradySum'),
                     names_to = 'Medication',
                     values_to = 'Up3BradySum') %>%
        mutate(Medication=factor(Medication,
                                 levels=c('Up3OfBradySum','Up3OnBradySum'),
                                 labels=c('Off','On')),
               TimepointNr=factor(TimepointNr),
               Age=Age-mean(Age,na.rm=T),
               YearSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
        na.omit()

m.LEDD <- tmp %>%
        filter(Medication=='On') %>%
        lmer(LEDD ~ TimepointNr + Age + Gender + YearsSinceDiag + NpsEducYears + (1|pseudonym), data = .)
tab_model(m.LEDD, digits = 5, show.se = T)
Anova(m.LEDD, type=3) %>% print()
eta_squared(m.LEDD, alternative = 'two.sided')
em <- emmeans(m.LEDD, ~ TimepointNr, type='response')
pairs(em) %>% print()

# Correlation between medication increase and clinical progression
tmp.dLEDD <- tmp %>%
        filter(Medication=='On') %>%
        pivot_wider(id_cols = c('pseudonym','Age','Gender','YearsSinceDiag','NpsEducYears'),
                    names_from = TimepointNr,
                    names_prefix = 'T',
                    values_from = c('LEDD','Up3BradySum')) %>%
        mutate(Gender=factor(Gender),
               Age=Age-mean(Age,na.rm=T),
               YearsSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
               NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T),
               Up3BradySum_Td = Up3BradySum_T2 - Up3BradySum_T0,
               LEDD_Td = LEDD_T2 - LEDD_T0,
               Up3BradySum_Td = Up3BradySum_Td - mean(Up3BradySum_Td,na.rm=T),
               Up3BradySum_T0 = Up3BradySum_T0 - mean(Up3BradySum_T0,na.rm=T),
               LEDD_T0 = LEDD_T0 - mean(LEDD_T0,na.rm=T)) %>%
        na.omit()

m.dLEDD <- lm(LEDD_Td ~ Up3BradySum_Td + LEDD_T0 + Up3BradySum_T0 + Age + Gender + YearsSinceDiag, data = tmp.dLEDD)
Anova(m.dLEDD,type=3) %>% print()
eff <- eta_squared(m.dLEDD)
print(eff)
s <- summary(m.dLEDD)
tab_model(m.dLEDD, digits = 5, show.se = T)
print(s)
ggemmeans(m.dLEDD, terms='Up3BradySum_Td') %>% plot(add.data=T)

# ##### Cognitive progression
# tmp <- dfClin %>%
#         filter(TimepointNr != 1) %>%
#         select(pseudonym,TimepointNr,z_MoCA__total,Age,Gender,YearsSinceDiag,NpsEducYears) %>%
#         mutate(TimepointNr=factor(TimepointNr),
#                Age=Age-mean(Age,na.rm=T),
#                YearSinceDiag=YearsSinceDiag-mean(YearsSinceDiag,na.rm=T),
#                NpsEducYears=NpsEducYears-mean(NpsEducYears,na.rm=T)) %>%
#         na.omit()
# 
# tmp %>% select(TimepointNr) %>% table()
# m <- lmer(z_MoCA__total ~ TimepointNr + Age + Gender + YearsSinceDiag + NpsEducYears + (1|pseudonym), data = tmp)
# tab_model(m, digits=5,show.se = T)
# Anova(m, type=3) %>% print()
# em <- emmeans(m, ~TimepointNr)
# contrast(em, interaction = c('pairwise','pairwise')) %>% print()
# contrast(em, interaction = c('identity','pairwise')) %>% print()
# emmeans(m, revpairwise~TimepointNr)$contrast %>% print()
# 
# g <- tmp %>%
#         ggplot(aes(x=TimepointNr, y = z_MoCA__total, color=TimepointNr)) +
#         geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
#         geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) +
#         stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5,
#                      mapping = aes(group=TimepointNr), position = position_dodge(width=0.8)) +
#         theme_bw() +
#         scale_x_discrete(labels=c('0','2')) +
#         scale_color_viridis_d(option='mako', begin = .1, end = .6,
#                               direction = -1) +
#         ggtitle('Cognitive decline') +
#         ylab('MoCA score (z)') + xlab('Year') +
#         guides(color = guide_legend(title='Year')) +
#         annotate(geom='text',label='N=350',x=1,y=-3.5) +
#         annotate(geom='text',label='N=323',x=2,y=-3.5)
# y <- 2.6
# d = 0.5
# segmap <- data.frame(
#         x =    c(1.00),
#         xend = c(2.00),
#         y =    c(y),
#         yend = c(y)
# )
# sigmap <- data.frame(
#         x =     c(1.5),
#         y =     c(y),
#         label = c('***')
# )
# g <- g +
#         geom_segment(data=segmap,
#                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
#                      inherit.aes = FALSE,
#                      size = lsize) +
#         geom_text(data=sigmap,
#                   mapping = aes(x=x,y=y,label=label),
#                   inherit.aes = FALSE,
#                   size = sigsize)
# 
# print(g)
# 
# save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ClinProg_lmer_MoCA.png',
#           g, dpi=300, device='png', base_width = 5)

```

# *Brain activity

## *Voxelwise: Group comparison


### FSL

 - Putamen: Lower change in patients compared to controls

```{r fsl-rand-unpaired_motor-tstat1, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

unpaired_tstat1_ba <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0010/vals/rand_unpaired_tfce_tstat1_ba_stats.txt',
                               col_names = F) %>%
        rename(IMG_BA=X1,
               VAL_BA=X2)
unpaired_tstat1_fu <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0010/vals/rand_unpaired_tfce_tstat1_fu_stats.txt',
                               col_names = F) %>%
        rename(IMG_FU=X1,
               VAL_FU=X2)
unpaired_tstat1_delta <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0010/vals/rand_unpaired_tfce_tstat1_delta_stats.txt',
                               col_names = F) %>%
        rename(IMG_DELTA=X1,
               VAL_DELTA=X2)

df <- unpaired_tstat1_ba %>%
        mutate(pseudonym = str_sub(IMG_BA,83,106),
               ParticipantType = str_sub(IMG_BA,76,81),
               Timepoint = str_sub(IMG_BA,108,120)) %>%
        select(-c(IMG_BA,VAL_BA))
df <- bind_cols(df, BA=unpaired_tstat1_ba$VAL_BA, FU=unpaired_tstat1_fu$VAL_FU, DELTA=unpaired_tstat1_delta$VAL_DELTA)
resid <- resid(lm(DELTA ~ BA, data = df))
df <- df %>%
        bind_cols(., DELTA.adj = resid)

df2 <- df %>%
        pivot_longer(cols = c('BA','FU'),
                     names_to = 'Session',
                     values_to = 'Beta')

df %>%
        ggplot(aes(x=ParticipantType,y=DELTA.adj)) + 
        geom_boxplot()
df2 %>%
        ggplot(aes(x=ParticipantType,y=Beta,fill=Session)) + 
        geom_boxplot()

```

 - PMC: Patients show more change compared to controls

```{r fsl-rand-unpaired_motor-tstat2, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

unpaired_tstat2_ba <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0010/vals/rand_unpaired_tfce_tstat2_ba_stats.txt',
                               col_names = F) %>%
        rename(IMG_BA=X1,
               VAL_BA=X2)
unpaired_tstat2_fu <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0010/vals/rand_unpaired_tfce_tstat2_fu_stats.txt',
                               col_names = F) %>%
        rename(IMG_FU=X1,
               VAL_FU=X2)
unpaired_tstat2_delta <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0010/vals/rand_unpaired_tfce_tstat2_delta_stats.txt',
                               col_names = F) %>%
        rename(IMG_DELTA=X1,
               VAL_DELTA=X2)

df <- unpaired_tstat2_ba %>%
        mutate(pseudonym = str_sub(IMG_BA,83,106),
               ParticipantType = str_sub(IMG_BA,76,81),
               Timepoint = str_sub(IMG_BA,108,120)) %>%
        select(-c(IMG_BA,VAL_BA))
df <- bind_cols(df, BA=unpaired_tstat2_ba$VAL_BA, FU=unpaired_tstat2_fu$VAL_FU, DELTA=unpaired_tstat2_delta$VAL_DELTA)
resid <- resid(lm(DELTA ~ BA, data = df))
df <- df %>%
        bind_cols(., DELTA.adj = resid)

df2 <- df %>%
        pivot_longer(cols = c('BA','FU'),
                     names_to = 'Session',
                     values_to = 'Beta')

df %>%
        ggplot(aes(x=ParticipantType,y=DELTA.adj)) + 
        geom_boxplot()
df2 %>%
        ggplot(aes(x=ParticipantType,y=Beta,fill=Session)) + 
        geom_boxplot()


```

 - Putamen: Patients show more change compared to controls

```{r fsl-rand-unpaired_as-tstat2, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

unpaired_tstat2_ba <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_unpaired_tfce_tstat2_ba_stats.txt',
                               col_names = F) %>%
        rename(IMG_BA=X1,
               VAL_BA=X2)
unpaired_tstat2_fu <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_unpaired_tfce_tstat2_fu_stats.txt',
                               col_names = F) %>%
        rename(IMG_FU=X1,
               VAL_FU=X2)
unpaired_tstat2_delta <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_unpaired_tfce_tstat2_delta_stats.txt',
                               col_names = F) %>%
        rename(IMG_DELTA=X1,
               VAL_DELTA=X2)

df <- unpaired_tstat2_ba %>%
        mutate(pseudonym = str_sub(IMG_BA,83,106),
               ParticipantType = str_sub(IMG_BA,76,81),
               Timepoint = str_sub(IMG_BA,108,120)) %>%
        select(-c(IMG_BA,VAL_BA))
df <- bind_cols(df, BA=unpaired_tstat2_ba$VAL_BA, FU=unpaired_tstat2_fu$VAL_FU, DELTA=unpaired_tstat2_delta$VAL_DELTA)
resid <- resid(lm(DELTA ~ BA, data = df))
df <- df %>%
        bind_cols(., DELTA.adj = resid)

df2 <- df %>%
        pivot_longer(cols = c('BA','FU'),
                     names_to = 'Session',
                     values_to = 'Beta')

df %>%
        ggplot(aes(x=ParticipantType,y=DELTA.adj)) + 
        geom_boxplot()
df2 %>%
        ggplot(aes(x=ParticipantType,y=Beta,fill=Session)) + 
        geom_boxplot()


```

 - PMC: Negative correlation between change and progression

```{r fsl-rand-clincorr_as-tstat2, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

clincorr_tstat2_ba <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_clincorr-brady_tfce_tstat2_ba_stats.txt',
                               col_names = F) %>%
        rename(IMG_BA=X1,
               VAL_BA=X2)
clincorr_tstat2_fu <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_clincorr-brady_tfce_tstat2_fu_stats.txt',
                               col_names = F) %>%
        rename(IMG_FU=X1,
               VAL_FU=X2)
clincorr_tstat2_delta <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_clincorr-brady_tfce_tstat2_delta_stats.txt',
                               col_names = F) %>%
        rename(IMG_DELTA=X1,
               VAL_DELTA=X2)

covars <- read_delim('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/data/con_0007/clincorr_covars.txt')

df <- clincorr_tstat2_ba %>%
        mutate(pseudonym = str_sub(IMG_BA,83,106),
               ParticipantType = str_sub(IMG_BA,76,81),
               Timepoint = str_sub(IMG_BA,108,120)) %>%
        select(-c(IMG_BA,VAL_BA))
df <- bind_cols(df, BA=clincorr_tstat2_ba$VAL_BA, FU=clincorr_tstat2_fu$VAL_FU, DELTA=clincorr_tstat2_delta$VAL_DELTA, covars)
resid <- resid(lm(DELTA ~ BA, data = df))
df <- df %>%
        bind_cols(., DELTA.adj = resid)
resid <- resid(lm(Up3OnBradySum_Delta ~ Up3OnBradySum_T0, data = df))
df <- df %>%
        bind_cols(., Up3OnBradySum_Delta.adj = resid)


df2 <- df %>%
        pivot_longer(cols = c('BA','FU'),
                     names_to = 'Session',
                     values_to = 'Beta')

df %>%
        ggplot(aes(x=Up3OnBradySum_Delta.adj,y=DELTA.adj)) + 
        geom_point() + 
        geom_smooth(method = 'lm', color='darkred')

df2 %>%
        ggplot(aes(x=Session,y=Beta)) + 
        geom_point(alpha=0.5) + 
        geom_line(aes(group=pseudonym),alpha=0.5)


```

### *AFNI

GROUP x TIME x CONDITION, analyzed using 3dLMEr

```{r pd-vs-hc, echo=FALSE, warning=TRUE, message=TRUE}

# Group x Type
dat <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/AFNI/WholeBrain/3dLME_disease/stats/con_combined_Group2_x_TimepointNr2_x_Type3_z_Group_by_Type_dataTable_24-Jun-2024.txt') %>%
        left_join(., read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/AFNI/WholeBrain/3dLME_disease/stats/con_combined_Group2_x_TimepointNr2_x_Type3_Z_Group_dataTable_24-Jun-2024.txt')) %>%
        mutate(trial_type = case_when(trial_type == '1c' ~ 'Single',
                                      trial_type == '23c' ~ 'Multiple'),
               trial_type = factor(trial_type, 
                                   levels = c('Single','Multiple'),
                                   labels = c('Single','Multiple')),
               TimepointNr = case_when(TimepointNr == 'T0' ~ 0,
                                       TimepointNr == 'T1' ~ 2),
               TimepointNr = factor(TimepointNr)) %>%
        group_by(Subj,Group,TimepointNr,trial_type) %>%
        summarise(con_combined__z_Group_by_Type_cid1 = mean(con_combined__z_Group_by_Type_cid1),
                  con_combined__z_Group_by_Type_cid2 = mean(con_combined__z_Group_by_Type_cid2),
                  con_combined__z_Group_by_Type_cid3 = mean(con_combined__z_Group_by_Type_cid3),
                  con_combined__z_Group_by_Type_cid4 = mean(con_combined__z_Group_by_Type_cid4),
                  con_combined__z_Group_by_Type_cid5 = mean(con_combined__z_Group_by_Type_cid5),
                  con_combined__z_Group_by_Type_cid6 = mean(con_combined__z_Group_by_Type_cid6),
                  con_combined__z_Group_by_Type_cid7 = mean(con_combined__z_Group_by_Type_cid7),
                  con_combined__z_Group_by_Type_cid8 = mean(con_combined__z_Group_by_Type_cid8),
                  con_combined__Z_Group_cid1 = mean(con_combined__Z_Group_cid1)) %>%
        ungroup()

dat %>%
        count(Group,TimepointNr,trial_type) %>%
        print()

# Group x Time
g <- dat %>%
        ggplot(aes(x=Group,y=con_combined__z_Group_by_Type_cid1,color=TimepointNr)) + 
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=TimepointNr), position = position_dodge(width=0.8)) +
        theme_bw() + 
        scale_x_discrete(labels=c('Ctrl','PD-ON')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('') +
        ylab('Precuneus (beta)') + xlab('') + 
        guides(color = guide_legend(title='Year')) +
        annotate(geom='text',label='N=60',x=0.8,y=-14) + 
        annotate(geom='text',label='N=52',x=1.2,y=-14) +
        annotate(geom='text',label='N=332',x=1.8,y=-14) + 
        annotate(geom='text',label='N=276',x=2.2,y=-14) +
        ylim(-14, 12)
y <- 11
d = 0.75
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  1.20,  1.80,  2.20,  1.80),
        xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  0.80,  1.20,  1.80,  2.20,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2, y-d*3)
)
sigmap <- data.frame(
        x =     c(1.50, 2.00),
        y =     c(y,    y-d*3),
        label = c('***', '***')
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/AFNI/3dLMEr_GroupComp_GROUPxTYPE_cb1.png',
          g, dpi=300, device='png', base_width = 5)

# Group
g <- dat %>%
        ggplot(aes(x=Group,y=con_combined__Z_Group_cid1,color=TimepointNr)) + 
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=TimepointNr), position = position_dodge(width=0.8)) +
        theme_bw() + 
        scale_x_discrete(labels=c('Ctrl','PD-ON')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('Decreased basal ganglia activity') +
        ylab('Putamen activity (beta)') + xlab('') + 
        guides(color = guide_legend(title='Year')) +
        annotate(geom='text',label='N=60',x=0.8,y=-2.9) + 
        annotate(geom='text',label='N=52',x=1.2,y=-2.9) +
        annotate(geom='text',label='N=332',x=1.8,y=-2.9) + 
        annotate(geom='text',label='N=276',x=2.2,y=-2.9) +
        ylim(-3, 6)
y <- 6
d = 0.5
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  1.80),
        xend = c(2.00, 1.00,  2.00,  1.20,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/3dLMEr_Group_putamen.png',
          g, dpi=300, device='png', base_width = 5)

# # Repeated-measures correlations
# ClinScores <- dfClin %>%
#         filter(ParticipantType=='PD_POM',
#                TimepointNr==0 | TimepointNr==2) %>%
#         select(pseudonym,TimepointNr,Up3OnTotal,Up3OnBradySum,Up3OnRigiditySum,
#                Up3OnRestTremAmpSum,Up3OnActionTremorSum,Up3OnCompositeTremorSum,z_MoCA__total,LEDD) %>%
#         rename(Subj = pseudonym)
# FullData <- ClinScores %>%
#         select(Subj,TimepointNr,Up3OnTotal) %>%
#         pivot_wider(id_cols = 'Subj',
#                     names_from = TimepointNr,
#                     names_prefix = 'T',
#                     values_from = Up3OnTotal) %>%
#         na.omit()
# ClinScores <- ClinScores %>%
#         filter(Subj %in% FullData$Subj)
# dat.clincorr <- dat %>% 
#         filter(Group=='PD_POM') %>%
#         left_join(ClinScores, by = c('Subj','TimepointNr')) %>%
#         na.omit()
# 
# rmc_mat <- rmcorr_mat(participant = Subj,
#               variables = c('con_combined__z_Group_by_Time_cid1',
#                             'con_combined__Z_Group_cid1',
#                             'Up3OnTotal',
#                             'Up3OnBradySum',
#                             'Up3OnRestTremAmpSum',
#                             'Up3OnActionTremorSum',
#                             'Up3OnCompositeTremorSum',
#                             'z_MoCA__total',
#                             'LEDD'),
#               dataset = dat.clincorr,
#               CI.level = 0.95)
# plot(rmc_mat$models[[8]])

# 
# dat.int <- dat %>%
#     select(Subj, Group, TimepointNr, YearsToFollowUp, trial_type, con_combined__Z_TimeGroup_cid8)
# 
# m22 <- lmer(con_combined__Z_TimeGroup_cid8 ~ TimepointNr*Group*trial_type + (1|Subj), data=dat.int)
# summary(m2)
# Anova(m2)
# em <- emmeans(m2, ~ TimepointNr|Group, type='response')
# contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
# contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print()
# ggemmeans(m2, terms=c('TimepointNr','trial_type','Group'), back.transform = TRUE) %>% plot(connect.lines=TRUE) %>%
#         save_plot('M:/Visualization/R_LongitudinalComparisonFmri/3dLMEr_disease_TimeXGroup.png', ., dpi=300)
# 
# g <- ggplot(dat.int, aes(y=con_combined__Z_TimeGroup_cid1,x=TimepointNr,color=trial_type)) + 
#     geom_point(alpha=0.5) +
#     geom_boxplot(outlier.shape = NA) +
#     facet_grid(~Group+trial_type)+
#     theme_bw() +
#     scale_x_discrete(labels=c('BA','2Y')) +
#     scale_color_viridis_d(option='mako', begin = .1, end = .6,
#                           direction = -1) +
#     ggtitle('Condition effect') + ylab('Beta')
# print(g)
# save_plot('M:/Visualization/R_LongitudinalComparisonFmri/3dLMER_disease_cond.png',
#           g, dpi=300, device='png', base_width = 5)

```

### Voxelwise: Post hoc subtyping comparison

```{r subtype-vs-hc, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

##### MMP VS DM #####
dat.MMPvsDM <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ON_ANALYSES/ROI/BG_Parietal/3dLME_MMPvsDM/stats/con_combined_dataTable_13-Apr-2023.txt')
dat.MMPvsDM <- dat.MMPvsDM %>%
        select(-c(InputFile,Group,YearsToFollowUp,Age_timevar)) %>%
        mutate(Subtype1 = if_else(Subtype1=='G1','1_MMP','2_DM'),
               Subtype1=factor(Subtype1),
               TimepointNr=factor(TimepointNr),
               trial_type=factor(trial_type),
               Sex=factor(Sex)) %>%
        rename(y = con_combined__Z_TimeGroup_cid1)

m <- lmer(y ~ Subtype1*TimepointNr*trial_type + Age + Sex + YearSinceDiag + (1|Subj), data=dat.MMPvsDM)
s <- summary(m)
print(s)
Anova(m,type=3) %>% print()
eta_squared(m, alternative = 'two.sided')
em <- emmeans(m, pairwise ~ Subtype1*TimepointNr)
contrast(em, interaction=c('revpairwise','revpairwise')) %>% print()
contrast(em, interaction=c('identity','revpairwise')) %>% print()
g <- ggemmeans(m, terms=c('trial_type','TimepointNr','Subtype1')) %>% plot(add.data=T) + theme_bw()
print(g)

N <- dat.MMPvsDM  %>% 
        group_by(Subj, Subtype1, TimepointNr) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        select(Subtype1, TimepointNr) %>%
        table()

g <- dat.MMPvsDM %>%
        mutate(trial_type=factor(trial_type,levels=c('1c','2c','3c'), labels=c('One','Two','Three')),
               Subtype1=factor(Subtype1,labels=c('Mild-motor predominant','Diffuse-malignant'))) %>%
        ggplot(aes(x=TimepointNr, y = y, color=trial_type)) +
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
        facet_grid(~Subtype1) + 
        theme_bw() + 
        scale_x_discrete(labels=c('Baseline','Two years')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('Longitudinal change in premotor cortex (6mp)') +
        ylab('Beta (Z)') + xlab('Time point') + 
        guides(color = guide_legend(title='Choices')) +
        ylim(-4,10)
y <- 9.5
d = 1
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  1.80),
        xend = c(2.00, 1.00,  2.00,  1.20,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1),
        Subtype1=factor(c('Diffuse-malignant','Diffuse-malignant','Diffuse-malignant',
                   'Diffuse-malignant','Diffuse-malignant'))
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y+0.5),
        label = c('P<0.08'),
        Subtype1=factor(c('Diffuse-malignant'))
)
annmap <- data.frame(
        x=c(1,2,1,2),
        y=c(-3,-3,-3,-3),
        label=c('N=138','N=129','N=40','N=23'),
        Subtype1=factor(c('Mild-motor predominant','Mild-motor predominant',
                   'Diffuse-malignant','Diffuse-malignant'))
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend,color=NULL),
                     inherit.aes = T,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label,color=NULL),
                  inherit.aes = T) +
        geom_text(data=annmap, 
                  mapping = aes(x=x,y=y,label=label,color=NULL),
                  inherit.aes = T)

print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/MMPvsDM_fmri-lmer.png',
          g, dpi=300, device='png', base_width = 5)

##### HC VS DM #####
dat.HCvsDM <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ON_ANALYSES/ROI/BG_Parietal/3dLME_HCvsDM/stats/con_combined_dataTable_13-Apr-2023.txt')
dat.HCvsDM <- dat.HCvsDM %>%
        select(-c(InputFile,Group,YearsToFollowUp,Age_timevar)) %>%
        mutate(Subtype1 = if_else(Subtype1=='G1','1_HC','2_DM'),
               Subtype1=factor(Subtype1),
               TimepointNr=factor(TimepointNr),
               trial_type=factor(trial_type),
               Sex=factor(Sex)) %>%
        rename(y = con_combined__Z_TimeGroup_cid1)

m <- lmer(y ~ Subtype1*TimepointNr*trial_type + Age + Sex + (1|Subj), data=dat.HCvsDM)
s <- summary(m)
print(s)
Anova(m,type=3) %>% print()
eta_squared(m, alternative = 'two.sided')
em <- emmeans(m, pairwise ~ Subtype1*TimepointNr)
contrast(em, interaction=c('revpairwise','revpairwise')) %>% print()
contrast(em, interaction=c('identity','revpairwise')) %>% print()
g <- ggemmeans(m, terms=c('trial_type','TimepointNr','Subtype1')) %>% plot(add.data=T) + theme_bw()
print(g)

N <- dat.HCvsDM  %>% 
        group_by(Subj, Subtype1, TimepointNr) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        select(Subtype1, TimepointNr) %>%
        table()

g <- dat.HCvsDM %>%
        mutate(trial_type=factor(trial_type,levels=c('1c','2c','3c'), labels=c('One','Two','Three')),
               Subtype1=factor(Subtype1,levels=c('1_HC','2_DM'),labels=c('Control','Diffuse-malignant'))) %>%
        ggplot(aes(x=TimepointNr, y = y, color=trial_type)) +
        geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
        geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
        stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
                     mapping = aes(group=trial_type), position = position_dodge(width=0.8)) +
        facet_grid(~Subtype1) + 
        theme_bw() + 
        scale_x_discrete(labels=c('Baseline','Two years')) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1) + 
        ggtitle('Longitudinal change in primary motor cortex (M1)') +
        ylab('Beta (Z)') + xlab('Time point') + 
        guides(color = guide_legend(title='Choices')) +
        ylim(-3,13)
y <- 12.5
d = 1
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  1.80),
        xend = c(2.00, 1.00,  2.00,  1.20,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1),
        Subtype1=factor(c('Diffuse-malignant','Diffuse-malignant','Diffuse-malignant',
                   'Diffuse-malignant','Diffuse-malignant'))
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('*'),
        Subtype1=factor(c('Diffuse-malignant'))
)
annmap <- data.frame(
        x=c(1,2,1,2),
        y=c(-3,-3,-3,-3),
        label=c('N=60','N=51','N=40','N=23'),
        Subtype1=factor(c('Control','Control',
                   'Diffuse-malignant','Diffuse-malignant'))
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size=sigsize) +
        geom_text(data=annmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/HCvsDM_fmri-lmer.png',
          g, dpi=300, device='png', base_width = 5)


```

## *Voxelwise: Brain-clinical associations

Correlation between change in bradykinesia and change in brain activity, analyzed using 3dttest++ / randomise adjusting for baseline severity and activity.

### *FSL

```{r brain-clin-fsl, echo=FALSE, warning=TRUE, message=TRUE, eval=T}

dat_delta <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_delta_clincorr_all_vxlEV_tfce_corrp_tstat2_stats_stats_avg_agg.txt',
                      col_names = c('Subj','cid1_delta','cid2_delta','cid3_delta','cid4_delta','cid5_delta','cid6_delta')) %>%
        mutate(Subj = str_replace(Subj, '.nii',''),
               Subj = str_sub(Subj, start=80))

dat_ba <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_delta_clincorr_all_vxlEV_tfce_corrp_tstat2_stats_BASELINE_stats_avg_agg.txt',
                   col_names = c('Subj','cid1_ba','cid2_ba','cid3_ba','cid4_ba','cid5_ba','cid6_ba')) %>%
        select(-Subj)

# dat_covs <- read_delim('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/data/con_0007/covs__delta_clincorr_all_vxlEV.txt',
#                      col_names = c('Up3OnBradySum_delta','Up3OnBradySum_T0','MoCA_delta','MoCA_T0','LEDD_delta','LEDD_T0','Age','Gender','NpsEducYears','DisDur','RespHandIsDominant','mean','vxlEV'))

dat <- bind_cols(dat_delta, dat_ba) %>%
        mutate(Subj = str_sub(Subj, start=1L, end=16),
               Subj = str_glue('sub-POMU{Subj}')) %>%
        rename(pseudonym=Subj)

dat_covs <- dfFMRI %>%
        filter(ParticipantType=='PD_POM',
               TimepointNr==0) %>%
        group_by(pseudonym) %>%
        summarise(pseudonym=first(pseudonym),Up3BradySum.imp_RawChange=first(Up3BradySum.imp_RawChange),Up3BradySum.imp_T0=first(Up3BradySum.imp_T0),
                  z_MoCA__total.imp_RawChange=first(z_MoCA__total.imp_RawChange),z_MoCA__total.imp_T0=first(z_MoCA__total.imp_T0),
               LEDD.imp_RawChange=first(LEDD.imp_RawChange),LEDD.imp_T0=first(LEDD.imp_T0),Age=first(Age),Gender=first(Gender),NpsEducYears=first(NpsEducYears),
               YearsSinceDiag=first(YearsSinceDiag),RespHandIsDominant=first(RespHandIsDominant)) %>%
        mutate(Gender=factor(Gender),RespHandIsDominant=factor(RespHandIsDominant))

dat <- dat %>%
        left_join(dat_covs, by = 'pseudonym')

m <- dat %>%
        lm(cid6_delta ~ Up3BradySum.imp_RawChange + Up3BradySum.imp_T0 + cid6_ba + Age + Gender + NpsEducYears + YearsSinceDiag + RespHandIsDominant, data = .)

tab_model(m,title='Brain-Clinical Associations',digits=5,show.se = T)
ols_vif_tol(m) %>% print()
Anova(m,type=3) %>% print()
LmPlots(m)
pred <- ggpredict(m, terms='Up3BradySum.imp_RawChange')
g <- plot(pred, add.data = TRUE,color='darkred') + theme_bw() + ggtitle('') +
        ylab('Change in activity (Multiple > Single, z)') + xlab('Change in bradykinesia (ON)') +
        annotate('text',y=-4,x=-25,
                 label=expression(italic('N')*'=264, '*italic('β')*'=-0.054, SE=0.012, '*italic('P')*'<0.001 (FWEc-corrected)'), hjust=0) +
        ylim(-4,5) + 
        geom_hline(yintercept = 0, color = 'darkgrey', lty = 2) + geom_vline(xintercept = 0, color = 'darkgrey', lty = 2)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/FSL/randomise_severity_23gt1.png',
                  g, dpi=300, device='png', base_width = 5)
```
 

### AFNI

```{r brain-clin, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

# 3dttest++: MEAN
# Data reading
dat <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ON_ANALYSES/ROI/BG_Parietal/3dttest++_severity/stats/con_0010_dataTable_09-May-2023.txt')
dat <- dat %>%
        mutate(Subj=str_c('sub-POMU', str_sub(Subj,end=16)),
               Sex=factor(Sex)) %>%
        select(-c(InputFile, voxelwiseBA)) %>%
        rename(C1_BA = con_0010_Severity2_T_Delta_ba_cid1,
               C1_delta = con_0010_Severity2_T_Delta_cid1) %>%
        relocate(Subj, Sex, Age, YearSinceDiag_imp, ClinScore_delta, ClinScore_BA, C1_delta, C1_BA)

# Initial visualization
gp <- ggpairs(dat, columns = 2:8, aes(color=Sex, alpha=0.5),
        lower = list(continuous = 'smooth'))
print(gp)

# Analysis
m <- dat %>%
        mutate(Age=Age-mean(Age),
               YearSinceDiag_imp=YearSinceDiag_imp-mean(YearSinceDiag_imp),
               ClinScore_delta=ClinScore_delta-mean(ClinScore_delta),
               ClinScore_BA=ClinScore_BA-mean(ClinScore_BA),
               C1_BA = C1_BA-mean(C1_BA)) %>%
        lm(C1_delta ~ ClinScore_delta + C1_BA + ClinScore_BA + Age + Sex, data = .)
tab_model(m,title='Brain-Clinical Associations',digits=5,show.se = T)
Anova(m,type=3) %>% print()
LmPlots(m)
pred <- ggpredict(m, terms='ClinScore_delta')
g <- plot(pred, add.data = TRUE) + theme_bw() + ggtitle('') +
        ylab('Change in activity (Mean, Z)') + xlab('Change in bradykinesia (ON)') +
        annotate('text',y=15,x=-25,label='N=250, β=-0.20, SE=0.04, P<0.001', hjust=0) +
        ylim(-12,15)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/3dttest++_severity_Mean.png',
                  g, dpi=300, device='png', base_width = 5)

# 3dttest++: 3 > 1
# Data reading
dat <- read_csv('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/AFNI/ROI/Masked_full/3dttest++_severity/stats/con_0007_dataTable_21-Feb-2024.txt')
dat <- dat %>%
        mutate(Subj=str_c('sub-POMU', str_sub(Subj,end=16)),
               Sex=factor(Sex),
               RespHandIsDominant = factor(RespHandIsDominant)) %>%
        select(-c(InputFile, voxelwiseBA)) %>%
        rename(C1_BA = con_0007_Severity_T_Delta_brady_ba_cid1,
               C1_delta = con_0007_Severity_T_Delta_brady_cid1) %>%
        relocate(Subj, Sex, Age, YearsSinceDiag_imp, ClinScore_brady_delta, ClinScore_brady_BA, C1_delta, C1_BA)

# Initial visualization
gp <- ggpairs(dat, columns = 2:8, aes(color=Sex, alpha=0.5),
        lower = list(continuous = 'smooth'))
print(gp)

# Analysis
m <- dat %>%
        mutate(Age=Age-mean(Age),
               YearsSinceDiag_imp=YearsSinceDiag_imp-mean(YearsSinceDiag_imp),
               NpsEducYears = NpsEducYears - mean(NpsEducYears),
               ClinScore_brady_delta=ClinScore_brady_delta-mean(ClinScore_brady_delta),
               ClinScore_brady_BA=ClinScore_brady_BA-mean(ClinScore_brady_BA),
               C1_BA = C1_BA-mean(C1_BA)) %>%
        lm(C1_delta ~ ClinScore_brady_delta + C1_BA + ClinScore_brady_BA + Age + Sex + NpsEducYears + YearsSinceDiag_imp + RespHandIsDominant, data = .)
tab_model(m,title='Brain-Clinical Associations',digits=5,show.se = T)
Anova(m,type=3) %>% print()
LmPlots(m)
pred <- ggpredict(m, terms='ClinScore_brady_delta')
cor.test(dat$C1_delta, dat$ClinScore_brady_delta, method = 'spearman')
g <- plot(pred, add.data = TRUE) + theme_bw() + ggtitle('Longitudinal alterations in parieto-premotor activity correlate with clinical progression') +
        ylab('Change in activity (Multiple > Single, Z)') + xlab('Change in bradykinesia (ON)') +
        annotate('text',y=5.2,x=-25,label='N=265, β=-0.051, SE=0.011, P<0.001', hjust=0) +
        ylim(-3.5,5.2)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/3dttest++_severity_23gt1.png',
                  g, dpi=300, device='png', base_width = 5)

#3dLME_severity
dat <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ROI/BG_Parietal/3dLME_severity/stats/con_combined_Severity2_x_Type3_chi_CbCwType_dataTable_03-Apr-2023.txt')
dat <- dat %>%
        select(-c(InputFile)) %>%
        group_by(Subj,TimepointNr,ClinScore_imp_cb,ClinScore_imp_cw,Age,Sex,MonthSinceDiag) %>%
        summarise(con_combined__chi_CbCwType_cid1 = mean(con_combined__chi_CbCwType_cid1),
                  con_combined__chi_CbCwType_cid2 = mean(con_combined__chi_CbCwType_cid2),
                  con_combined__chi_CbCwType_cid3 = mean(con_combined__chi_CbCwType_cid3)) %>%
        ungroup() %>%
        isolate(d = .,
                by = 'Subj',
                value = c('con_combined__chi_CbCwType_cid1','con_combined__chi_CbCwType_cid2','con_combined__chi_CbCwType_cid3'),
                which = 'both')

up3.mean.tab <- dat %>% 
        group_by(TimepointNr) %>% 
        summarise(N=n(),AVG=mean(ClinScore_imp_cb,na.rm=T),SD=sd(ClinScore_imp_cb,na.rm=T)) %>%
        select(-TimepointNr) %>%
        colMeans()

dat <- dat %>% 
        mutate(ClinScore_imp_fct = 0,
               ClinScore_imp_fct = if_else(ClinScore_imp_cb > up3.mean.tab[2]+up3.mean.tab[3],1,ClinScore_imp_fct),
               ClinScore_imp_fct = if_else(ClinScore_imp_cb < up3.mean.tab[2]-up3.mean.tab[3],-1,ClinScore_imp_fct),
               ClinScore_imp_fct=factor(ClinScore_imp_fct))

m <- dat %>%
        mutate(Sex=factor(Sex),
               Age=Age-mean(Age)) %>%
        lmer(con_combined__chi_CbCwType_cid1 ~ ClinScore_imp_cb*ClinScore_imp_cw + Age + Sex + (1|Subj), data = .)
tab_model(m) %>% print()
Anova(m, type=3) %>% print()
eta_squared(m, alternative = 'two.sided')
ggemmeans(m, terms = c('ClinScore_imp_cb')) %>% plot(add.data=T)
ggemmeans(m, terms = c('ClinScore_imp_cw')) %>% plot(add.data=T)
ggemmeans(m, terms = c('ClinScore_imp_cw','ClinScore_imp_cb')) %>% plot(add.data=T)
g1 <- ggplot(dat, aes(y=con_combined__chi_CbCwType_cid1_cb,x=ClinScore_imp_cb)) + 
 geom_point() + 
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Inter-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Brain activity')
g2 <- ggplot(dat, aes(y=con_combined__chi_CbCwType_cid1_cw,x=ClinScore_imp_cw,)) + 
 geom_point() + 
 geom_line(aes(group=Subj),alpha=0.3) +
 geom_smooth(method='lm', color='darkred') + theme_bw() + ggtitle('Intra-subject variability') +
 xlab('MDS-UPDRS III: Bradykinesia') + ylab('Brain activity')
g3 <- ggplot(dat, aes(y=con_combined__chi_CbCwType_cid1_cw,x=ClinScore_imp_cw)) +
        geom_point() +
        geom_line(aes(group=Subj)) +
        geom_smooth(method=lm, color='darkred') +
        facet_grid(~ClinScore_imp_fct)+ theme_bw() + ggtitle('Interaction between variance components') +
 xlab('Change in bradykinesia') + ylab('Change in brain activity')
g <- ggarrange(g1,g2,g3)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/3dLME_severity_clinprog-meanxbxw.png',
                  g, dpi=300, device='png', base_width = 5)



```

## *Spherical ROIs from PMd and SPL (BRAIN, 2024)

```{r sphere_rois, echo=FALSE, warning=TRUE, message=TRUE, eval=T}

# Load data
roi_file <- c('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/ExtractedRoiData/con_combined_ClustROI-both.csv')
if(grepl('con_combined_SphericalROI_2xPrefrontal_2xParietal', roi_file)){
        df.sphere <- read_csv(roi_file) %>%
                select(-c(InputFile,Subtype,YearsToFollowUp,Age_timevar)) %>%
                mutate(PMd_6ma = (vals1 + vals2) / 2,
                       PMd_6a = (vals3 + vals4) / 2,
                       SPL_7ma = (vals5 + vals6) / 2,
                       IPL_PFm = (vals7 + vals8) / 2,
                       PMd = (PMd_6ma + PMd_6a) / 2,
                       Parietal = (SPL_7ma+IPL_PFm) / 2,
                       Avg = (PMd_6ma + PMd_6a + SPL_7ma + IPL_PFm) / 4,
                       MAF_Avg = (vals1 + vals3 + vals5 + vals7) / 4) %>%
                rename(pseudonym = Subj, ParticipantType=Group, 
                       L_PMd_6ma = vals1, R_PMd_6ma = vals2, L_PMd_6a = vals3, R_PMd_6a = vals4,
                       L_SPL_7ma = vals5, R_SPL_7ma = vals6, L_IPL_PFm = vals7, R_IPL_PFm = vals8) %>%
                pivot_longer(cols = c(Avg, MAF_Avg, PMd_6ma, PMd_6a, SPL_7ma, IPL_PFm, PMd, Parietal,
                                      L_PMd_6ma, R_PMd_6ma, L_PMd_6a, R_PMd_6a,
                                      L_SPL_7ma, R_SPL_7ma, L_IPL_PFm, R_IPL_PFm),
                             names_to = 'ROI',
                             values_to = 'Beta') %>%
                pivot_wider(id_cols = c('pseudonym','ParticipantType','TimepointNr','Age','Sex','NpsEducYears','RespHandIsDominant','ROI'),
                            names_from = trial_type,
                            names_prefix = 'Cond_',
                            values_from = 'Beta') %>%
                mutate(SelectionActivity = Cond_23c - Cond_1c,
                       MotorActivity = (Cond_1c + Cond_23c) / 2,
                       TimepointNr = if_else(TimepointNr == 'T0',0,2),
                       TimepointNr = factor(TimepointNr),
                       Sex = factor(Sex),
                       RespHandIsDominant = factor(RespHandIsDominant)) %>%
                left_join(.,
                          dfClin %>% 
                                  filter(TimepointNr != 1) %>%
                                  select(pseudonym,TimepointNr,ParticipantType,YearsSinceDiag,Up3OfBradySum,Up3OnBradySum,
                                         z_MoCA__total, LEDD),
                          by = c('pseudonym','TimepointNr','ParticipantType'))
}else if(grepl('con_0007_SphericalROI_2xPrefrontal_2xParietal', roi_file)){
        df.sphere <- read_csv(roi_file) %>%
                select(-c(InputFile,Subtype,YearsToFollowUp,Age_timevar)) %>%
                mutate(PMd_6ma = (vals1 + vals2) / 2,
                       PMd_6a = (vals3 + vals4) / 2,
                       SPL_7ma = (vals5 + vals6) / 2,
                       IPL_PFm = (vals7 + vals8) / 2,
                       PMd = (PMd_6ma + PMd_6a) / 2,
                       Parietal = (SPL_7ma+IPL_PFm) / 2,
                       Avg = (PMd_6ma + PMd_6a + SPL_7ma + IPL_PFm) / 4,
                       MAF_Avg = (vals1 + vals3 + vals5 + vals7) / 4) %>%
                rename(pseudonym = Subj, ParticipantType=Group, 
                       L_PMd_6ma = vals1, R_PMd_6ma = vals2, L_PMd_6a = vals3, R_PMd_6a = vals4,
                       L_SPL_7ma = vals5, R_SPL_7ma = vals6, L_IPL_PFm = vals7, R_IPL_PFm = vals8) %>%
                pivot_longer(cols = c(Avg, MAF_Avg, PMd_6ma, PMd_6a, SPL_7ma, IPL_PFm, PMd, Parietal,
                                      L_PMd_6ma, R_PMd_6ma, L_PMd_6a, R_PMd_6a,
                                      L_SPL_7ma, R_SPL_7ma, L_IPL_PFm, R_IPL_PFm),
                             names_to = 'ROI',
                             values_to = 'Beta') %>%
                mutate(SelectionActivity = Beta,
                       TimepointNr = if_else(TimepointNr == 'T0',0,2),
                       TimepointNr = factor(TimepointNr),
                       Sex = factor(Sex),
                       RespHandIsDominant = factor(RespHandIsDominant)) %>%
                left_join(.,
                          dfClin %>% 
                                  filter(TimepointNr != 1) %>%
                                  select(pseudonym,TimepointNr,ParticipantType,YearsSinceDiag,Up3OfBradySum,Up3OnBradySum,
                                         z_MoCA__total, LEDD),
                          by = c('pseudonym','TimepointNr','ParticipantType'))
}else if(grepl('con_combined_ClustROI', roi_file)){
        df.sphere <- read_csv(roi_file) %>%
                select(-c(InputFile,Subtype,YearsToFollowUp,Age_timevar)) %>%
                rename(pseudonym = Subj, ParticipantType=Group) %>%
                pivot_longer(cols = c(vals),
                             names_to = 'ROI',
                             values_to = 'Beta') %>%
                pivot_wider(id_cols = c('pseudonym','ParticipantType','TimepointNr','Age','Sex','NpsEducYears','RespHandIsDominant','ROI'),
                            names_from = trial_type,
                            names_prefix = 'Cond_',
                            values_from = 'Beta') %>%
                mutate(SelectionActivity = Cond_23c - Cond_1c,
                       MotorActivity = (Cond_1c + Cond_23c) / 2,
                       ROI = 'ClustROI',
                       TimepointNr = if_else(TimepointNr == 'T0',0,2),
                       TimepointNr = factor(TimepointNr),
                       Sex = factor(Sex),
                       RespHandIsDominant = factor(RespHandIsDominant)) %>%
                # left_join(.,
                #           dfClin %>%
                #                   filter(TimepointNr != 1) %>%
                #                   select(pseudonym,TimepointNr,ParticipantType,YearsSinceDiag,Up3OfBradySum,Up3OnBradySum,
                #                          z_MoCA__total, LEDD),
                #           by = c('pseudonym','TimepointNr','ParticipantType'))
                left_join(.,
                          dfFMRI %>%
                                  filter(ParticipantType=='PD_POM') %>%
                                  group_by(pseudonym, ParticipantType) %>%
                                  summarise(Up3OfBradySum_T0=first(Up3OfBradySum_T0),
                                            Up3OfBradySum_T2=first(Up3OfBradySum_T2),
                                            Up3BradySum.imp_T0=first(Up3BradySum.imp_T0), 
                                            Up3BradySum.imp_T2=first(Up3BradySum.imp_T2),
                                            z_MoCA__total.imp_T0=first(z_MoCA__total.imp_T0),
                                            z_MoCA__total.imp_T2=first(z_MoCA__total.imp_T2),
                                            LEDD.imp_T0=first(LEDD.imp_T0),
                                            LEDD.imp_T2=first(LEDD.imp_T2)) %>%
                                  ungroup() %>%
                                  pivot_longer(cols = Up3OfBradySum_T0:LEDD.imp_T2,
                                               names_pattern = '(.*)_T(.*)',
                                               names_to = c('.value','TimepointNr')))
}else if(grepl('con_0007_ClustROI', roi_file)){
        df.sphere <- read_csv(roi_file) %>%
                select(-c(InputFile,YearsToFollowUp,Age_timevar)) %>%
                rename(pseudonym = Subj, ParticipantType=Group) %>%
                mutate(SelectionActivity=vals,
                       ROI = 'ClustROI',
                       TimepointNr = if_else(TimepointNr == 'T0',0,2),
                       TimepointNr = factor(TimepointNr),
                       Sex = factor(Sex),
                       RespHandIsDominant = factor(RespHandIsDominant)) %>%
                left_join(.,
                          dfClin %>% 
                                  filter(TimepointNr != 1) %>%
                                  select(pseudonym,TimepointNr,ParticipantType,YearsSinceDiag,Up3OfBradySum,Up3OnBradySum,
                                         z_MoCA__total, LEDD),
                          by = c('pseudonym','TimepointNr','ParticipantType'))
        
}

sumtab <- df.sphere %>%
        group_by(ParticipantType,TimepointNr,ROI) %>%
        summarise(N = n(), AVG = mean(SelectionActivity,na.rm=T), SD = sd(SelectionActivity,na.rm=T))
print(sumtab)

plot_fun <- function(dat){
        
        dat1 <- dat
        
        # m <- lm(SelectionActivity ~ Up3OfBradySum + z_MoCA__total + LEDD + Age + Sex + NpsEducYears + RespHandIsDominant, data = dat1)
        m <- lm(SelectionActivity ~ Up3OfBradySum + z_MoCA__total.imp + LEDD.imp + Age + Sex + NpsEducYears + RespHandIsDominant, data = dat1)
        Anova(m,type=3) %>% print()
        tab_model(m, digits=5, show.se = T) %>% print()
        
        # Visualize (http://www.sthda.com/english/wiki/wiki.php?id_contents=7904)
        transparent_theme <- theme(
                axis.title.x = element_blank(),
                axis.title.y = element_blank(),
                axis.text.x = element_blank(), 
                axis.text.y = element_blank(),
                axis.ticks = element_blank(),
                panel.grid = element_blank(),
                axis.line = element_blank(),
                panel.background = element_rect(fill = "transparent",colour = NA),
                plot.background = element_rect(fill = "transparent",colour = NA))
        # g1 <- dat1 %>%
        #         filter(ParticipantType=='PD_POM') %>%
        #         ggplot(aes(x=Up3OfBradySum,y=SelectionActivity)) + 
        #         geom_point(alpha = 0.5) + 
        #         geom_smooth(method='lm', color='darkred') + 
        #         theme_bw() + 
        #         xlim(0,42) + ylim(-2,7) + xlab('Bradykinesia severity (OFF)') + ylab('Beta (Multiple > Single)')
        g1 <- ggemmeans(m, terms = 'Up3OfBradySum') %>% 
                plot(add.data=TRUE,color='darkred') + 
                theme_bw() + 
                ggtitle('') +
                xlim(0,42) + ylim(-2,7) + xlab('Bradykinesia severity (OFF)') + ylab('Beta (Multiple > Single)')
        g2 <- dat1 %>%
                filter(ParticipantType=='HC_PIT') %>%
                ggplot(aes(x=factor(1),y=SelectionActivity)) + 
                geom_jitter(width=0.15,size=1, alpha=0.75, shape=17) + 
                geom_boxplot(width=0.5, alpha=0.75, fill='lightgrey', outlier.shape = NA) +
                ylim(-2,7) +
                transparent_theme
        g2_grob <- ggplotGrob(g2)
        xmin <- min(-5); xmax <- max(43)
        ymin <- min(-2); ymax <- max(5)
        g1 + annotation_custom(grob = g2_grob,
                               xmin = xmin+1, xmax = xmin+10, 
                               ymin = ymin, ymax = ymax)
        
}
g1 <- df.sphere %>% 
        filter(TimepointNr==0,
               ROI=='ClustROI') %>%
        plot_fun() + ggtitle('Baseline')
g2 <- df.sphere %>% 
        filter(TimepointNr==2,
               ROI=='ClustROI') %>%
        plot_fun() + ggtitle('Follow-up') +
        annotate(geom = 'text', x=0, y=-1.9, hjust=0, 
                 label = expression(italic('N')*'= 265, '*italic('β')*' = -0.033, SE = -0.012, '*italic('P')*' = 0.006'),
                 size=3.5)
g <- ggarrange(g1,g2)
print(g)
save_plot('M:/Visualization/R_LongitudinalComparisonFmri/AFNI/ClustROI_Selection_vs_Bradykinesia.png',
                  g, dpi=300, device='png', base_width = 7)

# varnames <- c('PMd_6ma', 'PMd_6a', 'SPL_7ma', 'IPL_PFm', 'PMd', 'Parietal',
#               'L_PMd_6ma', 'R_PMd_6ma', 'L_PMd_6a', 'R_PMd_6a',
#               'L_SPL_7ma', 'R_SPL_7ma', 'L_IPL_PFm', 'R_IPL_PFm')
# for(v in varnames){
#         print(v)
#         g1 <- df.sphere %>% 
#         filter(TimepointNr==0,
#                ROI==v) %>%
#         plot_fun() + ggtitle('Baseline')
# g2 <- df.sphere %>% 
#         filter(TimepointNr==2,
#                ROI==v) %>%
#         plot_fun() + ggtitle('Follow-up')
# ggarrange(g1,g2)
# }

```


## Extracted betas: Group comparison

```{r roi-beta-disease, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

dat <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ROI_BetaExtraction/con_combined_disease_20-Mar-2023_dataTable.txt')

b1 <- dat %>%
        select(Subj, Group, TimepointNr, trial_type, Age, Sex, HCgtPD_Mean_1_bilat_cid1_Mean, Neg_Parietal_bilat_cid1_Mean) %>%
        select(!contains('PCA')) %>%
        rowwise() %>%
        mutate(Pathology = HCgtPD_Mean_1_bilat_cid1_Mean,
               Compensation = Neg_Parietal_bilat_cid1_Mean) %>%
        select(Subj, Group, TimepointNr, trial_type, Age, Sex, Pathology, Compensation)

b1 %>%
        select(Group,TimepointNr,trial_type) %>%
        table()

b2 <- b1 %>%
        pivot_longer(cols = c('Pathology','Compensation'),
                     names_to = 'Network',
                     values_to = 'Beta')

m <- lmer(Beta ~ Group*TimepointNr*trial_type*Network+Age+factor(Sex)+(1+Network|Subj), data = b2)
tab_model(m)
Anova(m, type=3) %>% print()
ggemmeans(m, terms=c('TimepointNr','Group','Network')) %>% plot(connect.lines=TRUE) %>%
        save_plot('M:/Visualization/R_LongitudinalComparisonFmri/ROI_Extraction_Group-CompVSPath.jpeg', ., dpi=300)
em <- emmeans(m, ~ TimepointNr*Group|Network)
contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'), by=NULL)
contrast(em, interaction = c('revpairwise','revpairwise','revpairwise'))

# ##### Testing correspondence between full LMER analysis and baseline-corrected 3dttest++
# # Near-threshold clusters from full LMER analysis
# dat <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ROI/3dLME_disease/stats/con_combined_dataTable_31-Jan-2023.txt')
# dat
# colnames(dat)
# dat.e <- dat %>%
#     rename(beta = con_combined__Z_TimeGroupType2gt1_cid1)
# summary(dat.e$beta)
# dat.e %>%
#     ggplot(aes(x=TimepointNr,y=beta,color=trial_type)) +
#     geom_boxplot() +
#     facet_grid(~Group)
# m <- lmer(beta ~ Group*TimepointNr*trial_type + Age + Sex + (1+TimepointNr|Subj), data = dat.e)
# Anova(m, type=3)
# ggemmeans(m, terms = c('Group','trial_type','TimepointNr')) %>% plot()
# 
# dat.e %>%
#         filter(trial_type != '3c') %>%
#         pivot_wider(id_cols = c('Subj','Group','Age','Sex','TimepointNr'),
#                     names_from = trial_type,
#                     values_from = beta) %>%
#         mutate(con12 = `2c`-`1c`) %>%
#         ggplot(aes(y=con12,x=Group,color=TimepointNr)) +
#         geom_boxplot()
# # Corresponding analyses of 3dttest++
# # Con 12
# dat <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ROI/3dttest++/stats/con_0012_dataTable_01-Feb-2023.txt')
# dat
# colnames(dat)
# dat.e <- dat %>%
#     rename(beta = con_0012_PDvsHC_T_Delta_cid1) %>%
#         mutate(Group = if_else(str_detect(InputFile,'HC_PIT'),'HC','PD'),
#                Group = factor(Group))
# summary(dat.e$beta)
# dat.e %>%
#     ggplot(aes(x=Group,y=beta)) +
#     geom_boxplot()
# m <- lm(beta ~ Group + Age + factor(Sex), data = dat.e)
# Anova(m, type=3)
# ggemmeans(m, terms = c('Group')) %>% plot()
# 
# # Conclusion: Full LMER and 3dttest++ yields the same clusters. The latter is more sensitive (or more wrong?)
# # At the very least, it shows that the two approaches work similarly, which should be the case

```

## Extracted betas: Brain-clinical associations, post hoc analysis of BG vs. Parietal

```{r roi-beta-severity, echo=FALSE, warning=TRUE, message=TRUE, eval=FALSE}

dat <- read_csv('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Longitudinal/AFNI/ON_ANALYSES/ROI_BetaExtraction/con_combined_severity_12-Apr-2023_dataTable.txt')
dat <- dat %>%
        select(Subj,TimepointNr,trial_type,Sex,Age,YearSinceDiag_imp,ClinScore_imp,starts_with('a_Pathology')) %>%
        rename(Putamen.lr=a_Pathology1_vs_Compensation23_cid1_Mean,
               Parietal.lr=a_Pathology1_vs_Compensation23_cid2_Mean,
               Premotor.lr=a_Pathology1_vs_Compensation23_cid3_Mean)

# Collapse by condition
dat.c <- dat %>%
        pivot_wider(id_cols = c('Subj','TimepointNr','Sex','Age','YearSinceDiag_imp','ClinScore_imp'),
                    names_from = trial_type,
                    values_from = c(Putamen.lr,Parietal.lr,Premotor.lr)) %>%
        mutate(Putamen.lr_3gt1 = Putamen.lr_3c - Putamen.lr_1c,
               Putamen.lr_2gt1 = Putamen.lr_2c - Putamen.lr_1c,
               Putamen.lr_Mean = (Putamen.lr_3c + Putamen.lr_2c + Putamen.lr_1c)/3,
               Parietal.lr_3gt1 = Parietal.lr_3c - Parietal.lr_1c,
               Parietal.lr_2gt1 = Parietal.lr_2c - Parietal.lr_1c,
               Parietal.lr_Mean = (Parietal.lr_3c + Parietal.lr_2c + Parietal.lr_1c)/3,
               Premotor.lr_3gt1 = Premotor.lr_3c - Premotor.lr_1c,
               Premotor.lr_2gt1 = Premotor.lr_2c - Premotor.lr_1c,
               Premotor.lr_Mean = (Premotor.lr_3c + Premotor.lr_2c + Premotor.lr_1c)/3)
# Collapse by time
dat.c <- dat.c %>%
        pivot_wider(id_cols = c('Subj','Sex','Age','YearSinceDiag_imp'),
                    names_from = TimepointNr,
                    names_sep = '_',
                    values_from = c('Putamen.lr_3gt1','Putamen.lr_2gt1','Putamen.lr_Mean',
                                    'Parietal.lr_3gt1','Parietal.lr_2gt1','Parietal.lr_Mean',
                                    'Premotor.lr_3gt1','Premotor.lr_2gt1','Premotor.lr_Mean',
                                    'ClinScore_imp')) %>%
        mutate(Putamen.lr_3gt1_Delta = Putamen.lr_3gt1_T1 - Putamen.lr_3gt1_T0,
               Putamen.lr_2gt1_Delta = Putamen.lr_2gt1_T1 - Putamen.lr_2gt1_T0,
               Putamen.lr_Mean_Delta = Putamen.lr_Mean_T1 - Putamen.lr_Mean_T0,
               Parietal.lr_3gt1_Delta = Parietal.lr_3gt1_T1 - Parietal.lr_3gt1_T0,
               Parietal.lr_2gt1_Delta = Parietal.lr_2gt1_T1 - Parietal.lr_2gt1_T0,
               Parietal.lr_Mean_Delta = Parietal.lr_Mean_T1 - Parietal.lr_Mean_T0,
               Premotor.lr_3gt1_Delta = Premotor.lr_3gt1_T1 - Premotor.lr_3gt1_T0,
               Premotor.lr_2gt1_Delta = Premotor.lr_2gt1_T1 - Premotor.lr_2gt1_T0,
               Premotor.lr_Mean_Delta = Premotor.lr_Mean_T1 - Premotor.lr_Mean_T0,
               ClinScore_imp_Delta = ClinScore_imp_T1 - ClinScore_imp_T0) %>%
        na.omit()
# Remove baseline variability from follow-up bradykinesia measurement
m1 <- dat.c %>%
        mutate(ClinScore_imp_T0=ClinScore_imp_T0-mean(ClinScore_imp_T0)) %>%
        lm(ClinScore_imp_T1 ~ ClinScore_imp_T0, data = .)
dat.c <- bind_cols(dat.c, ClinScore_imp_T1.resid = resid(m1))
m1 <- dat.c %>%
        mutate(ClinScore_imp_T0=ClinScore_imp_T0-mean(ClinScore_imp_T0)) %>%
        lm(ClinScore_imp_Delta ~ ClinScore_imp_T0, data = .)
dat.c <- bind_cols(dat.c, ClinScore_imp_Delta.resid = resid(m1))
# Separate variables
dat.c <- dat.c %>%
        select(Subj,Sex,Age,YearSinceDiag_imp, starts_with('ClinScore'), starts_with('Putamen'), starts_with('Parietal'), starts_with('Premotor')) %>%
        pivot_longer(cols = c(starts_with('Putamen'), starts_with('Parietal'), starts_with('Premotor')),
                     names_to = c('Region','Composite','Timepoint'),
                     names_pattern = '(.*)_(.*)_(.*)',
                     values_to = 'Value') %>%
        pivot_wider(id_cols = c('Subj','Age','Sex','YearSinceDiag_imp','ClinScore_imp_T0','ClinScore_imp_T1',
                                'ClinScore_imp_Delta','ClinScore_imp_T1.resid','ClinScore_imp_Delta.resid','Region','Composite'),
                    names_from = Timepoint,
                    names_prefix = 'Beta_',
                    values_from = Value) %>%
        relocate(Subj,Sex,Age,YearSinceDiag_imp,Region) %>%
        mutate(Sex=factor(Sex),
               Region=factor(Region))
# Separate by composite
dat.c.mean <- dat.c %>% filter(Composite=='Mean') %>% select(-Composite)
dat.c.2gt1 <- dat.c %>% filter(Composite=='2gt1') %>% select(-Composite)
dat.c.3gt1 <- dat.c %>% filter(Composite=='3gt1') %>% select(-Composite)
# Remove baseline variability from follow-up activity measurement
ResidualizeChange <- function(dat){
        
        m1 <- dat %>%
                mutate(Beta_T0=Beta_T0-mean(Beta_T0)) %>%
                lm(Beta_T1 ~ Beta_T0, data = .)
        dat <- bind_cols(dat, Beta_T1.resid = resid(m1))
        
        m2 <- dat %>%
                mutate(Beta_T0=Beta_T0-mean(Beta_T0)) %>%
                lm(Beta_Delta ~ Beta_T0, data = .)
        dat <- bind_cols(dat, Beta_Delta.resid = resid(m1))
        
        return(dat)
}
dat.c.mean <- ResidualizeChange(dat.c.mean)
dat.c.2gt1 <- ResidualizeChange(dat.c.2gt1)
dat.c.3gt1 <- ResidualizeChange(dat.c.3gt1)
# Analysis
AnalyzeChangeCorrs <- function(dat, cname){
        
        # Initial visualization
        # gp <- ggpairs(dat, columns = 2:14, aes(color=Region, alpha=0.5),
        #               lower = list(continuous = 'smooth'))
        # print(gp)
        
        m <- dat %>%
                mutate(Age=Age-mean(Age),
                       YearSinceDiag_imp=YearSinceDiag_imp-mean(YearSinceDiag_imp),
                       ClinScore_imp_Delta=ClinScore_imp_Delta-mean(ClinScore_imp_Delta),
                       ClinScore_imp_T0=ClinScore_imp_T0-mean(ClinScore_imp_T0),
                       Beta_T0 = Beta_T0-mean(Beta_T0)) %>%
                lmer(Beta_Delta ~ ClinScore_imp_Delta*Region + Beta_T0 + ClinScore_imp_T0 + Age + Sex + YearSinceDiag_imp + (1|Subj), data = .)
        tab_model(m,title='Brain-Clinical Associations',digits=5,show.se=T)
        s <- summary(m)
        label <- paste('N=251, β=',round(s$coefficients[9,1],digits=3), ', SE=', round(s$coefficients[9,2],digits=3),
                       ', P=', round(s$coefficients[9,5],digits=3), sep='')
        Anova(m,type=3) %>% print()
        eta_squared(m) %>% print()
        print(s)
        plot(m)
        qqmath(m)
        qqmath(ranef(m))
        pred <- ggemmeans(m, terms=c('ClinScore_imp_Delta','Region'))
        g <- plot(pred, add.data = TRUE) + theme_bw() + ggtitle('') +
                ylab(str_c('Change in beta (', cname, ', Z)',sep='')) + xlab('Change in bradykinesia') +
                scale_color_viridis_d(option='mako', begin = .1, end = .6,
                                      direction = -1, labels=c('Premotor','Putamen')) +
                scale_fill_viridis_d(option='mako', begin = .1, end = .6,
                                      direction = -1) + 
                annotate(geom='text',label=label,x=-5,y=-2.5)
        print(g)
        save_plot(str_c('M:/Visualization/R_LongitudinalComparisonFmri/ClinCorr_', cname, '.jpeg',sep=''),
                  g, dpi=300, device='jpeg', base_width = 5)
        
}
dat.c.mean %>%
        filter(Region=='Putamen.lr' | Region=='Premotor.lr') %>%
        AnalyzeChangeCorrs(.,'mean')
dat.c.2gt1 %>%
        filter(Region=='Putamen.lr' | Region=='Premotor.lr') %>%
        AnalyzeChangeCorrs(.,'2-1')
dat.c.3gt1 %>%
        filter(Region=='Putamen.lr' | Region=='Premotor.lr') %>%
        AnalyzeChangeCorrs(.,'3-1')

dat.c.mean2 <- dat.c.mean %>%
        filter(Region=='Putamen.lr' | Region=='Premotor.lr')  %>%
        mutate(Age=Age-mean(Age),
               YearSinceDiag_imp=YearSinceDiag_imp-mean(YearSinceDiag_imp),
               ClinScore_imp_Delta=ClinScore_imp_Delta-mean(ClinScore_imp_Delta),
               ClinScore_imp_T0=ClinScore_imp_T0-mean(ClinScore_imp_T0),
               Beta_T0 = Beta_T0-mean(Beta_T0))
m <- lmer(Beta_Delta ~ ClinScore_imp_Delta*Region + Beta_T0 + ClinScore_imp_T0 + Age + Sex + YearSinceDiag_imp + (1|Subj), data = dat.c.mean2)
s <- summary(m)
m.cortex <- dat.c.mean2 %>%
        filter(Region=='Premotor.lr') %>%
        lm(Beta_Delta ~ ClinScore_imp_Delta + Beta_T0 + ClinScore_imp_T0 + Age + Sex + YearSinceDiag_imp, data = .)
s.cortex <- summary(m.cortex)
m.putamen <- dat.c.mean2 %>%
        filter(Region=='Putamen.lr') %>%
        lm(Beta_Delta ~ ClinScore_imp_Delta + Beta_T0 + ClinScore_imp_T0 + Age + Sex + YearSinceDiag_imp, data = .)
s.putamen <- summary(m.putamen)
label <- paste('N=250, β=',round(s$coefficients[9,1],digits=3), ', SE=', round(s$coefficients[9,2],digits=3),
               ', P=', round(s$coefficients[9,5],digits=3), sep='')
pred <- ggemmeans(m, terms=c('ClinScore_imp_Delta','Region'))
g <- plot(pred, add.data = TRUE) + theme_bw() + ggtitle('') +
        ylab(str_c('Change in motor-related activity (Z)',sep='')) + xlab('Change in bradykinesia') +
        scale_color_viridis_d(option='mako', begin = .1, end = .6,
                              direction = -1, labels=c('Premotor','Putamen')) +
        scale_fill_viridis_d(option='mako', begin = .1, end = .6,
                             direction = -1) + 
        annotate(geom='text', label='REGION x PROGRESSION', x=-25,y=4.5, hjust=0) + 
        annotate(geom='text',label=label,x=-25,y=4, hjust=0) + 
        ylim(-3,4.5)
print(g)
save_plot(str_c('M:/Visualization/R_LongitudinalComparisonFmri/ClinCorr_PremotorVsPutamen.png',sep=''),
          g, dpi=300, device='png', base_width = 5)

```


<!-- # Check of numbers prior to exclusions -->

<!-- ```{r echo=FALSE, warning=TRUE, message=TRUE} -->

<!-- # How many have succesfully done the task at both time points? -->

<!-- tmp <- df %>% -->
<!--         filter(event_type=='response') %>% -->
<!--         select(pseudonym,ParticipantType,TimepointNr,trial_type, response_time, Percentage.Correct, -->
<!--                Up3OfTotal, Up3OfAppendicularSum, Up3OfTotal.2YearDelta, Up3OfAppendicularSum.2YearDelta) -->

<!-- performance <- tmp %>% -->
<!--         group_by(pseudonym, ParticipantType, TimepointNr, trial_type) %>% -->
<!--         summarise(across(c(response_time, Percentage.Correct), ~ median(.x, na.rm=TRUE))) %>% -->
<!--         ungroup() %>% -->
<!--         na.omit() -->

<!-- performance %>% group_by(ParticipantType, TimepointNr, trial_type) %>% summarise(N=n(), -->
<!--                                                              RT.avg = mean(response_time,na.rm=TRUE), -->
<!--                                                              RT.sd = sd(response_time,na.rm=TRUE), -->
<!--                                                              ACC.avg = mean(Percentage.Correct,na.rm=TRUE), -->
<!--                                                              ACC.sd = sd(Percentage.Correct,na.rm=TRUE)) -->

<!-- g_plot <- ggplot(performance, aes(y=response_time, x = ParticipantType, fill = TimepointNr)) +  -->
<!--         geom_boxplot(size = 1.5, outlier.size = 3) + -->
<!--         facet_grid(~trial_type,  -->
<!--                    labeller = labeller(trial_type = c(`1choice` = 'One choice', -->
<!--                                                       `2choice` = 'Two choices', -->
<!--                                                       `3choice` = 'Three choices'))) + -->
<!--         scale_fill_viridis_d(option = 'viridis', begin = 0.3, end = 0.5, direction = -1, -->
<!--                              name = 'Timepoint', -->
<!--                              label = c('Baseline','Follow-up')) + -->
<!--         scale_x_discrete(labels=c('Healthy control','Patient')) + -->
<!--         theme_cowplot(font_size = 25) + -->
<!--         xlab('Group') + ylab('Response time (s)') + -->
<!--         ggtitle('2-year progression of task performance') -->
<!-- print(g_plot) -->

<!-- # How many have full progression data? -->

<!-- progression <- tmp %>% -->
<!--         filter(ParticipantType == 'PD_POM') %>% -->
<!--         group_by(pseudonym, TimepointNr) %>% -->
<!--         summarise(across(c(Up3OfTotal, Up3OfAppendicularSum, -->
<!--                            Up3OfTotal.2YearDelta, Up3OfAppendicularSum.2YearDelta), ~ mean(.x, na.rm=TRUE))) %>% -->
<!--         ungroup() -->

<!-- progression %>%  -->
<!--         group_by(TimepointNr) %>%  -->
<!--         summarise(N=n(), -->
<!--                   Total.avg = mean(Up3OfTotal,na.rm=TRUE), -->
<!--                   Total.sd = sd(Up3OfTotal,na.rm=TRUE), -->
<!--                   App.avg = mean(Up3OfAppendicularSum,na.rm=TRUE), -->
<!--                   App.sd = sd(Up3OfAppendicularSum,na.rm=TRUE), -->
<!--                   Prog.avg = mean(Up3OfTotal.2YearDelta,na.rm=TRUE), -->
<!--                   Prog.sd = sd(Up3OfTotal.2YearDelta,na.rm=TRUE)) -->

<!-- lines <- ggplot(progression, aes(y = Up3OfTotal, x = TimepointNr, group = pseudonym)) + -->
<!--         geom_line(aes(color=Up3OfTotal.2YearDelta), alpha = 0.3, lwd=1.5) + -->
<!--         geom_jitter(alpha = 0.2, width = 0.01, size=4) +  -->
<!--         scale_color_viridis_c(option = 'inferno', name = '2-year \nprogression') + -->
<!--         scale_x_discrete(labels=c('Baseline','Follow-up')) + -->
<!--         theme_cowplot(font_size = 25) + -->
<!--         xlab('Timepoint') + ylab('MDS-UPDRS III total score') -->

<!-- boxes <- ggplot(progression, aes(y = Up3OfTotal, x = TimepointNr, fill = TimepointNr)) + -->
<!--         geom_boxplot(size = 1.5, outlier.size = 3) + -->
<!--         scale_fill_viridis_d(option = 'viridis', begin = 0.3, end = 0.5, direction = -1) + -->
<!--         scale_x_discrete(labels=c('Baseline','Follow-up')) + -->
<!--         theme_cowplot(font_size = 25) + -->
<!--         xlab('Timepoint') + ylab('MDS-UPDRS III total score') + -->
<!--         theme(legend.position = 'none') -->

<!-- plot <- ggarrange(boxes, lines) -->
<!-- plot <- annotate_figure(plot, top = text_grob('2-year progression of motor symptoms', size=30, face = 'bold')) -->
<!-- print(plot) -->

<!-- # plot <- raincloudplot_1Factor(progression, 'Up3OfTotal', c('TimepointNr'), title = '2-year progression of motor symptoms', -->
<!-- #                                       xlab='Time', ylab='MDS-UPDRS III total score', xticklabs = c('Baseline','Follow-up'), -->
<!-- #                                       color_scheme = 'viridis') %>% print() -->


<!-- ``` -->


<!-- # Descriptives -->

<!-- ```{r echo=FALSE, warning=TRUE, message=TRUE} -->

<!-- y <- df %>% -->
<!--   select(pseudonym, TimepointNr, response_time, Percentage.Correct, Button.Press.SwitchRatio, Button.Press.CoV) %>% -->
<!--   group_by(pseudonym, TimepointNr) %>% -->
<!--   summarise(across(where(is.numeric), ~mean(.x,na.rm=TRUE))) -->

<!-- gvars <- df %>% -->
<!--   filter(TimepointNr==0) %>% -->
<!--   group_by(pseudonym) %>% -->
<!--   select(pseudonym, ParticipantType, Age, Gender) %>% -->
<!--   summarise(across(everything(), ~first(.x))) -->

<!-- y <- left_join(y, gvars, by='pseudonym') -->

<!-- ggplot(y, aes(y=response_time, fill=ParticipantType)) +  -->
<!--   geom_boxplot() + -->
<!--   facet_grid(~TimepointNr) + -->
<!--   ggtitle('Average response times') %>% -->
<!--   print() -->

<!-- ggplot(y, aes(y=Percentage.Correct, fill=ParticipantType)) +  -->
<!--   geom_boxplot() + -->
<!--   facet_grid(~TimepointNr) + -->
<!--   ggtitle('Average accuracy') %>% -->
<!--   print() -->

<!-- ``` -->



<!-- em <- emtrends(fit, ~ degree*ParticipantType*trial_type | Age_Dmean, 'Age_Dmean', max.degree = 3, at = list(Age_Dmean=c(0,2.3))) -->
<!--         contrast(em, interaction = c('identity','revpairwise','revpairwise'), adjust = 'mvt') -->
<!--         g <- ggplot(tmp, aes(x=Age,y=response_time,color=ParticipantType)) +  -->
<!--                 geom_point() +  -->
<!--                 geom_line(aes(group=pseudonym)) +  -->
<!--                 facet_wrap(~trial_type+ParticipantType, nrow = 3,ncol = 6) +  -->
<!--                 geom_smooth(color='black') -->
<!--         print(g) -->


<!-- # compare_rts <- function(f, tmp, tmp.collapsed){ -->
<!-- #    -->
<!-- #         # Fit model -->
<!-- #         print(paste('Fitting the following model:', f, sep=' ')) -->
<!-- #         fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->
<!-- #         # outliers <- outlierTest(fit)[[1]] %>% names() %>% as.numeric() -->
<!-- #         # fit <- lmer(f, data=tmp[-c(outliers), ], control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->
<!-- #         s <- summary(fit) -->
<!-- #         # print(s, corr = FALSE, digits = 3) -->
<!-- #         anova <- Anova(fit,type=3) -->
<!-- #         print(anova) -->
<!-- #         eta_squared(fit, alternative = 'two.sided') %>% print() -->
<!-- #          -->
<!-- #         # Post hoc test -->
<!-- #         em <- emmeans(fit, ~ trial_type|ParticipantType, type='response') -->
<!-- #         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, ~ trial_type|ParticipantType, type='response') -->
<!-- #         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!-- #         emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response') -->
<!-- #         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response') -->
<!-- #         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!-- #         emmip(fit, ParticipantType ~ TimepointNr, type='response', CIs=TRUE) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, ~ trial_type|TimepointNr, type='response') -->
<!-- #         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, ~ trial_type|TimepointNr, type='response') -->
<!-- #         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!-- #         emmip(fit, trial_type ~ TimepointNr, type='response', CIs=TRUE) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt') -->
<!-- #         kable(em$emmeans,'pipe', digits = 3) %>% print() -->
<!-- #         kable(em$contrasts,'pipe', digits = 3) %>% print() -->
<!-- #         emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, revpairwise ~ TimepointNr, type='response', adjust='mvt') -->
<!-- #         kable(em$emmeans,'pipe', digits = 3) %>% print() -->
<!-- #         kable(em$contrasts,'pipe', digits = 3) %>% print() -->
<!-- #         emmip(fit, ~ TimepointNr, type='response', CIs=TRUE) %>% print() -->
<!-- #          -->
<!-- #         em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt') -->
<!-- #         kable(em$emmeans,'pipe', digits = 3) %>% print() -->
<!-- #         kable(em$contrasts,'pipe', digits = 3) %>% print() -->
<!-- #         emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print() -->
<!-- #          -->
<!-- #         # Visualization -->
<!-- #         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->
<!-- #         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->
<!-- #          -->
<!-- #         # Summary stats -->
<!-- #                 # emmip with plotit=FALSE gives a table of summarystats that is very handy -->
<!-- #                 # Some adjustments make it usable for the raincloudplot function below -->
<!-- #         emm.summary <- emmip(fit, ParticipantType ~ TimepointNr | trial_type, plotit = FALSE, type = 'response') %>% -->
<!-- #                 tibble() %>% -->
<!-- #                 rename(mean = yvar, -->
<!-- #                        se = SE) %>% -->
<!-- #                 select(-c(df, tvar, xvar)) %>% -->
<!-- #                 mutate(ci = se*1.96) -->
<!-- #         kable(emm.summary,'pipe', digits = 3) %>% print() -->
<!-- #          -->
<!-- #         # Plots -->
<!-- #         N <- tmp  %>%  -->
<!-- #                 group_by(pseudonym, ParticipantType, TimepointNr) %>% -->
<!-- #                 summarise(across(everything(), ~first(.x))) %>% -->
<!-- #                 ungroup() %>% -->
<!-- #                 select(ParticipantType, TimepointNr) %>% -->
<!-- #                 table() -->
<!-- #         kable(N, 'pipe') %>% print() -->
<!-- #         plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time', -->
<!-- #                               groupvar=c('trial_type','TimepointNr'), -->
<!-- #                               title='Influence of Parkinson\'s disease \non response times', -->
<!-- #                               xlab='Timepoint', ylab='Response time (s)', -->
<!-- #                               xticklabs=c('Baseline', -->
<!-- #                                           'Two years'), -->
<!-- #                               legend_title = '', -->
<!-- #                               legend_labels = c('One','Two','Three'), -->
<!-- #                               legend_position = legend_position, -->
<!-- #                               provided_summary = 'None') + -->
<!-- #                 ylim(0.3,2) +  -->
<!-- #                 facet_grid(~ParticipantType) -->
<!-- #         # y <- 1.75 -->
<!-- #         # d = 0.12 -->
<!-- #         # segmap <- data.frame( -->
<!-- #         #         x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  0.80,  1.80,  1.80), -->
<!-- #         #         xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  1.00,  1.20,  2.00,  2.20), -->
<!-- #         #         y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3), -->
<!-- #         #         yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3) -->
<!-- #         # ) -->
<!-- #         # sigmap <- data.frame( -->
<!-- #         #         x =     c(1.50,  0.90,  1.00,  1.90,  2.00), -->
<!-- #         #         y =     c(y,     y-d*2, y-d*3, y-d*2, y-d*3), -->
<!-- #         #         label = c('***', '***', '***', '***', '***') -->
<!-- #         # ) -->
<!-- #         # plot <- plot +  -->
<!-- #         #         geom_segment(data=segmap, -->
<!-- #         #                      mapping = aes(x=x,xend=xend,y=y,yend=yend), -->
<!-- #         #                      inherit.aes = FALSE, -->
<!-- #         #                      size = lsize) + -->
<!-- #         #         geom_text(data=sigmap,  -->
<!-- #         #                   mapping = aes(x=x,y=y,label=label), -->
<!-- #         #                   inherit.aes = FALSE, -->
<!-- #         #                   size = sigsize) -->
<!-- #         print(plot) -->
<!-- #         # save_plot('M:/Visualization/R_BaselineComparisonFmri/RT_HCvsON.tiff', -->
<!-- #         #   plot, dpi=300, device='tiff', base_width = 5) -->
<!-- #          -->
<!-- #         tplot <- emmip(fit, ParticipantType~trial_type|TimepointNr, CIs = TRUE, -->
<!-- #                        type='response') + -->
<!-- #                 scale_x_discrete(labels=c('One','Two','Three')) +  -->
<!-- #                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->
<!-- #                                        direction = -1,labels=c('Control','PD-On')) + -->
<!-- #                 ggtitle('') + ylab('Predicted response times (s)') + -->
<!-- #                 xlab('Group') +  -->
<!-- #                 guides(color=guide_legend(title='Group', reverse = FALSE)) + -->
<!-- #                 theme_cowplot(font_size = 20) -->
<!-- #         print(tplot) -->
<!-- #          -->
<!-- #         # Diagnostics -->
<!-- #         plot(fit) %>% print() -->
<!-- #         # qqmath(fit) %>% print() -->
<!-- #         qqmath(ranef(fit)) %>% print() -->
<!-- #          -->
<!-- # } -->

<!-- compare_correct <- function(f, tmp, tmp.collapsed){ -->

<!--         # Fit model -->
<!--         print(paste('Fitting the following model:', f, sep=' ')) -->
<!--         fit <- glmer(f, data=tmp, family = binomial, weights = n_trials, -->
<!--                      control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->
<!--         s <- summary(fit) -->
<!--         # print(s, corr = FALSE) -->
<!--         anova <- Anova(fit, type = 'III') -->
<!--         print(anova) -->
<!--         se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/ -->
<!--         tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se) -->
<!--         exp(tab) %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->

<!--         # Post hoc test -->
<!--         em <- emmeans(fit, ~ trial_type|ParticipantType, type='response') -->
<!--         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->

<!--         em <- emmeans(fit, ~ trial_type|ParticipantType, type='response') -->
<!--         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!--         emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print() -->

<!--         em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response') -->
<!--         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->

<!--         em <- emmeans(fit, ~ TimepointNr|ParticipantType, type='response') -->
<!--         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!--         emmip(fit, ParticipantType ~ TimepointNr, type='response', CIs=TRUE) %>% print() -->

<!--         em <- emmeans(fit, ~ trial_type|TimepointNr, type='response') -->
<!--         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response', by=NULL) %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->

<!--         em <- emmeans(fit, ~ trial_type|TimepointNr, type='response') -->
<!--         contrast(em, interaction = c('revpairwise','revpairwise'), adjust='mvt', type='response') %>% kable(., 'pipe', digits = 3, padding=0) %>% print() -->
<!--         emmip(fit, trial_type ~ TimepointNr, type='response', CIs=TRUE) %>% print() -->

<!--         em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt') -->
<!--         kable(em$emmeans,'pipe', digits = 3) %>% print() -->
<!--         kable(em$contrasts,'pipe', digits = 3) %>% print() -->
<!--         emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print() -->

<!--         em <- emmeans(fit, revpairwise ~ TimepointNr, type='response', adjust='mvt') -->
<!--         kable(em$emmeans,'pipe', digits = 3) %>% print() -->
<!--         kable(em$contrasts,'pipe', digits = 3) %>% print() -->
<!--         emmip(fit, ~ TimepointNr, type='response', CIs=TRUE) %>% print() -->

<!--         em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt') -->
<!--         kable(em$emmeans,'pipe', digits = 3) %>% print() -->
<!--         kable(em$contrasts,'pipe', digits = 3) %>% print() -->
<!--         emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print() -->

<!--         # Visualization -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->
<!--         N <- tmp  %>%  -->
<!--                 group_by(pseudonym, ParticipantType, TimepointNr) %>% -->
<!--                 summarise(across(everything(), ~first(.x))) %>% -->
<!--                 ungroup() %>% -->
<!--                 select(ParticipantType, TimepointNr) %>% -->
<!--                 table() -->
<!--         kable(N, 'pipe') %>% print() -->
<!--         plot <- raincloudplot_2Factor(data=tmp.collapsed, y='error_rate', -->
<!--                               groupvar=c('trial_type','TimepointNr'), -->
<!--                               title='Influence of Parkinson\'s \ndisease on error rates', -->
<!--                               xlab='', ylab='Errors (%)', -->
<!--                               xticklabs=c('Baseline','Two years'), -->
<!--                               legend_title = '', -->
<!--                               legend_labels = c('One','Two','Three'), -->
<!--                               legend_position = legend_position, -->
<!--                               provided_summary = 'None') + -->
<!--                 ylim(0,100) +  -->
<!--                 facet_grid(~ParticipantType) -->
<!--         # y <- 70 -->
<!--         # d = 6 -->
<!--         # segmap <- data.frame( -->
<!--         #         x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  1.80,  2.00), -->
<!--         #         xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  2.20,  2.20), -->
<!--         #         y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3), -->
<!--         #         yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3) -->
<!--         # ) -->
<!--         # sigmap <- data.frame( -->
<!--         #         x =     c(1.50,  2.00,  2.10), -->
<!--         #         y =     c(y,     y-d*2, y-d*3), -->
<!--         #         label = c('**', '***', '***') -->
<!--         # ) -->
<!--         # plot <- plot + -->
<!--         #         geom_segment(data=segmap, -->
<!--         #                      mapping = aes(x=x,xend=xend,y=y,yend=yend), -->
<!--         #                      inherit.aes = FALSE, -->
<!--         #                      size = lsize) + -->
<!--         #         geom_text(data=sigmap, -->
<!--         #                   mapping = aes(x=x,y=y,label=label), -->
<!--         #                   inherit.aes = FALSE, -->
<!--         #                   size = sigsize) -->
<!--         print(plot) -->
<!--         # save_plot('M:/Visualization/R_BaselineComparisonFmri/XXXXXXXAccuracy_HCvsON.tiff', -->
<!--         #   plot, dpi=300, device='tiff', base_width = 5) -->

<!-- } -->



<!-- ## ON, Bradykinesia-rigidity ~ RTs -->

<!-- ```{r echo = FALSE, warning = TRUE} -->

<!-- # Fit model -->
<!-- tmp.clincorr <- df %>% -->
<!--         filter(ParticipantType=='PD_POM') %>% -->
<!--         filter(event_type == 'response') %>% -->
<!--         filter(trial_type != 'Catch') %>% -->
<!--         filter(response_time > 0.3) %>% -->
<!--         filter(correct_response=='Hit') %>% -->
<!--         filter(!(pseudonym %in% poor_performance$pseudonym)) %>% -->
<!--         mutate(ParticipantType = droplevels(ParticipantType), -->
<!--                trial_type = droplevels(trial_type), -->
<!--                Up3OfBradySum = if_else(TimepointNr=='0',Up3OfBradySym.ba,Up3OfBradySym.ba+Up3OfBradySym.RawChange)) %>% -->
<!--         select(pseudonym, ParticipantType, TimepointNr, Up3OfBradySym.ba, Up3OfBradySym.RawChange, Up3OfBradySum, trial_type, block,  -->
<!--                Age, Gender, response_time) -->
<!-- tmp.clincorr <- tmp.clincorr %>% -->
<!--         group_by(pseudonym, TimepointNr, trial_type, block) %>% -->
<!--         summarise(ParticipantType = first(ParticipantType), -->
<!--                   response_time = median(response_time,na.rm=TRUE), -->
<!--                   Up3OfBradySum = first(Up3OfBradySum), -->
<!--                   Up3OfBradySym.ba = first(Up3OfBradySym.ba), -->
<!--                   Up3OfBradySym.RawChange = first(Up3OfBradySym.RawChange), -->
<!--                   Age = first(Age), -->
<!--                   Gender = first(Gender)) %>% -->
<!--         ungroup() -->

<!-- f.clincorr <- 'log(response_time) ~ 1 + Up3OfBradySum*trial_type + Age + Gender + (1|pseudonym) + (1|block)' -->
<!-- fit.clincorr <- lmer(f.clincorr, tmp.clincorr, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->
<!-- # outliers <- outlierTest(fit.clincorr)[[1]] %>% names() %>% as.numeric() -->
<!-- # fit.clincorr <- lmer(f.clincorr, data=tmp.clincorr[-c(outliers), ], control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->
<!-- s <- summary(fit.clincorr) -->
<!-- # print(s, corr=FALSE, digits = 3) -->
<!-- anova <- Anova(fit.clincorr,type=3) -->
<!-- print(anova) -->
<!-- eta_squared(fit.clincorr, alternative = 'two.sided') %>% print() -->

<!-- # Post hoc test -->
<!-- emt <- emtrends(fit.clincorr, ~trial_type, var='Up3OfBradySum', type = 'response') -->
<!-- contrast(emt, 'revpairwise', adjust = 'mvt') %>% kable(., 'pipe', digits = 4) %>% print() -->
<!-- emtc <- summary(emt)$Up3OfBradySum.trend %>% mean() -->

<!-- em <- emmeans(fit.clincorr, revpairwise ~ trial_type, type='response', adjust='mvt') -->
<!-- kable(em$emmeans,'pipe', digits = 3) %>% print() -->
<!-- kable(em$contrasts,'pipe', digits = 3) %>% print() -->
<!-- emmip(fit.clincorr, ~ trial_type, type='response', CIs=TRUE) %>% print() -->

<!-- # Visualize -->
<!-- plotdat <- tmp.clincorr %>% -->
<!--         group_by(pseudonym, trial_type) %>% -->
<!--         summarise(across(c(response_time, Up3OfBradySum), ~ mean(.x, na.rm=TRUE))) %>% -->
<!--         ungroup() -->
<!-- c <- plotdat %>% -->
<!--         group_by(pseudonym, trial_type) %>% -->
<!--         summarise(across(c(response_time, Up3OfBradySum), ~ mean(., na.rm=TRUE))) %>% -->
<!--         select(pseudonym, response_time, Up3OfBradySum) -->
<!-- c <- cor.test(c$response_time, c$Up3OfBradySum) -->
<!-- N <- tmp.clincorr  %>%  -->
<!--         group_by(pseudonym, ParticipantType) %>% -->
<!--         summarise(across(everything(), ~first(.x))) %>% -->
<!--         na.omit() %>% -->
<!--         ungroup() %>% -->
<!--         select(ParticipantType) %>% -->
<!--         table() -->
<!-- plot <- ggplot(plotdat, aes(y=response_time, x=Up3OfBradySum, color=trial_type)) + -->
<!--         geom_point(alpha = .3, shape = 19, size = 1.5) + -->
<!--         geom_smooth(method='lm', se = TRUE, lwd = 2) + -->
<!--         scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8, -->
<!--                               direction = -1, labels = c('One','Two','Three')) + -->
<!--         ggtitle('Association between response \ntimes and bradykinesia') +  -->
<!--         xlab('Bradykinesia severity') + -->
<!--         ylab('Response time (s)') + -->
<!--         theme_cowplot(font_size = 16, font_family = 'Calibri') + -->
<!--         guides(color=guide_legend(title='', reverse = FALSE, -->
<!--                                  title.position = 'left', label.position = 'right')) + -->
<!--         theme(legend.position = c(0.8,1.10), -->
<!--               legend.key.size = unit(0.5,'cm')) + -->
<!--         geom_text(x=19,y=1.55, label = paste('N = ', N,  -->
<!--                                              ', β = ', round(s$coefficients[2,1],digits=3), -->
<!--                                              ', SE = ', round(s$coefficients[2,2],digits=3), -->
<!--                                              ', P < 0.001', sep=''), -->
<!--                   size=4, inherit.aes = FALSE) + -->
<!--         xlim(0,42) + -->
<!--         scale_y_continuous(limits = c(0.5,1.75), breaks = seq(0.5,1.5, by=0.5)) -->
<!-- print(plot) -->
<!-- # save_plot('M:/Visualization/R_BaselineComparisonFmri/XXXXXXXRT_Corr_ON_Severity.tiff', -->
<!-- #           plot, dpi=300, device='tiff', base_width = 5) -->

<!-- ``` -->