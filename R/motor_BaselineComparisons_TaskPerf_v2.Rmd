---
title: "Baseline comparisons of motor task performance"
author: "M.E. Johansson"
date: "25/2/2022"
output: 
  html_document: 
    toc: yes
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set-options, echo=FALSE, cache=FALSE}
# options(width = 150)
```

# Load libraries and functions.

```{r libraries, message=FALSE}
# funcdir <- 'H:/sysneu/marjoh/scripts/Personalized-Parkinson-Project-Motor/R/functions/'
# funcs <- list.files(funcdir, full.names = TRUE)
# sapply(funcs, source)
library(MASS)
library(emmeans)
emm_options(lmerTest.df = 'satterthwaite')  # Calculates DFs in the same way as lmerTest
emm_options(lmerTest.limit = 50000)
emm_options(disable.pbkrtest=TRUE)
library(cowplot)
library(readr)
library(tidyverse)
library(lme4)
library(lmerTest)
library(effectsize)
library(car)
library(lattice)
library(viridis)
library(extrafont)
library(kableExtra)
loadfonts(device='win',quiet = TRUE)

sigsize=16
lsize=1.5
legend_position <- c(0.85,1.2)
```

# Load data

```{r datafile}
fTask <- 'P:/3022026.01/pep/bids/derivatives/manipulated_merged_motor_task_mri_2022-04-22.csv'
dfTask <- read_csv(fTask)
dfTask <- dfTask %>%
        select(pseudonym, Timepoint, trial_type, response_time, trial_number,
               event_type, correct_response, block, RespondingHand, Group, Percentage.Correct,
               Percentage.Correct.BelowCutoff, Button.Press.SwitchRatio, Button.Press.CoV,
               Button.Press.RepetitionRatio, Button.Press.AdjacentRatio) %>%
        rename(ParticipantType = Group) %>%
        mutate(TimepointNr = if_else(str_detect(Timepoint, 'Visit1'), '0', '1'),
               TimepointNr = factor(TimepointNr)) %>%
        relocate(pseudonym, TimepointNr, ParticipantType) %>%
        select(-Timepoint)

fClin <- 'P:/3022026.01/pep/ClinVars2/derivatives/merged_manipulated_2022-04-08_ba_and_fu_diag.csv'
clinvars <- c('pseudonym', 'TimepointNr', 'ParticipantType', 'CrossStudyParticipation', 'Subtype_DisDurSplit',
              'Subtype_Imputed_DisDurSplit',
         'Age', 'Gender', 'NpsEducYears', 'PrefHand', 'MonthSinceDiag', 'ParkinMedUser', 'LEDD', 'Up3OfHoeYah', 'MostAffSide',
         'Up3OfTotal', 'Up3OfAppendicularSum', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum', 
         'Up3OfTotal_pit', 'Up3OfAppendicularSum_pit', 'Up3OfBradySum_pit', 'Up3OfRigiditySum_pit',
         'Up3OfPIGDSum_pit', 'Up3OfCompositeTremorSum_pit', 
         'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum',
         'DiagParkCertain', 'DiagParkPersist', 'DiagParkReplace')
dfClin <- read_csv(fClin)
dfClin <- dfClin %>%
        filter(MriNeuroPsychTask == 'Motor') %>%
        filter(!is.na(ParticipantType)) %>%
        select(all_of(clinvars)) %>%
        rename(Subtype = Subtype_Imputed_DisDurSplit) %>%
        mutate(TimepointNr = factor(TimepointNr),
               Subtype = if_else(ParticipantType=='HC_PIT', '0_Healthy', Subtype),
               Subtype = factor(Subtype))

# Binarize the MostAffSide variable to Right and Left or NA
dfClin$MostAffSide[dfClin$MostAffSide=='BiL>R'] <- 'Left'
dfClin$MostAffSide[dfClin$MostAffSide=='LeftOnly'] <- 'Left'
dfClin$MostAffSide[dfClin$MostAffSide=='BiR>L'] <- 'Right'
dfClin$MostAffSide[dfClin$MostAffSide=='Right'] <- 'Right'
dfClin$MostAffSide[dfClin$MostAffSide=='BiR=L'] <- NA
dfClin$MostAffSide[dfClin$MostAffSide=='None'] <- NA

# Merge motor sub-scores for POM and PIT. Rigidity is not included since the variables
# names in Castor match exactly between the studies
dfClin <- dfClin %>%
        unite('Up3OfTotal', Up3OfTotal, Up3OfTotal_pit, na.rm = TRUE) %>%
        unite('Up3OfAppendicularSum', Up3OfAppendicularSum, Up3OfAppendicularSum_pit, na.rm = TRUE) %>%
        unite('Up3OfBradySum', Up3OfBradySum, Up3OfBradySum_pit, na.rm = TRUE) %>%
        unite('Up3OfPIGDSum', Up3OfPIGDSum, Up3OfPIGDSum_pit, na.rm = TRUE) %>%
        unite('Up3OfCompositeTremorSum', Up3OfCompositeTremorSum, Up3OfCompositeTremorSum_pit, na.rm = TRUE) %>%
        mutate(Up3OfTotal = as.numeric(Up3OfTotal),
               Up3OfAppendicularSum = as.numeric(Up3OfAppendicularSum),
               Up3OfBradySum = as.numeric(Up3OfBradySum),
               Up3OfPIGDSum = as.numeric(Up3OfPIGDSum),
               Up3OfCompositeTremorSum = as.numeric(Up3OfCompositeTremorSum))

df <- full_join(dfClin, dfTask, by = c('pseudonym', 'ParticipantType', 'TimepointNr'))
df <- df %>%
        filter(TimepointNr==0) %>%
        mutate(trial_type = factor(trial_type),
               block = factor(block),
               ParticipantType = factor(ParticipantType),
               Gender = factor(Gender),
               Age_Dmean = scale(Age, center=TRUE, scale=FALSE),
               MonthSinceDiag_Dmean = scale(MonthSinceDiag, center=TRUE, scale=FALSE),
               NpsEducYears_Dmean = scale(NpsEducYears, center=TRUE, scale=FALSE),
               Up3OfAppendicularSum_Dmean = scale(Up3OfAppendicularSum, center=TRUE, scale=FALSE),
               RespHandIsDominant = if_else(RespondingHand == PrefHand | RespondingHand == 'NoPref', 1, 0),
               RespHandIsDominant = factor(RespHandIsDominant))

```

## Exclusion criteria

This section tells us a bit about how many participants were analyzed and how many were excluded.

<!-- ```{r number, echo=FALSE} -->
<!-- n <- data_task_clin %>% -->
<!--         filter(Timepoint=='ses-Visit1' & Condition == 'Ext') %>% -->
<!--         select(pseudonym) %>% -->
<!--         unique() %>% -->
<!--         nrow -->
<!-- msg <- paste('Number of unique pseudonyms:', n) -->
<!-- print(msg) -->
<!-- ``` -->

- Participants without data

<!-- ```{r missing, echo=FALSE} -->
<!-- no_task <- data_task_clin %>% -->
<!--         filter(Timepoint == 'ses-Visit1') %>% -->
<!--         filter(Condition == 'Ext') %>% -->
<!--         select(pseudonym, Response.Time, Age) %>% -->
<!--         filter(is.na(Response.Time)) -->
<!-- msg <- paste('Number of subjects without task data (defined as RTs on Ext):', length(unique(no_task$pseudonym))) -->
<!-- print(msg) -->
<!-- print(unique(no_task$pseudonym)) -->

<!-- no_clin <- data_task_clin %>% -->
<!--         filter(Timepoint == 'ses-Visit1') %>% -->
<!--         filter(Condition == 'Ext') %>% -->
<!--         select(pseudonym, Response.Time, Age) %>% -->
<!--         filter(is.na(Age)) -->
<!-- msg <- paste('Number of subjects without clinical data (defined as Age):', length(unique(no_clin$pseudonym))) -->
<!-- print(msg) -->
<!-- print(unique(no_clin$pseudonym)) -->
<!-- ``` -->

- Participants who performed at or below 25% correct responses in the 1-choice condition

<!-- ```{r poor_performance, echo=FALSE} -->
<!-- poor_performance <- data_task_clin %>% -->
<!--         filter(Timepoint == 'ses-Visit1') %>% -->
<!--         filter(Condition == 'Ext') %>% -->
<!--         filter(Poor.Performance == 'Yes') %>% -->
<!--         select(pseudonym) -->
<!-- msg <- paste('Number of subjects with poor performance:', length(unique(poor_performance$pseudonym))) -->
<!-- print(msg) -->
<!-- print(unique(poor_performance$pseudonym)) -->
<!-- ``` -->

```{r echo=FALSE, warning=FALSE}
# Exclude patients with confirmed non-PD diagnosis
cat('\n\n Excluding patients with confirmed non-PD diagnosis at baseline and patients who received a non-PD diagnosis at 2-year follow-up')
diagnosis <- dfClin %>% filter(ParticipantType=='PD_POM') %>% select(pseudonym, TimepointNr, DiagParkCertain, DiagParkPersist, DiagParkReplace)
diagnosis %>% filter(TimepointNr==0) %>% select(DiagParkCertain) %>% table() %>% print()
diagnosis %>% filter(TimepointNr==2) %>% select(DiagParkPersist) %>% table() %>% print()
diagnosis %>% filter(TimepointNr==2) %>% select(DiagParkReplace) %>% table() %>% print()

        # Define a list of subjects to exclude
baseline_exclusion <- diagnosis %>%
        filter(TimepointNr==0, (DiagParkCertain == 'NeitherDisease' | DiagParkCertain == 'DoubtAboutParkinsonism' | DiagParkCertain == 'Parkinsonism')) %>% 
        select(pseudonym)
visit2_exclusion <- diagnosis %>%
        filter(TimepointNr==2, (DiagParkPersist == 2)) %>% 
        select(pseudonym)
diag_exclusions <- full_join(baseline_exclusion, visit2_exclusion) %>% unique()
# diag_exclusions <- baseline_exclusion %>% unique()

        # Checks 
cat('\n\n Check the 2-year follow-up diagnosis for patients with uncertain PD diagnoses')
doubt_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'DoubtAboutPD') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% doubt_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table() %>% print()
parkinsonism_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'Parkinsonism') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% parkinsonism_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table()
neither_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'NeitherDisease') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% neither_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table()
doubt2_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'DoubtAboutParkinsonism') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% doubt2_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table()

df <- df %>%
        filter(!(pseudonym %in% diag_exclusions$pseudonym))
# df <- df %>%
#         filter(!(pseudonym %in% doubt_at_ba$pseudonym))
```


# Demographics

```{r echo=FALSE, warning=FALSE}
demographics_table <- function(dat){
        tab_demo <- dat %>%
                group_by(ParticipantType) %>%
                summarise(across(where(is.numeric), list(mean=mean,sd=sd), .names = "{.col}.{.fn}", na.rm=TRUE),
                          N = n(),
                          Sex_Male=sum(Gender=='Male', na.rm=TRUE), Sex_Fem=sum(Gender=='Female', na.rm=TRUE),
                          Sex_PropMale=mean(Gender=='Male', na.rm=TRUE), Sex_PropFem=mean(Gender=='Female', na.rm=TRUE),
                          PrefHand_R=sum(PrefHand=='Right', na.rm=TRUE), PrefHand_L=sum(PrefHand=='Left', na.rm=TRUE),
                          PrefHand_PropR=mean(PrefHand=='Right', na.rm=TRUE), PrefHand_PropL=mean(PrefHand=='Left', na.rm=TRUE),
                          RespHand_R=sum(RespondingHand=='Right', na.rm=TRUE), RespHand_L=sum(RespondingHand=='Left', na.rm=TRUE),
                          RespHand_PropR=mean(RespondingHand=='Right', na.rm=TRUE), RespHand_PropL=mean(RespondingHand=='Left', na.rm=TRUE),
                          RespHandDom_Y=sum(RespHandIsDominant==1, na.rm=TRUE), RespHandDom_N=sum(RespHandIsDominant==0, na.rm=TRUE),
                          RespHandDom_PropY=mean(RespHandIsDominant==1, na.rm=TRUE), RespHandDom_PropN=mean(RespHandIsDominant==0, na.rm=TRUE),
                          MostAffSide_R=sum(MostAffSide=='Right', na.rm=TRUE),MostAffSide_L=sum(MostAffSide=='Left', na.rm=TRUE),
                          MostAffSide_PropR=mean(MostAffSide=='Right', na.rm=TRUE),MostAffSide_PropL=mean(MostAffSide=='Left', na.rm=TRUE),
                          MedUser=sum(ParkinMedUser=='Yes', na.rm=TRUE), NonMedUser=sum(ParkinMedUser=='No', na.rm=TRUE),
                          PropMedUser=mean(ParkinMedUser=='Yes', na.rm=TRUE), PropNonMedUser=mean(ParkinMedUser=='No', na.rm=TRUE),
                          HnY_1=sum(Up3OfHoeYah==1, na.rm=TRUE), HnY_2=sum(Up3OfHoeYah==2, na.rm=TRUE),
                          HnY_3=sum(Up3OfHoeYah==3, na.rm=TRUE), HnY_4=sum(Up3OfHoeYah==4, na.rm=TRUE),
                          HnY_Prop1=mean(Up3OfHoeYah==1, na.rm=TRUE), HnY_Prop2=mean(Up3OfHoeYah==2, na.rm=TRUE),
                          HnY_Prop3=mean(Up3OfHoeYah==3, na.rm=TRUE), HnY_Prop4=mean(Up3OfHoeYah==4, na.rm=TRUE),
                          Diagnosis_PD=sum(DiagParkCertain=='PD', na.rm=TRUE), Diagnosis_Doubt=sum(DiagParkCertain=='DoubtAboutPD', na.rm=TRUE),
                          Diagnosis_PropPD=mean(DiagParkCertain=='PD', na.rm=TRUE), Diagnosis_PropDoubt=mean(DiagParkCertain=='DoubtAboutPD', na.rm=TRUE)) %>%
                mutate(across(where(is.double), round, digits=2))
        
        # Format table to show values in mean (sd) for each variable in vars1
        format_cell1 <- function(table,var){
                t2 <- table %>%
                        select(starts_with(var)) %>%
                        mutate('{var}' := paste(.[[1]], ' (',.[[2]], ')', sep='')) %>%
                        select(all_of(var))
                table <- table %>%
                        select(!contains(var))
                table <- cbind(table, t2)
                table
        }
        vars1 <- c('Age', 'NpsEducYears', 'MonthSinceDiag', 'LEDD', 'Up3OfHoeYah', 'Up3OfTotal', 
                   'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum', 
                   'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum')
        for(v in vars1){
                tab_demo <- format_cell1(tab_demo, v)
        }
        # Format table to show count (proportion) for each variable in vars2
        format_cell2 <- function(table,var,var1,var2){
                t2 <- table %>%
                        select(any_of(c(var1, var2))) %>%
                        mutate('{var}' := paste(.[[var1]], ':',.[[var2]], sep='')) %>%
                        select(all_of(var))
                table <- table %>%
                        select(!any_of(c(var1, var2)))
                table <- cbind(table, t2)
                table
        }
        var1 <- c('Sex_Male', 'Sex_PropMale', 'PrefHand_R', 'PrefHand_PropR', 'RespHand_R', 'RespHand_PropR', 'RespHandDom_Y', 'RespHandDom_PropY', 'MostAffSide_R', 'MostAffSide_PropR', 'MedUser', 'PropMedUser', 'Diagnosis_PD', 'Diagnosis_PropPD')
        var2 <- c('Sex_Fem', 'Sex_PropFem', 'PrefHand_L', 'PrefHand_PropL', 'RespHand_L', 'RespHand_PropL', 'RespHandDom_N', 'RespHandDom_PropN', 'MostAffSide_L', 'MostAffSide_PropL', 'NonMedUser', 'PropNonMedUser', 'Diagnosis_Doubt', 'Diagnosis_PropDoubt')
        var <- c('Sex_MF', 'Sex_Prop_MF', 'PrefHand_RL', 'PrefHand_PropRL', 'RespHand_RL', 'RespHand_PropRL', 'RespHandDom_YN', 'RespHandDom_PropYN', 'MostAffSide_RL', 'MostAffSide_PropRL', 'Meduser_YN', 'Meduser_Prop_YN', 'Diagnosis_PDDoubt', 'Diagnosis_PropPDDoubt')
        for(v in 1:length(var)){
                tab_demo <- format_cell2(tab_demo, var[v], var1[v], var2[v])
        }
        
        tab_demo <- bind_cols(Vars = colnames(tab_demo), t(tab_demo), .name_repair = 'universal')
        # colnames(tab_demo) <- c('Variable', 'Healthy', 'PD-Off', 'PD-On')
        
        kbl(tab_demo, caption = 'Demographics') %>%
                kable_paper('hover', full_width = F)
}
compare_demographics <- function(dat,numvars,catvars){
        
        cat('\n\n\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                HC <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                ON <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(HC,ON,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: Healthy-PD = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}
compare_demographics.subs <- function(dat,numvars,catvars){
        
        cat('\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                
                G1 <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                G2 <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                G3 <- dat %>% filter(ParticipantType==groups[3]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(G1,G2,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-IM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G1,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G2,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: IM-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}

```

## ON vs HC

```{r echo=FALSE, warning=FALSE}
df_demo <- df %>% 
        filter(TimepointNr==0) %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        select(pseudonym, ParticipantType, CrossStudyParticipation, Subtype,
               Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
               ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
               Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
               MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain) %>%
        arrange(pseudonym,ParticipantType) %>%
        ungroup()

demographics_table(df_demo)

groups <- c('HC_PIT','PD_POM')
demo.test <- df_demo %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2]) %>%
        mutate(ParticipantType = factor(ParticipantType))
numvars <- c('Age', 'NpsEducYears', 'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum')
catvars <- c('Gender', 'PrefHand', 'RespondingHand', 'RespHandIsDominant')
cat('\n\n\n', 'Healthy controls versus PD-On', '\n\n\n')
compare_demographics(demo.test,numvars,catvars)

```

## ON vs OFF

```{r echo=FALSE, warning=FALSE}

df_demo.onoff <- df %>% 
        filter(TimepointNr==0,
               CrossStudyParticipation==TRUE) %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        select(pseudonym, ParticipantType, CrossStudyParticipation, Subtype,
               Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
               ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
               Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
               MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain) %>%
        arrange(pseudonym,ParticipantType) %>%
        ungroup()

demographics_table(df_demo.onoff)

groups <- c('PD_PIT','PD_POM')
demo.test <- df_demo.onoff %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2]) %>%
        mutate(ParticipantType = factor(ParticipantType))
numvars <- c('Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum')
catvars <- c()
cat('\n\n\n', 'PD-Off versus PD-On', '\n\n\n')
compare_demographics(demo.test,numvars,catvars)

```

## Subtypes

```{r echo=FALSE, warning=FALSE}

df_demo.subs <- df %>% 
        filter(TimepointNr==0,
               ParticipantType=='PD_POM',
               Subtype!='4_Undefined') %>%
        mutate(ParticipantType=factor(Subtype)) %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        select(pseudonym, ParticipantType, CrossStudyParticipation,
               Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
               ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
               Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
               MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain
               ) %>%
        arrange(pseudonym,ParticipantType) %>%
        ungroup()

demographics_table(df_demo.subs)

compare_demographics.subs <- function(dat,numvars,catvars){
        
        cat('\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                
                G1 <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                G2 <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                G3 <- dat %>% filter(ParticipantType==groups[3]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(G1,G2,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-IM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G1,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G2,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: IM-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}
groups <- c('1_Mild-Motor', '2_Intermediate','3_Diffuse-Malignant')
demo.test <- df_demo.subs %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2] | ParticipantType==groups[3]) %>%
        mutate(ParticipantType = factor(ParticipantType))
numvars <- c('Age', 'NpsEducYears', 'LEDD', 'MonthSinceDiag', 'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum', 
             'Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum')
catvars <- c('Gender', 'PrefHand', 'RespondingHand', 'RespHandIsDominant')
cat('\n\n\n', 'Subtypes', '\n\n\n')
compare_demographics.subs(demo.test,numvars,catvars)

```

# Brain activity

## ON vs. HC

```{r echo=FALSE, warning=FALSE, message=FALSE}

# SPM VOI eigenvariate
# fmri.onvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOn_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.onvshc, 'VOI.*csv', full.names = TRUE)
# MarsBar ROI betas
fmri.onvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOn_x_ExtInt2Int3Catch_NoOutliers/marsbar/'
vois <- dir(fmri.onvshc, '*csv', full.names = TRUE)

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch') %>%
                mutate(Group = factor(Group,
                                      levels = c('HC_PIT','PD_POM')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        bn <- basename(csvfile)
        if(str_detect(bn, 'MTean')){
                fmridat <- fmridat %>%
                        group_by(pseudonym, Group) %>%
                        summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>%
                        ungroup()
                raincloudplot_1Factor(fmridat, 'Beta', c('Group'), title = basename(csvfile),
                                      xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'),
                                      color_scheme = 'viridis') %>% print()   
        }else{
                raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile),
                                      xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'),
                                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                                      color_scheme = 'mako') %>% print()        
        }
}

##### Putamen #####
putamen <- vois[2]
csvfile <- putamen
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Group = factor(Group,
                              levels = c('HC_PIT','PD_POM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
         rename(Beta = Vals) #%>%
        # group_by(pseudonym, Group) %>%
        # summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>%
        # ungroup()
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
# plot <-raincloudplot_1Factor(fmridat, 'Beta', c('Group'), title = 'Average task-related activity in \nthe most affected putamen',
#                       xlab='', ylab='Beta (mean)',
#                       xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
#                                           paste('PD-On', ' (n=', N[2],')', sep='')),
#                       color_scheme = 'cividis') +
#         ylim(-1.5,2.5) +
#         theme_cowplot(font_size = 60, font_family = 'Calibri')
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
                              title = 'Task-related activity in the most \naffected putamen',
                              xlab='', ylab='Beta', 
                              xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                            paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_position = legend_position, legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako') + 
        ylim(-2,5)
y <- 5
d = 0.45
segmap <- data.frame(
        x =    c(1.00, 1.00, 0.80,  2.00,  1.80),
        xend = c(2.00, 1.00, 1.20,  2.00,  2.20),
        y =    c(y,    y,    y-d*1, y,     y-d*1),
        yend = c(y,    y-d*1,y-d*1, y-d*1, y-d*1)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON_HCgtON_Mean_Putamen1.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
#####

##### Parietal interaction #####
parietal <- vois[6]
csvfile <- parietal
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Group = factor(Group,
                              levels = c('HC_PIT','PD_POM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals)
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
                              title = 'Task-related activity in the least \naffected inferior parietal cortex',
                              xlab='', ylab='Beta', 
                              xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                            paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_position = legend_position, legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako') + 
        ylim(-6,6)
y <- 6
d = 0.6
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  1.20, 1.80,  2.20),
        xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  0.80,  1.20, 1.80,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON_ONgtHC_INT3gtEXT_IPL.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
#####
```


<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- fmri.offvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOff_x_ExtInt2Int3Catch_NoOutliers/' -->
<!-- vois <- dir(fmri.offvshc, 'VOI.*csv', full.names = TRUE) -->

<!-- source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->
<!-- source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->
<!-- for(v in 1:length(vois)){ -->

<!--         csvfile <- vois[v] -->

<!--         fmridat <- read_csv(csvfile, show_col_types = FALSE) %>% -->
<!--                 select(-scans) %>% -->
<!--                 filter(Cond != 'Catch') %>% -->
<!--                 mutate(Group = factor(Group, -->
<!--                                       levels = c('HC_PIT','PD_PIT')), -->
<!--                        Cond = factor(Cond, -->
<!--                                      levels = c('Ext','Int2','Int3'), -->
<!--                                      labels = c('1choice','2choice','3choice'))) %>% -->
<!--                 rename(Beta = Vals) -->

<!--         bn <- basename(csvfile) -->
<!--         if(str_detect(bn, 'Mean')){ -->
<!--                 fmridat <- fmridat %>% -->
<!--                         group_by(pseudonym, Group) %>% -->
<!--                         summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>% -->
<!--                         ungroup() -->
<!--                 raincloudplot_1Factor(fmridat, 'Beta', c('Group'), title = basename(csvfile), -->
<!--                                       xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'), -->
<!--                                       color_scheme = 'viridis') %>% print()    -->
<!--         }else{ -->
<!--                 raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile), -->
<!--                                       xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'), -->
<!--                                       legend_title = 'No. of choices', legend_labels = c('One','Two','Three'), -->
<!--                                       color_scheme = 'mako') %>% print()         -->
<!--         } -->
<!-- } -->
<!-- ``` -->

## Subtypes vs subtypes

```{r echo=FALSE, warning=FALSE, message=FALSE}

##### Group analysis #####
# fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Imputed_Subtypes_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.subtypes, 'VOI.*csv', full.names = TRUE)
fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Imputed_Subtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar'
vois <- dir(fmri.subtypes, '*csv', full.names = TRUE)

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch',
                       Group != 'HC_PIT') %>%
                left_join(., Subtypes, by='pseudonym') %>%
                mutate(Group = Subtype,
                       Group = factor(Group,
                                      levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        # fmridat <- fmridat %>%
        #         filter(Group %in% c('1_Mild-Motor','3_Diffuse-Malignant'))
        
        raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile),
                      xlab='Group', ylab='Beta', xticklabs = c('MMP','IM', 'DM'),
                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') %>% print()
}
#####

##### Parietal lobule #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)

# MMP > DM: 3 > 1, PMC
ips <- vois[6]
csvfile1 <- ips
fmridat1 <- read_csv(csvfile1, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
# N1 <- fmridat1 %>%
#         filter(Cond=='1choice') %>%
#         select(Group) %>%
#         table()
# plot <- raincloudplot_2Factor(fmridat1, 'Beta', c('Cond','Group'), 
#                               title = 'Task-related activity in the \nintraparietal sulcus (hIP8)',
#                       xlab='Group', ylab='Beta', 
#                       xticklabs = c(paste('MMP', ' (n=', N1[1],')', sep=''),
#                                     paste('IM', ' (n=', N1[2],')', sep=''),
#                                     paste('DM', ' (n=', N1[3],')', sep='')),
#                       legend_title = '',
#                       legend_position = c(0.85,1.08), legend_labels = c('One','Two','Three'),
#                       color_scheme = 'mako') +
#         ylim(-6,10) +
#         geom_segment(x=1,xend=3,y=10,yend=10,size=lsize) + 
#         geom_segment(x=1,xend=1,y=10,yend=9.7,size=lsize) + 
#         geom_segment(x=3,xend=3,y=10,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=1.2,y=9.7,yend=9.7,size=lsize) + 
#         geom_segment(x=2.8,xend=3.2,y=9.7,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=0.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=1.2,xend=1.2,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=2.8,xend=2.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=3.2,xend=3.2,y=9.7,yend=9.5,size=lsize) +
#         geom_text(x=2,y=10.2,label='**',size=sigsize,show.legend = FALSE)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ImputedSubtypes_MMPgtDM_INT3gtEXT_IPS.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

# MMP > IM: 3 > 1, PMC
spl <- vois[2]
csvfile2 <- spl
fmridat2 <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
# N2 <- fmridat2 %>%
#         filter(Cond=='1choice') %>%
#         select(Group) %>%
#         table()
# plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
#                               title = 'Task-related activity in the \nsuperior parietal lobule (7A)',
#                       xlab='Group', ylab='Beta', 
#                       xticklabs = c(paste('MMP', ' (n=', N2[1],')', sep=''),
#                                     paste('IM', ' (n=', N2[2],')', sep=''),
#                                     paste('DM', ' (n=', N2[3],')', sep='')),
#                       legend_title = '',
#                       legend_position = c(0.85,1.08), legend_labels = c('One','Two','Three'),
#                       color_scheme = 'mako') +
#         ylim(-6,10) +
#         geom_segment(x=1,xend=3,y=10,yend=10,size=lsize) + 
#         geom_segment(x=1,xend=1,y=10,yend=9.7,size=lsize) + 
#         geom_segment(x=3,xend=3,y=10,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=1.2,y=9.7,yend=9.7,size=lsize) + 
#         geom_segment(x=2.8,xend=3.2,y=9.7,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=0.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=1.2,xend=1.2,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=2.8,xend=2.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=3.2,xend=3.2,y=9.7,yend=9.5,size=lsize) +
#         geom_text(x=2,y=10.2,label='**',size=sigsize,show.legend = FALSE)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ImputedSubtypes_MMPgtDM_INT3gtEXT_IPS.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

# MMP > DM & MMP > IM: 3 gt 1, Parietal
fmridat <- bind_cols(fmridat1, Beta2=fmridat2$Beta) %>%
        mutate(AvgBeta = (Beta+Beta2)/2)
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()

plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Task-related activity in the least \naffected parietal cortex',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-3,13)

y <- 13
d = 0.7
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  0.80,  1.20,  1.80,  1.80,  2.20,  1.00, 1.00,  3.00,  0.80,  0.80,  1.20,  2.80,  2.80,  3.20),
        xend = c(2.00, 1.00,  2.00,  1.20,  0.80,  1.20,  2.20,  1.80,  2.20,  3.00, 1.00,  3.00,  1.20,  0.80,  1.20,  3.20,  2.80,  3.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3,y-d*3, y-d*3, y-d*4, y-d*4, y-d*4, y-d*4, y-d*4, y-d*4),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2, y-d*3,y-d*4, y-d*4, y-d*4, y-d*5, y-d*5, y-d*4, y-d*5, y-d*5)
)
sigmap <- data.frame(
        x =     c(1.50,  2.00),
        y =     c(y,     y-d*3),
        label = c('***', '***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_ImputedSubtypes_MMPgtDM&MMPgtIM_INT3gtEXT_Parietal.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

#####

##### Putamen cluster #####
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfAppendicularSum)

file <- c('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0001_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0002_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0003_ses-Visit1.txt')

con1 <- read_csv(file[1])
con2 <- read_csv(file[2])
con3 <- read_csv(file[3])
fmridat.putamen <- bind_rows(con1,con2,con3)
fmridat.putamen <- fmridat.putamen %>%
        separate(Img, into = c('x1','x2','pseudonym','session','y1','contrast'), sep = '_') %>%
        mutate(ParticipantType = paste(x1,x2,sep='_'),
               contrast = str_remove(contrast, 'L2Rswap'),
               contrast = str_remove(contrast, '.nii')) %>%
        select(-c(x1,x2,y1,session))
fmridat.putamen <- fmridat.putamen %>%
        filter(ParticipantType=='PD_POM')
fmridat.putamen <- fmridat.putamen %>%
        left_join(., Subtypes, by = 'pseudonym')
fmridat.putamen <- fmridat.putamen %>%
        mutate(Group = Subtype,
               Group = factor(Group,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
               Cond = factor(contrast,
                                 levels = c('0001','0002','0003'),
                                 labels = c('1choice','2choice','3choice'))) %>%
        na.omit() %>%
        filter(pseudonym %in% unique(fmridat.putamen$pseudonym))

fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','ParticipantType','Group','Up3OfAppendicularSum'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean=(`1choice`+`2choice`+`3choice`)/3)

N <- fmridat.putamen.collapsed %>%
        select(Group) %>%
        table()

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
plot <- raincloudplot_2Factor(fmridat.putamen, 'Beta', c('Cond','Group'),
                      title = 'Task-related activity in the \nmost affected putamen',
                      xlab='', ylab='Beta', 
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '', 
                      legend_labels = c('One','Two','Three'),
                      legend_position = legend_position,
                      color_scheme = 'mako')
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_ImputedSubtypes_Putamen.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

c <- cor.test(fmridat.putamen.collapsed$Mean, fmridat.putamen.collapsed$Up3OfAppendicularSum)
N <- fmridat.putamen.collapsed %>%
                select(pseudonym) %>%
                summarise(N=n())
plot <- ggplot(fmridat.putamen.collapsed, aes(y=Mean, x=Up3OfAppendicularSum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, lwd = 2, color = 'black') +
        ggtitle('Association between mean putamen activity and \ndisease severity') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Beta') +
        theme_cowplot(font_size = 35, font_family = 'Calibri') +
        geom_text(x=16,y=1.3, label = paste('N=', N, ', r=', round(c$estimate,digits=2), sep=''),
                  size=12)
print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Corr_ON_Putamen_Severity.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

#####
```

## Subtypes vs HC

```{r echo=FALSE, warning=FALSE, message=FALSE}

##### Group analysis #####
# fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcImpSubtypes_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.subtypes, 'VOI.*csv', full.names = TRUE)
fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcImpSubtypes_x_ExtInt2Int3Catch_NoOutliers/marsbar'
vois <- dir(fmri.subtypes, '*csv', full.names = TRUE)

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch') %>%
                left_join(., Subtypes, by='pseudonym') %>%
                mutate(Group = as.character(Subtype),
                       Group = if_else(is.na(Group),'0_Healthy', Group),
                       Group = factor(Group,
                                      levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        # fmridat <- fmridat %>%
        #         filter(Group %in% c('1_Mild-Motor','3_Diffuse-Malignant'))
        
        raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile),
                      xlab='Group', ylab='Beta', xticklabs = c('HC','MMP','IM', 'DM'),
                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') %>% print()
}
#####

##### Interactions #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)

# MMP > HC: 3 > 1, rIPL
mmpgthc_ipl <- vois[14]
csvfile2 <- mmpgthc_ipl
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Task-related activity in the least \naffected inferior parietal lobule',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-4,4)
y <- 4
d = 0.4
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  0.80,  1.20,  1.80,  1.80,  2.20),
        xend = c(2.00, 1.00,  2.00,  1.20,  0.80,  1.20,  2.20,  1.80,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcImpSubtypes_MMPgtHC_INT3gtEXT_Parietal.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

# MMP > HC: 3 > 1, rPMC
mmpgthc_pmc <- vois[13]
csvfile2 <- mmpgthc_pmc
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Task-related activity in the least \naffected premotor cortex',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-2.5,5)
y <- 5
d = 0.35
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  0.80,  1.20,  1.80,  1.80,  2.20),
        xend = c(2.00, 1.00,  2.00,  1.20,  0.80,  1.20,  2.20,  1.80,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcImpSubtypes_MMPgtHC_INT3gtEXT_PMC.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

# HC > DM: 3 > 1, lSPL
hcgtdm_spl <- vois[1]
csvfile2 <- hcgtdm_spl
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Task-related activity in the most \n affected superior parietal lobule',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-4,7)
y <- 7
d = 0.45
segmap <- data.frame(
        x =    c(1.00, 1.00,  4.00,  0.80,  0.80,  1.20,  3.80,  3.80,  4.20),
        xend = c(4.00, 1.00,  4.00,  1.20,  0.80,  1.20,  4.20,  3.80,  4.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(2.5),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcImpSubtypes_HCgtDM_INT3gtEXT_Parietal.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

# HC > DM: 3 > 1, lPMC
hcgtdm_pmc <- vois[2]
csvfile2 <- hcgtdm_pmc
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'Task-related activity in the most \naffected premotor cortex',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-3,9)
y <- 8
d = 0.5
segmap <- data.frame(
        x =    c(1.00, 1.00,  4.00,  0.80,  0.80,  1.20,  3.80,  3.80,  4.20),
        xend = c(4.00, 1.00,  4.00,  1.20,  0.80,  1.20,  4.20,  3.80,  4.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(2.5),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcImpSubtypes_HCgtDM_INT3gtEXT_PMC.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

#####

```


## On: clinical correlation

```{r echo=FALSE, warning=FALSE, message=FALSE}

# fmri.oncorr1 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers/Int2gtExt'
# fmri.oncorr2 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers/Int3gtExt'
# fmri.oncorr3 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers/Mean_ExtInt/'
# vois <- c(dir(fmri.oncorr1, 'VOI.*csv', full.names = TRUE),
#           dir(fmri.oncorr2, 'VOI.*csv', full.names = TRUE),
#           dir(fmri.oncorr3, 'VOI.*csv', full.names = TRUE))
fmri.oncorr1 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers/Int2gtExt/marsbar'
fmri.oncorr2 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers/Int3gtExt/marsbar'
fmri.oncorr3 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers/Mean_ExtInt/marsbar'
vois <- c(dir(fmri.oncorr1, '*csv', full.names = TRUE),
          dir(fmri.oncorr2, '*csv', full.names = TRUE),
          dir(fmri.oncorr3, '*csv', full.names = TRUE))

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfAppendicularSum, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
        
        c <- cor.test(fmridat$Beta,fmridat$Up3OfAppendicularSum)
        
        p <- ggplot(fmridat, aes(x=Up3OfAppendicularSum, y=Beta)) + 
                geom_point(aes(color=Subtype), alpha = .3, shape = 19, size = 2) + 
                geom_smooth(method = 'lm', se = FALSE, lwd = 2, color='black') +
                ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ': r=', round(c$estimate, digits = 3), sep = ' '))) + 
                theme_cowplot(font_size = 20) +
                xlab('MDS-UPDRS III (bradykinesia+rigidity)')
        print(p)
        
}

# Putamen and subtype data
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfAppendicularSum)

file <- c('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0001_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0002_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0003_ses-Visit1.txt')

con1 <- read_csv(file[1])
con2 <- read_csv(file[2])
con3 <- read_csv(file[3])
fmridat.putamen <- bind_rows(con1,con2,con3)
fmridat.putamen <- fmridat.putamen %>%
        separate(Img, into = c('x1','x2','pseudonym','session','y1','contrast'), sep = '_') %>%
        mutate(ParticipantType = paste(x1,x2,sep='_'),
               contrast = str_remove(contrast, 'L2Rswap'),
               contrast = str_remove(contrast, '.nii')) %>%
        select(-c(x1,x2,y1,session))
fmridat.putamen <- fmridat.putamen %>%
        filter(ParticipantType=='PD_POM')
fmridat.putamen <- fmridat.putamen %>%
        left_join(., Subtypes, by = 'pseudonym')
fmridat.putamen <- fmridat.putamen %>%
        mutate(Group = Subtype,
               Group = factor(Group,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
               Cond = factor(contrast,
                                 levels = c('0001','0002','0003'),
                                 labels = c('1choice','2choice','3choice'))) %>%
        na.omit() %>%
        filter(pseudonym %in% unique(fmridat.putamen$pseudonym))

fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','ParticipantType','Group','Up3OfAppendicularSum'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean=(`1choice`+`2choice`+`3choice`)/3)

##### Mean correlation #####

voi.ipl <- vois[14]
voi.spl <- vois[15]
voi.pmc <- vois[13]
voi.putamen <- fmridat.putamen.collapsed %>%
        select(pseudonym,Mean) %>%
        rename(Putamen=Mean)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfAppendicularSum, Subtype)

fmridat1 <- read_csv(voi.pmc, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(PMC = Vals) %>%
                left_join(., severity, by = 'pseudonym')
fmridat2 <- read_csv(voi.ipl, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(IPL = Vals) %>%
                left_join(., severity, by = 'pseudonym')
fmridat3 <- read_csv(voi.spl, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(IPL = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- full_join(fmridat1, fmridat2)
fmridat <- left_join(fmridat, voi.putamen, by = 'pseudonym')
fmridat <- fmridat %>%
        pivot_longer(cols = c('PMC','IPL','Putamen'), names_to = 'Region', values_to = 'Beta')

c.PMC <- cor.test(fmridat$Beta[fmridat$Region=='PMC'],
                  fmridat$Up3OfAppendicularSum[fmridat$Region=='PMC'])
c.IPL <- cor.test(fmridat$Beta[fmridat$Region=='IPL'],
                  fmridat$Up3OfAppendicularSum[fmridat$Region=='IPL'])
c.Putamen <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                  fmridat$Up3OfAppendicularSum[fmridat$Region=='Putamen'])

N <- fmridat %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat, aes(x=Up3OfAppendicularSum, y=Beta, color=factor(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 4) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 2.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction=-1,
                               labels = c(paste('IPL', ' (n=', N[1],')',
                                                ', r=', round(c.IPL$estimate,digits=2), sep=''),
                                          paste('PMC', ' (n=', N[1],')',
                                                ', r=', round(c.PMC$estimate,digits=2), sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                ', r=', round(c.Putamen$estimate,digits=2), sep=''))) +
        ggtitle('Associations between mean task-related \nactivity and disease severity') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 60, font_family = 'Calibri') +
        theme(legend.position = c(0.6,1),
              legend.key.size = unit(2,'cm'),
              legend.text = element_text(size = 40)) +
        xlab('MDS-UPDRS-III (bradykinesia + rigidity)') +
        ylab('Beta (mean)') +
        ylim(-18,20)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_Mean_Severity.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

# Facetted version
N <- fmridat %>%
        select(pseudonym, Subtype) %>%
        group_by(Subtype) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat, aes(x=Up3OfAppendicularSum, y=Beta)) + 
        geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 6) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 2.5, color='black') +
        scale_colour_viridis_d(option='viridis', begin = 0.1, end = .6, alpha = .8,
                               direction=-1,
                               labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
                                          paste('IM', ' (n=', N[2,2],')', sep=''),
                                          paste('DM', ' (n=', N[3,2],')', sep=''))) +
        ggtitle('Associations between mean task-related \nactivity and disease severity') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 60, font_family = 'Calibri') +
        theme(legend.position = c(0.8,0.35),
              legend.key.size = unit(1.5,'cm'),
              legend.text = element_text(size = 40)) +
        xlab('MDS-UPDRS-III (bradykinesia + rigidity)') +
        ylab('Beta (mean)') +
        ylim(-18,20) + 
        facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_Mean_Severity_facet.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)


#####

##### Three>One correlation #####

parietal1 <- vois[1]
parietal2 <- vois[8]
voi.putamen <- fmridat.putamen.collapsed %>%
        mutate(INT3gtEXT = `3choice` - `1choice`) %>%
        select(pseudonym,INT3gtEXT) %>%
        rename(Putamen=INT3gtEXT)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfAppendicularSum, Subtype)

fmridat1 <- read_csv(parietal1, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
fmridat2 <- read_csv(parietal2, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- full_join(fmridat1, fmridat2) %>%
        arrange(pseudonym) %>%
        mutate(Cond=factor(Cond)) %>%
        group_by(pseudonym, Subtype) %>%
        summarise(across(c(Beta,Up3OfAppendicularSum), ~mean(.x, na.rm=TRUE))) %>%
        rename(SPL = Beta)

fmridat.SPL_putamen <- left_join(fmridat, voi.putamen, by=c('pseudonym')) %>%
        pivot_longer(cols = c('SPL','Putamen'), names_to = 'Region', values_to = 'Beta') %>% ungroup()

c.SPL <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'],
                  fmridat.SPL_putamen$Up3OfAppendicularSum[fmridat.SPL_putamen$Region=='SPL'])
c.Putamen <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                  fmridat.SPL_putamen$Up3OfAppendicularSum[fmridat.SPL_putamen$Region=='Putamen'])

N <- fmridat.SPL_putamen %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())
plot <- ggplot(fmridat.SPL_putamen, aes(x=Up3OfAppendicularSum, y=Beta, color=fct_rev(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 4, show.legend = FALSE) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 2.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction = -1,
                               labels = c(paste('SPL', ' (n=', N[1],')',
                                                ', r=', round(c.SPL$estimate,digits=2), sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                ', r=', round(c.Putamen$estimate,digits=2), sep=''))) +
        ggtitle('Associations between task-related \nactivity and disease severity') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 60, font_family = 'Calibri') +
        theme(legend.position = c(0.6,1),
              legend.key.size = unit(2,'cm'),
              legend.text = element_text(size = 40)) +
        xlab('MDS-UPDRS III (bradykinesia + rigidity)') +
        ylab('Beta (multiple - one)')
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_INT2nINT3gtEXT_Severity.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

#Facetted vcersion
N <- fmridat.SPL_putamen %>%
        select(pseudonym, Subtype) %>%
        group_by(Subtype) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat.SPL_putamen, aes(x=Up3OfAppendicularSum, y=Beta)) + 
        geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 6) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 2.5, color='black') +
        scale_colour_viridis_d(option='viridis', begin = 0.1, end = .6, alpha = .8,
                               direction=-1,
                               labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
                                          paste('IM', ' (n=', N[2,2],')', sep=''),
                                          paste('DM', ' (n=', N[3,2],')', sep=''))) +
        ggtitle('Associations between task-related \nactivity and disease severity') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 60, font_family = 'Calibri') +
        theme(legend.position = c(0.8,0.9),
              legend.key.size = unit(1.5,'cm'),
              legend.text = element_text(size = 40)) +
        xlab('MDS-UPDRS-III (bradykinesia + rigidity)') +
        ylab('Beta (multiple - one)') +
        facet_grid(~factor(Region, levels = c('SPL','Putamen'), labels = c('SPL','Putamen')))
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_INT2nINT3gtEXT_Severity_facet.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)


#####
```

# Response times

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_rts <- function(f, tmp, tmp.collapsed){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE, digits = 3)
        cat('\n \n Anova: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        em3 <- emmeans(fit, ~ block|trial_type, type='response')
        contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, trial_type ~ block, type='response') %>% print()
        
        em4 <- emmeans(fit, pairwise ~ ParticipantType, type='response')
        print(em4)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em5 <- emmeans(fit, pairwise ~ trial_type, type='response')
        print(em5)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
                # Generate rainclouds where points, boxplots and densities reflect actual data
                # Means, CIs, and lines reflect estimated marginal means
        cat('\n \n Summary statistics \n')
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of Parkinson\'s \ndisease on response times',
                              xlab='', ylab='Response time (s)',
                              xticklabs=c(paste('Healthy', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0.3,1.75)
        y <- 1.75
        d = 0.1
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  0.80,  1.80,  1.80),
                xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  1.00,  1.20,  2.00,  2.20),
                y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(1.50,  0.90,  1.00,  1.90,  2.00),
                y =     c(y,     y-d*2, y-d*3, y-d*2, y-d*3),
                label = c('***', '***', '***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_HCvsON.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
        
        tplot <- emmip(fit, trial_type~ParticipantType, CIs = TRUE,
                       type='response') +
                scale_x_discrete(labels=c('Healthy','PD-On')) + 
                scale_colour_viridis_d(option='mako', begin = .1, end = .6,
                                       direction = -1,labels=c('One','Two','Three')) +
                ggtitle('') + ylab('Predicted response times (s)') +
                xlab('Group') + 
                guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
                theme_cowplot(font_size = 20)
        print(tplot)
        
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + (1+trial_type+block|pseudonym)'
# removed due to non-significance

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type))
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time), ~ mean(.x, na.rm=TRUE)))
compare_rts(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)
```

## ON, Bradykinesia-rigidity ~ RTs

```{r echo = FALSE, warning = TRUE}
tmp.clincorr <- tmp %>%
        filter(ParticipantType=='PD_POM')
f.clincorr <- 'log(response_time) ~ 1 + trial_type*block*Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + (1+trial_type+block|pseudonym)'
fit.clincorr <- lmer(f.clincorr, tmp.clincorr, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit.clincorr)
print(s, corr=FALSE, digits = 3)
anova <- anova(fit.clincorr)
print(anova)
plotdat <- tmp.clincorr %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, Up3OfAppendicularSum), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()

c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, Up3OfAppendicularSum), ~ mean(., na.rm=TRUE))) %>%
        select(response_time, Up3OfAppendicularSum)
c <- cor.test(c$response_time, c$Up3OfAppendicularSum)
N <- plotdat %>%
        filter(trial_type=='1choice') %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(plotdat, aes(y=response_time, x=Up3OfAppendicularSum, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 5) +
        geom_smooth(method='lm', se = FALSE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between response \ntimes and disease severity') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Response time (s)') +
        theme_cowplot(font_size = 60, font_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = c(0.75,1.15),
              legend.key.size = unit(2,'cm')) +
        geom_text(x=10,y=1.35, label = paste('N=', N, ', r=', round(c$estimate,digits=2), sep=''),
                  size=16, inherit.aes = FALSE) +
        ylim(0.5,1.75) + xlim(0,60)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Corr_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

# Post hoc test
# Association between disease severity and response times
cat('\n \n Emtrends \n \n ')
emt <- emtrends(fit.clincorr, ~trial_type, var='Up3OfAppendicularSum_Dmean')
contrast(emt, 'identity', adjust = 'mvt') %>% print()
# emttplot <- emmip(fit.clincorr, trial_type ~ Up3OfAppendicularSum, cov.reduce=range,
#                   CIs = TRUE)
# emttplot <- emttplot +
#         theme_cowplot(font_size = 20) +
#         scale_colour_viridis_d(option='turbo', labels = c('One','Two','Three')) +
#         ggtitle('') +
#         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
#         guides(color=guide_legend(title='No. of choices', reverse = TRUE))
# print(emttplot)
# Association between subtype and trial type, corrected for by disease severity
# cat('\n \n Emmeans \n \n')
# emm <- emmeans(fit.clincorr, ~trial_type*Up3OfAppendicularSum, type='response')
# print(emm)
# contrast(emm, interaction = c(trial_type='revpairwise', Up3OfAppendicularSum='identity'), adjust = 'mvt', by = NULL) %>% print()
# Visualization
# emmip(fit.clincorr, Up3OfAppendicularSum ~ trial_type, type = 'response', CIs=TRUE) %>% print()
```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->
<!-- compare_rts <- function(f, tmp, tmp.collapsed){ -->
<!--         # Fit model -->
<!--         print(paste('Fitting the following model:', f, sep=' ')) -->
<!--         fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->
<!--         s <- summary(fit) -->
<!--         print(s, corr = FALSE, digits = 3) -->
<!--         cat('\n \n Anova: ') -->
<!--         anova <- anova(fit) -->
<!--         print(anova) -->
<!--         cat('\n \n') -->
<!--         effectsize(anova) %>% print() -->
<!--         # Post hoc test -->
<!--                 # Interaction -->
<!--         cat('\n \n Post hoc tests of interaction ParticipantType x trial_type \n') -->
<!--         em <- emmeans(fit, ~ ParticipantType | trial_type) -->
<!--         print(em) -->
<!--         contrast(em, interaction = c(ParticipantType = 'revpairwise', trial_type='revpairwise'), -->
<!--                  by=NULL, adjust = 'mvt', type='response') %>% print() # by=NULL overrides the grouping of em -->
<!--         # interaction specifies the contrasts that are defined and how they are presented -->
<!--                 # Main effects -->
<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->
<!--         emmeans(fit, pairwise ~ ParticipantType|trial_type, type = 'response', adjust = 'mvt')$contrast %>% print() -->
<!--         cat('\n \n Post hoc tests of main effect trial_type \n') -->
<!--         emmeans(fit, pairwise ~ trial_type|ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->
<!--         # Visualization -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->
<!--                 # emmip with plotit=FALSE gives a table of summarystats that is very handy -->
<!--                 # Some adjustments make it usable for the raincloudplot function below -->
<!--         emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>% -->
<!--                 tibble() %>% -->
<!--                 rename(mean = yvar, -->
<!--                        se = SE) %>% -->
<!--                 select(-c(df, tvar, xvar)) %>% -->
<!--                 mutate(ci = se*1.96) -->
<!--                 # Generate rainclouds where points, boxplots and densities reflect actual data -->
<!--                 # Means, CIs, and lines reflect estimated marginal means -->
<!--         cat('\n \n Summary statistics \n') -->
<!--         raincloudplot_2Factor(data=tmp.collapsed, y='response_time', -->
<!--                               groupvar=c('trial_type','ParticipantType'), -->
<!--                               title='', xlab='Group', ylab='Response time (s)', -->
<!--                               xticklabs=c('Healthy','PD-Off'), legend_title = 'No. of choices', -->
<!--                               legend_labels = c('One','Two','Three'), -->
<!--                               provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, trial_type~ParticipantType, CIs = TRUE, -->
<!--                        type='response') + -->
<!--                 scale_x_discrete(labels=c('Healthy','PD-Off')) +  -->
<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->
<!--                                        direction = -1,labels=c('One','Two','Three')) + -->
<!--                 ggtitle('') + ylab('Predicted response times (s)') + -->
<!--                 xlab('Group') +  -->
<!--                 guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->
<!--                 theme_cowplot(font_size = 20) -->
<!--         print(tplot) -->

<!--         plot(fit) %>% print() -->
<!--         qqmath(fit) %>% print() -->
<!--         qqmath(ranef(fit)) -->

<!-- } -->

<!-- f <- 'log(response_time) ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + (1+trial_type+block|pseudonym)' -->
<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->
<!-- tmp <- df %>% -->
<!--         filter(event_type == 'response') %>% -->
<!--         filter(trial_type != 'Catch') %>% -->
<!--         filter(response_time > 0.3) %>% -->
<!--         filter(correct_response=='Hit') %>% -->
<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->
<!--         filter(ParticipantType %in% groups) %>% -->
<!--         mutate(ParticipantType = droplevels(ParticipantType), -->
<!--                trial_type = droplevels(trial_type)) -->
<!-- tmp.collapsed <- tmp %>%  -->
<!--         group_by(pseudonym, ParticipantType, trial_type) %>% -->
<!--         summarise(across(c(response_time), ~ mean(.x))) -->
<!-- compare_rts(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed) -->

<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_rts_for_medication <- function(f, tmp, tmp.collapsed){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr=FALSE, digits = 3)
        cat('\n \n Anova: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, 'pairwise', adjust = 'mvt') %>% print()
                # Association between subtype and trial type, corrected for by disease severity
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        em3 <- emmeans(fit, ~ block|trial_type, type='response')
        contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, trial_type ~ block, type='response') %>% print()
        
        em4 <- emmeans(fit, pairwise ~ ParticipantType, type='response')
        print(em4)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em5 <- emmeans(fit, pairwise ~ trial_type, type='response')
        print(em5)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        # emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE,
        #                      type = 'response', cov.reduce=Up3OfAppendicularSum_Dmean ~ ParticipantType) %>%
        #         tibble() %>%
        #         rename(mean = yvar,
        #                se = SE) %>%
        #         select(-c(df, tvar, xvar)) %>%
        #         mutate(ci = se*1.96)
                # Generate rainclouds where points, boxplots and densities reflect actual data
                # Means, CIs, and lines reflect estimated marginal means
        cat('\n \n Summary statistics \n')
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                                      groupvar=c('trial_type','ParticipantType'),
                                      title='Influence of medication on \nresponse times',
                                      xlab='', ylab='Response time (s)',
                                      xticklabs=c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                                  paste('PD-On', ' (n=', N[2],')', sep='')), 
                                      legend_title = '',
                                      legend_position = legend_position,
                                      legend_labels = c('One', 'Two', 'Three'),
                                      provided_summary = 'None') +
                ylim(0.3,1.75) #+
                # geom_segment(x=1,xend=2,y=1.46,yend=1.46,size=lsize) +
                # geom_segment(x=1,xend=1,y=1.46,yend=1.44,size=lsize) +
                # geom_segment(x=2,xend=2,y=1.46,yend=1.44,size=lsize) +
                # geom_segment(x=0.8,xend=1.2,y=1.44,yend=1.44,size=lsize) +
                # geom_segment(x=1.8,xend=2.2,y=1.44,yend=1.44,size=lsize) +
                # geom_segment(x=0.8,xend=0.8,y=1.44,yend=1.42,size=lsize) +
                # geom_segment(x=1.2,xend=1.2,y=1.44,yend=1.42,size=lsize) +
                # geom_segment(x=1.8,xend=1.8,y=1.44,yend=1.42,size=lsize) +
                # geom_segment(x=2.2,xend=2.2,y=1.44,yend=1.42,size=lsize) +
                # geom_text(x=1.5,y=1.5,label=('p = 0.085'),size=sigsize,
                #           show.legend = FALSE)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_ONvsOff.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
        
        # tplot <- emmip(fit, ParticipantType~Up3OfAppendicularSum, CIs = TRUE,
        #                type='response', at=list(Up3OfAppendicularSum = c(7,26.5,46)), dodge=1.5) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + ylab('Predicted response times (s)') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)
        
        # plotdat <- tmp %>%
        #         group_by(pseudonym, ParticipantType) %>%
        #         summarise(across(c(response_time, Up3OfAppendicularSum), ~ mean(.x, na.rm=TRUE))) %>%
        #         ungroup()
        # 
        # dOff <- plotdat %>% filter(ParticipantType=='PD_PIT')
        # cOff <- cor.test(dOff$response_time, dOff$Up3OfAppendicularSum)
        # dOn <- plotdat %>% filter(ParticipantType=='PD_POM')
        # cOn <- cor.test(dOn$response_time, dOn$Up3OfAppendicularSum)
        # 
        # plot <- ggplot(plotdat, aes(y=response_time, x=Up3OfAppendicularSum, 
        #                             color = ParticipantType)) +
        #         geom_point(alpha = .3, shape = 19, size = 2, show.legend = FALSE) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1,
        #                                labels = c(paste('PD-Off', ' (n=', N[1],')',
        #                                                 ', r=', round(cOff$estimate,digits=3), sep=''),
        #                                   paste('PD-On', ' (n=', N[2],')',
        #                                                 ', r=', round(cOn$estimate,digits=3), sep=''))) +
        #         ggtitle('Influence of medication on the association \nbetween response times and disease severity') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Response times (s)') + 
        #         guides(color=guide_legend(title='', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 35, font_family = 'Calibri') +
        #         theme(legend.position = c(.05,.85)) +
        #         xlim(6,55)+
        #         geom_segment(x=47,xend=47,y=1.005,yend=1.035,size=lsize) +
        #         geom_text(x=48,y=1.014,label='*',size=sigsize, show.legend = FALSE)
        #         
        # print(plot)
        # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ONvsOFF_RTs_Severity.tiff',
        #   plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)
        
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + (1+block|pseudonym)'
# Random slope for trial_type removed due to non-significance

groups <- c('PD_PIT','PD_POM')

tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type))
disease_severity <- tmp %>%
        filter(ParticipantType=='PD_POM') %>%
        select(pseudonym, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean, NpsEducYears, NpsEducYears_Dmean) %>%
        group_by(pseudonym) %>%
        summarise(across(c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean)) %>%
        left_join(., disease_severity, by = 'pseudonym')
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time), ~ mean(.x)))
compare_rts_for_medication(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```

## Subtypes vs subtypes

```{r echo=FALSE, message=FALSE}

compare_rts_for_subtypes <- function(f, tmp, tmp.collapsed){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr=FALSE, digits = 3)
        anova <- anova(fit)
        print(anova)
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        em3 <- emmeans(fit, ~ block|trial_type, type='response')
        contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, trial_type ~ block, type='response') %>% print()
        
        em4 <- emmeans(fit, trt.vs.ctrl ~ ParticipantType, adjust='mvt', type='response')
        print(em4)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em5 <- emmeans(fit, pairwise ~ trial_type, type='response')
        print(em5)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        # emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE,
        #                      type = 'response', cov.reduce=Up3OfAppendicularSum_Dmean ~ ParticipantType) %>%
        #         tibble() %>%
        #         rename(mean = yvar,
        #                se = SE) %>%
        #         select(-c(df, tvar, xvar)) %>%
        #         mutate(ci = se*1.96)
                # Generate rainclouds where points, boxplots and densities reflect actual data
                # Means, CIs, and lines reflect estimated marginal means
        
        # raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
        #                       groupvar=c('trial_type','ParticipantType'),
        #                       title='', xlab='Number of choices', ylab='Response time (s)',
        #                       xticklabs=c('MMP','IM', 'DM'), legend_title = 'No. of choices',
        #                       legend_labels = c('One', 'Two', 'Three'),
        #                       provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, trial_type~Up3OfAppendicularSum|ParticipantType, CIs = TRUE,
        #                type='response', at=list(Up3OfAppendicularSum = c(5,31,57)), dodge=7) +
        #         scale_colour_viridis_d(option='mako', begin = .1, end = .6,
        #                                direction = -1, labels = c('One','Two', 'Three')) +
        #         ggtitle('') + ylab('Predicted response times (s)') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)
        
        # plotdat <- tmp %>%
        #         group_by(pseudonym, ParticipantType, trial_type) %>%
        #         summarise(across(c(response_time, Up3OfAppendicularSum), ~ mean(.x, na.rm=TRUE))) %>%
        #         ungroup()
        # g <- ggplot(plotdat, aes(y=response_time, x=Up3OfAppendicularSum, color = trial_type, group = trial_type)) +
        #         geom_point(alpha = .3, shape = 19, size = 2) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1, labels = c('One','Two','Three')) +
        #         ggtitle('') + xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Response times (s)') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 20) +
        #         facet_grid(~ParticipantType)
        # print(g)
        
        # emmeans(fit, pairwise ~ trial_type*Up3OfAppendicularSum_Dmean|ParticipantType)
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice',
                       block == '1') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                                      groupvar=c('trial_type','ParticipantType'),
                                      title='Influence of subtype on \nresponse times',
                                      xlab='', ylab='Response time (s)',
                                      xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                                  paste('IM', ' (n=', N[2],')', sep=''),
                                                  paste('DM', ' (n=', N[3],')', sep='')), 
                                      legend_title = '',
                                      legend_position = legend_position,
                                      legend_labels = c('One', 'Two', 'Three'),
                                      provided_summary = 'None') +
                ylim(0.3,1.75)
        y <- 1.75
        d = 0.1
        segmap <- data.frame(
                x =    c(0.80,  0.80,  1.80,  1.80,  2.80,  2.80),
                xend = c(1.00,  1.20,  2.00,  2.20,  3.00,  3.20),
                y =    c(y-d*1, y-d*2, y-d*1, y-d*2, y-d*1, y-d*2),
                yend = c(y-d*1, y-d*2, y-d*1, y-d*2, y-d*1, y-d*2)
        )
        sigmap <- data.frame(
                x =     c(0.90,  1.00,  1.90,  2.00,  2.90,  3.00),
                y =     c(y-d*1, y-d*2, y-d*1, y-d*2, y-d*1, y-d*2),
                label = c('***', '***', '***', '***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Subtypes.tiff',
                  plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
        
        # dOff <- tmp. %>% filter(ParticipantType=='PD_PIT')
        # cOff <- cor.test(dOff$response_time, dOff$Up3OfAppendicularSum)
        # dOn <- plotdat %>% filter(ParticipantType=='PD_POM')
        # cOn <- cor.test(dOn$response_time, dOn$Up3OfAppendicularSum)
        
        # faclabs <- c(MMP=paste('MMP',' (n=',N[1],')',sep=''),
        #              IM=paste('IM',' (n=', N[2],')',sep=''),
        #              DM=paste('DM',' (n=', N[3],')',sep=''))
        # 
        # segmap <- data.frame(
        #         ParticipantType=factor(c(1,2,3,3),
        #                                labels=c('MMP','IM','DM'),
        #                                levels=c(1,2,3)),
        #         x=c(45,59,53,57),
        #         xend=c(45,59,53,57),
        #         y=c(0.86,0.995,0.93,0.93),
        #         yend=c(0.89,1.055,1.06,1.08)
        # )
        # sigmap <- data.frame(
        #         ParticipantType=factor(c(1,2,3,3),
        #                                labels=c('MMP','IM','DM'),
        #                                levels=c(1,2,3)),
        #         x=c(49,62,57,61),
        #         y=c(0.875,1.025,0.995,1.005),
        #         label=c('*','+','***','***')
        # )
        # 
        # plot <- ggplot(tmp.collapsed, aes(y=response_time, x=Up3OfAppendicularSum)) +
        #         geom_point(aes(color=trial_type),
        #                    alpha = .3, shape = 19, size = 2, show.legend=FALSE) +
        #         geom_smooth(aes(color=trial_type),
        #                     method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1,
        #                                labels = c('One','Two','Three')) +
        #         ggtitle('Influence of subtype on the association \nbetween response times and disease severity') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Response times (s)') + 
        #         guides(color=guide_legend(title='', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 35, font_family = 'Calibri') +
        #         theme(legend.position = c(0.02,0.9)) +
        #         facet_grid(~ParticipantType, labeller=labeller(ParticipantType=faclabs)) +
        #         xlim(5,62) +
        #         geom_segment(data = segmap,
        #                      mapping = aes(x=x,xend=xend,
        #                                    y=y,yend=yend),
        #                      size=lsize) +
        #         geom_text(data=sigmap,
        #                   mapping = aes(x=x,y=y,label=label,angle=90),
        #                   size=sigsize,
        #                   show.legend = FALSE)
        #         
        # print(plot)
        # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Subtypes_RTs_Severity.tiff',
        #   plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)
        
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}
plot_rts_for_subtypes <- function(tmp){
        plotdat <- tmp %>%
                group_by(pseudonym, trial_type, Subtype) %>%
                summarise(across(c(response_time, Up3OfAppendicularSum), ~ mean(.x, na.rm=TRUE))) %>%
                ungroup() %>%
                na.omit()
        # plotdat$Subtype <- factor(plotdat$Subtype, labels = c('MMP','IM','DM'))
        g <- ggplot(plotdat, aes(y=Up3OfAppendicularSum, x=response_time, color = trial_type, group = trial_type)) +
                geom_point(alpha = .4, shape = 19, size = 2) +
                geom_smooth(method='lm', se = FALSE, lwd = 2) +
                scale_colour_viridis_d(option='turbo', labels = c('One','Two','Three')) +
                ggtitle('') + ylab('MDS-UPDRS III (bradykineisa + rigidity)') + xlab('Response times (s)') + 
                guides(color=guide_legend(title='No. of choices', reverse = TRUE)) + 
                theme_cowplot(font_size = 20) +
                facet_grid(~Subtype)
        print(g)
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + (1+trial_type+block|pseudonym)'
#  was removed due to non-significance

# Subtypes only
groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')))

tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, block, trial_type) %>%
        summarise(across(c(response_time, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean), ~ mean(.x)))
compare_rts_for_subtypes(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

cat('\n\n\n\n')
```

## Subtypes vs HC

```{r}

compare_rts_for_subtypeshc <- function(f, tmp, tmp.collapsed){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr=FALSE, digits = 3)
        anova <- anova(fit)
        print(anova)
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        em3 <- emmeans(fit, ~ block|trial_type, type='response')
        contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, trial_type ~ block, type='response') %>% print()
        
        em4 <- emmeans(fit, trt.vs.ctrl ~ ParticipantType, adjust='mvt', type='response')
        print(em4)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em5 <- emmeans(fit, pairwise ~ trial_type, type='response')
        print(em5)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice',
                       block == '1') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                                      groupvar=c('trial_type','ParticipantType'),
                                      title='Influence of subtype on \nresponse times',
                                      xlab='', ylab='Response time (s)',
                                      xticklabs=c(paste('HC', ' (n=', N[1],')', sep=''),
                                                  paste('MMP', ' (n=', N[2],')', sep=''),
                                                  paste('IM', ' (n=', N[3],')', sep=''),
                                                  paste('DM', ' (n=', N[4],')', sep='')), 
                                      legend_title = '',
                                      legend_position = legend_position,
                                      legend_labels = c('One', 'Two', 'Three'),
                                      provided_summary = 'None') +
                ylim(0.3,1.75)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_SubtypesHc.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
        
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + (1+trial_type+block|pseudonym)'
#  was removed due to non-significance

# Subtypes compared to healthy controls
groups <- c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype,
                                      levels = c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('HC', 'MMP', 'IM', 'DM')))

tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, block, trial_type) %>%
        summarise(across(c(response_time, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean), ~ mean(.x)))
compare_rts_for_subtypes(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```


# Button selection variability

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_cov <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        group_by(ParticipantType) %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        # anovaOutliersRetained <- anova(fitOutliersRetained)
        # cat('\n \n Outliers retained: ')
        # print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        print(em)
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Coefficient of variation', xlab = 'Group',
                              xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print()
        
        tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response')
        tplot <- tplot + 
                theme_cowplot(font_size = 20) +
                scale_x_discrete(labels = c('Healthy','PD-On')) +
                ggtitle('') + 
                xlab('Group')
        print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()
compare_cov(f=f, tmp=tmp)

```

## ON, Bradykinesia-rigidity ~ CoV

```{r echo=FALSE, message=FALSE, warning=TRUE}
f <- 'log(Button.Press.CoV) ~ 1 + Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()

fit <- lm(f, tmp)
s <- summary(fit)
print(s, corr=FALSE, digits = 3)
anova <- anova(fit)
print(anova)

c <- cor.test(tmp$Button.Press.CoV, tmp$Up3OfAppendicularSum)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(tmp, aes(y=Button.Press.CoV, x=Up3OfAppendicularSum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, lwd = 2, color = 'black') +
        ggtitle('') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('CoV') +
        theme_cowplot(font_size = 35, font_family = 'Calibri')
print(plot)

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_cov <- function(f, tmp, outlier_method = 2){ -->
<!--         # Fit model -->
<!--         print(paste('Fitting the following model:', f, sep=' ')) -->
<!--         fitOutliersRetained <- lm(f, data=tmp) -->
<!--         if(outlier_method == 1){ -->
<!--                 outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric() -->
<!--                 tmp <- tmp[-c(outliers),] -->
<!--         }else if(outlier_method == 2){ -->
<!--                 tmp <- tmp %>% -->
<!--                         group_by(ParticipantType) %>% -->
<!--                         filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>% -->
<!--                         ungroup() -->
<!--         } -->
<!--         fit <- lm(f, data=tmp) -->
<!--         s <- summary(fit) -->
<!--         print(s, digits=3) -->
<!--         # anovaOutliersRetained <- anova(fitOutliersRetained) -->
<!--         # cat('\n \n Outliers retained: ') -->
<!--         # print(anovaOutliersRetained) -->
<!--         cat('\n \n Outliers removed: ') -->
<!--         anova <- anova(fit) -->
<!--         print(anova) -->
<!--         cat('\n \n') -->
<!--         effectsize(anova) %>% print() -->
<!--         # Post hoc test -->
<!--         cat('\n \n EMMs \n') -->
<!--         em <- emmeans(fit, ~ ParticipantType, type = 'response') -->
<!--         print(em) -->
<!--                 # Main effects -->
<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->
<!--         emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->
<!--         # Visualization -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R') -->
<!--         cat('\n \n Summary statistics \n') -->
<!--         emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>% -->
<!--                 tibble() %>% -->
<!--                 rename(mean = yvar, -->
<!--                        se = SE) %>% -->
<!--                 select(-c(df, tvar, xvar)) %>% -->
<!--                 mutate(ci = se*1.96) -->
<!--         raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType', -->
<!--                               title = '', ylab = 'Coefficient of variation', xlab = 'Group', -->
<!--                               xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response') -->
<!--         tplot <- tplot +  -->
<!--                 theme_cowplot(font_size = 20) + -->
<!--                 scale_x_discrete(labels = c('Healthy','PD-Off')) + -->
<!--                 scale_colour_viridis_d(option='viridis', begin = .1, end = .6, -->
<!--                                        direction = -1) + -->
<!--                 ggtitle('') +  -->
<!--                 xlab('Group') -->
<!--         print(tplot) -->

<!--         plot(fit, which = 1) %>% print() -->
<!--         plot(fit, which = 2) %>% print() -->
<!--         plot(fit, which = 4) %>% print() -->

<!-- } -->

<!-- f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + RespHandIsDominant' -->
<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->
<!-- tmp <- df %>% -->
<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->
<!--         filter(ParticipantType %in% groups) %>% -->
<!--         mutate(ParticipantType = droplevels(ParticipantType)) %>% -->
<!--         group_by(pseudonym, ParticipantType) %>% -->
<!--         summarise(across(everything(), ~first(.x))) %>% -->
<!--         ungroup() -->
<!-- compare_cov(f=f, tmp=tmp) -->
<!-- ``` -->

## OFF vs. ON

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_cov_for_medication <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV))
        }
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE, digits=3)
        # anovaOutliersRetained <- anova(fitOutliersRetained)
        # cat('\n \n Outliers retained: ')
        # print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova, digits=4)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        emm_options(lmer.df = 'satterthwaite')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% print()
        #         # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum_Dmean, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response') %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Coefficient of variation', xlab = 'Group',
                              xticklabs = c('PD-Off','PD-On'), provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, type='response', dodge=2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Group', reverse = TRUE))
        # print(tplot)
        
        plot(fit) %>% print()
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# removed due to non-significance

groups <- c('PD_POM','PD_PIT')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()
disease_severity <- tmp %>%
        filter(ParticipantType=='PD_POM') %>%
        select(pseudonym, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean) %>%
        group_by(pseudonym) %>%
        summarise(across(c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean)) %>%
        left_join(., disease_severity, by = 'pseudonym')
compare_cov_for_medication(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_cov_for_subtypes <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        group_by(ParticipantType) %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>%
                ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        # anovaOutliersRetained <- anova(fitOutliersRetained)
        # cat('\n \n Outliers retained: ')
        # print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        emm_options(lmer.df = 'satterthwaite')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% print()
        #         # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum_Dmean, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response') %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Coefficient of variation', xlab = 'Group',
                              xticklabs = levels(tmp$ParticipantType),
                              color_scheme='viridis', provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, dodge=2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Subtype', reverse = TRUE))
        # print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')))
compare_cov_for_subtypes(f=f, tmp=tmp)

# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
```

# Switch ratio

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        group_by(ParticipantType) %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        # anovaOutliersRetained <- anova(fitOutliersRetained)
        # cat('\n \n Outliers retained: ')
        # print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        print(em)
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Switch ratio', xlab = 'Group',
                              xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print()
        
        tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response')
        tplot <- tplot + 
                theme_cowplot(font_size = 20) +
                scale_x_discrete(labels = c('Healthy','PD-On')) +
                ggtitle('') + 
                xlab('Group')
        print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()
compare_switch(f=f, tmp=tmp)
```

## ON, Bradykinesia-rigidity ~ Switch

```{r echo=FALSE, message=FALSE, warning=TRUE}
f <- 'log(Button.Press.SwitchRatio) ~ 1 + Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()

fit <- lm(f, tmp)
s <- summary(fit)
print(s, corr=FALSE, digits = 3)
anova <- anova(fit)
print(anova)

c <- cor.test(tmp$Button.Press.SwitchRatio, tmp$Up3OfAppendicularSum)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, lwd = 2, color = 'black') +
        ggtitle('') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Switch ratio') +
        theme_cowplot(font_size = 35, font_family = 'Calibri')
print(plot)

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->
<!-- compare_switch <- function(f, tmp, outlier_method = 2){ -->
<!--         # Fit model -->
<!--         print(paste('Fitting the following model:', f, sep=' ')) -->
<!--         fitOutliersRetained <- lm(f, data=tmp) -->
<!--         if(outlier_method == 1){ -->
<!--                 outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric() -->
<!--                 tmp <- tmp[-c(outliers),] -->
<!--         }else if(outlier_method == 2){ -->
<!--                 tmp <- tmp %>% -->
<!--                         group_by(ParticipantType) %>% -->
<!--                         filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>% -->
<!--                         ungroup() -->
<!--         } -->
<!--         fit <- lm(f, data=tmp) -->
<!--         s <- summary(fit) -->
<!--         print(s, digits=3) -->
<!--         # anovaOutliersRetained <- anova(fitOutliersRetained) -->
<!--         # cat('\n \n Outliers retained: ') -->
<!--         # print(anovaOutliersRetained) -->
<!--         cat('\n \n Outliers removed: ') -->
<!--         anova <- anova(fit) -->
<!--         print(anova) -->
<!--         cat('\n \n') -->
<!--         effectsize(anova) %>% print() -->
<!--         # Post hoc test -->
<!--         cat('\n \n EMMs \n') -->
<!--         em <- emmeans(fit, ~ ParticipantType, type = 'response') -->
<!--         print(em) -->
<!--                 # Main effects -->
<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->
<!--         emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->
<!--         # Visualization -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->
<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R') -->
<!--         cat('\n \n Summary statistics \n') -->
<!--         emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>% -->
<!--                 tibble() %>% -->
<!--                 rename(mean = yvar, -->
<!--                        se = SE) %>% -->
<!--                 select(-c(df, tvar, xvar)) %>% -->
<!--                 mutate(ci = se*1.96) -->
<!--         raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType', -->
<!--                               title = '', ylab = 'Switch ratio', xlab = 'Group', -->
<!--                               xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response') -->
<!--         tplot <- tplot +  -->
<!--                 theme_cowplot(font_size = 20) + -->
<!--                 scale_x_discrete(labels = c('Healthy','PD-Off')) + -->
<!--                 ggtitle('') +  -->
<!--                 xlab('Group') -->
<!--         print(tplot) -->

<!--         plot(fit, which = 1) %>% print() -->
<!--         plot(fit, which = 2) %>% print() -->
<!--         plot(fit, which = 4) %>% print() -->

<!-- } -->

<!-- f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + RespHandIsDominant' -->
<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->
<!-- tmp <- df %>% -->
<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->
<!--         filter(ParticipantType %in% groups) %>% -->
<!--         mutate(ParticipantType = droplevels(ParticipantType)) %>% -->
<!--         group_by(pseudonym, ParticipantType) %>% -->
<!--         summarise(across(everything(), ~first(.x))) %>% -->
<!--         ungroup() -->
<!-- compare_switch(f=f, tmp=tmp) -->
<!-- ``` -->

## OFF vs. ON

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch_repeated <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa',
                                                                       optCtrl=list(maxfun=2e5)))
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV))
        }
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE, digits=3)
        # anovaOutliersRetained <- anova(fitOutliersRetained)
        # cat('\n \n Outliers retained: ')
        # print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response') %>% print()
        cat('\n \n')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise'), adjust = 'mvt') %>% print()
                # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Switch ratio', xlab = 'Group',
                              xticklabs = c('PD-Off','PD-On'), provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType~Up3OfAppendicularSum, CIs = TRUE,
        #                type='response', cov.reduce=range, dodge=2) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + ylab('Predicted switch ratio') +
        #         xlab('Bradykinesia-rigidity severity') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)
        
        # g <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum, color = ParticipantType, group = ParticipantType)) +
        #         geom_point(alpha = .3, shape = 19, size = 2) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Switch ratio') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 20)
        # print(g)
        # 
        # dOff <- tmp %>% filter(ParticipantType=='PD_PIT')
        # cOff <- cor.test(dOff$Button.Press.SwitchRatio, dOff$Up3OfAppendicularSum)
        # dOn <- tmp %>% filter(ParticipantType=='PD_POM')
        # cOn <- cor.test(dOn$Button.Press.SwitchRatio, dOn$Up3OfAppendicularSum)
        # 
        # N <- tmp %>%
        #         select(pseudonym) %>%
        #         unique() %>%
        #         nrow()
        # 
        # plot <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum, 
        #                             color = ParticipantType)) +
        #         geom_point(alpha = .3, shape = 19, size = 2, show.legend = FALSE) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1,
        #                                labels = c(paste('PD-Off', ' (n=', N[1],')',
        #                                                 ', r=', round(cOff$estimate,digits=3), sep=''),
        #                                   paste('PD-On', ' (n=', N[1],')',
        #                                                 ', r=', round(cOn$estimate,digits=3), sep=''))) +
        #         ggtitle('Influence of medication on the association \nbetween switches and disease severity') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Switch ratio') + 
        #         guides(color=guide_legend(title='', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 35, font_family = 'Calibri') +
        #         theme(legend.position = c(.05,.85)) +
        #         xlim(0,50) +
        #         geom_segment(x=47,xend=47,y=0.475,yend=0.365,size=lsize) +
        #         geom_text(x=48,y=0.415,label='*',size=sigsize, show.legend = FALSE)
        #         
        # print(plot)
        # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ONvsOFF_Switch_Severity.tiff',
        #   plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)
        
        plot(fit) %>% print()
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# removed due to non-significance

groups <- c('PD_POM','PD_PIT')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup()
disease_severity <- tmp %>%
        filter(ParticipantType=='PD_POM') %>%
        select(pseudonym, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean) %>%
        group_by(pseudonym) %>%
        summarise(across(c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean)) %>%
        left_join(., disease_severity, by = 'pseudonym')
compare_switch_repeated(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch_for_subtypes <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        group_by(ParticipantType) %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        # anovaOutliersRetained <- anova(fitOutliersRetained)
        # cat('\n \n Outliers retained: ')
        # print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        emm_options(lmer.df = 'satterthwaite')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% print()
        #         # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum_Dmean, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response') %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Ratio of switches to non-switches', xlab = 'Group',
                              xticklabs = levels(tmp$ParticipantType),
                              color_scheme = 'viridis', provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, type = 'response', dodge = 2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Subtype', reverse = TRUE))
        # print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')))
compare_switch_for_subtypes(f=f, tmp=tmp)

# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
```

# Percentage correct (multiple-choice conditions)

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_correct <- function(f, tmp, tmp.collapsed){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        cat('\n \n')
        anova <- Anova(fit, type = 'III')
        print(anova)
        cat('\n \n Odds ratios:')
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        # em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        # contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        # emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        # em3 <- emmeans(fit, ~ block|trial_type, type='response')
        # contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        # emmip(fit, trial_type ~ block, type='response') %>% print()
        
        em4 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em4, interaction = c('pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()
        
        cat('\n \n')
        # Visualization
        N <- tmp %>%
                group_by(pseudonym, ParticipantType) %>%
                filter(trial_type == '1choice') %>%
                summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        pcorr <- tmp %>%
                select(pseudonym, trial_type,ParticipantType,Percentage.Correct) %>%
                group_by(pseudonym, trial_type, ParticipantType) %>%
                summarise(across(Percentage.Correct, ~mean(.x,na.rm=TRUE)))
        tplot <- emmip(fit, trial_type ~ ParticipantType,
                       type = 'response', CIs=TRUE, plotit=FALSE) %>%
                ggplot(aes(x=xvar,y=yvar*100, color=trial_type)) +
                geom_point(position=position_dodge(width=0.6),size=8) +
                geom_errorbar(aes(ymin=LCL*100,ymax=UCL*100), lwd=2, width=0.5,
                              position=position_dodge(width=0.6)) +
                scale_x_discrete(labels=c(paste('Healthy', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep=''))) +
                scale_colour_viridis_d(option='mako', begin = .1, end = .6,
                                       direction = -1,labels=c('One','Two','Three')) +
                ggtitle('Influence of Parkinson\'s disease \non accuracy') + ylab('Correct (%)') +
                xlab('') +
                guides(color=guide_legend(title='', reverse = FALSE)) +
                theme_cowplot(font_size = 60, font_family = 'Calibri') +
                theme(legend.position = c(0.79,1.3)) +
                ylim(98.5,100) +
                geom_text(x=1.5,y=99.97,label='***',size=sigsize,
                          show.legend = FALSE)+
                geom_segment(x=1,xend=2,y=99.95,yend=99.95,size=lsize)+
                geom_segment(x=1,xend=1,y=99.95,yend=99.92,size=lsize)+
                geom_segment(x=2,xend=2,y=99.95,yend=99.92,size=lsize)+
                geom_segment(x=0.8,xend=1.2,y=99.92,yend=99.92,size=lsize)+
                geom_segment(x=1.8,xend=2.2,y=99.92,yend=99.92,size=lsize)+
                geom_segment(x=0.8,xend=0.8,y=99.92,yend=99.89,size=lsize)+
                geom_segment(x=1.2,xend=1.2,y=99.92,yend=99.89,size=lsize)+
                geom_segment(x=1.8,xend=1.8,y=99.92,yend=99.89,size=lsize)+
                geom_segment(x=2.2,xend=2.2,y=99.92,yend=99.89,size=lsize)+
                geom_text(x=2,y=99.82,label='***',size=sigsize,
                          show.legend = FALSE)+
                geom_segment(x=1.8,xend=2.2,y=99.80,yend=99.80,size=lsize)+
                geom_text(x=2.1,y=99.71,label='***',size=sigsize,
                          show.legend = FALSE)+
                geom_segment(x=2,xend=2.2,y=99.69,yend=99.69,size=lsize) #+
                # geom_point(data=pcorr, aes(x=ParticipantType,y=Percentage.Correct,
                #                            color=trial_type),
                #            position = position_jitterdodge(dodge.width = .6,
                #                                            jitter.width = .1))
        print(tplot)

        # tplot <- emmip(fit, trial_type ~ ParticipantType, type = 'response', CIs=TRUE,
        #                dodge=0.6, CIarg = list(lwd=4, alpha=0.5)) +
        #         scale_x_discrete(labels=c('Healthy','PD-On')) +
        #         scale_colour_viridis_d(option='mako', begin = .1, end = .6,
        #                                direction = -1,labels=c('One','Two','Three')) +
        #         ggtitle('') + ylab('Predicted probability of correct response') +
        #         xlab('Group') +
        #         guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
        #         theme_cowplot(font_size = 35, font_family = 'Calibri')
        # print(tplot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_HCvsON.tiff',
                  tplot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
        
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of Parkinson\'s \ndisease on accuracy',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('Healthy', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        y <- 70
        d = 3
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.80,  0.80,  1.20,  1.80,  1.80,  2.20,  1.80,  1.80),
                xend = c(2.00, 1.00,  2.00,  1.20,  0.80,  1.20,  2.20,  1.80,  2.20,  2.00,  2.20),
                y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3, y-d*4),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2, y-d*3, y-d*4)
        )
        sigmap <- data.frame(
                x =     c(1.50,  1.90,  2.00),
                y =     c(y,     y-d*3, y-d*4),
                label = c('***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_HCvsON_v2.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

}

f <- 'correct_response ~ 1 + ParticipantType*trial_type + block + Age_Dmean + NpsEducYears_Dmean + (1|pseudonym)'
# Random slopes, along with the interaction with block removed due to singular fit

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               correct_response = factor(if_else(correct_response=='Hit',1,0)))
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)
compare_correct(f=f, tmp=tmp)

```

## ON, Bradykinesia ~ Accuracy

```{r echo=FALSE, message=FALSE, warning=TRUE}

tmp.clincorr <- tmp %>%
        filter(ParticipantType=='PD_POM') %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)
f.clincorr <- 'correct_response ~ 1 + trial_type*block*Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# f.clincorr <- 'correct_response ~ 1 + trial_type*Up3OfAppendicularSum_Dmean + (1|pseudonym)'
fit.clincorr <- glmer(f.clincorr, data=tmp.clincorr, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit.clincorr)
print(s, corr = FALSE)
anova <- Anova(fit.clincorr, type = 'III')
print(anova)
emt <- emtrends(fit.clincorr, ~ trial_type, var='Up3OfAppendicularSum_Dmean')
contrast(emt, 'identity', adjust = 'mvt') %>% print()

plotdat <- tmp.clincorr %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(Percentage.Incorrect, Up3OfAppendicularSum), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()

c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(Percentage.Incorrect, Up3OfAppendicularSum), ~ mean(., na.rm=TRUE))) %>%
        select(Percentage.Incorrect, Up3OfAppendicularSum)
c <- cor.test(c$Percentage.Incorrect, c$Up3OfAppendicularSum)
N <- plotdat %>%
        filter(trial_type=='1choice') %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(plotdat, aes(y=Percentage.Incorrect, x=Up3OfAppendicularSum, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 5) +
        geom_smooth(method='lm', se = FALSE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between accuracy \n and disease severity') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Errors (%)') +
        theme_cowplot(font_size = 60, font_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = c(0.75,1.15),
              legend.key.size = unit(2,'cm')) +
        geom_text(x=10,y=40, label = paste('N=', N, ', r=', round(c$estimate,digits=2), sep=''),
                  size=16, inherit.aes = FALSE) +
        ylim(0,65) + xlim(0,60)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Corr_ON_Severity.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

```


<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_correct <- function(f, tmp){ -->
<!--         # Fit model -->
<!--         print(paste('Fitting the following model:', f, sep=' ')) -->
<!--         fit <- glmer(f, data=tmp, family = binomial, -->
<!--                      control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->
<!--         s <- summary(fit) -->
<!--         print(s, corr = FALSE) -->
<!--         cat('\n \n') -->
<!--         anova <- Anova(fit, type = 'III') -->
<!--         print(anova) -->
<!--         cat('\n \n Odds ratios:') -->
<!--         se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/ -->
<!--         tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se) -->
<!--         exp(tab) %>% print() -->
<!--         # Post hoc test -->
<!--         emm_options(lmer.df = 'satterthwaite') -->
<!--                 # Interaction -->
<!--         cat('\n \n Post hoc tests \n \n') -->
<!--         em <- emmeans(fit, ~ ParticipantType | trial_type, type = 'response') -->
<!--         print(em) -->
<!--         contrast(em, 'eff', interaction = c(ParticipantType = 'pairwise', trial_type = 'revpairwise'), -->
<!--                  by=NULL, adjust = 'mvt') %>% print() # by=NULL overrides the grouping of em -->
<!--         # interaction specifies the contrasts that are defined and how they are presented -->
<!--                 # Main effects -->
<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->
<!--         emmeans(fit, pairwise ~ ParticipantType|trial_type, type = 'response', adjust = 'mvt')$contrast %>% print() -->
<!--         cat('\n \n Post hoc tests of main effect trial_type \n') -->
<!--         emmeans(fit, revpairwise ~ trial_type|ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->
<!--         # Visualization -->
<!--         tplot <- emmip(fit, trial_type ~ ParticipantType, type = 'response', CIs=TRUE) + -->
<!--                 scale_x_discrete(labels=c('Healthy','PD-Off')) + -->
<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->
<!--                                        direction = -1,labels=c('One','Two','Three')) + -->
<!--                 ggtitle('') + ylab('Predicted probability of correct response') + -->
<!--                 xlab('Group') + -->
<!--                 guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->
<!--                 theme_cowplot(font_size = 20) -->
<!--         print(tplot) -->

<!--         plot(fit) %>% print() -->

<!-- } -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + (1|pseudonym)' -->
<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->
<!-- tmp <- df %>% -->
<!--         filter(event_type == 'response') %>% -->
<!--         filter(trial_type != 'Catch') %>% -->
<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->
<!--         filter(ParticipantType %in% groups) %>% -->
<!--         mutate(ParticipantType = droplevels(ParticipantType), -->
<!--                trial_type = droplevels(trial_type), -->
<!--                correct_response = factor(if_else(correct_response=='Hit',1,0))) -->
<!-- compare_correct(f=f, tmp=tmp) -->
<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_correct_for_medication <- function(f, tmp, tmp.collapsed){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr=FALSE)
        cat('\n \n')
        anova <- Anova(fit, type = 'III')
        print(anova)
        cat('\n \n Odds ratios:')
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        em3 <- emmeans(fit, ~ block|trial_type, type='response')
        contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, trial_type ~ block, type='response') %>% print()
        cat('\n \n')
        # Visualization
        N <- tmp %>%
                select(pseudonym) %>%
                unique() %>%
                nrow()
        tplot <- emmip(fit, trial_type ~ ParticipantType,
                       type = 'response', CIs=TRUE, plotit=FALSE) %>%
                ggplot(aes(x=xvar,y=yvar*100, color=tvar)) +
                geom_point(position=position_dodge(width=0.6),size=8) +
                geom_errorbar(aes(ymin=LCL*100,ymax=UCL*100), lwd=2, width=0.5,
                              position=position_dodge(width=0.6)) +
                scale_x_discrete(labels=c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[1],')', sep=''))) +
                scale_colour_viridis_d(option='mako', begin = .1, end = .6,
                                       direction = -1,labels=c('One','Two','Three')) +
                ggtitle('Influence of medication \non accuracy') + ylab('Correct (%)') +
                xlab('') +
                guides(color=guide_legend(title='', reverse = FALSE)) +
                theme_cowplot(font_size = 60, font_family = 'Calibri') +
                theme(legend.position = c(0.79,1.3)) +
                ylim(97.5,100) #+
                # geom_segment(x=0.8,xend=1.2,y=0.9998,yend=0.9998,size=lsize)+
                # geom_text(x=1,y=1,label='**',size=sigsize,show.legend=FALSE) +
                # geom_segment(x=1,xend=1.2,y=0.9988,yend=0.9988,size=lsize)+
                # geom_text(x=1.1,y=0.999,label='**',size=sigsize,show.legend=FALSE)+
                # geom_segment(x=1.8,xend=2.2,y=0.9998,yend=0.9998,size=lsize)+
                # geom_text(x=2,y=1,label='**',size=sigsize,show.legend=FALSE)

        print(tplot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_ONvsOFF.tiff',
                  tplot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

        # tplot <- emmip(fit, trial_type ~ Up3OfAppendicularSum, at=list(Up3OfAppendicularSum = c(7,26.5,46)),
        #                CIs = TRUE, type='response', dodge=2)
        # tplot <- tplot +
        #         scale_colour_viridis_d(option='mako', begin = .1, end = .6,
        #                                direction = -1, labels = c('One','Two', 'Three')) +
        #         ggtitle('') + ylab('Predicted probability of correct response') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)
        
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of medication \non accuracy',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        # y <- 70
        # d = 3
        # segmap <- data.frame(
        #         x =    c(),
        #         xend = c(),
        #         y =    c(),
        #         yend = c()
        # )
        # sigmap <- data.frame(
        #         x =     c(),
        #         y =     c(),
        #         label = c()
        # )
        # plot <- plot + 
        #         geom_segment(data=segmap,
        #                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
        #                      inherit.aes = FALSE,
        #                      size = lsize) +
        #         geom_text(data=sigmap, 
        #                   mapping = aes(x=x,y=y,label=label),
        #                   inherit.aes = FALSE,
        #                   size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_ONvsOFF_v2.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'correct_response ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
#  Random slopes removed due to singular fits and convergence issues

groups <- c('PD_PIT','PD_POM')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               correct_response = factor(if_else(correct_response=='Hit',1,0)))
disease_severity <- tmp %>%
        filter(ParticipantType=='PD_POM') %>%
        select(pseudonym, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean, NpsEducYears, NpsEducYears_Dmean) %>%
        group_by(pseudonym) %>%
        summarise(across(c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,
                           NpsEducYears, NpsEducYears_Dmean), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean)) %>%
        left_join(., disease_severity, by = 'pseudonym')

tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)

compare_correct_for_medication(f=f, tmp=tmp)
```

## Subtypes vs subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_correct_for_subtypes <- function(f, tmp, tmp.collapsed){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        cat('\n \n')
        anova <- Anova(fit, type = 'III')
        print(anova)
        cat('\n \n Odds ratios:')
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        em3 <- emmeans(fit, ~ block|trial_type, type='response')
        contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, trial_type ~ block, type='response') %>% print()
        cat('\n \n')
        # contrast(emm, interaction = c('revpairwise','revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        # Visualization
        # tplot <- emmip(fit, trial_type~Up3OfAppendicularSum_Dmean|ParticipantType, CIs = TRUE,
        #                type='response', cov.reduce=range, dodge=7) +
        #         scale_colour_viridis_d(option='mako', begin = .1, end = .6,
        #                                direction = -1, labels = c('One','Two', 'Three')) +
        #         ggtitle('') + ylab('Predicted probability of correct response') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)

        N <- tmp %>%
                group_by(pseudonym, ParticipantType) %>%
                filter(trial_type == '1choice') %>%
                summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()

        tplot <- emmip(fit, trial_type ~ ParticipantType,
                       type = 'response', CIs=TRUE, plotit=FALSE) %>%
                ggplot(aes(x=xvar,y=yvar*100, color=tvar)) +
                geom_point(position=position_dodge(width=0.6),size=8) +
                geom_errorbar(aes(ymin=LCL*100,ymax=UCL*100), lwd=2, width=0.5,
                              position=position_dodge(width=0.6)) +
                scale_x_discrete(labels=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                          paste('IM', ' (n=', N[2],')', sep=''),
                                          paste('DM', ' (n=', N[3],')', sep=''))) +
                scale_colour_viridis_d(option='mako', begin = .1, end = .6,
                                       direction = -1,labels=c('One','Two','Three')) +
                ggtitle('Influence of subtype \non accuracy') + ylab('Correct (%)') +
                xlab('') +
                guides(color=guide_legend(title='', reverse = FALSE)) +
                theme_cowplot(font_size = 60, font_family = 'Calibri') +
                theme(legend.position = c(0.78, 1.25)) +
                ylim(97,100) #+
# 
#                 geom_text(x=2,y=1.0075,label='**',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=1,xend=3,y=1.007,yend=1.007,size=lsize) +
#                 geom_segment(x=1,xend=1,y=1.007,yend=1.006,size=lsize) +
#                 geom_segment(x=3,xend=3,y=1.007,yend=1.006,size=lsize) +
#                 geom_segment(x=0.8,xend=1.2,y=1.006,yend=1.006,size=lsize) +
#                 geom_segment(x=2.8,xend=3.2,y=1.006,yend=1.006,size=lsize) +
#                 geom_segment(x=0.8,xend=0.8,y=1.006,yend=1.005,size=lsize) +
#                 geom_segment(x=1.2,xend=1.2,y=1.006,yend=1.005,size=lsize) +
#                 geom_segment(x=2.8,xend=2.8,y=1.006,yend=1.005,size=lsize) +
#                 geom_segment(x=3.2,xend=3.2,y=1.006,yend=1.005,size=lsize) +
# 
#                 geom_text(x=1,y=1.0045,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=0.8,xend=1.2,y=1.004,yend=1.004,size=lsize) +
#                 geom_text(x=1.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=1,xend=1.2,y=1.002,yend=1.002,size=lsize) +
# 
#                 geom_text(x=2,y=1.0045,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=1.8,xend=2.2,y=1.004,yend=1.004,size=lsize) +
#                 geom_text(x=2.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=2,xend=2.2,y=1.002,yend=1.002,size=lsize) +
# 
#                 geom_text(x=3,y=1.0045,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=2.8,xend=3.2,y=1.004,yend=1.004,size=lsize) +
#                 geom_text(x=3.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=3,xend=3.2,y=1.002,yend=1.002,size=lsize)

        print(tplot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Subtypes.tiff',
                  tplot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
        
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of subtypes \non accuracy',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                          paste('IM', ' (n=', N[2],')', sep=''),
                                          paste('DM', ' (n=', N[3],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        # y <- 70
        # d = 3
        # segmap <- data.frame(
        #         x =    c(),
        #         xend = c(),
        #         y =    c(),
        #         yend = c()
        # )
        # sigmap <- data.frame(
        #         x =     c(),
        #         y =     c(),
        #         label = c()
        # )
        # plot <- plot + 
        #         geom_segment(data=segmap,
        #                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
        #                      inherit.aes = FALSE,
        #                      size = lsize) +
        #         geom_text(data=sigmap, 
        #                   mapping = aes(x=x,y=y,label=label),
        #                   inherit.aes = FALSE,
        #                   size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Subtypes_v2.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

}

# f <- 'correct_response ~ 1 + ParticipantType*trial_type*block + (1+trial_type+block|pseudonym)'
f <- 'correct_response ~ 1 + ParticipantType*trial_type*block + Age_Dmean + NpsEducYears_Dmean + (1|pseudonym)'
# Random slopes and Gender removed to solve singular fits and convergence issues

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype),
               correct_response = factor(if_else(correct_response=='Hit',1,0)))
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)
compare_correct_for_subtypes(f=f, tmp=tmp)

cat('\n\n\n\n')

# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(event_type == 'response') %>%
#         filter(trial_type != 'Catch') %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype),
#                correct_response = factor(if_else(correct_response=='Hit',1,0)))
# compare_correct_for_subtypes(f=f, tmp=tmp)
#
# cat('\n\n\n\n')
#
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(event_type == 'response') %>%
#         filter(trial_type != 'Catch') %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype),
#                correct_response = factor(if_else(correct_response=='Hit',1,0)))
# compare_correct_for_subtypes(f=f, tmp=tmp)
#
# cat('\n\n\n\n')
#
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(event_type == 'response') %>%
#         filter(trial_type != 'Catch') %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype),
#                correct_response = factor(if_else(correct_response=='Hit',1,0)))
# compare_correct_for_subtypes(f=f, tmp=tmp)
```

## Subtypes vs HC

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_correct_for_subtypes <- function(f, tmp){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        cat('\n \n')
        anova <- Anova(fit, type = 'III')
        print(anova)
        cat('\n \n Odds ratios:')
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response')
        contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print()

        em1 <- emmeans(fit, ~ block|ParticipantType, type='response')
        contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ block, type='response') %>% print()

        em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response') %>% print()

        em3 <- emmeans(fit, ~ block|trial_type, type='response')
        contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, trial_type ~ block, type='response') %>% print()
        cat('\n \n')
        # contrast(emm, interaction = c('revpairwise','revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        # Visualization
        # tplot <- emmip(fit, trial_type~Up3OfAppendicularSum_Dmean|ParticipantType, CIs = TRUE,
        #                type='response', cov.reduce=range, dodge=7) +
        #         scale_colour_viridis_d(option='mako', begin = .1, end = .6,
        #                                direction = -1, labels = c('One','Two', 'Three')) +
        #         ggtitle('') + ylab('Predicted probability of correct response') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)

        N <- tmp %>%
                group_by(pseudonym, ParticipantType) %>%
                filter(trial_type == '1choice') %>%
                summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()

        tplot <- emmip(fit, trial_type ~ ParticipantType,
                       type = 'response', CIs=TRUE, plotit=FALSE) %>%
                ggplot(aes(x=xvar,y=yvar*100, color=tvar)) +
                geom_point(position=position_dodge(width=0.6),size=8) +
                geom_errorbar(aes(ymin=LCL*100,ymax=UCL*100), lwd=2, width=0.5,
                              position=position_dodge(width=0.6)) +
                scale_x_discrete(labels=c(paste('HC', ' (n=', N[1],')', sep=''),
                                          paste('MMP', ' (n=', N[2],')', sep=''),
                                          paste('IM', ' (n=', N[3],')', sep=''),
                                          paste('DM', ' (n=', N[4],')', sep=''))) +
                scale_colour_viridis_d(option='mako', begin = .1, end = .6,
                                       direction = -1,labels=c('One','Two','Three')) +
                ggtitle('Influence of subtype \non accuracy') + ylab('Correct (%)') +
                xlab('') +
                guides(color=guide_legend(title='', reverse = FALSE)) +
                theme_cowplot(font_size = 60, font_family = 'Calibri') +
                theme(legend.position = c(0.78, 1.25)) +
                ylim(96.5,100.5) #+
# 
#                 geom_text(x=2,y=1.0075,label='**',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=1,xend=3,y=1.007,yend=1.007,size=lsize) +
#                 geom_segment(x=1,xend=1,y=1.007,yend=1.006,size=lsize) +
#                 geom_segment(x=3,xend=3,y=1.007,yend=1.006,size=lsize) +
#                 geom_segment(x=0.8,xend=1.2,y=1.006,yend=1.006,size=lsize) +
#                 geom_segment(x=2.8,xend=3.2,y=1.006,yend=1.006,size=lsize) +
#                 geom_segment(x=0.8,xend=0.8,y=1.006,yend=1.005,size=lsize) +
#                 geom_segment(x=1.2,xend=1.2,y=1.006,yend=1.005,size=lsize) +
#                 geom_segment(x=2.8,xend=2.8,y=1.006,yend=1.005,size=lsize) +
#                 geom_segment(x=3.2,xend=3.2,y=1.006,yend=1.005,size=lsize) +
# 
#                 geom_text(x=1,y=1.0045,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=0.8,xend=1.2,y=1.004,yend=1.004,size=lsize) +
#                 geom_text(x=1.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=1,xend=1.2,y=1.002,yend=1.002,size=lsize) +
# 
#                 geom_text(x=2,y=1.0045,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=1.8,xend=2.2,y=1.004,yend=1.004,size=lsize) +
#                 geom_text(x=2.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=2,xend=2.2,y=1.002,yend=1.002,size=lsize) +
# 
#                 geom_text(x=3,y=1.0045,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=2.8,xend=3.2,y=1.004,yend=1.004,size=lsize) +
#                 geom_text(x=3.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) +
#                 geom_segment(x=3,xend=3.2,y=1.002,yend=1.002,size=lsize)

        print(tplot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_SubtypesHc.tiff',
                  tplot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)
        
        N <- tmp.collapsed %>%
                ungroup() %>%
                filter(trial_type == '1choice') %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of subtypes \non accuracy',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('HC', ' (n=', N[1],')', sep=''),
                                          paste('MMP', ' (n=', N[2],')', sep=''),
                                          paste('IM', ' (n=', N[3],')', sep=''),
                                          paste('DM', ' (n=', N[4],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        # y <- 70
        # d = 3
        # segmap <- data.frame(
        #         x =    c(),
        #         xend = c(),
        #         y =    c(),
        #         yend = c()
        # )
        # sigmap <- data.frame(
        #         x =     c(),
        #         y =     c(),
        #         label = c()
        # )
        # plot <- plot + 
        #         geom_segment(data=segmap,
        #                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
        #                      inherit.aes = FALSE,
        #                      size = lsize) +
        #         geom_text(data=sigmap, 
        #                   mapping = aes(x=x,y=y,label=label),
        #                   inherit.aes = FALSE,
        #                   size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_SubtypesHc_v2.tiff',
          plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.8)

}

f <- 'correct_response ~ 1 + ParticipantType*trial_type + block + Age_Dmean + NpsEducYears_Dmean + (1|pseudonym)'
# Random slopes and Gender removed to solve singular fits and convergence issues

groups <- c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype),
               correct_response = factor(if_else(correct_response=='Hit',1,0)))
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)
compare_correct_for_subtypes(f=f, tmp=tmp)

cat('\n\n\n\n')
```

# Percentage correct (catch)

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_catch_correct <- function(f, tmp){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        cat('\n \n')
        anova <- Anova(fit, type = 'III')
        print(anova)
        cat('\n \n Odds ratios:')
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        # Post hoc test
        emm_options(lmer.df = 'satterthwaite')
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt') %>% summary()
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

        plot(fit) %>% print()

}

f <- 'correct_response ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# Random slope of block removed due to convergence issues

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(event_type == 'cue') %>%
        filter(trial_type == 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               correct_response = factor(if_else(correct_response=='False Alarm',1,0)))
compare_catch_correct(f=f, tmp=tmp)

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*block*Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + (1|pseudonym)' -->
<!-- # Random slope of block removed due to convergence issues -->

<!-- groups <- c('PD_PIT','HC_PIT') -->
<!-- tmp <- df %>% -->
<!--         filter(event_type == 'cue') %>% -->
<!--         filter(trial_type == 'Catch') %>% -->
<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->
<!--         filter(ParticipantType %in% groups) %>% -->
<!--         mutate(ParticipantType = droplevels(ParticipantType), -->
<!--                trial_type = droplevels(trial_type), -->
<!--                correct_response = factor(if_else(correct_response=='False Alarm',1,0))) -->
<!-- compare_catch_correct(f=f, tmp=tmp) -->
<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_catch_correct_for_medication <- function(f, tmp){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        cat('\n \n')
        anova <- Anova(fit, type = 'III')
        print(anova)
        cat('\n \n Odds ratios:')
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        # Post hoc test
        # emm_options(lmer.df = 'satterthwaite')
        #         # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise'), adjust = 'mvt') %>% print()
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum, cov.reduce=range,
        #                CIs = TRUE)
        # tplot <- tplot +
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='turbo') +
        #         ggtitle('') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Group', reverse = TRUE))
        # print(tplot)
                # Association between subtype, corrected for by disease severity
        cat('\n \n Emmeans \n \n')
        emm <- emmeans(fit, ~ParticipantType, type = 'response')
        print(emm)
        contrast(emm, interaction = c('revpairwise'), adjust = 'mvt', by = NULL) %>% print()
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

        plot(fit) %>% print()

}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'correct_response ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# Random slope of block removed due to convergence issues

groups <- c('PD_PIT','PD_POM')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(event_type == 'cue') %>%
        filter(trial_type == 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               correct_response = factor(if_else(correct_response=='False Alarm',1,0)))
disease_severity <- tmp %>%
        filter(ParticipantType=='PD_POM') %>%
        select(pseudonym, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean, NpsEducYears, NpsEducYears_Dmean) %>%
        group_by(pseudonym) %>%
        summarise(across(c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,
                           NpsEducYears, NpsEducYears_Dmean), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean)) %>%
        left_join(., disease_severity, by = 'pseudonym')
compare_catch_correct_for_medication(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_catch_correct_for_subtypes <- function(f, tmp){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        cat('\n \n')
        anova <- Anova(fit, type = 'III')
        print(anova)
        cat('\n \n Odds ratios:')
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        # Post hoc test
        # emm_options(lmer.df = 'satterthwaite')
        #         # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise'), adjust = 'mvt') %>% print()
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE)
        # tplot <- tplot +
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='turbo', labels = c('One','Two','Three')) +
        #         ggtitle('') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='No. of choices', reverse = TRUE))
        # print(tplot)
                # Association between subtype, corrected for by disease severity
        cat('\n \n Emmeans \n \n')
        emm <- emmeans(fit, ~ParticipantType, type = 'response')
        print(emm)
        contrast(emm, interaction = c('revpairwise'), adjust = 'mvt', by = NULL) %>% print()
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

        plot(fit) %>% print()

}

f <- 'correct_response ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# Random slope of block removed to solve convergence issues

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        filter(event_type == 'cue') %>%
        filter(trial_type == 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype),
               correct_response = factor(if_else(correct_response=='False Alarm',1,0)))
compare_catch_correct_for_subtypes(f=f, tmp=tmp)

cat('\n\n\n\n')

# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(event_type == 'cue') %>%
#         filter(trial_type == 'Catch') %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype),
#                correct_response = factor(if_else(correct_response=='False Alarm',1,0)))
# compare_catch_correct_for_subtypes(f=f, tmp=tmp)
#
# cat('\n\n\n\n')
#
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(event_type == 'cue') %>%
#         filter(trial_type == 'Catch') %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype),
#                correct_response = factor(if_else(correct_response=='False Alarm',1,0)))
# compare_catch_correct_for_subtypes(f=f, tmp=tmp)
#
# cat('\n\n\n\n')
#
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(event_type == 'cue') %>%
#         filter(trial_type == 'Catch') %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype),
#                correct_response = factor(if_else(correct_response=='Hit',1,0)))
# compare_catch_correct_for_subtypes(f=f, tmp=tmp)
```
