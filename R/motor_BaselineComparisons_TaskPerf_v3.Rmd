---
title: "Baseline comparisons of motor task performance"
author: "M.E. Johansson"
date: "25/2/2022"
output: 
  html_document: 
    toc: yes
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set-options, echo=FALSE, cache=FALSE}
# options(width = 150)
```

# Load libraries and functions.

```{r libraries, message=FALSE}
# funcdir <- 'H:/sysneu/marjoh/scripts/Personalized-Parkinson-Project-Motor/R/functions/'
# funcs <- list.files(funcdir, full.names = TRUE)
# sapply(funcs, source)
library(MASS)
library(ggpubr)
library(emmeans)
emm_options(lmerTest.df = 'satterthwaite')  # Calculates DFs in the same way as lmerTest
emm_options(lmerTest.limit = 50000)
emm_options(disable.pbkrtest=TRUE)
library(cowplot)
library(readr)
library(tidyverse)
library(lme4)
library(lmerTest)
library(effectsize)
library(car)
library(lattice)
library(viridis)
library(extrafont)
library(kableExtra)
loadfonts(device='win',quiet = TRUE)

sigsize=10
lsize=0.75
legend_position <- c(0.85,1.1)
```

# Load data

```{r datafile}
fTask <- 'P:/3022026.01/pep/bids/derivatives/manipulated_merged_motor_task_mri_2022-04-22.csv'
dfTask <- read_csv(fTask)
dfTask <- dfTask %>%
        select(pseudonym, Timepoint, trial_type, response_time, trial_number,
               event_type, correct_response, block, RespondingHand, Group, Percentage.Correct,
               Percentage.Correct.BelowCutoff, Button.Press.SwitchRatio, Button.Press.CoV,
               Button.Press.RepetitionRatio, Button.Press.AdjacentRatio) %>%
        rename(ParticipantType = Group) %>%
        mutate(TimepointNr = if_else(str_detect(Timepoint, 'Visit1'), '0', '1'),
               TimepointNr = factor(TimepointNr)) %>%
        relocate(pseudonym, TimepointNr, ParticipantType) %>%
        select(-Timepoint)

# fClin <- 'P:/3022026.01/pep/ClinVars2/derivatives/merged_manipulated_2022-05-25.csv'
fClin <- 'P:/3022026.01/pep/ClinVars3/derivatives/merged_manipulated_2022-06-16.csv'
clinvars <- c('pseudonym', 'TimepointNr', 'ParticipantType', 'CrossStudyParticipation', 'Subtype_DiagEx1_DisDurSplit', 'Subtype_Imputed_DiagEx1_DisDurSplit',
         'Age', 'Gender', 'NpsEducYears', 'PrefHand', 'MonthSinceDiag', 'ParkinMedUser', 'LEDD', 'Up3OfHoeYah', 'MostAffSide',
         'Up3OfTotal', 'Up3OfAppendicularSum', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum', 
         'Up3OfTotal_pit', 'Up3OfAppendicularSum_pit', 'Up3OfBradySum_pit', 'Up3OfRigiditySum_pit',
         'Up3OfPIGDSum_pit', 'Up3OfCompositeTremorSum_pit', 
         'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum',
         'DiagParkCertain', 'DiagParkPersist', 'DiagParkReplace',
         'MotorComposite','CognitiveComposite','SCOPA_AUTSum', 'RBDSQSum')
dfClin <- read_csv(fClin)
dfClin <- dfClin %>%
        filter(MriNeuroPsychTask == 'Motor') %>%
        filter(!is.na(ParticipantType)) %>%
        select(all_of(clinvars)) %>%
        rename(Subtype = Subtype_DiagEx1_DisDurSplit) %>%
        mutate(TimepointNr = factor(TimepointNr),
               Subtype = if_else(ParticipantType=='HC_PIT', '0_Healthy', Subtype),
               Subtype = factor(Subtype))
dfClin$Subtype[is.na(dfClin$Subtype)] <- '4_Undefined'

# Binarize the MostAffSide variable to Right and Left or NA
dfClin$MostAffSide[dfClin$MostAffSide=='BiL>R'] <- 'Left'
dfClin$MostAffSide[dfClin$MostAffSide=='LeftOnly'] <- 'Left'
dfClin$MostAffSide[dfClin$MostAffSide=='BiR>L'] <- 'Right'
dfClin$MostAffSide[dfClin$MostAffSide=='Right'] <- 'Right'
dfClin$MostAffSide[dfClin$MostAffSide=='BiR=L'] <- NA
dfClin$MostAffSide[dfClin$MostAffSide=='None'] <- NA

# Merge motor sub-scores for POM and PIT. Rigidity is not included since the variables
# names in Castor match exactly between the studies
dfClin <- dfClin %>%
        unite('Up3OfTotal', Up3OfTotal, Up3OfTotal_pit, na.rm = TRUE) %>%
        unite('Up3OfAppendicularSum', Up3OfAppendicularSum, Up3OfAppendicularSum_pit, na.rm = TRUE) %>%
        unite('Up3OfBradySum', Up3OfBradySum, Up3OfBradySum_pit, na.rm = TRUE) %>%
        unite('Up3OfPIGDSum', Up3OfPIGDSum, Up3OfPIGDSum_pit, na.rm = TRUE) %>%
        unite('Up3OfCompositeTremorSum', Up3OfCompositeTremorSum, Up3OfCompositeTremorSum_pit, na.rm = TRUE) %>%
        mutate(Up3OfTotal = as.numeric(Up3OfTotal),
               Up3OfAppendicularSum = as.numeric(Up3OfAppendicularSum),
               Up3OfBradySum = as.numeric(Up3OfBradySum),
               Up3OfPIGDSum = as.numeric(Up3OfPIGDSum),
               Up3OfCompositeTremorSum = as.numeric(Up3OfCompositeTremorSum))

df <- full_join(dfClin, dfTask, by = c('pseudonym', 'ParticipantType', 'TimepointNr'))
# df <- df %>%
#         filter(TimepointNr==0) %>%
#         mutate(trial_type = factor(trial_type),
#                block = factor(block),
#                ParticipantType = factor(ParticipantType),
#                Gender = factor(Gender),
#                Age_Dmean = scale(Age, center=TRUE, scale=FALSE),
#                MonthSinceDiag_Dmean = scale(MonthSinceDiag, center=TRUE, scale=FALSE),
#                NpsEducYears_Dmean = scale(NpsEducYears, center=TRUE, scale=FALSE),
#                Up3OfAppendicularSum_Dmean = scale(Up3OfAppendicularSum, center=TRUE, scale=FALSE),
#                RespHandIsDominant = if_else(RespondingHand == PrefHand | RespondingHand == 'NoPref', 1, 0),
#                RespHandIsDominant = factor(RespHandIsDominant))
df <- df %>%
  filter(TimepointNr==0) %>%
  mutate(trial_type = factor(trial_type),
         block = factor(block),
         ParticipantType = factor(ParticipantType),
         Gender = factor(Gender),
         RespHandIsDominant = if_else(RespondingHand == PrefHand | RespondingHand == 'NoPref', 1, 0),
         RespHandIsDominant = factor(RespHandIsDominant)) %>%
  group_by(ParticipantType) %>%
  mutate(Age_Dmean = scale(Age, center=TRUE, scale=FALSE),
         MonthSinceDiag_Dmean = scale(MonthSinceDiag, center=TRUE, scale=FALSE),
         NpsEducYears_Dmean = scale(NpsEducYears, center=TRUE, scale=FALSE),
         Up3OfAppendicularSum_Dmean = scale(Up3OfAppendicularSum, center=TRUE, scale=FALSE)) %>%
  ungroup()

```

## Exclusion criteria

This section tells us a bit about how many participants were analyzed and how many were excluded.

<!-- ```{r number, echo=FALSE} -->

<!-- n <- data_task_clin %>% -->

<!--         filter(Timepoint=='ses-Visit1' & Condition == 'Ext') %>% -->

<!--         select(pseudonym) %>% -->

<!--         unique() %>% -->

<!--         nrow -->

<!-- msg <- paste('Number of unique pseudonyms:', n) -->

<!-- print(msg) -->

<!-- ``` -->

-   Participants without data

<!-- ```{r missing, echo=FALSE} -->

<!-- no_task <- data_task_clin %>% -->

<!--         filter(Timepoint == 'ses-Visit1') %>% -->

<!--         filter(Condition == 'Ext') %>% -->

<!--         select(pseudonym, Response.Time, Age) %>% -->

<!--         filter(is.na(Response.Time)) -->

<!-- msg <- paste('Number of subjects without task data (defined as RTs on Ext):', length(unique(no_task$pseudonym))) -->

<!-- print(msg) -->

<!-- print(unique(no_task$pseudonym)) -->

<!-- no_clin <- data_task_clin %>% -->

<!--         filter(Timepoint == 'ses-Visit1') %>% -->

<!--         filter(Condition == 'Ext') %>% -->

<!--         select(pseudonym, Response.Time, Age) %>% -->

<!--         filter(is.na(Age)) -->

<!-- msg <- paste('Number of subjects without clinical data (defined as Age):', length(unique(no_clin$pseudonym))) -->

<!-- print(msg) -->

<!-- print(unique(no_clin$pseudonym)) -->

<!-- ``` -->

-   Patients who were misdiagnosed

```{r echo=FALSE, warning=FALSE}
# Exclude patients with confirmed non-PD diagnosis
cat('\n\n Excluding patients with confirmed non-PD diagnosis at baseline and patients who received a non-PD diagnosis at 2-year follow-up')
diagnosis <- dfClin %>% filter(ParticipantType=='PD_POM') %>% select(pseudonym, TimepointNr, DiagParkCertain, DiagParkPersist, DiagParkReplace)
diagnosis %>% filter(TimepointNr==0) %>% select(DiagParkCertain) %>% table() %>% print()
diagnosis %>% filter(TimepointNr==2) %>% select(DiagParkPersist) %>% table() %>% print()
diagnosis %>% filter(TimepointNr==2) %>% select(DiagParkReplace) %>% table() %>% print()

        # Define a list of subjects to exclude
baseline_exclusion <- diagnosis %>%
        filter(TimepointNr==0, (DiagParkCertain == 'NeitherDisease' | DiagParkCertain == 'DoubtAboutParkinsonism' | DiagParkCertain == 'Parkinsonism')) %>% 
        select(pseudonym)
visit2_exclusion <- diagnosis %>%
        filter(TimepointNr==2, (DiagParkPersist == 2)) %>% 
        select(pseudonym)
# diag_exclusions <- full_join(baseline_exclusion, visit2_exclusion) %>% unique()
diag_exclusions <- baseline_exclusion %>% unique()

        # Checks 
cat('\n\n Check the 2-year follow-up diagnosis for patients with uncertain PD diagnoses')
doubt_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'DoubtAboutPD') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% doubt_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table() %>% print()
parkinsonism_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'Parkinsonism') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% parkinsonism_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table()
neither_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'NeitherDisease') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% neither_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table()
doubt2_at_ba <- diagnosis %>%
        filter(DiagParkCertain == 'DoubtAboutParkinsonism') %>%
        select(pseudonym)
diagnosis %>% filter(TimepointNr==2, pseudonym %in% doubt2_at_ba$pseudonym) %>% select(DiagParkPersist) %>% table()

df.orig <- df
df <- df %>%
        filter(!(pseudonym %in% diag_exclusions$pseudonym))
# df <- df %>%
#         filter(!(pseudonym %in% doubt_at_ba$pseudonym))
```

-   Participants who performed at or below 25% correct responses in the 1-choice condition

```{r poor_performance, echo=FALSE}
cat('Subjects below performance cutoff should be excluded:')
df %>%
        filter(TimepointNr==0) %>%
        group_by(ParticipantType, pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>% 
        select(pseudonym, ParticipantType, Percentage.Correct.BelowCutoff) %>%
        group_by(ParticipantType) %>%
        summarise(Total=n(), 
                  Below = sum(Percentage.Correct.BelowCutoff==TRUE,na.rm = TRUE), 
                  Above = sum(Percentage.Correct.BelowCutoff==FALSE,na.rm = TRUE)) %>% print()
```

# Demographics

```{r echo=FALSE, warning=FALSE}
demographics_table <- function(dat){
        tab_demo <- dat %>%
                group_by(ParticipantType) %>%
                summarise(across(where(is.numeric), list(mean=mean,sd=sd), .names = "{.col}.{.fn}", na.rm=TRUE),
                          N = n(),
                          Sex_Male=sum(Gender=='Male', na.rm=TRUE), 
                          Sex_Fem=sum(Gender=='Female', na.rm=TRUE),
                          Sex_PropMale=mean(Gender=='Male', na.rm=TRUE), 
                          Sex_PropFem=mean(Gender=='Female', na.rm=TRUE),
                          PrefHand_R=sum(PrefHand=='Right', na.rm=TRUE), 
                          PrefHand_L=sum(PrefHand=='Left', na.rm=TRUE),
                          PrefHand_PropR=mean(PrefHand=='Right', na.rm=TRUE),
                          PrefHand_PropL=mean(PrefHand=='Left', na.rm=TRUE),
                          RespHand_R=sum(RespondingHand=='Right', na.rm=TRUE), 
                          RespHand_L=sum(RespondingHand=='Left', na.rm=TRUE),
                          RespHand_PropR=mean(RespondingHand=='Right', na.rm=TRUE), 
                          RespHand_PropL=mean(RespondingHand=='Left', na.rm=TRUE),
                          RespHandDom_Y=sum(RespHandIsDominant==1, na.rm=TRUE), 
                          RespHandDom_N=sum(RespHandIsDominant==0, na.rm=TRUE),
                          RespHandDom_PropY=mean(RespHandIsDominant==1, na.rm=TRUE), 
                          RespHandDom_PropN=mean(RespHandIsDominant==0, na.rm=TRUE),
                          MostAffSide_R=sum(MostAffSide=='Right', na.rm=TRUE),
                          MostAffSide_L=sum(MostAffSide=='Left', na.rm=TRUE),
                          MostAffSide_PropR=mean(MostAffSide=='Right', na.rm=TRUE),
                          MostAffSide_PropL=mean(MostAffSide=='Left', na.rm=TRUE),
                          MedUser=sum(ParkinMedUser=='Yes', na.rm=TRUE), 
                          NonMedUser=sum(ParkinMedUser=='No', na.rm=TRUE),
                          PropMedUser=mean(ParkinMedUser=='Yes', na.rm=TRUE), 
                          PropNonMedUser=mean(ParkinMedUser=='No', na.rm=TRUE),
                          HnY_1=sum(Up3OfHoeYah==1, na.rm=TRUE), 
                          HnY_2=sum(Up3OfHoeYah==2, na.rm=TRUE),
                          HnY_3=sum(Up3OfHoeYah==3, na.rm=TRUE), 
                          HnY_4=sum(Up3OfHoeYah==4, na.rm=TRUE),
                          HnY_Prop1=mean(Up3OfHoeYah==1, na.rm=TRUE), 
                          HnY_Prop2=mean(Up3OfHoeYah==2, na.rm=TRUE),
                          HnY_Prop3=mean(Up3OfHoeYah==3, na.rm=TRUE), 
                          HnY_Prop4=mean(Up3OfHoeYah==4, na.rm=TRUE),
                          Diagnosis_PD=sum(DiagParkCertain=='PD', na.rm=TRUE), 
                          Diagnosis_Doubt=sum(DiagParkCertain=='DoubtAboutPD', na.rm=TRUE),
                          Diagnosis_PropPD=mean(DiagParkCertain=='PD', na.rm=TRUE), 
                          Diagnosis_PropDoubt=mean(DiagParkCertain=='DoubtAboutPD', na.rm=TRUE)) %>%
                mutate(across(where(is.double), round, digits=2))
        
        # Format table to show values in mean (sd) for each variable in vars1
        format_cell1 <- function(table,var){
                t2 <- table %>%
                        select(starts_with(var)) %>%
                        mutate('{var}' := paste(.[[1]], ' (',.[[2]], ')', sep='')) %>%
                        select(all_of(var))
                table <- table %>%
                        select(!contains(var))
                table <- cbind(table, t2)
                table
        }
        vars1 <- c('Age', 'NpsEducYears', 'MonthSinceDiag', 'LEDD', 'Up3OfHoeYah', 'Up3OfTotal', 
                   'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum', 
                   'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum')
        for(v in vars1){
                tab_demo <- format_cell1(tab_demo, v)
        }
        # Format table to show count (proportion) for each variable in vars2
        format_cell2 <- function(table,var,var1,var2){
                t2 <- table %>%
                        select(any_of(c(var1, var2))) %>%
                        mutate('{var}' := paste(.[[var1]], ':',.[[var2]], sep='')) %>%
                        select(all_of(var))
                table <- table %>%
                        select(!any_of(c(var1, var2)))
                table <- cbind(table, t2)
                table
        }
        var1 <- c('Sex_Male', 'Sex_PropMale', 'PrefHand_R', 'PrefHand_PropR', 'RespHand_R', 'RespHand_PropR', 'RespHandDom_Y', 'RespHandDom_PropY', 'MostAffSide_R', 'MostAffSide_PropR', 'MedUser', 'PropMedUser', 'Diagnosis_PD', 'Diagnosis_PropPD')
        var2 <- c('Sex_Fem', 'Sex_PropFem', 'PrefHand_L', 'PrefHand_PropL', 'RespHand_L', 'RespHand_PropL', 'RespHandDom_N', 'RespHandDom_PropN', 'MostAffSide_L', 'MostAffSide_PropL', 'NonMedUser', 'PropNonMedUser', 'Diagnosis_Doubt', 'Diagnosis_PropDoubt')
        var <- c('Sex_MF', 'Sex_Prop_MF', 'PrefHand_RL', 'PrefHand_PropRL', 'RespHand_RL', 'RespHand_PropRL', 'RespHandDom_YN', 'RespHandDom_PropYN', 'MostAffSide_RL', 'MostAffSide_PropRL', 'Meduser_YN', 'Meduser_Prop_YN', 'Diagnosis_PDDoubt', 'Diagnosis_PropPDDoubt')
        for(v in 1:length(var)){
                tab_demo <- format_cell2(tab_demo, var[v], var1[v], var2[v])
        }
        
        tab_demo <- bind_cols(Vars = colnames(tab_demo), t(tab_demo), .name_repair = 'universal')
        # colnames(tab_demo) <- c('Variable', 'Healthy', 'PD-Off', 'PD-On')
        
        kbl(tab_demo, caption = 'Demographics') %>%
                kable_paper('hover', full_width = F)
}
compare_demographics <- function(dat,numvars,catvars){
        
        cat('\n\n\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                HC <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                ON <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(HC,ON,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: Healthy-PD = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}
compare_demographics.subs <- function(dat,numvars,catvars){
        
        cat('\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                
                G1 <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                G2 <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                G3 <- dat %>% filter(ParticipantType==groups[3]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(G1,G2,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-IM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G1,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G2,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: IM-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}

```

## ON vs HC

```{r echo=FALSE, warning=FALSE}
df_demo <- df %>% 
        filter(TimepointNr==0) %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        select(pseudonym, ParticipantType, CrossStudyParticipation, Subtype,
               Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
               ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
               Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
               MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain) %>%
        arrange(pseudonym,ParticipantType) %>%
        ungroup()

cat('Number of patients excluded due to mis-diagnosis:', length(diag_exclusions$pseudonym))
demographics_table(df_demo)

groups <- c('HC_PIT','PD_POM')
demo.test <- df_demo %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2]) %>%
        mutate(ParticipantType = factor(ParticipantType))
numvars <- c('Age', 'NpsEducYears', 'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum')
catvars <- c('Gender', 'PrefHand', 'RespondingHand', 'RespHandIsDominant')
cat('\n\n\n', 'Healthy controls versus PD-On', '\n\n\n')
compare_demographics(demo.test,numvars,catvars)

```

## ON vs OFF

```{r echo=FALSE, warning=FALSE}

df_demo.onoff <- df %>% 
        filter(TimepointNr==0,
               CrossStudyParticipation==TRUE) %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        select(pseudonym, ParticipantType, CrossStudyParticipation, Subtype,
               Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
               ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
               Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
               MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain) %>%
        arrange(pseudonym,ParticipantType) %>%
        ungroup()

demographics_table(df_demo.onoff)

groups <- c('PD_PIT','PD_POM')
demo.test <- df_demo.onoff %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2]) %>%
        mutate(ParticipantType = factor(ParticipantType))
numvars <- c('Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum')
catvars <- c()
cat('\n\n\n', 'PD-Off versus PD-On', '\n\n\n')
compare_demographics(demo.test,numvars,catvars)

```

## Subtypes

```{r echo=FALSE, warning=FALSE}

df_demo.subs <- df %>% 
        filter(TimepointNr==0,
               ParticipantType=='PD_POM',
               Subtype!='4_Undefined') %>%
        mutate(ParticipantType=factor(Subtype)) %>%
        group_by(pseudonym,ParticipantType) %>% 
        summarise(across(everything(), ~first(.x))) %>%
        select(pseudonym, ParticipantType, CrossStudyParticipation,
               Age, Gender, NpsEducYears, PrefHand, RespondingHand, RespHandIsDominant, MonthSinceDiag,
               ParkinMedUser, LEDD, Up3OfHoeYah, MostAffSide,
               Up3OfTotal, Up3OfBradySum, Up3OfRigiditySum, Up3OfPIGDSum, Up3OfCompositeTremorSum, 
               MoCASum, BDI2Sum, STAITraitSum, STAIStateSum, QUIPicdSum, DiagParkCertain
               ) %>%
        arrange(pseudonym,ParticipantType) %>%
        ungroup()

demographics_table(df_demo.subs)

compare_demographics.subs <- function(dat,numvars,catvars){
        
        cat('\n', '#####################################', '\n')
        
        for(v in numvars){
                f <- paste(v, '~ ParticipantType')
                
                G1 <- dat %>% filter(ParticipantType==groups[1]) %>% select(all_of(v)) %>% na.omit()
                G2 <- dat %>% filter(ParticipantType==groups[2]) %>% select(all_of(v)) %>% na.omit()
                G3 <- dat %>% filter(ParticipantType==groups[3]) %>% select(all_of(v)) %>% na.omit()
                t <- t.test(G1,G2,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-IM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G1,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: MMP-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
                t <- t.test(G2,G3,alternative='two.sided',paired=FALSE)
                msg <- paste(v, 
                             ', t = ', round(t$statistic,digits=2), 
                             ', p-val = ', round(t$p.value,digits=3),
                             ', Difference: IM-DM = ',round(t$estimate[1]-t$estimate[2],digits=3),
                             sep='')
                cat('\n',msg,'\n')
        }
        for(v in catvars){
                dat1 <- dat %>%
                        select(ParticipantType, any_of(v)) %>%
                        mutate(across(where(is.character),as.factor))
                c <- chisq.test(table(dat1), simulate.p.value = TRUE, B = 5000)
                msg <- paste(v,
                             ', X2 = ', round(c$statistic, digits=2),
                             ', p-val = ', round(c$p.value, digits=3),
                             sep='')
                cat('\n', msg, '\n')
                # table(dat) %>% print()
        }
        cat('\n', '#####################################', '\n\n\n')
}
groups <- c('1_Mild-Motor', '2_Intermediate','3_Diffuse-Malignant')
demo.test <- df_demo.subs %>% filter(ParticipantType==groups[1] | ParticipantType==groups[2] | ParticipantType==groups[3]) %>%
        mutate(ParticipantType = factor(ParticipantType))
numvars <- c('Age', 'NpsEducYears', 'LEDD', 'MonthSinceDiag', 'MoCASum', 'BDI2Sum', 'STAITraitSum', 'STAIStateSum', 'QUIPicdSum', 
             'Up3OfTotal', 'Up3OfBradySum', 'Up3OfRigiditySum', 'Up3OfPIGDSum', 'Up3OfCompositeTremorSum')
catvars <- c('Gender', 'PrefHand', 'RespondingHand', 'RespHandIsDominant')
cat('\n\n\n', 'Subtypes', '\n\n\n')
compare_demographics.subs(demo.test,numvars,catvars)

```

# Brain activity

## ON vs. HC

```{r echo=FALSE, warning=FALSE, message=FALSE}

# SPM VOI eigenvariate
# fmri.onvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOn_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.onvshc, 'VOI.*csv', full.names = TRUE)
# MarsBar ROI betas
fmri.onvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOn_x_ExtInt2Int3Catch_NoOutliers2/marsbar/'
vois <- dir(fmri.onvshc, '*csv', full.names = TRUE)

# Make a list of subjects that were included in the functional analyses, used later for the VBM comparison
funcsubs <- vois[1] %>% read_csv() %>% select(pseudonym) %>% unique()

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
outliers <- c()
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch') %>%
                mutate(Group = factor(Group,
                                      levels = c('HC_PIT','PD_POM')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        bn <- basename(csvfile)
        fmridat.subset <- fmridat
        fmridat.subset <- fmridat.subset %>% pivot_wider(id_cols = c('pseudonym','Group'),
                                       names_from = Cond,
                                       values_from = Beta) %>%
          mutate(Avg = (`3choice` + `2choice` + `1choice`)/3,
                 IvL = `2choice` - `1choice`,
                 HvL = `3choice` - `1choice`,
                 Avg.Outlier = if_else(abs(Avg-mean(Avg)) > 3*sd(Avg), 1, 0),
                 IvL.Outlier = if_else(abs(IvL-mean(IvL)) > 3*sd(IvL), 1, 0),
                 HvL.Outlier = if_else(abs(HvL-mean(HvL)) > 3*sd(HvL), 1, 0)) %>%
          select(-c(`1choice`,`2choice`,`3choice`))
        print(bn)
        outs <- fmridat.subset %>% filter(Avg.Outlier == TRUE | IvL.Outlier == TRUE | HvL.Outlier == TRUE) %>% print()
        outliers <- c(outliers, outs$pseudonym)
        
        if(str_detect(bn, 'MTean')){
                fmridat <- fmridat %>%
                        group_by(pseudonym, Group) %>%
                        summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>%
                        ungroup()
                raincloudplot_1Factor(fmridat, 'Beta', c('Group'), title = basename(csvfile),
                                      xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'),
                                      color_scheme = 'viridis') %>% print()   
        }else{
                raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile),
                                      xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'),
                                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                                      color_scheme = 'mako') %>% print()        
        }
}

##### Putamen #####
putamen <- vois[1]
csvfile <- putamen
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Group = factor(Group,
                              levels = c('HC_PIT','PD_POM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
         rename(Beta = Vals) #%>%
        # group_by(pseudonym, Group) %>%
        # summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>%
        # ungroup()
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
# plot <-raincloudplot_1Factor(fmridat, 'Beta', c('Group'), title = 'Average task-related activity in \nthe most affected putamen',
#                       xlab='', ylab='Beta (mean)',
#                       xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
#                                           paste('PD-On', ' (n=', N[2],')', sep='')),
#                       color_scheme = 'cividis') +
#         ylim(-1.5,2.5) +
#         theme_cowplot(font_size = 60, font_family = 'Calibri')
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
                              title = 'MAS: Putamen\n ',
                              xlab='', ylab='Beta', 
                              xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                            paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_position = legend_position, legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako') + 
        ylim(-2,5)
y <- 5
d = 0.45
segmap <- data.frame(
        x =    c(1.00, 1.00, 0.80,  2.00,  1.80),
        xend = c(2.00, 1.00, 1.20,  2.00,  2.20),
        y =    c(y,    y,    y-d*1, y,     y-d*1),
        yend = c(y,    y-d*1,y-d*1, y-d*1, y-d*1)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON_HCgtON_Mean_Putamen1.tiff',
          plot, dpi=300, device='tiff')

# Association with response times
fmridat.rts <- fmridat %>%
  rename(trial_type=Cond,
         ParticipantType=Group)
groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type)) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, response_time)
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time), ~ mean(.x, na.rm=TRUE))) %>%
  ungroup()
t <- left_join(fmridat.rts, tmp.collapsed, by=c('pseudonym', 'ParticipantType','trial_type')) %>%
  pivot_wider(id_cols = c('pseudonym', 'ParticipantType'),
              names_from = trial_type,
              values_from = c(Beta,response_time)) %>%
  mutate(Beta.avg = (Beta_1choice+Beta_2choice+Beta_3choice)/3,
         RT.avg = (response_time_1choice+response_time_2choice+response_time_3choice)/3) %>%
  select(-starts_with('Beta_'),
         -starts_with('response_time'))

ggplot(t, aes(x=Beta.avg,y=RT.avg, fill=ParticipantType)) +
  geom_point() +
  geom_smooth(method='lm')

plot <- ggplot(t, aes(y=RT.avg, x=Beta.avg, color=ParticipantType)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = FALSE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('HC','PD')) +
        ggtitle('Association between response \ntimes and putamen activity') + 
        xlab('Average beta') +
        ylab('Average RT (s)') +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = c(0.8,1.10),
              legend.key.size = unit(0.5,'cm'))
print(plot)

m <- lm(RT.avg ~ Beta.avg*ParticipantType, data = t)
summary(m)

#####

##### Parietal interaction #####
parietal <- vois[7]
csvfile <- parietal
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Group = factor(Group,
                              levels = c('HC_PIT','PD_POM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals)
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
                              title = 'LAS: IPL\n ',
                              xlab='', ylab='Beta', 
                              xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                            paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_position = legend_position, legend_labels = c('One','Two','Three'),
                              color_scheme = 'mako') + 
        ylim(-6,6)
y <- 6
d = 0.6
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  1.20, 1.80,  2.20),
        xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  0.80,  1.20, 1.80,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HCvsON_ONgtHC_INT3gtEXT_IPL.tiff',
          plot, dpi=300, device='tiff')
#####
```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- fmri.offvshc <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcOff_x_ExtInt2Int3Catch_NoOutliers/' -->

<!-- vois <- dir(fmri.offvshc, 'VOI.*csv', full.names = TRUE) -->

<!-- source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!-- source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->

<!-- for(v in 1:length(vois)){ -->

<!--         csvfile <- vois[v] -->

<!--         fmridat <- read_csv(csvfile, show_col_types = FALSE) %>% -->

<!--                 select(-scans) %>% -->

<!--                 filter(Cond != 'Catch') %>% -->

<!--                 mutate(Group = factor(Group, -->

<!--                                       levels = c('HC_PIT','PD_PIT')), -->

<!--                        Cond = factor(Cond, -->

<!--                                      levels = c('Ext','Int2','Int3'), -->

<!--                                      labels = c('1choice','2choice','3choice'))) %>% -->

<!--                 rename(Beta = Vals) -->

<!--         bn <- basename(csvfile) -->

<!--         if(str_detect(bn, 'Mean')){ -->

<!--                 fmridat <- fmridat %>% -->

<!--                         group_by(pseudonym, Group) %>% -->

<!--                         summarise(across(c(Beta), ~ mean(.x, na.rm=TRUE))) %>% -->

<!--                         ungroup() -->

<!--                 raincloudplot_1Factor(fmridat, 'Beta', c('Group'), title = basename(csvfile), -->

<!--                                       xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'), -->

<!--                                       color_scheme = 'viridis') %>% print()    -->

<!--         }else{ -->

<!--                 raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile), -->

<!--                                       xlab='Group', ylab='Beta', xticklabs = c('Healthy','PD-On'), -->

<!--                                       legend_title = 'No. of choices', legend_labels = c('One','Two','Three'), -->

<!--                                       color_scheme = 'mako') %>% print()         -->

<!--         } -->

<!-- } -->

<!-- ``` -->

## Subtypes vs subtypes

```{r echo=FALSE, warning=FALSE, message=FALSE}

##### Group analysis #####
# fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Imputed_Subtypes_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.subtypes, 'VOI.*csv', full.names = TRUE)
fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Subtypes_x_ExtInt2Int3Catch_NoOutliers2/marsbar'
vois <- dir(fmri.subtypes, '*csv', full.names = TRUE)

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch',
                       Group != 'HC_PIT') %>%
                left_join(., Subtypes, by='pseudonym') %>%
                mutate(Group = Subtype,
                       Group = factor(Group,
                                      levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        bn <- basename(csvfile)
        if(str_detect(bn, 'HC_PD')){
          fmridat.subset <- fmridat %>%
            filter(Group == '1_Mild-Motor' | Group == '2_Intermediate' | Group == '3_Diffuse-Malignant')
        }else if(str_detect(bn, 'Inter_DM')){
          fmridat.subset <- fmridat %>%
            filter(Group == '2_Intermediate' | Group == '3_Diffuse-Malignant')
        }else if(str_detect(bn, 'MMP_DM') | str_detect(bn, 'MMP_MD')){
          fmridat.subset <- fmridat %>%
            filter(Group == '1_Mild-Motor' | Group == '3_Diffuse-Malignant')
        }
        fmridat.subset <- fmridat.subset %>% pivot_wider(id_cols = c('pseudonym','Group'),
                                       names_from = Cond,
                                       values_from = Beta) %>%
          mutate(Avg = (`3choice` + `2choice` + `1choice`)/3,
                 IvL = `2choice` - `1choice`,
                 HvL = `3choice` - `1choice`,
                 Avg.Outlier = if_else(abs(Avg-mean(Avg)) > 3*sd(Avg), 1, 0),
                 IvL.Outlier = if_else(abs(IvL-mean(IvL)) > 3*sd(IvL), 1, 0),
                 HvL.Outlier = if_else(abs(HvL-mean(HvL)) > 3*sd(HvL), 1, 0)) %>%
          select(-c(`1choice`,`2choice`,`3choice`))
        print(bn)
        fmridat.subset %>% filter(Avg.Outlier == TRUE | IvL.Outlier == TRUE | HvL.Outlier == TRUE) %>% print()
        
        raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile),
                      xlab='Group', ylab='Beta', xticklabs = c('MMP','IM', 'DM'),
                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') %>% print()
}
#####

##### Parietal lobule #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)

# MMP > DM: 3 > 1, PMC
ips <- vois[3]
csvfile1 <- ips
fmridat1 <- read_csv(csvfile1, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
# N1 <- fmridat1 %>%
#         filter(Cond=='1choice') %>%
#         select(Group) %>%
#         table()
# plot <- raincloudplot_2Factor(fmridat1, 'Beta', c('Cond','Group'), 
#                               title = 'Task-related activity in the \nintraparietal sulcus (hIP8)',
#                       xlab='Group', ylab='Beta', 
#                       xticklabs = c(paste('MMP', ' (n=', N1[1],')', sep=''),
#                                     paste('IM', ' (n=', N1[2],')', sep=''),
#                                     paste('DM', ' (n=', N1[3],')', sep='')),
#                       legend_title = '',
#                       legend_position = c(0.85,1.08), legend_labels = c('One','Two','Three'),
#                       color_scheme = 'mako') +
#         ylim(-6,10) +
#         geom_segment(x=1,xend=3,y=10,yend=10,size=lsize) + 
#         geom_segment(x=1,xend=1,y=10,yend=9.7,size=lsize) + 
#         geom_segment(x=3,xend=3,y=10,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=1.2,y=9.7,yend=9.7,size=lsize) + 
#         geom_segment(x=2.8,xend=3.2,y=9.7,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=0.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=1.2,xend=1.2,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=2.8,xend=2.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=3.2,xend=3.2,y=9.7,yend=9.5,size=lsize) +
#         geom_text(x=2,y=10.2,label='**',size=sigsize,show.legend = FALSE)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ImputedSubtypes_MMPgtDM_INT3gtEXT_IPS.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

# IM > DM: 3 > 1, PMC
spl <- vois[2]
csvfile2 <- spl
fmridat2 <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
# N2 <- fmridat2 %>%
#         filter(Cond=='1choice') %>%
#         select(Group) %>%
#         table()
# plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), 
#                               title = 'Task-related activity in the \nsuperior parietal lobule (7A)',
#                       xlab='Group', ylab='Beta', 
#                       xticklabs = c(paste('MMP', ' (n=', N2[1],')', sep=''),
#                                     paste('IM', ' (n=', N2[2],')', sep=''),
#                                     paste('DM', ' (n=', N2[3],')', sep='')),
#                       legend_title = '',
#                       legend_position = c(0.85,1.08), legend_labels = c('One','Two','Three'),
#                       color_scheme = 'mako') +
#         ylim(-6,10) +
#         geom_segment(x=1,xend=3,y=10,yend=10,size=lsize) + 
#         geom_segment(x=1,xend=1,y=10,yend=9.7,size=lsize) + 
#         geom_segment(x=3,xend=3,y=10,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=1.2,y=9.7,yend=9.7,size=lsize) + 
#         geom_segment(x=2.8,xend=3.2,y=9.7,yend=9.7,size=lsize) +
#         geom_segment(x=0.8,xend=0.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=1.2,xend=1.2,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=2.8,xend=2.8,y=9.7,yend=9.5,size=lsize) +
#         geom_segment(x=3.2,xend=3.2,y=9.7,yend=9.5,size=lsize) +
#         geom_text(x=2,y=10.2,label='**',size=sigsize,show.legend = FALSE)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ImputedSubtypes_MMPgtDM_INT3gtEXT_IPS.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

# MMP > DM & MMP > IM: 3 gt 1, Parietal
fmridat <- bind_cols(fmridat1, Beta2=fmridat2$Beta) %>%
        mutate(AvgBeta = (Beta+Beta2)/2)
N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()

plot <- raincloudplot_2Factor(fmridat, 'AvgBeta', c('Cond','Group'),
                              title = 'MAS: PMC\n ',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-2,9)

y <- 9
d = 0.35
segmap <- data.frame(
        x =    c(1.00, 1.00,  3.00,  0.80,  0.80,  1.20,  2.80,  2.80,  3.20,  2.00, 2.00,  3.00,  1.80,  1.80,  2.20,  2.80,  2.80,  3.20),
        xend = c(3.00, 1.00,  3.00,  1.20,  0.80,  1.20,  3.20,  2.80,  3.20,  3.00, 2.00,  3.00,  2.20,  1.80,  2.20,  3.20,  2.80,  3.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3,y-d*3, y-d*3, y-d*4, y-d*4, y-d*4, y-d*4, y-d*4, y-d*4),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2, y-d*3,y-d*4, y-d*4, y-d*4, y-d*5, y-d*5, y-d*4, y-d*5, y-d*5)
)
sigmap <- data.frame(
        x =     c(2,     2.5),
        y =     c(y,     y-d*3),
        label = c('*', '*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Subtypes_MMPgtDM&IMgtDM_INT3gtEXT_PMC.tiff',
          plot, dpi=300, device='tiff')

#####

##### Putamen cluster #####
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfAppendicularSum)

# file <- c('P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0001_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0002_ses-Visit1.txt','P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/clusterstats/x_HCgtON_Mean_Putamen1Only_con_0003_ses-Visit1.txt')
# 
# con1 <- read_csv(file[1])
# con2 <- read_csv(file[2])
# con3 <- read_csv(file[3])
# fmridat.putamen <- bind_rows(con1,con2,con3)
# fmridat.putamen <- fmridat.putamen %>%
#         separate(Img, into = c('x1','x2','pseudonym','session','y1','contrast'), sep = '_') %>%
#         mutate(ParticipantType = paste(x1,x2,sep='_'),
#                contrast = str_remove(contrast, 'L2Rswap'),
#                contrast = str_remove(contrast, '.nii')) %>%
#         select(-c(x1,x2,y1,session))
# fmridat.putamen <- fmridat.putamen %>%
#         filter(ParticipantType=='PD_POM')
# fmridat.putamen <- fmridat.putamen %>%
#         left_join(., Subtypes, by = 'pseudonym')
# fmridat.putamen <- fmridat.putamen %>%
#         mutate(Group = Subtype,
#                Group = factor(Group,
#                               levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
#                Cond = factor(contrast,
#                                  levels = c('0001','0002','0003'),
#                                  labels = c('1choice','2choice','3choice'))) %>%
#         na.omit() %>%
#         filter(pseudonym %in% unique(fmridat.putamen$pseudonym))
# 
# fmridat.putamen.collapsed <- fmridat.putamen %>%
#         pivot_wider(id_cols = c('pseudonym','ParticipantType','Group','Up3OfAppendicularSum'),
#                     values_from = Beta,
#                     names_from = Cond) %>%
#         mutate(Mean=(`1choice`+`2choice`+`3choice`)/3)
# 
# N <- fmridat.putamen.collapsed %>%
#         select(Group) %>%
#         table()

putamen <- vois[1]
csvfile <- putamen
fmridat.putamen <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat.putamen %>%
        filter(Cond == '1choice') %>%
        select(Group) %>%
        table()

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
plot <- raincloudplot_2Factor(fmridat.putamen, 'Beta', c('Cond','Group'),
                      title = 'MAS: Putamen\n ',
                      xlab='', ylab='Beta', 
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '', 
                      legend_labels = c('One','Two','Three'),
                      legend_position = legend_position,
                      color_scheme = 'mako')
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Subtypes_Putamen.tiff',
          plot, dpi=300, device='tiff')

fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','Group','Up3OfAppendicularSum'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean=(`1choice`+`2choice`+`3choice`)/3)

c <- cor.test(fmridat.putamen.collapsed$Mean, fmridat.putamen.collapsed$Up3OfAppendicularSum)
N <- fmridat.putamen.collapsed %>%
                select(pseudonym) %>%
                summarise(N=n())
plot <- ggplot(fmridat.putamen.collapsed, aes(y=Mean, x=Up3OfAppendicularSum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, lwd = 2, color = 'black') +
        ggtitle('Association between mean putamen activity and \ndisease severity') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Beta') +
        theme_cowplot(font_size = 35, font_family = 'Calibri') +
        geom_text(x=16,y=1.3, label = paste('N=', N, ', r=', round(c$estimate,digits=2), sep=''),
                  size=12)
print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Corr_ON_Putamen_Severity.tiff',
#           plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)

#####

##### Mean activation #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfAppendicularSum)

# MMP > DM, mean

ips <- vois[8]
csvfile <- ips
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()

plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'LAS: IPS\n ',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('MMP', ' (n=', N[1],')', sep=''),
                                    paste('IM', ' (n=', N[2],')', sep=''),
                                    paste('DM', ' (n=', N[3],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-3,10)

y <- 10
d = 0.7
segmap <- data.frame(
        x =    c(1.00, 1.00,  3.00,  0.80, 2.80),
        xend = c(3.00, 1.00,  3.00,  1.20, 3.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1)
)
sigmap <- data.frame(
        x =     c(2),
        y =     c(y),
        label = c('**')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Subtypes_MMPgtDM_Mean_IPS.tiff',
          plot, dpi=300, device='tiff')

#####
```

## Subtypes vs HC

```{r echo=FALSE, warning=FALSE, message=FALSE}

##### Group analysis #####
# fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcImpSubtypes_x_ExtInt2Int3Catch_NoOutliers/'
# vois <- dir(fmri.subtypes, 'VOI.*csv', full.names = TRUE)
fmri.subtypes <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers2/marsbar'
vois <- dir(fmri.subtypes, '*csv', full.names = TRUE)

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                filter(Cond != 'Catch') %>%
                left_join(., Subtypes, by='pseudonym') %>%
                mutate(Group = as.character(Subtype),
                       Group = if_else(is.na(Group),'0_Healthy', Group),
                       Group = factor(Group,
                                      levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant')),
                       Cond = factor(Cond,
                                     levels = c('Ext','Int2','Int3'),
                                     labels = c('1choice','2choice','3choice'))) %>%
                rename(Beta = Vals)
        
        bn <- basename(csvfile)
        if(str_detect(bn, 'MMP_HC')){
          fmridat.subset <- fmridat %>%
            filter(Group == '1_Mild-Motor' | Group == '0_Healthy')
        }else if(str_detect(bn, 'IM_HC')){
          fmridat.subset <- fmridat %>%
            filter(Group == '2_Intermediate' | Group == '0_Healthy')
        }else if(str_detect(bn, 'HC_DM')){
          fmridat.subset <- fmridat %>%
            filter(Group == '3_Diffuse-Malignant' | Group == '0_Healthy')
        }
        fmridat.subset <- fmridat.subset %>% pivot_wider(id_cols = c('pseudonym','Group'),
                                       names_from = Cond,
                                       values_from = Beta) %>%
          mutate(Avg = (`3choice` + `2choice` + `1choice`)/3,
                 IvL = `2choice` - `1choice`,
                 HvL = `3choice` - `1choice`,
                 Avg.Outlier = if_else(abs(Avg-mean(Avg)) > 3*sd(Avg), 1, 0),
                 IvL.Outlier = if_else(abs(IvL-mean(IvL)) > 3*sd(IvL), 1, 0),
                 HvL.Outlier = if_else(abs(HvL-mean(HvL)) > 3*sd(HvL), 1, 0)) %>%
          select(-c(`1choice`,`2choice`,`3choice`))
        print(bn)
        fmridat.subset %>% filter(Avg.Outlier == TRUE | IvL.Outlier == TRUE | HvL.Outlier == TRUE) %>% print()
        
        # fmridat <- fmridat %>%
        #         filter(Group %in% c('1_Mild-Motor','3_Diffuse-Malignant'))
        
        raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'), title = basename(csvfile),
                      xlab='Group', ylab='Beta', xticklabs = c('HC','MMP','IM', 'DM'),
                      legend_title = 'No. of choices', legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') %>% print()
}
#####

##### Interactions #####

Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype)

# MMP > HC: 3 > 1, rIPL
mmpgthc_ipl <- vois[6]
csvfile2 <- mmpgthc_ipl
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'LAS: IPL\n',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-6,5)
y <- 5
d = 0.4
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  0.80,  1.20,  1.80,  1.80,  2.20),
        xend = c(2.00, 1.00,  2.00,  1.20,  0.80,  1.20,  2.20,  1.80,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_MMPgtHC_INT3gtEXT_IPL.tiff',
          plot, dpi=300, device='tiff')

# MMP > HC: 3 > 1, PMC
mmpgthc_pmc <- vois[5]
csvfile2 <- mmpgthc_pmc
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'LAS: PMC\n ',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-2,5)
y <- 5
d = 0.3
segmap <- data.frame(
        x =    c(1.00, 1.00,  2.00,  0.80,  0.80,  1.20,  1.80,  1.80,  2.20),
        xend = c(2.00, 1.00,  2.00,  1.20,  0.80,  1.20,  2.20,  1.80,  2.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(1.50),
        y =     c(y),
        label = c('*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_MMPgtHC_INT3gtEXT_PMC.tiff',
          plot, dpi=300, device='tiff')

# HC > DM: 3 > 1, PMC
hcgtdm_spl <- vois[2]
csvfile2 <- hcgtdm_spl
fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'MAS: PMC\n ',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-3,8)
y <- 8
d = 0.35
segmap <- data.frame(
        x =    c(1.00, 1.00,  4.00,  0.80,  0.80,  1.20,  3.80,  3.80,  4.20),
        xend = c(4.00, 1.00,  4.00,  1.20,  0.80,  1.20,  4.20,  3.80,  4.20),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(2.5),
        y =     c(y),
        label = c('***')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_HCgtDM_INT3gtEXT_PMC.tiff',
          plot, dpi=300, device='tiff')

# HC > DM: 3 > 1, lPMC
# hcgtdm_pmc <- vois[2]
# csvfile2 <- hcgtdm_pmc
# fmridat <- read_csv(csvfile2, show_col_types = FALSE) %>%
#         left_join(., Subtypes, by = 'pseudonym') %>%
#         select(-scans) %>%
#         filter(Cond != 'Catch') %>%
#         mutate(Subtype = as.character(Subtype),
#                Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
#                Group = factor(Subtype,
#                               levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
#                               labels = c('HC', 'MMP','IM','DM')),
#                Cond = factor(Cond,
#                              levels = c('Ext','Int2','Int3'),
#                              labels = c('1choice','2choice','3choice'))) %>%
#         rename(Beta = Vals) %>%
#         na.omit()
# 
# N <- fmridat %>%
#         filter(Cond=='1choice') %>%
#         select(Group) %>%
#         table()
# plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
#                               title = 'Task-related activity in the most \naffected premotor cortex',
#                       xlab='', ylab='Beta',
#                       xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
#                                     paste('MMP', ' (n=', N[2],')', sep=''),
#                                     paste('IM', ' (n=', N[3],')', sep=''),
#                                     paste('DM', ' (n=', N[4],')', sep='')),
#                       legend_title = '',
#                       legend_position = legend_position, legend_labels = c('One','Two','Three'),
#                       color_scheme = 'mako') +
#         ylim(-3,8)
# y <- 8
# d = 0.5
# segmap <- data.frame(
#         x =    c(1.00, 1.00,  4.00,  0.80,  0.80,  1.20,  3.80,  3.80,  4.20),
#         xend = c(4.00, 1.00,  4.00,  1.20,  0.80,  1.20,  4.20,  3.80,  4.20),
#         y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
#         yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
# )
# sigmap <- data.frame(
#         x =     c(2.5),
#         y =     c(y),
#         label = c('***')
# )
# plot <- plot + 
#         geom_segment(data=segmap,
#                      mapping = aes(x=x,xend=xend,y=y,yend=yend),
#                      inherit.aes = FALSE,
#                      size = lsize) +
#         geom_text(data=sigmap, 
#                   mapping = aes(x=x,y=y,label=label),
#                   inherit.aes = FALSE,
#                   size = sigsize)
# print(plot)
# save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_HCgtDM_INT3gtEXT_PMC.tiff',
#           plot, dpi=300, device='tiff')

# IM > HC: 2 > 1, rPutamen

imgthc_put <- vois[3]
csvfile <- imgthc_put
fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Cond != 'Catch') %>%
        mutate(Subtype = as.character(Subtype),
               Subtype = if_else(is.na(Subtype),'0_Healthy', Subtype),
               Group = factor(Subtype,
                              levels = c('0_Healthy', '1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('HC', 'MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()

N <- fmridat %>%
        filter(Cond=='1choice') %>%
        select(Group) %>%
        table()
plot <- raincloudplot_2Factor(fmridat, 'Beta', c('Cond','Group'),
                              title = 'LAS: Putamen\n ',
                      xlab='', ylab='Beta',
                      xticklabs = c(paste('HC', ' (n=', N[1],')', sep=''),
                                    paste('MMP', ' (n=', N[2],')', sep=''),
                                    paste('IM', ' (n=', N[3],')', sep=''),
                                    paste('DM', ' (n=', N[4],')', sep='')),
                      legend_title = '',
                      legend_position = legend_position, legend_labels = c('One','Two','Three'),
                      color_scheme = 'mako') +
        ylim(-3,4)
y <- 4
d = 0.25
segmap <- data.frame(
        x =    c(0.90, 0.90,  2.90,  0.80,  0.80,  1.00,  2.80,  2.80,  3.00),
        xend = c(2.90, 0.90,  2.90,  1.00,  0.80,  1.00,  3.00,  2.80,  3.00),
        y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1),
        yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2)
)
sigmap <- data.frame(
        x =     c(2),
        y =     c(y),
        label = c('*')
)
plot <- plot + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     size = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_HcSubtypes_IMgtHC_INT2gtEXT_Putamen.tiff',
          plot, dpi=300, device='tiff')


#####

```

## On: clinical correlation

```{r echo=FALSE, warning=FALSE, message=FALSE}

fmri.oncorr1 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers2/Int2gtExt/marsbar'
fmri.oncorr2 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers2/Int3gtExt/marsbar'
fmri.oncorr3 <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/OneSampleTtest_ClinCorr-Off-BAAppendicularSum_NoOutliers2/Mean_ExtInt/marsbar'
vois <- c(dir(fmri.oncorr1, '*csv', full.names = TRUE),
          dir(fmri.oncorr2, '*csv', full.names = TRUE),
          dir(fmri.oncorr3, '*csv', full.names = TRUE))

source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
for(v in 1:length(vois)){
        
        csvfile <- vois[v]
        
        severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfAppendicularSum, Subtype)
        
        fmridat <- read_csv(csvfile, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
        
        c <- cor.test(fmridat$Beta,fmridat$Up3OfAppendicularSum)
        
        p <- ggplot(fmridat, aes(x=Up3OfAppendicularSum, y=Beta)) + 
                geom_point(aes(color=Subtype), alpha = .3, shape = 19, size = 2) + 
                geom_smooth(method = 'lm', se = FALSE, lwd = 2, color='black') +
                ggtitle(basename(paste(csvfile, unique(fmridat$Cond), ': r=', round(c$estimate, digits = 3), sep = ' '))) + 
                theme_cowplot(font_size = 20) +
                xlab('MDS-UPDRS III (bradykinesia+rigidity)')
        print(p)
        
}

# Putamen and subtype data
Subtypes <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Subtype, Up3OfAppendicularSum)

putamen <- 'P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/Subtypes_x_ExtInt2Int3Catch_NoOutliers2/marsbar/HC_PD_(IntExt)_-25_3_4.csv'
csvfile <- putamen
fmridat.putamen <- read_csv(csvfile, show_col_types = FALSE) %>%
        left_join(., Subtypes, by = 'pseudonym') %>%
        select(-scans) %>%
        filter(Group == 'PD_POM',
               Cond != 'Catch') %>%
        mutate(Group = factor(Subtype,
                              levels = c('1_Mild-Motor','2_Intermediate','3_Diffuse-Malignant'),
                              labels = c('MMP','IM','DM')),
               Cond = factor(Cond,
                             levels = c('Ext','Int2','Int3'),
                             labels = c('1choice','2choice','3choice'))) %>%
        rename(Beta = Vals) %>%
        na.omit()
fmridat.putamen.collapsed <- fmridat.putamen %>%
        pivot_wider(id_cols = c('pseudonym','Subtype','Group','Up3OfAppendicularSum'),
                    values_from = Beta,
                    names_from = Cond) %>%
        mutate(Mean_ExtInt=(`1choice`+`2choice`+`3choice`)/3)

##### Mean correlation #####

voi.ipl <- vois[18]
voi.spl <- vois[16]
voi.pmc <- vois[17]
voi.putamen <- fmridat.putamen.collapsed %>%
        select(pseudonym,Mean_ExtInt) %>%
        rename(Putamen=Mean_ExtInt)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfAppendicularSum, Subtype)

fmridat1 <- read_csv(voi.pmc, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(PMC = Vals) %>%
                left_join(., severity, by = 'pseudonym')
fmridat2 <- read_csv(voi.ipl, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(IPL = Vals) %>%
                left_join(., severity, by = 'pseudonym')
fmridat3 <- read_csv(voi.spl, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(IPL = Vals) %>%
                left_join(., severity, by = 'pseudonym')

fmridat <- full_join(fmridat1, fmridat2)
fmridat <- left_join(fmridat, voi.putamen, by = 'pseudonym')
fmridat <- fmridat %>%
        pivot_longer(cols = c('PMC','IPL','Putamen'), names_to = 'Region', values_to = 'Beta')

c.PMC <- cor.test(fmridat$Beta[fmridat$Region=='PMC'],
                  fmridat$Up3OfAppendicularSum[fmridat$Region=='PMC'])
c.IPL <- cor.test(fmridat$Beta[fmridat$Region=='IPL'],
                  fmridat$Up3OfAppendicularSum[fmridat$Region=='IPL'])
c.Putamen <- cor.test(fmridat$Beta[fmridat$Region=='Putamen'],
                  fmridat$Up3OfAppendicularSum[fmridat$Region=='Putamen'])

N <- fmridat %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat, aes(x=Up3OfAppendicularSum, y=Beta, color=factor(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 1.5) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction=-1,
                               labels = c(paste('IPL', ' (n=', N[1],')',
                                                ', r=', round(c.IPL$estimate,digits=2), sep=''),
                                          paste('PMC', ' (n=', N[1],')',
                                                ', r=', round(c.PMC$estimate,digits=2), sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                ', r=', round(c.Putamen$estimate,digits=2), sep=''))) +
        ggtitle(' Mean activity\n ') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        theme(legend.position = c(0.6,0.9),
              legend.key.size = unit(0.5,'cm')) +
        xlab('MDS-UPDRS-III (bradykinesia + rigidity)') +
        ylab('Beta (mean)') +
        ylim(-18,25)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_Mean_Severity.tiff',
          plot, dpi=300, device='tiff')

# Facetted version
fmridat <- fmridat %>%
        filter(Subtype != '4_Undefined',
               !is.na(Subtype)) %>%
        mutate(Subtype=factor(Subtype))

N <- fmridat %>%
        select(pseudonym, Subtype) %>%
        group_by(Subtype) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat, aes(x=Up3OfAppendicularSum, y=Beta)) + 
        geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 1.5) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 1.5, color='black') +
        scale_colour_viridis_d(option='viridis', begin = 0.1, end = .6, alpha = .8,
                               direction=-1,
                               labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
                                          paste('IM', ' (n=', N[2,2],')', sep=''),
                                          paste('DM', ' (n=', N[3,2],')', sep=''))) +
        ggtitle('Mean activity\n') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        theme(legend.position = c(0.75,1.3),
              legend.key.size = unit(0.5,'cm')) +
        xlab('MDS-UPDRS-III (bradykinesia + rigidity)') +
        ylab('Beta (mean)') +
        ylim(-18,20) + 
        facet_grid(~Region)
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_Mean_Severity_facet.tiff',
          plot, dpi=300, device='tiff')

#####

##### Three>One correlation #####

parietal1 <- vois[12] # 3 gt 1
# parietal2 <- vois[1]  # 2 gt 1
voi.putamen <- fmridat.putamen.collapsed %>%
        mutate(INT3gtEXT = `3choice` - `1choice`) %>%
        select(pseudonym,INT3gtEXT) %>%
        rename(Putamen=INT3gtEXT)

severity <- dfClin %>%
                filter(TimepointNr==0,
                       ParticipantType=='PD_POM') %>%
                select(pseudonym, Up3OfAppendicularSum, Subtype)

fmridat1 <- read_csv(parietal1, show_col_types = FALSE) %>%
                select(-scans) %>%
                rename(Beta = Vals) %>%
                left_join(., severity, by = 'pseudonym')
# fmridat2 <- read_csv(parietal2, show_col_types = FALSE) %>%
# select(-scans) %>%
# rename(Beta = Vals) %>%
# left_join(., severity, by = 'pseudonym')

# fmridat <- full_join(fmridat1, fmridat2) %>%
#         arrange(pseudonym) %>%
#         mutate(Cond=factor(Cond)) %>%
#         group_by(pseudonym, Subtype) %>%
#         summarise(across(c(Beta,Up3OfAppendicularSum), ~mean(.x, na.rm=TRUE))) %>%
#         rename(SPL = Beta)
fmridat <- fmridat1 %>%
        mutate(Cond=factor(Cond)) %>%
        rename(SPL = Beta)

fmridat.SPL_putamen <- left_join(fmridat, voi.putamen, by=c('pseudonym')) %>%
        pivot_longer(cols = c('SPL','Putamen'), names_to = 'Region', values_to = 'Beta')

c.SPL <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='SPL'],
                  fmridat.SPL_putamen$Up3OfAppendicularSum[fmridat.SPL_putamen$Region=='SPL'])
c.Putamen <- cor.test(fmridat.SPL_putamen$Beta[fmridat.SPL_putamen$Region=='Putamen'],
                  fmridat.SPL_putamen$Up3OfAppendicularSum[fmridat.SPL_putamen$Region=='Putamen'])

N <- fmridat.SPL_putamen %>%
        select(pseudonym) %>%
        unique() %>%
        summarise(N=n())
plot <- ggplot(fmridat.SPL_putamen, aes(x=Up3OfAppendicularSum, y=Beta, color=fct_rev(Region))) + 
        geom_point(alpha = .3, shape = 19, size = 1.5, show.legend = FALSE) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 1.5) +
        scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
                               direction = -1,
                               labels = c(paste('PMC', ' (n=', N[1],')',
                                                ', r=', round(c.SPL$estimate,digits=2), sep=''),
                                          paste('Putamen', ' (n=', N[1],')',
                                                ', r=', round(c.Putamen$estimate,digits=2), sep=''))) +
        ggtitle('3 > 1\n ') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        theme(legend.position = c(0.6,0.8),
              legend.key.size = unit(0.5,'cm')) +
        xlab('MDS-UPDRS-III (bradykinesia + rigidity)') +
        ylab('Beta (three - one)')
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_INT3gtEXT_Severity.tiff',
          plot, dpi=300, device='tiff')

#Facetted vcersion
fmridat.SPL_putamen <- fmridat.SPL_putamen %>%
        filter(Subtype != '4_Undefined',
               !is.na(Subtype)) %>%
        mutate(Subtype=factor(Subtype))

N <- fmridat.SPL_putamen %>%
        select(pseudonym, Subtype) %>%
        group_by(Subtype) %>%
        unique() %>%
        summarise(N=n())

plot <- ggplot(fmridat.SPL_putamen, aes(x=Up3OfAppendicularSum, y=Beta)) + 
        geom_point(aes(color=Subtype), alpha = .5, shape = 19, size = 1.5) + 
        geom_smooth(method = 'lm', se = FALSE, lwd = 1.5, color='black') +
        scale_colour_viridis_d(option='viridis', begin = 0.1, end = .6, alpha = .8,
                               direction=-1,
                               labels = c(paste('MMP', ' (n=', N[1,2],')', sep=''),
                                          paste('IM', ' (n=', N[2,2],')', sep=''),
                                          paste('DM', ' (n=', N[3,2],')', sep=''))) +
        ggtitle('3 > 1\n ') + 
        guides(color=guide_legend(title='', reverse = FALSE)) +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        theme(legend.position = c(0.75,1.3),
              legend.key.size = unit(0.5,'cm')) +
        xlab('MDS-UPDRS-III (bradykinesia + rigidity)') +
        ylab('Beta (three - one)') +
        facet_grid(~factor(Region, levels = c('SPL','Putamen'), labels = c('SPL','Putamen')))
print(plot)

save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Brain_Corr_ON_INT3gtEXT_Severity_facet.tiff',
          plot, dpi=300, device='tiff')


#####
```

# Response times

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_rts <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE, digits = 3)
        anova <- anova(fit)
        print(anova)
        effectsize(anova) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ ParticipantType, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        # Summary stats
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        print(emm.summary)
        
        # Plots
                # Generate rainclouds where points, boxplots and densities reflect actual data
                # Means, CIs, and lines reflect estimated marginal means
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of Parkinson\'s disease \non response times',
                              xlab='', ylab='Response time (s)',
                              xticklabs=c(paste('Healthy', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0.3,1.75)
        y <- 1.75
        d = 0.1
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.80,  1.80,  0.80,  0.80,  1.80,  1.80),
                xend = c(2.00, 1.00,  2.00,  1.20,  2.20,  1.00,  1.20,  2.00,  2.20),
                y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*1, y-d*2, y-d*3, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(1.50,  0.90,  1.00,  1.90,  2.00),
                y =     c(y,     y-d*2, y-d*3, y-d*2, y-d*3),
                label = c('***', '***', '***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_HCvsON.tiff',
          plot, dpi=300, device='tiff')
        
        tplot <- emmip(fit, trial_type~ParticipantType, CIs = TRUE,
                       type='response') +
                scale_x_discrete(labels=c('Healthy','PD-On')) + 
                scale_colour_viridis_d(option='mako', begin = .1, end = .6,
                                       direction = -1,labels=c('One','Two','Three')) +
                ggtitle('') + ylab('Predicted response times (s)') +
                xlab('Group') + 
                guides(color=guide_legend(title='No. of choices', reverse = FALSE)) +
                theme_cowplot(font_size = 20)
        print(tplot)
        
        # Diagnostics
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1+trial_type|pseudonym)'

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type)) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, response_time)
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time), ~ mean(.x, na.rm=TRUE)))
compare_rts(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```

## ON, Bradykinesia-rigidity \~ RTs

```{r echo = FALSE, warning = TRUE}

# Fit model
tmp.clincorr <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type)) %>%
        select(pseudonym, Up3OfAppendicularSum_Dmean, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, response_time, Up3OfAppendicularSum)
f.clincorr <- 'log(response_time) ~ 1 + Up3OfAppendicularSum_Dmean*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1+trial_type|pseudonym)'
fit.clincorr <- lmer(f.clincorr, tmp.clincorr, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit.clincorr)
print(s, corr=FALSE, digits = 3)
anova <- anova(fit.clincorr)
print(anova)
effectsize(anova) %>% print()

# Post hoc test
emt <- emtrends(fit.clincorr, ~trial_type, var='Up3OfAppendicularSum_Dmean')
contrast(emt, 'revpairwise', adjust = 'mvt') %>% print()

# Visualize
plotdat <- tmp.clincorr %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, Up3OfAppendicularSum), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(response_time, Up3OfAppendicularSum), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, response_time, Up3OfAppendicularSum)
c <- cor.test(c$response_time, c$Up3OfAppendicularSum)
N <- tmp.clincorr  %>% 
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        na.omit() %>%
        ungroup() %>%
        select(ParticipantType) %>%
        table()
plot <- ggplot(plotdat, aes(y=response_time, x=Up3OfAppendicularSum, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = FALSE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between response \ntimes and disease severity') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Response time (s)') +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = c(0.8,1.10),
              legend.key.size = unit(0.5,'cm')) +
        geom_text(x=10,y=1.35, label = paste('N=', N, ', r=', round(c$estimate,digits=2), sep=''),
                  size=4, inherit.aes = FALSE) +
        ylim(0.5,1.75) + xlim(0,60)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Corr_ON_Severity.tiff',
          plot, dpi=300, device='tiff')

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_rts <- function(f, tmp, tmp.collapsed){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->

<!--         s <- summary(fit) -->

<!--         print(s, corr = FALSE, digits = 3) -->

<!--         cat('\n \n Anova: ') -->

<!--         anova <- anova(fit) -->

<!--         print(anova) -->

<!--         cat('\n \n') -->

<!--         effectsize(anova) %>% print() -->

<!--         # Post hoc test -->

<!--                 # Interaction -->

<!--         cat('\n \n Post hoc tests of interaction ParticipantType x trial_type \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType | trial_type) -->

<!--         print(em) -->

<!--         contrast(em, interaction = c(ParticipantType = 'revpairwise', trial_type='revpairwise'), -->

<!--                  by=NULL, adjust = 'mvt', type='response') %>% print() # by=NULL overrides the grouping of em -->

<!--         # interaction specifies the contrasts that are defined and how they are presented -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType|trial_type, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         cat('\n \n Post hoc tests of main effect trial_type \n') -->

<!--         emmeans(fit, pairwise ~ trial_type|ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->

<!--                 # emmip with plotit=FALSE gives a table of summarystats that is very handy -->

<!--                 # Some adjustments make it usable for the raincloudplot function below -->

<!--         emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>% -->

<!--                 tibble() %>% -->

<!--                 rename(mean = yvar, -->

<!--                        se = SE) %>% -->

<!--                 select(-c(df, tvar, xvar)) %>% -->

<!--                 mutate(ci = se*1.96) -->

<!--                 # Generate rainclouds where points, boxplots and densities reflect actual data -->

<!--                 # Means, CIs, and lines reflect estimated marginal means -->

<!--         cat('\n \n Summary statistics \n') -->

<!--         raincloudplot_2Factor(data=tmp.collapsed, y='response_time', -->

<!--                               groupvar=c('trial_type','ParticipantType'), -->

<!--                               title='', xlab='Group', ylab='Response time (s)', -->

<!--                               xticklabs=c('Healthy','PD-Off'), legend_title = 'No. of choices', -->

<!--                               legend_labels = c('One','Two','Three'), -->

<!--                               provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, trial_type~ParticipantType, CIs = TRUE, -->

<!--                        type='response') + -->

<!--                 scale_x_discrete(labels=c('Healthy','PD-Off')) +  -->

<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--                                        direction = -1,labels=c('One','Two','Three')) + -->

<!--                 ggtitle('') + ylab('Predicted response times (s)') + -->

<!--                 xlab('Group') +  -->

<!--                 guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->

<!--                 theme_cowplot(font_size = 20) -->

<!--         print(tplot) -->

<!--         plot(fit) %>% print() -->

<!--         qqmath(fit) %>% print() -->

<!--         qqmath(ranef(fit)) -->

<!-- } -->

<!-- f <- 'log(response_time) ~ 1 + ParticipantType*trial_type*block + Age_Dmean + Gender + (1+trial_type+block|pseudonym)' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(event_type == 'response') %>% -->

<!--         filter(trial_type != 'Catch') %>% -->

<!--         filter(response_time > 0.3) %>% -->

<!--         filter(correct_response=='Hit') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType), -->

<!--                trial_type = droplevels(trial_type)) -->

<!-- tmp.collapsed <- tmp %>%  -->

<!--         group_by(pseudonym, ParticipantType, trial_type) %>% -->

<!--         summarise(across(c(response_time), ~ mean(.x))) -->

<!-- compare_rts(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed) -->

<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_rts_for_medication <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp2, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr=FALSE, digits = 3)
        anova <- anova(fit)
        print(anova)
        effectsize(anova) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('pairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        # Summary stats
        emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        print(emm.summary)
        
        # Plots
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                                      groupvar=c('trial_type','ParticipantType'),
                                      title='Influence of medication on \nresponse times',
                                      xlab='', ylab='Response time (s)',
                                      xticklabs=c(paste('PD-Off', ' (n=', N[1],')', sep=''),
                                                  paste('PD-On', ' (n=', N[2],')', sep='')), 
                                      legend_title = '',
                                      legend_position = legend_position,
                                      legend_labels = c('One', 'Two', 'Three'),
                                      provided_summary = 'None') +
                ylim(0.3,1.75)
        y <- 1.75
        d = 0.1
        segmap <- data.frame(
                x =    c(0.80,  0.80,  1.80,  1.80),
                xend = c(1.00,  1.20,  2.00,  2.20),
                y =    c(y-d*2, y-d*3, y-d*2, y-d*3),
                yend = c(y-d*2, y-d*3, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(0.90,  1.00,  1.90,  2.00),
                y =     c(y-d*2, y-d*3, y-d*2, y-d*3),
                label = c('***', '***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_ONvsOff.tiff',
          plot, dpi=300, device='tiff')

        # Diagnostics
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'

groups <- c('PD_PIT','PD_POM')

tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type)) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, response_time)
# disease_severity <- tmp %>%
#         filter(ParticipantType=='PD_POM') %>%
#         select(pseudonym, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean, NpsEducYears, NpsEducYears_Dmean) %>%
#         group_by(pseudonym) %>%
#         summarise(across(c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean), ~ mean(.x, na.rm=TRUE)))
# tmp <- tmp %>%
#         select(-c(Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean,NpsEducYears,NpsEducYears_Dmean)) %>%
#         left_join(., disease_severity, by = 'pseudonym')
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  select(pseudonym, Age_Dmean, Gender, NpsEducYears_Dmean) %>%
  mutate(Gender = as.numeric(Gender)) %>%
  group_by(pseudonym) %>%
  summarise(across(c(NpsEducYears_Dmean,Age_Dmean, Gender), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Age_Dmean, Gender, NpsEducYears_Dmean)) %>%
        left_join(., covars, by = 'pseudonym')
tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time,Age_Dmean), ~ mean(.x)))
compare_rts_for_medication(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

```

## Subtypes vs subtypes

```{r echo=FALSE, message=FALSE}

compare_rts_for_subtypes <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr=FALSE, digits = 3)
        anova <- anova(fit)
        print(anova)
        effectsize(anova) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()

        em <- emmeans(fit, pairwise ~ ParticipantType, adjust='none', type='response')
        print(em)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        
        # Summary
        emm.summary <- emmip(fit, ParticipantType ~ trial_type, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        print(emm.summary)
        
        # Plots
        # N <- tmp.collapsed %>%
        #         ungroup() %>%
        #         filter(trial_type == '1choice',
        #                block == '1') %>%
        #         select(ParticipantType) %>%
        #         table()
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time',
                                      groupvar=c('trial_type','ParticipantType'),
                                      title='Influence of subtypes on \nresponse times',
                                      xlab='', ylab='Response time (s)',
                                      xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                                  paste('IM', ' (n=', N[2],')', sep=''),
                                                  paste('DM', ' (n=', N[3],')', sep='')), 
                                      legend_title = '',
                                      legend_position = legend_position,
                                      legend_labels = c('One', 'Two', 'Three'),
                                      provided_summary = 'None') +
                ylim(0.3,1.75)
        y <- 1.75
        d = 0.1
        segmap <- data.frame(
                x =    c(0.80,  0.80,  1.80,  1.80,  2.80,  2.80),
                xend = c(1.00,  1.20,  2.00,  2.20,  3.00,  3.20),
                y =    c(y-d*2, y-d*3, y-d*2, y-d*3, y-d*2, y-d*3),
                yend = c(y-d*2, y-d*3, y-d*2, y-d*3, y-d*2, y-d*3)
        )
        sigmap <- data.frame(
                x =     c(0.90,  1.00,  1.90,  2.00,  2.90,  3.00),
                y =     c(y-d*2, y-d*3, y-d*2, y-d*3, y-d*2, y-d*3),
                label = c('***', '***', '***', '***', '***', '***')
        )
        plot <- plot + 
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap, 
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_Subtypes.tiff',
                  plot, dpi=300, device='tiff')
        
        # Diagnostics
        plot(fit) %>% print()
        qqmath(fit) %>% print()
        qqmath(ranef(fit))
        
}

f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1+trial_type|pseudonym)'

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(response_time > 0.3) %>%
        filter(correct_response=='Hit') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM'))) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, response_time)

tmp.collapsed <- tmp %>% 
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(response_time), ~ mean(.x)))
tmp.for.struc <- tmp.collapsed
compare_rts_for_subtypes(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed)

cat('\n\n\n\n')
```

<!-- ## Subtypes vs HC -->

<!-- ```{r echo=FALSE, warning=FALSE} -->

<!-- compare_rts_for_subtypeshc <- function(f, tmp, tmp.collapsed){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->

<!--         s <- summary(fit) -->

<!--         print(s, corr=FALSE, digits = 3) -->

<!--         anova <- anova(fit) -->

<!--         print(anova) -->

<!--         effectsize(anova) %>% print() -->

<!--         # Post hoc test -->

<!--         cat('\n \n Post hoc tests of interactions \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response') -->

<!--         contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print() -->

<!--         emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print() -->

<!--         # em1 <- emmeans(fit, ~ block|ParticipantType, type='response') -->

<!--         # contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         # emmip(fit, ParticipantType ~ block, type='response') %>% print() -->

<!--         em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response') -->

<!--         contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         emmip(fit, ParticipantType ~ trial_type, type='response') %>% print() -->

<!--         # em3 <- emmeans(fit, ~ block|trial_type, type='response') -->

<!--         # contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         # emmip(fit, trial_type ~ block, type='response') %>% print() -->

<!--         em4 <- emmeans(fit, trt.vs.ctrl ~ ParticipantType, adjust='mvt', type='response') -->

<!--         print(em4) -->

<!--         emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print() -->

<!--         em5 <- emmeans(fit, pairwise ~ trial_type, type='response') -->

<!--         print(em5) -->

<!--         emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print() -->

<!--         cat('\n \n') -->

<!--         # Visualization -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->

<!--         N <- tmp.collapsed %>% -->

<!--                 ungroup() %>% -->

<!--                 filter(trial_type == '1choice', -->

<!--                        block == '1') %>% -->

<!--                 select(ParticipantType) %>% -->

<!--                 table() -->

<!--         plot <- raincloudplot_2Factor(data=tmp.collapsed, y='response_time', -->

<!--                                       groupvar=c('trial_type','ParticipantType'), -->

<!--                                       title='Influence of subtype on \nresponse times', -->

<!--                                       xlab='', ylab='Response time (s)', -->

<!--                                       xticklabs=c(paste('HC', ' (n=', N[1],')', sep=''), -->

<!--                                                   paste('MMP', ' (n=', N[2],')', sep=''), -->

<!--                                                   paste('IM', ' (n=', N[3],')', sep=''), -->

<!--                                                   paste('DM', ' (n=', N[4],')', sep='')),  -->

<!--                                       legend_title = '', -->

<!--                                       legend_position = legend_position, -->

<!--                                       legend_labels = c('One', 'Two', 'Three'), -->

<!--                                       provided_summary = 'None') + -->

<!--                 ylim(0.3,1.75) -->

<!--         print(plot) -->

<!--         save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/RT_SubtypesHc.tiff', -->

<!--           plot, dpi=300, device='tiff') -->

<!--         plot(fit) %>% print() -->

<!--         qqmath(fit) %>% print() -->

<!--         qqmath(ranef(fit)) -->

<!-- } -->

<!-- f <- 'log(response_time) ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1+trial_type|pseudonym)' -->

<!-- # -->

<!-- # Subtypes compared to healthy controls -->

<!-- groups <- c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant') -->

<!-- tmp <- df %>% -->

<!--         filter(ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT') %>% -->

<!--         filter(event_type == 'response') %>% -->

<!--         filter(trial_type != 'Catch') %>% -->

<!--         filter(response_time > 0.3) %>% -->

<!--         filter(correct_response=='Hit') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(Subtype %in% groups) %>% -->

<!--         mutate(Subtype = droplevels(Subtype), -->

<!--                trial_type = droplevels(trial_type), -->

<!--                ParticipantType=factor(Subtype, -->

<!--                                       levels = c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'), -->

<!--                                       labels = c('HC', 'MMP', 'IM', 'DM'))) -->

<!-- tmp.collapsed <- tmp %>%  -->

<!--         group_by(pseudonym, ParticipantType, block, trial_type) %>% -->

<!--         summarise(across(c(response_time, Up3OfAppendicularSum,Up3OfAppendicularSum_Dmean), ~ mean(.x))) -->

<!-- compare_rts_for_subtypes(f=f, tmp=tmp, tmp.collapsed=tmp.collapsed) -->

<!-- ``` -->

# Button selection variability

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_cov <- function(f, tmp, outlier_method = 2){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        anovaOutliersRetained <- anova(fitOutliersRetained)
        cat('\n \n Outliers retained: ')
        print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        print(em)
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Coefficient of variation', xlab = 'Group',
                              xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print()
        
        tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response')
        tplot <- tplot + 
                theme_cowplot(font_size = 20) +
                scale_x_discrete(labels = c('Healthy','PD-On')) +
                ggtitle('') + 
                xlab('Group')
        print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
  select(pseudonym, ParticipantType, Age_Dmean, Gender, NpsEducYears_Dmean, Button.Press.CoV)
compare_cov(f=f, tmp=tmp)

```

## ON, Bradykinesia-rigidity \~ CoV

```{r echo=FALSE, message=FALSE, warning=TRUE}
f <- 'log(Button.Press.CoV) ~ 1 + Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
  select(pseudonym, ParticipantType, Age_Dmean, Gender, NpsEducYears_Dmean, Button.Press.CoV, Up3OfAppendicularSum_Dmean, Up3OfAppendicularSum)
tmp <- tmp %>%
  filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio))

fit <- lm(f, tmp)
s <- summary(fit)
print(s, corr=FALSE, digits = 3)
anova <- anova(fit)
print(anova)

c <- cor.test(tmp$Button.Press.CoV, tmp$Up3OfAppendicularSum)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(tmp, aes(y=Button.Press.CoV, x=Up3OfAppendicularSum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, lwd = 2, color = 'black') +
        ggtitle('') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('CoV') +
        theme_cowplot(font_size = 35, font_family = 'Calibri')
print(plot)

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_cov <- function(f, tmp, outlier_method = 2){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fitOutliersRetained <- lm(f, data=tmp) -->

<!--         if(outlier_method == 1){ -->

<!--                 outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric() -->

<!--                 tmp <- tmp[-c(outliers),] -->

<!--         }else if(outlier_method == 2){ -->

<!--                 tmp <- tmp %>% -->

<!--                         group_by(ParticipantType) %>% -->

<!--                         filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>% -->

<!--                         ungroup() -->

<!--         } -->

<!--         fit <- lm(f, data=tmp) -->

<!--         s <- summary(fit) -->

<!--         print(s, digits=3) -->

<!--         # anovaOutliersRetained <- anova(fitOutliersRetained) -->

<!--         # cat('\n \n Outliers retained: ') -->

<!--         # print(anovaOutliersRetained) -->

<!--         cat('\n \n Outliers removed: ') -->

<!--         anova <- anova(fit) -->

<!--         print(anova) -->

<!--         cat('\n \n') -->

<!--         effectsize(anova) %>% print() -->

<!--         # Post hoc test -->

<!--         cat('\n \n EMMs \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType, type = 'response') -->

<!--         print(em) -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R') -->

<!--         cat('\n \n Summary statistics \n') -->

<!--         emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>% -->

<!--                 tibble() %>% -->

<!--                 rename(mean = yvar, -->

<!--                        se = SE) %>% -->

<!--                 select(-c(df, tvar, xvar)) %>% -->

<!--                 mutate(ci = se*1.96) -->

<!--         raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType', -->

<!--                               title = '', ylab = 'Coefficient of variation', xlab = 'Group', -->

<!--                               xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response') -->

<!--         tplot <- tplot +  -->

<!--                 theme_cowplot(font_size = 20) + -->

<!--                 scale_x_discrete(labels = c('Healthy','PD-Off')) + -->

<!--                 scale_colour_viridis_d(option='viridis', begin = .1, end = .6, -->

<!--                                        direction = -1) + -->

<!--                 ggtitle('') +  -->

<!--                 xlab('Group') -->

<!--         print(tplot) -->

<!--         plot(fit, which = 1) %>% print() -->

<!--         plot(fit, which = 2) %>% print() -->

<!--         plot(fit, which = 4) %>% print() -->

<!-- } -->

<!-- f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + RespHandIsDominant' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType)) %>% -->

<!--         group_by(pseudonym, ParticipantType) %>% -->

<!--         summarise(across(everything(), ~first(.x))) %>% -->

<!--         ungroup() -->

<!-- compare_cov(f=f, tmp=tmp) -->

<!-- ``` -->

## OFF vs. ON

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_cov_for_medication <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV))
        }
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE, digits=3)
        anovaOutliersRetained <- anova(fitOutliersRetained)
        cat('\n \n Outliers retained: ')
        print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova, digits=4)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        emm_options(lmer.df = 'satterthwaite')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% print()
        #         # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum_Dmean, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response') %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Coefficient of variation', xlab = 'Group',
                              xticklabs = c('PD-Off','PD-On'), provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, type='response', dodge=2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Group', reverse = TRUE))
        # print(tplot)
        
        plot(fit) %>% print()
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# removed due to non-significance

groups <- c('PD_POM','PD_PIT')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        select(pseudonym, ParticipantType, 
               Age_Dmean, Gender, NpsEducYears_Dmean, Button.Press.CoV)
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  select(pseudonym, Age_Dmean, Gender, NpsEducYears_Dmean) %>%
  mutate(Gender = as.numeric(Gender)) %>%
  group_by(pseudonym) %>%
  summarise(across(c(NpsEducYears_Dmean,Age_Dmean, Gender), ~ mean(.x, na.rm=TRUE))) %>%
  mutate(Gender=as.factor(Gender))
tmp <- tmp %>%
        select(-c(Age_Dmean, Gender, NpsEducYears_Dmean)) %>%
        left_join(., covars, by = 'pseudonym')
compare_cov_for_medication(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_cov_for_subtypes <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>%
                ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        anovaOutliersRetained <- anova(fitOutliersRetained)
        cat('\n \n Outliers retained: ')
        print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        emm_options(lmer.df = 'satterthwaite')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% print()
        #         # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum_Dmean, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response') %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
                # emmip with plotit=FALSE gives a table of summarystats that is very handy
                # Some adjustments make it usable for the raincloudplot function below
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.CoV', groupvar='ParticipantType',
                              title = '', ylab = 'Coefficient of variation', xlab = 'Group',
                              xticklabs = levels(tmp$ParticipantType),
                              color_scheme='viridis', provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, dodge=2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Subtype', reverse = TRUE))
        # print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.CoV) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM'))) %>%
  select(pseudonym, ParticipantType, Age_Dmean, Gender, NpsEducYears_Dmean, Button.Press.CoV)
compare_cov_for_subtypes(f=f, tmp=tmp)

# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_cov_for_subtypes(f=f, tmp=tmp)
```

# Switch ratio

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        anovaOutliersRetained <- anova(fitOutliersRetained)
        cat('\n \n Outliers retained: ')
        print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n EMMs \n')
        em <- emmeans(fit, ~ ParticipantType, type = 'response')
        print(em)
                # Main effects
        cat('\n \n Post hoc tests of main effect ParticipantType \n')
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Switch ratio', xlab = 'Group',
                              xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print()
        
        tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response')
        tplot <- tplot + 
                theme_cowplot(font_size = 20) +
                scale_x_discrete(labels = c('Healthy','PD-On')) +
                ggtitle('') + 
                xlab('Group')
        print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
  select(pseudonym, ParticipantType, Age_Dmean, Gender, NpsEducYears_Dmean, Button.Press.SwitchRatio)
compare_switch(f=f, tmp=tmp)
```

## ON, Bradykinesia-rigidity \~ Switch

```{r echo=FALSE, message=FALSE, warning=TRUE}
f <- 'log(Button.Press.SwitchRatio) ~ 1 + Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('PD_POM')
tmp <- df %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
  select(pseudonym, ParticipantType, Age_Dmean, Gender, NpsEducYears_Dmean, Button.Press.SwitchRatio, Up3OfAppendicularSum_Dmean, Up3OfAppendicularSum)
tmp <- tmp %>%
  filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio))
fit <- lm(f, tmp)
s <- summary(fit)
print(s, corr=FALSE, digits = 3)
anova <- anova(fit)
print(anova)

c <- cor.test(tmp$Button.Press.SwitchRatio, tmp$Up3OfAppendicularSum)
N <- tmp %>%
                select(pseudonym) %>%
                summarise(N=n())

plot <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum)) +
        geom_point(alpha = .3, shape = 19, size = 2) +
        geom_smooth(method='lm', se = FALSE, lwd = 2, color = 'black') +
        ggtitle('') + 
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Switch ratio') +
        theme_cowplot(font_size = 35, font_family = 'Calibri')
print(plot)

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_switch <- function(f, tmp, outlier_method = 2){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fitOutliersRetained <- lm(f, data=tmp) -->

<!--         if(outlier_method == 1){ -->

<!--                 outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric() -->

<!--                 tmp <- tmp[-c(outliers),] -->

<!--         }else if(outlier_method == 2){ -->

<!--                 tmp <- tmp %>% -->

<!--                         group_by(ParticipantType) %>% -->

<!--                         filter(abs(Button.Press.CoV - mean(Button.Press.CoV)) < 3*sd(Button.Press.CoV)) %>% -->

<!--                         ungroup() -->

<!--         } -->

<!--         fit <- lm(f, data=tmp) -->

<!--         s <- summary(fit) -->

<!--         print(s, digits=3) -->

<!--         # anovaOutliersRetained <- anova(fitOutliersRetained) -->

<!--         # cat('\n \n Outliers retained: ') -->

<!--         # print(anovaOutliersRetained) -->

<!--         cat('\n \n Outliers removed: ') -->

<!--         anova <- anova(fit) -->

<!--         print(anova) -->

<!--         cat('\n \n') -->

<!--         effectsize(anova) %>% print() -->

<!--         # Post hoc test -->

<!--         cat('\n \n EMMs \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType, type = 'response') -->

<!--         print(em) -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R') -->

<!--         cat('\n \n Summary statistics \n') -->

<!--         emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>% -->

<!--                 tibble() %>% -->

<!--                 rename(mean = yvar, -->

<!--                        se = SE) %>% -->

<!--                 select(-c(df, tvar, xvar)) %>% -->

<!--                 mutate(ci = se*1.96) -->

<!--         raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType', -->

<!--                               title = '', ylab = 'Switch ratio', xlab = 'Group', -->

<!--                               xticklabs = c('Healthy','PD-On'), provided_summary = 'None') %>% print() -->

<!--         tplot <- emmip(fit, ~ ParticipantType, CIs = TRUE, type='response') -->

<!--         tplot <- tplot +  -->

<!--                 theme_cowplot(font_size = 20) + -->

<!--                 scale_x_discrete(labels = c('Healthy','PD-Off')) + -->

<!--                 ggtitle('') +  -->

<!--                 xlab('Group') -->

<!--         print(tplot) -->

<!--         plot(fit, which = 1) %>% print() -->

<!--         plot(fit, which = 2) %>% print() -->

<!--         plot(fit, which = 4) %>% print() -->

<!-- } -->

<!-- f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + RespHandIsDominant' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType)) %>% -->

<!--         group_by(pseudonym, ParticipantType) %>% -->

<!--         summarise(across(everything(), ~first(.x))) %>% -->

<!--         ungroup() -->

<!-- compare_switch(f=f, tmp=tmp) -->

<!-- ``` -->

## OFF vs. ON

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch_repeated <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa',
                                                                       optCtrl=list(maxfun=2e5)))
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio))
        }
        fit <- lmer(f, data=tmp, control = lmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE, digits=3)
        anovaOutliersRetained <- anova(fitOutliersRetained)
        cat('\n \n Outliers retained: ')
        print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response') %>% print()
        cat('\n \n')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise'), adjust = 'mvt') %>% print()
                # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Switch ratio', xlab = 'Group',
                              xticklabs = c('PD-Off','PD-On'), provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType~Up3OfAppendicularSum, CIs = TRUE,
        #                type='response', cov.reduce=range, dodge=2) +
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + ylab('Predicted switch ratio') +
        #         xlab('Bradykinesia-rigidity severity') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) +
        #         theme_cowplot(font_size = 20)
        # print(tplot)
        
        # g <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum, color = ParticipantType, group = ParticipantType)) +
        #         geom_point(alpha = .3, shape = 19, size = 2) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1, labels = c('PD-Off','PD-On')) +
        #         ggtitle('') + xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Switch ratio') + 
        #         guides(color=guide_legend(title='Group', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 20)
        # print(g)
        # 
        # dOff <- tmp %>% filter(ParticipantType=='PD_PIT')
        # cOff <- cor.test(dOff$Button.Press.SwitchRatio, dOff$Up3OfAppendicularSum)
        # dOn <- tmp %>% filter(ParticipantType=='PD_POM')
        # cOn <- cor.test(dOn$Button.Press.SwitchRatio, dOn$Up3OfAppendicularSum)
        # 
        # N <- tmp %>%
        #         select(pseudonym) %>%
        #         unique() %>%
        #         nrow()
        # 
        # plot <- ggplot(tmp, aes(y=Button.Press.SwitchRatio, x=Up3OfAppendicularSum, 
        #                             color = ParticipantType)) +
        #         geom_point(alpha = .3, shape = 19, size = 2, show.legend = FALSE) +
        #         geom_smooth(method='lm', se = FALSE, lwd = 2) +
        #         scale_colour_viridis_d(option='mako', begin = 0.1, end = .6, alpha = .8,
        #                                direction = -1,
        #                                labels = c(paste('PD-Off', ' (n=', N[1],')',
        #                                                 ', r=', round(cOff$estimate,digits=3), sep=''),
        #                                   paste('PD-On', ' (n=', N[1],')',
        #                                                 ', r=', round(cOn$estimate,digits=3), sep=''))) +
        #         ggtitle('Influence of medication on the association \nbetween switches and disease severity') +
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + ylab('Switch ratio') + 
        #         guides(color=guide_legend(title='', reverse = FALSE)) + 
        #         theme_cowplot(font_size = 35, font_family = 'Calibri') +
        #         theme(legend.position = c(.05,.85)) +
        #         xlim(0,50) +
        #         geom_segment(x=47,xend=47,y=0.475,yend=0.365,size=lsize) +
        #         geom_text(x=48,y=0.415,label='*',size=sigsize, show.legend = FALSE)
        #         
        # print(plot)
        # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/ONvsOFF_Switch_Severity.tiff',
        #   plot, dpi=300, device='tiff', base_height = 12, base_asp = 1.2)
        
        plot(fit) %>% print()
        
}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# removed due to non-significance

groups <- c('PD_POM','PD_PIT')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType)) %>%
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        select(pseudonym, ParticipantType, 
               Age_Dmean, Gender, NpsEducYears_Dmean, Button.Press.SwitchRatio)
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  select(pseudonym, Age_Dmean, Gender, NpsEducYears_Dmean) %>%
  mutate(Gender = as.numeric(Gender)) %>%
  group_by(pseudonym) %>%
  summarise(across(c(NpsEducYears_Dmean,Age_Dmean, Gender), ~ mean(.x, na.rm=TRUE))) %>%
  mutate(Gender=as.factor(Gender))
tmp <- tmp %>%
        select(-c(Age_Dmean, Gender, NpsEducYears_Dmean)) %>%
        left_join(., covars, by = 'pseudonym')
compare_switch_repeated(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_switch_for_subtypes <- function(f, tmp, outlier_method = 2){
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fitOutliersRetained <- lm(f, data=tmp)
        if(outlier_method == 1){
                outliers <- outlierTest(fitOutliersRetained)[[1]] %>% names() %>% as.numeric()
                tmp <- tmp[-c(outliers),]
        }else if(outlier_method == 2){
                tmp <- tmp %>%
                        filter(abs(Button.Press.SwitchRatio - mean(Button.Press.SwitchRatio)) < 3*sd(Button.Press.SwitchRatio)) %>%
                        ungroup()
        }
        fit <- lm(f, data=tmp)
        s <- summary(fit)
        print(s, digits=3)
        anovaOutliersRetained <- anova(fitOutliersRetained)
        cat('\n \n Outliers retained: ')
        print(anovaOutliersRetained)
        cat('\n \n Outliers removed: ')
        anova <- anova(fit)
        print(anova)
        cat('\n \n')
        effectsize(anova) %>% print()
        # Post hoc test
        emm_options(lmer.df = 'satterthwaite')
                # Association between disease severity and response times
        # cat('\n \n Emtrends \n \n ')
        # emt <- emtrends(fit, ~ParticipantType, var='Up3OfAppendicularSum_Dmean')
        # print(emt)
        # contrast(emt, interaction = c('revpairwise','revpairwise'), adjust = 'mvt') %>% print()
        #         # Association between subtype and trial type, corrected for by disease severity
        # cat('\n \n Emmeans \n \n')
        # emm <- emmeans(fit, ~ParticipantType*Up3OfAppendicularSum_Dmean, type = 'response')
        # print(emm)
        # contrast(emm, interaction = c('revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print()
        cat('\n \n Post hoc tests of interactions \n')
        em <- emmeans(fit, ~ ParticipantType, type='response')
        contrast(em, interaction = c('pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ~ ParticipantType, type='response', CIs = TRUE) %>% print()
        cat('\n \n')
        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_1Factor.R')
        cat('\n \n Summary statistics \n')
        emm.summary <- emmip(fit, ~ ParticipantType, plotit = FALSE, type = 'response') %>%
                tibble() %>%
                rename(mean = yvar,
                       se = SE) %>%
                select(-c(df, tvar, xvar)) %>%
                mutate(ci = se*1.96)
        raincloudplot_1Factor(data=tmp, y='Button.Press.SwitchRatio', groupvar='ParticipantType',
                              title = '', ylab = 'Ratio of switches to non-switches', xlab = 'Group',
                              xticklabs = levels(tmp$ParticipantType),
                              color_scheme = 'viridis', provided_summary = 'None') %>% print()
        
        # tplot <- emmip(fit, ParticipantType ~ Up3OfAppendicularSum_Dmean, cov.reduce=range,
        #                CIs = TRUE, type = 'response', dodge = 2)
        # tplot <- tplot + 
        #         theme_cowplot(font_size = 20) +
        #         
        #         scale_colour_viridis_d(option='viridis', begin = .1, end = .6,
        #                                direction = -1) +
        #         ggtitle('') + 
        #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        #         guides(color=guide_legend(title='Subtype', reverse = TRUE))
        # print(tplot)
        
        plot(fit, which = 1) %>% print()
        plot(fit, which = 2) %>% print()
        plot(fit, which = 4) %>% print()
        
}

f <- 'log(Button.Press.SwitchRatio) ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean'
# removed due to non-significance

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        group_by(pseudonym) %>%
        summarise(across(everything(), ~first(.x))) %>%
        ungroup() %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype,
                                      levels = c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant'),
                                      labels = c('MMP', 'IM', 'DM')))
compare_switch_for_subtypes(f=f, tmp=tmp)

# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '2_Intermediate')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('1_Mild-Motor', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
# 
# cat('\n\n\n\n')
# 
# groups <- c('2_Intermediate', '3_Diffuse-Malignant')
# tmp <- df %>%
#         filter(trial_number == 1) %>%
#         filter(Percentage.Correct.BelowCutoff == FALSE) %>%
#         filter(Subtype %in% groups) %>%
#         mutate(Subtype = droplevels(Subtype),
#                trial_type = droplevels(trial_type),
#                ParticipantType=factor(Subtype))
# compare_switch_for_subtypes(f=f, tmp=tmp)
```

# Percentage correct (multiple-choice conditions)

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_correct <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()

        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, pairwise ~ ParticipantType, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of Parkinson\'s \ndisease on accuracy',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('Healthy', ' (n=', N[1],')', sep=''),
                                          paste('PD-On', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        y <- 70
        d = 5
        segmap <- data.frame(
                x =    c(1.00, 1.00,  2.00,  0.80,  0.80,  1.20,  1.80,  1.80,  2.20,  1.80,  2.00),
                xend = c(2.00, 1.00,  2.00,  1.20,  0.80,  1.20,  2.20,  1.80,  2.20,  2.20,  2.20),
                y =    c(y,    y,     y,     y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*1, y-d*3, y-d*4),
                yend = c(y,    y-d*1, y-d*1, y-d*1, y-d*2, y-d*2, y-d*1, y-d*2, y-d*2, y-d*3, y-d*4)
        )
        sigmap <- data.frame(
                x =     c(1.50,  2.00,  2.10),
                y =     c(y,     y-d*3, y-d*4),
                label = c('***', '***', '***')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_HCvsON_v2.tiff',
          plot, dpi=300, device='tiff')

}

f <- 'incorrect_response_fct ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# Random slopes, along with the interaction with block removed due to singular fit

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               correct_response_fct = factor(if_else(correct_response=='Hit',1,0)),
               incorrect_response_fct = factor(if_else(correct_response=='Incorrect',1,0))) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, incorrect_response_fct, Percentage.Correct)
        
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)
compare_correct(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

## ON, Bradykinesia \~ Accuracy

```{r echo=FALSE, message=FALSE, warning=TRUE}

# Fit model
tmp.clincorr <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               correct_response_fct = factor(if_else(correct_response=='Hit',1,0)),
               incorrect_response_fct = factor(if_else(correct_response=='Incorrect',1,0)),
               Percentage.Incorrect = (1-Percentage.Correct)*100) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, incorrect_response_fct, Percentage.Correct,
               Percentage.Incorrect, Up3OfAppendicularSum, Up3OfAppendicularSum_Dmean)
f.clincorr <- 'incorrect_response_fct ~ 1 + trial_type*Up3OfAppendicularSum_Dmean + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
fit.clincorr <- glmer(f.clincorr, data=tmp.clincorr, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
s <- summary(fit.clincorr)
print(s, corr = FALSE)
anova <- Anova(fit.clincorr, type = 'III')
print(anova)

# Post hoc
emt <- emtrends(fit.clincorr, ~ trial_type, var='Up3OfAppendicularSum_Dmean')
contrast(emt, 'revpairwise', adjust = 'mvt') %>% print()

# Visualization
plotdat <- tmp.clincorr %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(Percentage.Incorrect, Up3OfAppendicularSum), ~ mean(.x, na.rm=TRUE))) %>%
        ungroup()
c <- plotdat %>%
        group_by(pseudonym, trial_type) %>%
        summarise(across(c(Percentage.Incorrect, Up3OfAppendicularSum), ~ mean(., na.rm=TRUE))) %>%
        select(pseudonym, Percentage.Incorrect, Up3OfAppendicularSum)
c <- cor.test(c$Percentage.Incorrect, c$Up3OfAppendicularSum)
N <- tmp.clincorr  %>% 
        group_by(pseudonym, ParticipantType) %>%
        summarise(across(everything(), ~first(.x))) %>%
        na.omit() %>%
        ungroup() %>%
        select(ParticipantType) %>%
        table()
plot <- ggplot(plotdat, aes(y=Percentage.Incorrect, x=Up3OfAppendicularSum, color=trial_type)) +
        geom_point(alpha = .3, shape = 19, size = 1.5) +
        geom_smooth(method='lm', se = FALSE, lwd = 2) +
        scale_color_viridis_d(option='mako', begin = .1, end = .6, alpha = .8,
                              direction = -1, labels = c('One','Two','Three')) +
        ggtitle('Association between error rate \nand disease severity') +
        xlab('MDS-UPDRS III (bradykineisa + rigidity)') +
        ylab('Errors (%)') +
        theme_cowplot(font_size = 14, font_family = 'Calibri') +
        guides(color=guide_legend(title='', reverse = FALSE,
                                 title.position = 'left', label.position = 'right')) +
        theme(legend.position = c(0.8,1.10),
              legend.key.size = unit(0.5,'cm')) +
        geom_text(x=10,y=40, label = paste('N=', N, ', r=', round(c$estimate,digits=2), sep=''),
                  size=4, inherit.aes = FALSE) +
        ylim(0,65) + xlim(0,60) +
  geom_segment(x=59,xend=59,y=5,yend=12,size=lsize) +
  geom_segment(x=58,xend=59,y=5,yend=5,size=lsize) +
  geom_segment(x=58,xend=59,y=12,yend=12,size=lsize) +
  geom_text(x=61.3,y=6.2,label='**', size=sigsize, inherit.aes = FALSE)
print(plot)
save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Corr_ON_Severity.tiff',
          plot, dpi=300, device='tiff')

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_correct <- function(f, tmp){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fit <- glmer(f, data=tmp, family = binomial, -->

<!--                      control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->

<!--         s <- summary(fit) -->

<!--         print(s, corr = FALSE) -->

<!--         cat('\n \n') -->

<!--         anova <- Anova(fit, type = 'III') -->

<!--         print(anova) -->

<!--         cat('\n \n Odds ratios:') -->

<!--         se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/ -->

<!--         tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se) -->

<!--         exp(tab) %>% print() -->

<!--         # Post hoc test -->

<!--         emm_options(lmer.df = 'satterthwaite') -->

<!--                 # Interaction -->

<!--         cat('\n \n Post hoc tests \n \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType | trial_type, type = 'response') -->

<!--         print(em) -->

<!--         contrast(em, 'eff', interaction = c(ParticipantType = 'pairwise', trial_type = 'revpairwise'), -->

<!--                  by=NULL, adjust = 'mvt') %>% print() # by=NULL overrides the grouping of em -->

<!--         # interaction specifies the contrasts that are defined and how they are presented -->

<!--                 # Main effects -->

<!--         cat('\n \n Post hoc tests of main effect ParticipantType \n') -->

<!--         emmeans(fit, pairwise ~ ParticipantType|trial_type, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         cat('\n \n Post hoc tests of main effect trial_type \n') -->

<!--         emmeans(fit, revpairwise ~ trial_type|ParticipantType, type = 'response', adjust = 'mvt')$contrast %>% print() -->

<!--         # Visualization -->

<!--         tplot <- emmip(fit, trial_type ~ ParticipantType, type = 'response', CIs=TRUE) + -->

<!--                 scale_x_discrete(labels=c('Healthy','PD-Off')) + -->

<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--                                        direction = -1,labels=c('One','Two','Three')) + -->

<!--                 ggtitle('') + ylab('Predicted probability of correct response') + -->

<!--                 xlab('Group') + -->

<!--                 guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->

<!--                 theme_cowplot(font_size = 20) -->

<!--         print(tplot) -->

<!--         plot(fit) %>% print() -->

<!-- } -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + (1|pseudonym)' -->

<!-- # removed due to non-significance -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(event_type == 'response') %>% -->

<!--         filter(trial_type != 'Catch') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType), -->

<!--                trial_type = droplevels(trial_type), -->

<!--                correct_response = factor(if_else(correct_response=='Hit',1,0))) -->

<!-- compare_correct(f=f, tmp=tmp) -->

<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_correct_for_medication <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr=FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ ParticipantType, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of medication \non accuracy',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('PD-On', ' (n=', N[1],')', sep=''),
                                          paste('PD-Off', ' (n=', N[2],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        y <- 70
        d = 5
        segmap <- data.frame(
                x =    c(0.80,  1.00,  1.80,  2.00),
                xend = c(1.20,  1.20,  2.20,  2.20),
                y =    c(y-d*3, y-d*4, y-d*3, y-d*4),
                yend = c(y-d*3, y-d*4, y-d*3, y-d*4)
        )
        sigmap <- data.frame(
                x =     c(1.00,  1.10,  2.00,  2.10),
                y =     c(y-d*3, y-d*4, y-d*3, y-d*4),
                label = c('***', '**',  '***', '**')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_ONvsOFF_v2.tiff',
          plot, dpi=300, device='tiff')

}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'incorrect_response_fct ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
#  Random slopes removed due to singular fits and convergence issues

groups <- c('PD_PIT','PD_POM')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               correct_response_fct = factor(if_else(correct_response=='Hit',1,0)),
               incorrect_response_fct = factor(if_else(correct_response=='Incorrect',1,0))) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, incorrect_response_fct, Percentage.Correct)
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  select(pseudonym, Age_Dmean, Gender, NpsEducYears_Dmean) %>%
  mutate(Gender = as.numeric(Gender)) %>%
  group_by(pseudonym) %>%
  summarise(across(c(NpsEducYears_Dmean,Age_Dmean, Gender), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Age_Dmean, Gender, NpsEducYears_Dmean)) %>%
        left_join(., covars, by = 'pseudonym')
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)
compare_correct_for_medication(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)
```

## Subtypes vs subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_correct_for_subtypes <- function(f, tmp, tmp.collapsed){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        
        # Post hoc test
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print()
        
        em <- emmeans(fit, ~ trial_type|ParticipantType, type='response')
        contrast(em, interaction = c('revpairwise','pairwise'), adjust='mvt', type='response') %>% print()
        emmip(fit, ParticipantType ~ trial_type, type='response', CIs=TRUE) %>% print()

        em <- emmeans(fit, pairwise ~ ParticipantType, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ ParticipantType, type='response', CIs=TRUE) %>% print()
        
        em <- emmeans(fit, revpairwise ~ trial_type, type='response', adjust='mvt')
        print(em)
        emmip(fit, ~ trial_type, type='response', CIs=TRUE) %>% print()

        # Visualization
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R')
        source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R')
        N <- tmp  %>% 
                group_by(pseudonym, ParticipantType) %>%
                summarise(across(everything(), ~first(.x))) %>%
                na.omit() %>%
                ungroup() %>%
                select(ParticipantType) %>%
                table()
        plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect',
                              groupvar=c('trial_type','ParticipantType'),
                              title='Influence of subtypes \non accuracy',
                              xlab='', ylab='Errors (%)',
                              xticklabs=c(paste('MMP', ' (n=', N[1],')', sep=''),
                                          paste('IM', ' (n=', N[2],')', sep=''),
                                          paste('DM', ' (n=', N[3],')', sep='')),
                              legend_title = '',
                              legend_labels = c('One','Two','Three'),
                              legend_position = legend_position,
                              provided_summary = 'None') +
                ylim(0,70)
        y <- 70
        d = 5
        segmap <- data.frame(
                x =    c(0.80,  1.00,  1.80,  2.00,  2.80,  3.00),
                xend = c(1.20,  1.20,  2.20,  2.20,  3.20,  3.20),
                y =    c(y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4),
                yend = c(y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4)
        )
        sigmap <- data.frame(
                x =     c(1.00,  1.10,  2.00,  2.10,  3.00,  3.10),
                y =     c(y-d*3, y-d*4, y-d*3, y-d*4, y-d*3, y-d*4),
                label = c('***', '***',  '***', '***',  '***', '*')
        )
        plot <- plot +
                geom_segment(data=segmap,
                             mapping = aes(x=x,xend=xend,y=y,yend=yend),
                             inherit.aes = FALSE,
                             size = lsize) +
                geom_text(data=sigmap,
                          mapping = aes(x=x,y=y,label=label),
                          inherit.aes = FALSE,
                          size = sigsize)
        print(plot)
        save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_Subtypes_v2.tiff',
          plot, dpi=300, device='tiff')

}

f <- 'incorrect_response_fct ~ 1 + ParticipantType*trial_type + block + Gender + Age_Dmean + NpsEducYears_Dmean + (1|pseudonym)'
# Random slopes removed to solve singular fits and convergence issues

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        filter(event_type == 'response') %>%
        filter(trial_type != 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype),
               correct_response_fct = factor(if_else(correct_response=='Hit',1,0)),
               incorrect_response_fct = factor(if_else(correct_response=='Incorrect',1,0))) %>%
        select(pseudonym, ParticipantType, trial_type, block, 
               Age_Dmean, Gender, NpsEducYears_Dmean, incorrect_response_fct, Percentage.Correct)
tmp.collapsed <- tmp %>%
        group_by(pseudonym, ParticipantType, trial_type) %>%
        summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>%
        mutate(Percentage.Incorrect = (1-Percentage.Correct)*100)
compare_correct_for_subtypes(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed)

```

<!-- ## Subtypes vs HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- compare_correct_for_subtypes <- function(f, tmp, tmp.collapsed){ -->

<!--         # Fit model -->

<!--         print(paste('Fitting the following model:', f, sep=' ')) -->

<!--         fit <- glmer(f, data=tmp, family = binomial, -->

<!--                      control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5))) -->

<!--         s <- summary(fit) -->

<!--         print(s, corr = FALSE) -->

<!--         cat('\n \n') -->

<!--         anova <- Anova(fit, type = 'III') -->

<!--         print(anova) -->

<!--         cat('\n \n Odds ratios:') -->

<!--         se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/ -->

<!--         tab <- cbind(Est = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se) -->

<!--         exp(tab) %>% print() -->

<!--         # Post hoc test -->

<!--         cat('\n \n Post hoc tests of interactions \n') -->

<!--         em <- emmeans(fit, ~ ParticipantType*trial_type | block, type='response') -->

<!--         contrast(em, interaction = c('pairwise','pairwise','pairwise'), adjust='mvt', type='response') %>% print() -->

<!--         emmip(fit, ParticipantType ~ trial_type | block, type='response') %>% print() -->

<!--         em1 <- emmeans(fit, ~ block|ParticipantType, type='response') -->

<!--         contrast(em1, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         emmip(fit, ParticipantType ~ block, type='response') %>% print() -->

<!--         em2 <- emmeans(fit, ~ trial_type|ParticipantType, type='response') -->

<!--         contrast(em2, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         emmip(fit, ParticipantType ~ trial_type, type='response') %>% print() -->

<!--         em3 <- emmeans(fit, ~ block|trial_type, type='response') -->

<!--         contrast(em3, interaction = c('pairwise','pairwise'), adjust='mvt', type='response', by=NULL) %>% print() -->

<!--         emmip(fit, trial_type ~ block, type='response') %>% print() -->

<!--         cat('\n \n') -->

<!--         # contrast(emm, interaction = c('revpairwise','revpairwise', 'identity'), adjust = 'mvt', by = NULL) %>% print() -->

<!--         # Visualization -->

<!--         # tplot <- emmip(fit, trial_type~Up3OfAppendicularSum_Dmean|ParticipantType, CIs = TRUE, -->

<!--         #                type='response', cov.reduce=range, dodge=7) + -->

<!--         #         scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--         #                                direction = -1, labels = c('One','Two', 'Three')) + -->

<!--         #         ggtitle('') + ylab('Predicted probability of correct response') + -->

<!--         #         xlab('MDS-UPDRS III (bradykineisa + rigidity)') + -->

<!--         #         guides(color=guide_legend(title='No. of choices', reverse = FALSE)) + -->

<!--         #         theme_cowplot(font_size = 20) -->

<!--         # print(tplot) -->

<!--         N <- tmp %>% -->

<!--                 group_by(pseudonym, ParticipantType) %>% -->

<!--                 filter(trial_type == '1choice') %>% -->

<!--                 summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>% -->

<!--                 ungroup() %>% -->

<!--                 select(ParticipantType) %>% -->

<!--                 table() -->

<!--         tplot <- emmip(fit, trial_type ~ ParticipantType, -->

<!--                        type = 'response', CIs=TRUE, plotit=FALSE) %>% -->

<!--                 ggplot(aes(x=xvar,y=yvar*100, color=tvar)) + -->

<!--                 geom_point(position=position_dodge(width=0.6),size=8) + -->

<!--                 geom_errorbar(aes(ymin=LCL*100,ymax=UCL*100), lwd=2, width=0.5, -->

<!--                               position=position_dodge(width=0.6)) + -->

<!--                 scale_x_discrete(labels=c(paste('HC', ' (n=', N[1],')', sep=''), -->

<!--                                           paste('MMP', ' (n=', N[2],')', sep=''), -->

<!--                                           paste('IM', ' (n=', N[3],')', sep=''), -->

<!--                                           paste('DM', ' (n=', N[4],')', sep=''))) + -->

<!--                 scale_colour_viridis_d(option='mako', begin = .1, end = .6, -->

<!--                                        direction = -1,labels=c('One','Two','Three')) + -->

<!--                 ggtitle('Influence of subtype \non accuracy') + ylab('Correct (%)') + -->

<!--                 xlab('') + -->

<!--                 guides(color=guide_legend(title='', reverse = FALSE)) + -->

<!--                 theme_cowplot(font_size = 60, font_family = 'Calibri') + -->

<!--                 theme(legend.position = c(0.78, 1.25)) + -->

<!--                 ylim(96.5,100.5) #+ -->

<!-- # -->

<!-- #                 geom_text(x=2,y=1.0075,label='**',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=1,xend=3,y=1.007,yend=1.007,size=lsize) + -->

<!-- #                 geom_segment(x=1,xend=1,y=1.007,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=3,xend=3,y=1.007,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=0.8,xend=1.2,y=1.006,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=2.8,xend=3.2,y=1.006,yend=1.006,size=lsize) + -->

<!-- #                 geom_segment(x=0.8,xend=0.8,y=1.006,yend=1.005,size=lsize) + -->

<!-- #                 geom_segment(x=1.2,xend=1.2,y=1.006,yend=1.005,size=lsize) + -->

<!-- #                 geom_segment(x=2.8,xend=2.8,y=1.006,yend=1.005,size=lsize) + -->

<!-- #                 geom_segment(x=3.2,xend=3.2,y=1.006,yend=1.005,size=lsize) + -->

<!-- # -->

<!-- #                 geom_text(x=1,y=1.0045,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=0.8,xend=1.2,y=1.004,yend=1.004,size=lsize) + -->

<!-- #                 geom_text(x=1.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=1,xend=1.2,y=1.002,yend=1.002,size=lsize) + -->

<!-- # -->

<!-- #                 geom_text(x=2,y=1.0045,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=1.8,xend=2.2,y=1.004,yend=1.004,size=lsize) + -->

<!-- #                 geom_text(x=2.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=2,xend=2.2,y=1.002,yend=1.002,size=lsize) + -->

<!-- # -->

<!-- #                 geom_text(x=3,y=1.0045,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=2.8,xend=3.2,y=1.004,yend=1.004,size=lsize) + -->

<!-- #                 geom_text(x=3.1,y=1.0025,label='***',size=sigsize,show.legend=FALSE) + -->

<!-- #                 geom_segment(x=3,xend=3.2,y=1.002,yend=1.002,size=lsize) -->

<!--         print(tplot) -->

<!--         # save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_SubtypesHc.tiff', -->

<!--         #           tplot, dpi=300, device='tiff') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/plot_rainclouds.R') -->

<!--         source('M:/scripts/Personalized-Parkinson-Project-Motor/R/functions/raincloudplot_2Factor.R') -->

<!--         N <- tmp.collapsed %>% -->

<!--                 ungroup() %>% -->

<!--                 filter(trial_type == '1choice') %>% -->

<!--                 select(ParticipantType) %>% -->

<!--                 table() -->

<!--         plot <- raincloudplot_2Factor(data=tmp.collapsed, y='Percentage.Incorrect', -->

<!--                               groupvar=c('trial_type','ParticipantType'), -->

<!--                               title='Influence of subtypes \non accuracy', -->

<!--                               xlab='', ylab='Errors (%)', -->

<!--                               xticklabs=c(paste('HC', ' (n=', N[1],')', sep=''), -->

<!--                                           paste('MMP', ' (n=', N[2],')', sep=''), -->

<!--                                           paste('IM', ' (n=', N[3],')', sep=''), -->

<!--                                           paste('DM', ' (n=', N[4],')', sep='')), -->

<!--                               legend_title = '', -->

<!--                               legend_labels = c('One','Two','Three'), -->

<!--                               legend_position = legend_position, -->

<!--                               provided_summary = 'None') + -->

<!--                 ylim(0,70) -->

<!--         # y <- 70 -->

<!--         # d = 3 -->

<!--         # segmap <- data.frame( -->

<!--         #         x =    c(), -->

<!--         #         xend = c(), -->

<!--         #         y =    c(), -->

<!--         #         yend = c() -->

<!--         # ) -->

<!--         # sigmap <- data.frame( -->

<!--         #         x =     c(), -->

<!--         #         y =     c(), -->

<!--         #         label = c() -->

<!--         # ) -->

<!--         # plot <- plot + -->

<!--         #         geom_segment(data=segmap, -->

<!--         #                      mapping = aes(x=x,xend=xend,y=y,yend=yend), -->

<!--         #                      inherit.aes = FALSE, -->

<!--         #                      size = lsize) + -->

<!--         #         geom_text(data=sigmap, -->

<!--         #                   mapping = aes(x=x,y=y,label=label), -->

<!--         #                   inherit.aes = FALSE, -->

<!--         #                   size = sigsize) -->

<!--         print(plot) -->

<!--         save_plot('H:/sysneu/marjoh/Visualization/R_BaselineComparisonFmri/Accuracy_SubtypesHc_v2.tiff', -->

<!--           plot, dpi=300, device='tiff') -->

<!-- } -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*trial_type + block + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)' -->

<!-- # Random slopes and Gender removed to solve singular fits and convergence issues -->

<!-- groups <- c('0_Healthy', '1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant') -->

<!-- tmp <- df %>% -->

<!--         filter(ParticipantType=='PD_POM' | ParticipantType == 'HC_PIT') %>% -->

<!--         filter(event_type == 'response') %>% -->

<!--         filter(trial_type != 'Catch') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(Subtype %in% groups) %>% -->

<!--         mutate(Subtype = droplevels(Subtype), -->

<!--                trial_type = droplevels(trial_type), -->

<!--                ParticipantType=factor(Subtype), -->

<!--                correct_response = factor(if_else(correct_response=='Hit',1,0))) -->

<!-- tmp.collapsed <- tmp %>% -->

<!--         group_by(pseudonym, ParticipantType, trial_type) %>% -->

<!--         summarise(across(c(Percentage.Correct), ~ mean(.x, na.rm=TRUE))) %>% -->

<!--         mutate(Percentage.Incorrect = (1-Percentage.Correct)*100) -->

<!-- compare_correct_for_subtypes(f=f, tmp=tmp, tmp.collapsed = tmp.collapsed) -->

<!-- cat('\n\n\n\n') -->

<!-- ``` -->

# Percentage correct (catch)

## ON vs. HC

```{r echo=FALSE, message=FALSE, warning=TRUE}

compare_catch_correct <- function(f, tmp){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        
        # Post hoc test
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt') %>% summary()
        
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

}

f <- 'false_alarm ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# Random slope of block removed due to convergence issues

groups <- c('PD_POM','HC_PIT')
tmp <- df %>%
        filter(event_type == 'cue') %>%
        filter(trial_type == 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               false_alarm = factor(if_else(correct_response=='False Alarm',1,0)))
compare_catch_correct(f=f, tmp=tmp)

```

<!-- ## OFF vs. HC -->

<!-- ```{r echo=FALSE, message=FALSE, warning=TRUE} -->

<!-- f <- 'correct_response ~ 1 + ParticipantType*block*Up3OfAppendicularSum_Dmean + Age_Dmean + Gender + (1|pseudonym)' -->

<!-- # Random slope of block removed due to convergence issues -->

<!-- groups <- c('PD_PIT','HC_PIT') -->

<!-- tmp <- df %>% -->

<!--         filter(event_type == 'cue') %>% -->

<!--         filter(trial_type == 'Catch') %>% -->

<!--         filter(Percentage.Correct.BelowCutoff == FALSE) %>% -->

<!--         filter(ParticipantType %in% groups) %>% -->

<!--         mutate(ParticipantType = droplevels(ParticipantType), -->

<!--                trial_type = droplevels(trial_type), -->

<!--                correct_response = factor(if_else(correct_response=='False Alarm',1,0))) -->

<!-- compare_catch_correct(f=f, tmp=tmp) -->

<!-- ``` -->

## ON vs. OFF

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_catch_correct_for_medication <- function(f, tmp){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        
        # Post hoc test
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt') %>% summary()
        
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

}

ids <- df %>%
        filter(ParticipantType %in% c('PD_PIT','PD_POM'),
               TimepointNr==0,
               trial_type=='1choice',
               Percentage.Correct.BelowCutoff == FALSE,
               CrossStudyParticipation==TRUE) %>%
        select(pseudonym,ParticipantType,response_time) %>%
        group_by(pseudonym,ParticipantType) %>%
        summarise(across(response_time, ~mean(.x,na.rm=TRUE))) %>%
        ungroup() %>%
        select(pseudonym)

OnAndOff <- ids[duplicated(ids),]

f <- 'false_alarm ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# Random slope of block removed due to convergence issues

groups <- c('PD_PIT','PD_POM')
tmp <- df %>%
        filter(pseudonym %in% OnAndOff$pseudonym) %>%
        filter(event_type == 'cue') %>%
        filter(trial_type == 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(ParticipantType %in% groups) %>%
        mutate(ParticipantType = droplevels(ParticipantType),
               trial_type = droplevels(trial_type),
               false_alarm = factor(if_else(correct_response=='False Alarm',1,0)))
covars <- tmp %>%
  filter(ParticipantType=='PD_POM') %>%
  select(pseudonym, Age_Dmean, Gender, NpsEducYears_Dmean) %>%
  mutate(Gender = as.numeric(Gender)) %>%
  group_by(pseudonym) %>%
  summarise(across(c(NpsEducYears_Dmean,Age_Dmean, Gender), ~ mean(.x, na.rm=TRUE)))
tmp <- tmp %>%
        select(-c(Age_Dmean, Gender, NpsEducYears_Dmean)) %>%
        left_join(., covars, by = 'pseudonym')
compare_catch_correct_for_medication(f=f, tmp=tmp)
```

## Subtypes

```{r echo=FALSE, message=FALSE, warning=TRUE}
compare_catch_correct_for_subtypes <- function(f, tmp){
  
        # Fit model
        print(paste('Fitting the following model:', f, sep=' '))
        fit <- glmer(f, data=tmp, family = binomial,
                     control = glmerControl(optimizer = 'bobyqa', optCtrl=list(maxfun=2e5)))
        s <- summary(fit)
        print(s, corr = FALSE)
        anova <- Anova(fit, type = 'III')
        print(anova)
        se <- sqrt(diag(vcov(fit)))     #https://stats.oarc.ucla.edu/r/dae/mixed-effects-logistic-regression/
        tab <- cbind(OR = fixef(fit), CIlwr = fixef(fit)-1.96*se, CIupr = fixef(fit)+1.96*se)
        exp(tab) %>% print()
        
        # Post hoc test
        emmeans(fit, pairwise ~ ParticipantType, type = 'response', adjust = 'mvt') %>% summary()
        
        # Visualization
        emmip(fit, ~ ParticipantType, type = 'response', CIs=TRUE) %>% print()

}

f <- 'false_alarm ~ 1 + ParticipantType + Age_Dmean + Gender + NpsEducYears_Dmean + (1|pseudonym)'
# Random slope of block removed to solve convergence issues

groups <- c('1_Mild-Motor', '2_Intermediate', '3_Diffuse-Malignant')
tmp <- df %>%
        filter(ParticipantType=='PD_POM') %>%
        filter(event_type == 'cue') %>%
        filter(trial_type == 'Catch') %>%
        filter(Percentage.Correct.BelowCutoff == FALSE) %>%
        filter(Subtype %in% groups) %>%
        mutate(Subtype = droplevels(Subtype),
               trial_type = droplevels(trial_type),
               ParticipantType=factor(Subtype),
               false_alarm = factor(if_else(correct_response=='False Alarm',1,0)))
compare_catch_correct_for_subtypes(f=f, tmp=tmp)

```

# VBM

```{r echo=FALSE, message=FALSE}

prep_roi_dat <- function(roi_data, roi_to_cols=TRUE){
  
  roi_data1 <- roi_data
  
  # Demean covariates
  roi_data1 <- roi_data1 %>%
          group_by(group) %>%
          mutate(Age_Dmean = scale(Age, center=TRUE,scale=FALSE),
                 TIV_Dmean = scale(TIV, center=TRUE,scale=FALSE)) %>%
          ungroup()
  
  # Remove superfluous info from mask names
  colnames(roi_data1) <- colnames(roi_data1) %>% str_replace(., 'x_','')
  colnames(roi_data1) <- colnames(roi_data1) %>% str_replace(., 'mask_','')
  
  # Break mask name into variables
  roi_data1 <- pivot_longer(roi_data1,
                     !c(pseudonym,group,scan,L2Rflip,Age,Age_Dmean,TIV,TIV_Dmean),
                     names_to = c('MaskFlip','Contrast','ROI'),
                     names_pattern = '(.*)_(.*_.*)_(.*)',
                     values_to = 'Volume')
  
  # Turn ROIs into separate columns
  if(roi_to_cols){
    roi_data1 <- pivot_wider(roi_data1,
                            id_cols = c('pseudonym','group','scan','L2Rflip','Age','Age_Dmean',
                                        'TIV', 'TIV_Dmean','MaskFlip','Contrast'),
                            names_from = 'ROI',
                            names_prefix = 'ROI_',
                            values_from = 'Volume') %>%
      arrange(Contrast,pseudonym)
  }
  
  # Keep:
  # Flipped contrast + Values from flipped mask
  # Regular contrast + Values from regular mask
  roi_data1 <- roi_data1 %>%
    filter((L2Rflip==1 & MaskFlip=='f') | (L2Rflip==0 & MaskFlip=='nf'))
  
  # Factorize
  roi_data <- roi_data1 %>%
    mutate(Contrast = factor(Contrast))
  
  roi_data1
  
}

# Prep data
vbm_hc.vs.pd <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/HCvsPD/roi_data.csv') %>%
  prep_roi_dat(., roi_to_cols=TRUE)

vbm_subtypes <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/Subtypes/roi_data.csv') %>%
  prep_roi_dat(., roi_to_cols=TRUE)
types <- dfClin %>% filter(TimepointNr==0) %>% filter(ParticipantType!='PD_PIT') %>% select(pseudonym, Subtype) %>%
  mutate(Subtype = as.character(Subtype))
vbm_subtypes <- left_join(vbm_subtypes,types,by='pseudonym') %>%
  relocate(pseudonym, group, Subtype)

vbm_hc.vs.subtypes <- read_csv('P:/3024006.02/Analyses/CAT12/stats/VBM_shooting-custom/HcSubtypes/roi_data.csv') %>%
  prep_roi_dat(., roi_to_cols=TRUE)
vbm_hc.vs.subtypes <- left_join(vbm_hc.vs.subtypes,types,by='pseudonym') %>%
  relocate(pseudonym, group, Subtype)

# # Visualize
# ggplot(df.HCgtPD_Mean, aes(y = ROI_1, x = group)) + 
#   geom_boxplot()
# df.HCgtPD_Mean %>%
#   pivot_longer(cols = starts_with('ROI_'),
#                values_to = 'volume',
#                names_to = 'ROI',
#                names_prefix = 'ROI_') %>%
#   ggplot(aes(y = volume, x = ROI, fill = group)) +
#   geom_boxplot()

# Test
# ma <- manova(cbind(ROI_1,ROI_2,ROI_3,ROI_4,ROI_5,ROI_6) ~ group, data = df.HCgtPD_Mean)
# s <- summary(ma)
# print(s)
# s.aov <- summary.aov(ma)
# print(s.aov)
# em <- emmeans(ma, ~ group)
# summary(em)
# emmip(em, ~ group, CIs = TRUE)
```

## HC vs PD

```{r echo=FALSE,message=FALSE,warning=FALSE}

cons <- vbm_hc.vs.pd$Contrast %>% factor() %>% levels()
for(c in cons){
  
        print(c)
        if(c=='HCgtPD_Mean'){
                xticks = c('R_CB','L_Put', 'L_S1', 'R_Put', 'SMA', 'R_PMC')     
        }else if(c=='PDgtHC_3gt1'){
                xticks = c('R_IPL')
        }
        
  # One-way anova on average volume is the simplest
  vbm_test <- vbm_hc.vs.pd %>%
          filter(Contrast == c) %>%
          filter(pseudonym %in% funcsubs$pseudonym)
  vbm_test <- vbm_test[,colSums(is.na(vbm_test))<nrow(vbm_test)]
  vols <- vbm_test %>% select(starts_with('ROI'))
  avg_vols <- apply(vols, 1, mean)
  vbm_test <- bind_cols(vbm_test, Avg = avg_vols)
  m <- lm(Avg ~ group + Age_Dmean + TIV_Dmean, data = vbm_test)
  # summary(m) %>% print()
  anova(m) %>% print()
  eta_squared(anova(m)) %>% print()
  emmeans(m, pairwise ~ group, adjust='mvt') %>% print()
  
  box_by_roi <- vbm_test %>%
    pivot_longer(cols = starts_with('ROI_'),
                 values_to = 'volume',
                 names_to = 'ROI',
                 names_prefix = 'ROI_') %>%
    ggplot(aes(y = volume, x = ROI, fill = group)) +
    geom_boxplot() +
          scale_x_discrete(labels = xticks)
  
  box_by_avg <- vbm_test %>%
    ggplot(aes(y = Avg, fill = group)) +
    geom_boxplot()
  
  box <- ggarrange(box_by_roi, box_by_avg, common.legend = TRUE)
  print(box)
  
  # # PCA perhaps? Probably not.
  # data.pca <- vbm_test %>% select(starts_with('ROI_'))
  # if(ncol(data.pca)>1){
  #         pca <- prcomp(data.pca, center = TRUE, scale. = TRUE)
  #         fviz_pca_biplot(pca, geom.ind = "point", pointshape = 21, 
  #                         pointsize = 2, 
  #                         fill.ind = vbm_test$group, 
  #                         col.ind = "black", 
  #                         palette = "jco", 
  #                         addEllipses = TRUE,
  #                         label = "var",
  #                         col.var = "black",
  #                         repel = TRUE,
  #                         legend.title = "Group") +
  #                 ggtitle("2D PCA-plot from 30 feature dataset") +
  #                 theme(plot.title = element_text(hjust = 0.5))
  #}
  
}

```

## Subtypes

```{r echo=FALSE,message=FALSE,warning=FALSE}

cons <- vbm_subtypes$Contrast %>% factor() %>% levels()
for(c in cons){
  
  print(c)
        if(c=='IMgtDM_3gt1'){
                xticks = c('L_PMC')     
        }else if(c=='MMPgtDM_3gt1'){
                xticks = c('R_PMC', 'R_SPL', 'L_IPS', 'R_IPL', 'L_PMC')
        }else if(c=='MMPgtDM_Mean'){
                xticks = c('R_IPS', 'R_V5')
        }
  
  # # MANOVA followed by univariate anovas and LDA
  # vbm_test <- vbm_subtypes %>%
  #   filter(Contrast == c)
  # dv <- vbm_test %>% select(starts_with('ROI_')) %>% as.matrix()
  # iv <- vbm_test %>% select(Subtype) %>% as.matrix()
  # maov <- manova(dv ~ iv, data = vbm_test)
  # s <- summary(maov)
  # s.aov <- summary.aov(maov)
  # effsize <- effectsize(maov)
  # lda <- lda(iv ~ dv, CV = FALSE)
  # lda_df <- data.frame(
  #   groups = vbm_test[, 'Subtype'],
  #   lda = predict(lda)$x
  # )
  # ggplot(lda_df) + 
  #   geom_point(aes(x = lda.LD1, y = lda.LD2, color = Subtype), size = 4) +
  #   theme_classic()
  
  # Group x ROI ANOVA also possible...
  
  # One-way anova on average volume is the simplest
  vbm_test <- vbm_subtypes %>%
    filter(Contrast == c) %>%
          filter(pseudonym %in% funcsubs$pseudonym)
  vbm_test <- vbm_test[,colSums(is.na(vbm_test))<nrow(vbm_test)]
  g <- tibble(MMP = str_detect(c,'MMP'), IM = str_detect(c,'IM'), DM = str_detect(c, 'DM'))
  if(g$MMP & g$IM){
    vbm_test <- vbm_test %>% filter(Subtype == '1_Mild-Motor' | Subtype == '2_Intermediate')
  }else if(g$MMP & g$DM){
    vbm_test <- vbm_test %>% filter(Subtype == '1_Mild-Motor' | Subtype == '3_Diffuse-Malignant')
  }else if(g$IM & g$DM){
    vbm_test <- vbm_test %>% filter(Subtype == '2_Intermediate' | Subtype == '3_Diffuse-Malignant')
  }
  vols <- vbm_test %>% select(starts_with('ROI'))
  avg_vols <- apply(vols, 1, mean)
  vbm_test <- bind_cols(vbm_test, Avg = avg_vols)
  m <- lm(Avg ~ Subtype + Age_Dmean + TIV_Dmean, data = vbm_test)
  # summary(m) %>% print()
  anova(m) %>% print()
  eta_squared(anova(m)) %>% print()
  emmeans(m, pairwise ~ Subtype, adjust='mvt') %>% print()
  
  box_by_roi <- vbm_test %>%
    pivot_longer(cols = starts_with('ROI_'),
                 values_to = 'volume',
                 names_to = 'ROI',
                 names_prefix = 'ROI_') %>%
    ggplot(aes(y = volume, x = ROI, fill = Subtype)) +
    geom_boxplot() +
          scale_x_discrete(labels = xticks)

  box_by_avg <- vbm_test %>%
    ggplot(aes(y = Avg, fill = Subtype)) +
    geom_boxplot()
  
  box <- ggarrange(box_by_roi, box_by_avg, common.legend = TRUE)
  print(box)
  
}

```

## HC vs Subtypes

```{r echo=FALSE,message=FALSE,warning=FALSE}

cons <- vbm_hc.vs.subtypes$Contrast %>% factor() %>% levels()
for(c in cons){
  
  print(c)
        if(c=='HCgtDM_2gt1'){
                xticks = c('L_PMC')     
        }else if(c=='HCgtDM_3gt1'){
                xticks = c('L_PMC')
        }else if(c=='IMgtHC_2gt1'){
                xticks = c('R_Put')
        }else if(c=='MMPgtHC_3gt1'){
                xticks = c('R_MTG', 'R_PMC', 'R_FP', 'R_IPL')
        }else if(c=='MMPgtHC_3gt2'){
                xticks = c('R_MTG')
        }
  
  # One-way anova on average volume is the simplest
  vbm_test <- vbm_hc.vs.subtypes %>%
    filter(Contrast == c) %>%
          filter(pseudonym %in% funcsubs$pseudonym)
  vbm_test <- vbm_test[,colSums(is.na(vbm_test))<nrow(vbm_test)]
  g <- tibble(HC = str_detect(c,'HC'), MMP = str_detect(c,'MMP'), IM = str_detect(c,'IM'), DM = str_detect(c, 'DM'))
  if(g$HC & g$MMP){
    vbm_test <- vbm_test %>% filter(Subtype == '0_Healthy' | Subtype == '1_Mild-Motor')
  }else if(g$HC & g$IM){
    vbm_test <- vbm_test %>% filter(Subtype == '0_Healthy' | Subtype == '2_Intermediate')
  }else if(g$HC & g$DM){
    vbm_test <- vbm_test %>% filter(Subtype == '0_Healthy' | Subtype == '3_Diffuse-Malignant')
  }
  vols <- vbm_test %>% select(starts_with('ROI_'))
  avg_vols <- apply(vols, 1, mean)
  vbm_test <- bind_cols(vbm_test, Avg = avg_vols)
  
  # # Check outliers
  # summary <- vbm_test %>%
  #   summarise(avg=mean(Avg),sd=sd(Avg))
  # outliers <- vbm_test %>%
  #   mutate(Outlier = if_else(Avg > summary$avg+3*summary$sd | Avg < summary$avg-3*summary$sd, 1, 0)) %>%
  #   filter(Outlier==1)
  # vbm_test_clean <- vbm_test %>% filter(!(pseudonym %in% outliers$pseudonym))
  
  m <- lm(Avg ~ Subtype + Age_Dmean + TIV_Dmean, data = vbm_test)
  # summary(m) %>% print()
  anova(m) %>% print()
  eta_squared(anova(m)) %>% print()
  emmeans(m, pairwise ~ Subtype, adjust='mvt') %>% print()
  
  box_by_roi <- vbm_test %>%
    pivot_longer(cols = starts_with('ROI_'),
                 values_to = 'volume',
                 names_to = 'ROI',
                 names_prefix = 'ROI_') %>%
    ggplot(aes(y = volume, x = ROI, fill = Subtype)) +
    geom_boxplot() +
          scale_x_discrete(labels = xticks)
  
  box_by_avg <- vbm_test %>%
    ggplot(aes(y = Avg, x = Subtype, fill = Subtype)) +
    geom_boxplot()
  
  box <- ggarrange(box_by_roi, box_by_avg, common.legend = TRUE)
  print(box)

}

# Post hoc exploration of structure vs function

MMPvsHC.vbm <- vbm_hc.vs.subtypes %>%
        filter(Subtype=='0_Healthy' | Subtype=='1_Mild-Motor',
               Contrast=='MMPgtHC_3gt1')

MMPvsHC.mtg <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers2/marsbar/MMP_HC_(Int3_Ext)_21_48_44.csv") %>% select(-c(Group,scans))
MMPvsHC.pmc <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers2/marsbar/MMP_HC_(Int3_Ext)_27_11_40.csv") %>% select(-c(Group,scans))
MMPvsHC.fp <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers2/marsbar/MMP_HC_(Int3_Ext)_49_-57_22.csv") %>% select(-c(Group,scans))
MMPvsHC.ipl <- read_csv("P:/3024006.02/Analyses/DurAvg_ReAROMA_PMOD_TimeDer_Trem/Group/HcSubtypes_x_ExtInt2Int3Catch_NoOutliers2/marsbar/MMP_HC_(Int3_Ext)_67_-47_-4.csv") %>% select(-c(Group,scans))

disease_severity <- dfClin %>%
  filter(ParticipantType == 'PD_POM') %>%
  filter(Subtype == '1_Mild-Motor') %>%
  filter(TimepointNr == 0) %>%
  select(pseudonym, MotorComposite, Up3OfTotal, Up3OfAppendicularSum,
         CognitiveComposite,SCOPA_AUTSum,RBDSQSum, MonthSinceDiag)

struc.vs.fun <- full_join(MMPvsHC.mtg,MMPvsHC.vbm, by = 'pseudonym') %>%
        arrange(pseudonym) %>%
        na.omit() %>%
        filter(Cond != 'Catch') %>%
        select(-c(scan, L2Rflip, MaskFlip, Contrast, group)) %>%
        pivot_wider(id_cols = c('pseudonym', 'Subtype', 'Age', 'TIV', 'ROI_1', 'ROI_2', 'ROI_3', 'ROI_4'),
                    names_from = Cond, values_from = Vals) %>%
        mutate(Avg.vbm = (ROI_1 + ROI_2 + ROI_3 + ROI_4) / 4,
               Diff.3gt1 = Int3 - Ext,
               Diff.3gt2 = Int3 - Int2) %>%
  left_join(., disease_severity, by = 'pseudonym')

struc.vs.fun %>% select(Subtype) %>% table()

# Is there an association between brain activity and structure?
ggplot(struc.vs.fun, aes(x=Avg.vbm, y=Diff.3gt1, color=Subtype)) + 
        geom_point() + 
        geom_smooth(method='lm') + 
        facet_grid(~Subtype)

m.hc <- lm(Avg.vbm ~ Diff.3gt1+Age+TIV, data = struc.vs.fun, subset = (struc.vs.fun$Subtype=='0_Healthy'))
anova(m.hc)
m.mmp <- lm(Avg.vbm ~ Diff.3gt1+Age+TIV, data = struc.vs.fun, subset = (struc.vs.fun$Subtype=='1_Mild-Motor'))
anova(m.mmp)

# Is there an association between structure and symptom severity?
struc.vs.fun %>%
  filter(Subtype == '1_Mild-Motor') %>%
  ggplot(aes(x=Avg.vbm, y=Up3OfTotal, color=Subtype)) + 
  geom_point() +
  geom_smooth(method='lm')
m.mmp <- lm(Avg.vbm ~ Up3OfAppendicularSum + Age + TIV, data = struc.vs.fun, subset = (struc.vs.fun$Subtype=='1_Mild-Motor'))
anova(m.mmp) # Larger volumes = More severe symptoms

# Is there an association between task performance and structure?
RTs <- tmp.for.struc %>%
  ungroup() %>%
  filter(ParticipantType=='MMP') %>%
  mutate(ParticipantType='1_Mild-Motor') %>%
  pivot_wider(id_cols = c('pseudonym','ParticipantType'),
              names_from = trial_type,
              values_from = response_time) %>%
  mutate(RT.Avg = (`1choice` + `2choice` + `3choice`)/3,
         RT.Diff.3gt1 = `3choice` - `1choice`) %>%
  rename(Subtype = ParticipantType) %>%
  select(pseudonym, Subtype, RT.Avg, RT.Diff.3gt1)

struc.vs.fun2 <- left_join(struc.vs.fun, RTs, by=c('pseudonym','Subtype')) %>%
  filter(Subtype == '1_Mild-Motor')

struc.vs.fun2 %>%
  ggplot(aes(x=Avg.vbm,y=RT.Avg)) + 
  geom_point() + 
  geom_smooth(method='lm')
m <- lm(Avg.vbm ~ RT.Avg + Age + TIV, data = struc.vs.fun2)
anova(m)  # Smaller volumes = Slower avg RTs

struc.vs.fun2 %>%
  ggplot(aes(x=Avg.vbm,y=RT.Diff.3gt1)) + 
  geom_point() + 
  geom_smooth(method='lm')
m <- lm(Avg.vbm ~ RT.Diff.3gt1 + Age + TIV, data = struc.vs.fun2)
anova(m)

m <- lm(RT.Avg ~ Up3OfTotal, data = struc.vs.fun2)


```
